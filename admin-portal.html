<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Portal - Worry Free Moving</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* ==============================================
           LOGIN SCREEN
        ============================================== */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-card p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* ==============================================
           DASHBOARD
        ============================================== */
        #dashboardScreen {
            display: none;
            padding: 0;
            min-height: 100vh;
        }

        .dashboard-header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h1 {
            color: #333;
            font-size: 24px;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 0;
        }

        .tab-nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 5px;
        }

        .tab-button {
            padding: 15px 30px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #d32f2f;
        }

        .dashboard-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            color: #333;
            font-size: 32px;
            font-weight: 700;
        }

        .search-filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filters input,
        .search-filters select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .appointments-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            color: #333;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.2s;
        }

        .btn-action:hover {
            opacity: 0.8;
        }

        .btn-view {
            background: #2196F3;
            color: white;
        }

        .btn-edit {
            background: #FF9800;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        /* ==============================================
           MODAL
        ============================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #333;
            font-size: 22px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 25px;
        }

        .detail-group {
            margin-bottom: 20px;
        }

        .detail-group label {
            display: block;
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .detail-group .value {
            color: #333;
            font-size: 16px;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #333;
        }

        .btn-save {
            background: #4CAF50;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .table-wrapper {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-filters {
                flex-direction: column;
            }

            .search-filters input,
            .search-filters select {
                min-width: 100%;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Customer Catalog Styles */
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .customer-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .customer-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .customer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .customer-info h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .customer-info p {
            color: #666;
            font-size: 13px;
            margin: 0;
        }

        .customer-stats {
            display: flex;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .customer-stat {
            flex: 1;
        }

        .customer-stat label {
            display: block;
            color: #999;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .customer-stat .value {
            color: #333;
            font-size: 16px;
            font-weight: 700;
        }

        .customer-detail-modal .modal-content {
            max-width: 900px;
        }

        .customer-bookings-list {
            margin-top: 20px;
        }

        .booking-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .booking-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .booking-item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        /* Settings Styles */
        .settings-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .template-editor {
            margin-bottom: 20px;
        }

        .template-editor label {
            display: block;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .template-editor input,
        .template-editor textarea,
        .template-editor select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .template-editor input:focus,
        .template-editor textarea:focus,
        .template-editor select:focus {
            outline: none;
            border-color: #667eea;
        }

        .template-editor textarea {
            min-height: 120px;
            resize: vertical;
        }

        .template-variables {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }

        .template-variables strong {
            color: #333;
            display: block;
            margin-bottom: 8px;
        }

        .template-variables code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 4px;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .btn-save-settings {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-save-settings:hover {
            transform: translateY(-2px);
        }

        .save-indicator {
            display: inline-block;
            margin-left: 15px;
            color: #4CAF50;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }

        /* Calendar Styles */
        .calendar-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        .calendar-sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: fit-content;
        }

        /* Mini Calendar Navigator */
        .mini-calendar {
            margin-bottom: 20px;
        }

        .mini-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mini-calendar-header h3 {
            font-size: 14px;
            color: #333;
            margin: 0;
        }

        .mini-nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #667eea;
            font-size: 18px;
            padding: 0 5px;
        }

        .mini-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .mini-day-header {
            text-align: center;
            font-size: 10px;
            color: #999;
            padding: 4px 0;
            font-weight: 600;
        }

        .mini-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }

        .mini-day:hover {
            background: #f0f0f0;
        }

        .mini-day.today {
            background: #667eea;
            color: white;
            font-weight: 700;
        }

        .mini-day.has-bookings {
            background: #e0e0e0;
            font-weight: 600;
        }

        .mini-day.has-many-bookings {
            background: #999;
            color: white;
            font-weight: 600;
        }

        .mini-day.other-month {
            color: #ccc;
        }

        .calendar-main {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-header h2 {
            color: #333;
            font-size: 24px;
            margin: 0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-calendar {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-calendar:hover {
            background: #5568d3;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
            border: 1px solid #e0e0e0;
        }

        .calendar-day-header {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
        }

        .calendar-day {
            background: white;
            min-height: 110px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            background: #fafafa;
            color: #ccc;
        }

        .calendar-day.today {
            background: #e8f4fd;
            border: 2px solid #667eea;
        }

        .calendar-day.blocked {
            background: #ffe6e6;
            cursor: not-allowed;
        }

        .calendar-day.blocked:hover {
            background: #ffcccc;
        }

        .day-number {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .calendar-day.other-month .day-number {
            color: #ccc;
        }

        .day-bookings {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: auto;
        }

        .booking-circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #b0b0b0;
        }

        .booking-circle.confirmed {
            background: #5a5a5a;
        }

        .booking-circle.pending {
            background: #d0d0d0;
        }

        .booking-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 3px;
        }

        .blocked-badge {
            display: inline-block;
            background: #f44336;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            margin-top: 5px;
        }

        .calendar-legend {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .calendar-legend h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 13px;
            color: #666;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .availability-settings {
            margin-top: 20px;
        }

        .availability-settings h4 {
            color: #333;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .quick-action-btn {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        /* Day Detail Modal */
        .day-modal .modal-content {
            max-width: 600px;
        }

        .booking-list {
            margin-top: 15px;
        }

        .booking-list-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .booking-time {
            font-weight: 600;
            color: #667eea;
        }

        .booking-customer {
            color: #333;
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>üîê Admin Portal</h1>
            <p>Worry Free Moving</p>

            <div id="loginError" class="error-message"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>

                <button type="submit" class="btn-login">Login</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboardScreen">
        <div class="dashboard-header">
            <h1>üìä Admin Portal</h1>
            <div class="header-right">
                <div class="user-info">
                    Logged in as: <strong id="username-display">Admin</strong>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-nav-inner">
                <button class="tab-button active" onclick="switchTab('bookings')">üìÖ Bookings</button>
                <button class="tab-button" onclick="switchTab('customers')">üë• Customers</button>
                <button class="tab-button" onclick="switchTab('calendar')">üóìÔ∏è Calendar</button>
                <button class="tab-button" onclick="switchTab('services')">üí∞ Services & Pricing</button>
                <button class="tab-button" onclick="switchTab('users')">üîê Authorized Users</button>
                <button class="tab-button" onclick="switchTab('employees')">üë∑ Employees</button>
                <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <!-- BOOKINGS TAB -->
        <div id="bookingsTab" class="tab-content active">
            <div class="dashboard-content">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Bookings</h3>
                    <div class="number" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <h3>Confirmed</h3>
                    <div class="number" id="stat-confirmed">0</div>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <div class="number" id="stat-pending">0</div>
                </div>
                <div class="stat-card">
                    <h3>This Month</h3>
                    <div class="number" id="stat-month">0</div>
                </div>
            </div>

            <!-- Search/Filters -->
            <div class="search-filters">
                <input type="text" id="searchInput" placeholder="Search by name, email, booking ID..." oninput="filterAppointments()">
                <select id="statusFilter" onchange="filterAppointments()">
                    <option value="">All Statuses</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="pending">Pending</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <select id="serviceFilter" onchange="filterAppointments()">
                    <option value="">All Services</option>
                    <option value="Moving Service">Moving Service</option>
                    <option value="Labor Only">Labor Only</option>
                    <option value="Single Item">Single Item</option>
                    <option value="Packing Service">Packing Service</option>
                </select>
            </div>

            <!-- Appointments Table -->
            <div class="appointments-table">
                <div class="table-header">
                    <h2>All Appointments</h2>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Customer</th>
                                <th>Service</th>
                                <th>Date & Time</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading appointments...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="customersTab" class="tab-content">
            <div class="dashboard-content">
                <!-- Customer Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Customers</h3>
                        <div class="number" id="stat-customers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active This Month</h3>
                        <div class="number" id="stat-active-customers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Repeat Customers</h3>
                        <div class="number" id="stat-repeat-customers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>New This Month</h3>
                        <div class="number" id="stat-new-customers">0</div>
                    </div>
                </div>

                <!-- Customer Search -->
                <div class="search-filters">
                    <input type="text" id="customerSearchInput" placeholder="Search by name, email, phone..." oninput="filterCustomers()">
                </div>

                <!-- Customer Grid -->
                <div id="customerGrid" class="customer-grid">
                    <div class="loading">Loading customers...</div>
                </div>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendarTab" class="tab-content">
            <div class="dashboard-content">
                <div class="calendar-container">
                    <!-- Sidebar -->
                    <div class="calendar-sidebar">
                        <!-- Mini Calendar Navigator -->
                        <div class="mini-calendar">
                            <div class="mini-calendar-header">
                                <button class="mini-nav-btn" onclick="previousMonth()">‚Äπ</button>
                                <h3 id="mini-month-year">Jan 2025</h3>
                                <button class="mini-nav-btn" onclick="nextMonth()">‚Ä∫</button>
                            </div>
                            <div class="mini-calendar-grid" id="mini-calendar-grid">
                                <!-- Mini calendar will be generated here -->
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="calendar-legend">
                            <h4>Legend</h4>
                            <div class="legend-item">
                                <div class="booking-circle confirmed" style="width: 12px; height: 12px;"></div>
                                <span>Confirmed</span>
                            </div>
                            <div class="legend-item">
                                <div class="booking-circle pending" style="width: 12px; height: 12px;"></div>
                                <span>Pending</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ffe6e6;"></div>
                                <span>Blocked</span>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="availability-settings">
                            <h4>Quick Actions</h4>
                            <button class="quick-action-btn" onclick="openNewAppointmentModal()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: 600;">
                                ‚ûï New Appointment
                            </button>
                            <button class="quick-action-btn" onclick="openAvailabilitySettings()">
                                ‚öôÔ∏è Availability Settings
                            </button>
                            <button class="quick-action-btn" onclick="viewBlockedDates()">
                                üö´ View Blocked Dates
                            </button>
                            <button class="quick-action-btn" onclick="syncCalendars()">
                                üîÑ Sync Calendars
                            </button>
                        </div>

                        <!-- Stats -->
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">This Month</h4>
                            <div style="font-size: 13px; color: #666; margin: 5px 0;">
                                <strong id="month-bookings">0</strong> bookings
                            </div>
                            <div style="font-size: 13px; color: #666; margin: 5px 0;">
                                <strong id="month-blocked">0</strong> days blocked
                            </div>
                        </div>
                    </div>

                    <!-- Main Calendar -->
                    <div class="calendar-main">
                        <div class="calendar-header">
                            <h2 id="calendar-month-year">January 2025</h2>
                            <div class="calendar-nav">
                                <button class="btn-calendar" onclick="previousMonth()">‚Üê Previous</button>
                                <button class="btn-calendar" onclick="today()">Today</button>
                                <button class="btn-calendar" onclick="nextMonth()">Next ‚Üí</button>
                            </div>
                        </div>

                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVICES TAB -->
        <!--
            ========================================
            CENTRALIZED PRICING CONFIGURATION
            ========================================

            IMPORTANT: This is the single source of truth for ALL pricing across the entire system.

            Integration Points:
            1. Admin Portal (this page) - Manages and displays all service pricing
            2. Sarah AI v3 Chatbot - Reads pricing from /api/services endpoint
            3. Customer Booking Pages - Displays pricing from /api/services endpoint
            4. Backend Server - Serves pricing from data/services.json

            When integrating the chatbot:
            - The chatbot MUST fetch prices from the /api/services endpoint
            - DO NOT hardcode prices in the chatbot
            - Ensure backward compatibility by maintaining the services.json structure
            - Any changes made here will automatically update chatbot pricing

            Data Flow:
            Admin Portal ‚Üí saves to ‚Üí data/services.json ‚Üí served by ‚Üí /api/services ‚Üí consumed by ‚Üí Chatbot/Booking Pages

            ========================================
        -->
        <div id="servicesTab" class="tab-content">
            <div class="dashboard-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #333; margin: 0;">üíº Services & Pricing Management v4</h2>
                    <div id="pageLoadTime" style="background: #28a745; color: white; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- SUCCESS: Cache-busting enabled! -->
                <div style="background: #28a745; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; border: 3px solid #1e7e34;">
                    <h3 style="margin-top: 0; color: white;">‚úÖ Advanced Cache-Busting Enabled!</h3>
                    <p style="margin: 8px 0 0 0;">This page now uses aggressive cache-busting with timestamp parameters. Services should load automatically below.</p>
                </div>

                <div style="background: #e8f4f8; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #17a2b8; margin-bottom: 20px; font-size: 13px;">
                    <strong>‚ÑπÔ∏è Note:</strong> All pricing changes here will automatically sync to the chatbot and booking pages. This is the central pricing control for your entire system.
                </div>

                <!-- Loading Indicator -->
                <div id="servicesLoadingIndicator" style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span>Loading services...</span>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <button class="btn-primary" onclick="saveServices()" style="margin-right: 10px;">Save All Changes</button>
                    <button class="btn-secondary" onclick="loadServices()">Reload from Server</button>
                    <button class="btn-secondary" onclick="testServicesAPI()" style="margin-left: 10px; background: #ffc107;">üîß Test API</button>
                </div>

                <!-- Debug Information -->
                <div id="servicesDebugInfo" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
                    <h4 style="margin-top: 0;">Debug Information:</h4>
                    <pre id="debugOutput" style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;"></pre>
                </div>

                <!-- Moving Services Section -->
                <div class="settings-section">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üöö Moving Services (Full Service)</h3>
                    <div id="movingServicesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Other Services Section -->
                <div class="settings-section">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üì¶ Additional Services</h3>
                    <div id="otherServicesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Packing Materials Section -->
                <div class="settings-section">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üì¶ Packing Materials</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left;">Material</th>
                                    <th style="padding: 12px; text-align: left;">Category</th>
                                    <th style="padding: 12px; text-align: right;">Price</th>
                                    <th style="padding: 12px; text-align: center;">Enabled</th>
                                </tr>
                            </thead>
                            <tbody id="packingMaterialsTable">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Fees Section -->
                <div class="settings-section">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üí∞ Fees & Surcharges</h3>
                    <div id="feesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Packing Materials Section -->
                <div class="settings-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin: 0;">üì¶ Packing Materials</h3>
                        <button class="btn-primary" onclick="showAddMaterialModal()" style="padding: 10px 20px; font-size: 14px;">
                            ‚ûï Add New Material
                        </button>
                    </div>

                    <!-- Materials Grid -->
                    <div id="packingMaterialsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTab" class="tab-content">
            <div class="dashboard-content">
                <h2 style="color: #333; margin-bottom: 25px;">‚öôÔ∏è Communication Settings</h2>

                <!-- Quality Moving Settings Link -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="color: white; margin: 0 0 8px 0; font-size: 20px;">üè¢ Quality Moving Settings</h3>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">Manage all Quality Moving specific configurations, pricing, branding, and integrations</p>
                        </div>
                        <a href="quality-moving-settings.html" style="background: white; color: #667eea; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';">
                            Open Quality Moving Settings ‚Üí
                        </a>
                    </div>
                </div>

                <!-- Confirmation Email Settings -->
                <div class="settings-section">
                    <h3>üìß Confirmation Email (Sent Immediately)</h3>

                    <div class="template-editor">
                        <label>Email Subject</label>
                        <input type="text" id="confirm-email-subject" value="Your Worry Free Moving Appointment is Confirmed! üöö" />
                    </div>

                    <div class="template-editor">
                        <label>Email Message</label>
                        <textarea id="confirm-email-body">Hi {{firstName}}!

Great news - your moving appointment is confirmed! We're excited to help make your move worry-free.

üìÖ Date: {{date}}
üïê Time: {{time}}
üì¶ Service: {{serviceType}}
üìç Pickup: {{pickupAddress}}
üìç Dropoff: {{dropoffAddress}}

üì± Booking ID: {{bookingId}}

We'll send you a reminder 24 hours before your appointment. If you have any questions, feel free to contact us!

Best regards,
Worry Free Moving Team
330-435-8686
service@worryfreemovers.com</textarea>
                    </div>

                    <div class="template-variables">
                        <strong>Available Variables:</strong>
                        <code>{{firstName}}</code><code>{{lastName}}</code><code>{{email}}</code><code>{{phone}}</code><code>{{date}}</code><code>{{time}}</code><code>{{serviceType}}</code><code>{{pickupAddress}}</code><code>{{dropoffAddress}}</code><code>{{bookingId}}</code>
                    </div>
                </div>

                <!-- Confirmation SMS Settings -->
                <div class="settings-section">
                    <h3>üí¨ Confirmation SMS (Sent Immediately)</h3>

                    <div class="template-editor">
                        <label>SMS Message (160 characters recommended)</label>
                        <textarea id="confirm-sms-body" maxlength="320">Hi {{firstName}}! Your Worry Free Moving appointment is confirmed for {{date}} at {{time}}. Booking ID: {{bookingId}}. We'll send a reminder 24 hours before. Questions? Call 330-435-8686</textarea>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Character count: <span id="confirm-sms-count">0</span>/320
                        </div>
                    </div>

                    <div class="template-variables">
                        <strong>Available Variables:</strong>
                        <code>{{firstName}}</code><code>{{lastName}}</code><code>{{date}}</code><code>{{time}}</code><code>{{serviceType}}</code><code>{{bookingId}}</code>
                    </div>
                </div>

                <!-- 24-Hour Reminder Email Settings -->
                <div class="settings-section">
                    <h3>üìß 24-Hour Reminder Email</h3>

                    <div class="template-editor">
                        <label>Send Timing</label>
                        <select id="reminder-24h-timing">
                            <option value="24">24 hours before appointment</option>
                            <option value="48">48 hours before appointment</option>
                            <option value="72">72 hours before appointment</option>
                        </select>
                    </div>

                    <div class="template-editor">
                        <label>Email Subject</label>
                        <input type="text" id="reminder-24h-email-subject" value="Reminder: Your Move is Tomorrow! üöö" />
                    </div>

                    <div class="template-editor">
                        <label>Email Message</label>
                        <textarea id="reminder-24h-email-body">Hi {{firstName}}!

Just a friendly reminder that your move is scheduled for tomorrow!

üìÖ Date: {{date}}
üïê Time: {{time}}
üì¶ Service: {{serviceType}}
üìç Pickup: {{pickupAddress}}
üìç Dropoff: {{dropoffAddress}}

üì± Booking ID: {{bookingId}}

Please make sure everything is packed and ready to go. We'll send you another reminder 2 hours before your appointment.

Looking forward to helping you with your move!

Best regards,
Worry Free Moving Team
330-435-8686
service@worryfreemovers.com</textarea>
                    </div>

                    <div class="template-variables">
                        <strong>Available Variables:</strong>
                        <code>{{firstName}}</code><code>{{lastName}}</code><code>{{email}}</code><code>{{phone}}</code><code>{{date}}</code><code>{{time}}</code><code>{{serviceType}}</code><code>{{pickupAddress}}</code><code>{{dropoffAddress}}</code><code>{{bookingId}}</code>
                    </div>
                </div>

                <!-- 24-Hour Reminder SMS Settings -->
                <div class="settings-section">
                    <h3>üí¨ 24-Hour Reminder SMS</h3>

                    <div class="template-editor">
                        <label>SMS Message</label>
                        <textarea id="reminder-24h-sms-body" maxlength="320">Hi {{firstName}}! Reminder: Your move with Worry Free Moving is tomorrow {{date}} at {{time}}. Please have everything packed and ready. We'll text again 2 hours before. ID: {{bookingId}}</textarea>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Character count: <span id="reminder-24h-sms-count">0</span>/320
                        </div>
                    </div>

                    <div class="template-variables">
                        <strong>Available Variables:</strong>
                        <code>{{firstName}}</code><code>{{lastName}}</code><code>{{date}}</code><code>{{time}}</code><code>{{serviceType}}</code><code>{{bookingId}}</code>
                    </div>
                </div>

                <!-- 2-Hour Reminder SMS Settings -->
                <div class="settings-section">
                    <h3>üí¨ 2-Hour Reminder SMS</h3>

                    <div class="template-editor">
                        <label>Send Timing</label>
                        <select id="reminder-2h-timing">
                            <option value="2">2 hours before appointment</option>
                            <option value="1">1 hour before appointment</option>
                            <option value="3">3 hours before appointment</option>
                        </select>
                    </div>

                    <div class="template-editor">
                        <label>SMS Message</label>
                        <textarea id="reminder-2h-sms-body" maxlength="320">Hi {{firstName}}! Your Worry Free Moving crew will arrive in 2 hours at {{time}}. Make sure you're at {{pickupAddress}}. See you soon! ID: {{bookingId}}</textarea>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Character count: <span id="reminder-2h-sms-count">0</span>/320
                        </div>
                    </div>

                    <div class="template-variables">
                        <strong>Available Variables:</strong>
                        <code>{{firstName}}</code><code>{{lastName}}</code><code>{{date}}</code><code>{{time}}</code><code>{{serviceType}}</code><code>{{pickupAddress}}</code><code>{{bookingId}}</code>
                    </div>
                </div>

                <!-- Calendar Integration Settings -->
                <div class="settings-section">
                    <h3>üìÖ Calendar Integration</h3>

                    <div class="template-editor">
                        <label>Enable Calendar Sync</label>
                        <select id="calendar-sync-enabled">
                            <option value="disabled">Disabled</option>
                            <option value="enabled">Enabled</option>
                        </select>
                    </div>

                    <div class="template-editor">
                        <label>Calendar Provider</label>
                        <select id="calendar-provider">
                            <option value="google">Google Calendar</option>
                            <option value="outlook">Microsoft Outlook / Office 365</option>
                            <option value="apple">Apple iCloud Calendar</option>
                            <option value="caldav">CalDAV (Generic)</option>
                        </select>
                    </div>

                    <div class="template-editor">
                        <label>Calendar ID / Name</label>
                        <input type="text" id="calendar-id" placeholder="e.g., primary, your-calendar-id@group.calendar.google.com" />
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            For Google Calendar: Use "primary" for your main calendar or the calendar ID
                        </div>
                    </div>

                    <div class="template-editor">
                        <label>API Key / Credentials</label>
                        <input type="password" id="calendar-api-key" placeholder="Enter your API key or OAuth credentials" />
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Keep this secure. Never share your API keys.
                        </div>
                    </div>

                    <div class="template-editor">
                        <label>Sync Direction</label>
                        <select id="calendar-sync-direction">
                            <option value="one-way">One-way (Booking System ‚Üí Calendar)</option>
                            <option value="two-way">Two-way (Sync both directions)</option>
                        </select>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            Two-way sync will also import events from your calendar
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn-primary" onclick="testCalendarConnection()" style="font-size: 13px; padding: 8px 15px;">Test Connection</button>
                            <button class="btn-secondary" onclick="syncCalendarsNow()" style="font-size: 13px; padding: 8px 15px;">Sync Now</button>
                            <button class="btn-secondary" onclick="viewCalendarLogs()" style="font-size: 13px; padding: 8px 15px;">View Sync Logs</button>
                        </div>
                        <div id="calendar-sync-status" style="font-size: 13px; color: #856404;">
                            Status: Not configured
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div style="text-align: center; padding: 20px;">
                    <button class="btn-save-settings" onclick="saveSettings()">üíæ Save All Settings</button>
                    <span class="save-indicator" id="saveIndicator">‚úì Settings saved successfully!</span>
                </div>
            </div>
        </div>

        <!-- AUTHORIZED USERS TAB -->
        <div id="usersTab" class="tab-content">
            <div class="dashboard-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #333; margin: 0;">üë• Authorized Users</h2>
                    <button class="btn-primary" onclick="showAddUserModal()" style="padding: 12px 24px; font-size: 14px;">
                        ‚ûï Add New User
                    </button>
                </div>

                <!-- Search and Filter -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="userSearch" placeholder="üîç Search by name, email, or username..."
                           onkeyup="filterUsers()"
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>

                <!-- Users Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <table id="usersTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Username</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Full Name</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Email</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Role</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Last Login</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- User Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="totalUsersCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Total Users</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="activeUsersCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Active Users</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="adminUsersCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Administrators</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMPLOYEES TAB -->
        <div id="employeesTab" class="tab-content">
            <div class="dashboard-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: #333; margin: 0;">üë∑ Employees</h2>
                    <button class="btn-primary" onclick="showAddEmployeeModal()" style="padding: 12px 24px; font-size: 14px;">
                        ‚ûï Add New Employee
                    </button>
                </div>

                <!-- Search and Filter -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="employeeSearch" placeholder="üîç Search by name, email, or username..."
                           onkeyup="filterEmployees()"
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                </div>

                <!-- Employees Table -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <table id="employeesTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Username</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Full Name</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Email</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Phone</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Role</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Team</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Status</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr>
                                <td colspan="8" style="padding: 40px; text-align: center; color: #999;">
                                    Loading employees...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Employee Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="totalEmployeesCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Total Employees</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="activeEmployeesCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Active Employees</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 24px; font-weight: bold; color: #ff6b6b;" id="crewMembersCount">0</div>
                        <div style="color: #666; margin-top: 5px;">Crew Members</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW/EDIT MODAL -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Appointment Details</h2>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Buttons will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- CUSTOMER DETAIL MODAL -->
    <div id="customerModal" class="modal customer-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customerModalTitle">Customer Profile</h2>
                <button class="btn-close" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div class="modal-body" id="customerModalBody">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeCustomerModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- DAY DETAIL MODAL -->
    <div id="dayModal" class="modal day-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dayModalTitle">Day Details</h2>
                <button class="btn-close" onclick="closeDayModal()">&times;</button>
            </div>
            <div class="modal-body" id="dayModalBody">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer" id="dayModalFooter">
                <button class="btn-modal btn-cancel" onclick="closeDayModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- AVAILABILITY SETTINGS MODAL -->
    <div id="availabilityModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Availability Settings</h2>
                <button class="btn-close" onclick="closeAvailabilityModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Quick Actions -->
                <div style="background: #e8f4f8; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <strong style="font-size: 13px; margin-right: 8px;">Quick Apply:</strong>
                        <button onclick="applyToAllDays()" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">Apply Monday to All Days</button>
                        <button onclick="applyToWeekdays()" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">Apply Monday to Weekdays</button>
                        <button onclick="markAllClosed()" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">Mark All Closed</button>
                    </div>
                </div>

                <!-- Individual Day Hours -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üìÖ Weekly Schedule</h4>

                    <!-- Sunday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Sunday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-0-start" value="09:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-0-end" value="17:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-0-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Monday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Monday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-1-start" value="08:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-1-end" value="18:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-1-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Tuesday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Tuesday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-2-start" value="08:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-2-end" value="18:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-2-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Wednesday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Wednesday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-3-start" value="08:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-3-end" value="18:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-3-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Thursday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Thursday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-4-start" value="08:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-4-end" value="18:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-4-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Friday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Friday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-5-start" value="08:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-5-end" value="18:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-5-closed"> Closed
                            </label>
                        </div>
                    </div>

                    <!-- Saturday -->
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr 1fr 100px; gap: 10px; align-items: center;">
                            <strong style="color: #333;">Saturday</strong>
                            <div>
                                <label style="font-size: 12px; color: #666;">Start Time</label>
                                <input type="time" id="hours-6-start" value="09:00" style="width: 100%; padding: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">End Time</label>
                                <input type="time" id="hours-6-end" value="17:00" style="width: 100%; padding: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                <input type="checkbox" id="hours-6-closed"> Closed
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Holidays Section -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">üéÑ Holiday Closures</h4>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="date" id="holiday-date" placeholder="Date" style="flex: 1; padding: 8px;">
                            <input type="text" id="holiday-name" placeholder="Holiday Name (e.g., Christmas)" style="flex: 1; padding: 8px;">
                            <button onclick="addHoliday()" class="btn-primary" style="padding: 8px 15px;">Add Holiday</button>
                        </div>
                        <div id="holidays-list" style="max-height: 150px; overflow-y: auto;">
                            <!-- Holidays will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Other Settings -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="template-editor">
                        <label>Max Appointments Per Day</label>
                        <input type="number" id="max-appointments" value="5" min="1" max="20">
                    </div>
                    <div class="template-editor">
                        <label>Appointment Duration (minutes)</label>
                        <input type="number" id="appointment-duration" value="60" min="15" step="15">
                    </div>
                </div>

                <div class="template-editor">
                    <label>Buffer Time Between Appointments (minutes)</label>
                    <input type="number" id="buffer-time" value="0" min="0" step="15">
                </div>

                <div class="template-editor">
                    <label>Timezone</label>
                    <select id="timezone">
                        <option value="America/New_York" selected>Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeAvailabilityModal()">Cancel</button>
                <button class="btn-modal btn-save" onclick="saveAvailabilitySettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- USER MANAGEMENT MODAL -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <button class="btn-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userId" value="">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="userUsername" required
                                   pattern="[a-zA-Z0-9_]+"
                                   title="Only letters, numbers, and underscores"
                                   placeholder="e.g., jdoe">
                        </div>
                        <div class="form-group">
                            <label id="passwordLabel">Password *</label>
                            <div style="position: relative;">
                                <input type="password" id="userPassword"
                                       minlength="8"
                                       placeholder="Min 8 characters">
                                <div id="passwordStrength" style="height: 3px; background: #e0e0e0; margin-top: 5px; border-radius: 3px;">
                                    <div id="passwordStrengthBar" style="height: 100%; width: 0%; background: #dc3545; border-radius: 3px; transition: all 0.3s;"></div>
                                </div>
                                <small id="passwordStrengthText" style="font-size: 11px; color: #666;"></small>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="userFirstName" required placeholder="e.g., John">
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="userLastName" required placeholder="e.g., Doe">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Email *</label>
                        <input type="email" id="userEmail" required placeholder="e.g., john@worryfreemovers.com">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="userRole" required onchange="updatePermissionsByRole()">
                                <option value="">Select Role</option>
                                <option value="admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="userStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Permissions</label>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permViewBookings" checked>
                                <span>View Bookings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permCreateBookings" checked>
                                <span>Create Bookings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permEditBookings" checked>
                                <span>Edit Bookings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permDeleteBookings">
                                <span>Delete Bookings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permViewCustomers" checked>
                                <span>View Customers</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permManageUsers">
                                <span>Manage Users</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permManageSettings">
                                <span>Manage Settings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="permViewReports" checked>
                                <span>View Reports</span>
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer" style="margin-top: 25px;">
                        <button type="button" class="btn-modal btn-cancel" onclick="closeUserModal()">Cancel</button>
                        <button type="submit" class="btn-modal btn-save">Save User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- EMPLOYEE MODAL -->
    <div id="employeeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="employeeModalTitle">Add New Employee</h2>
                <button class="btn-close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="employeeForm" onsubmit="saveEmployee(event)">
                    <input type="hidden" id="employeeId" value="">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" id="employeeUsername" required
                                   pattern="[a-zA-Z0-9_]+"
                                   title="Only letters, numbers, and underscores"
                                   placeholder="e.g., jdoe">
                        </div>
                        <div class="form-group">
                            <label id="employeePasswordLabel">Password *</label>
                            <input type="password" id="employeePassword"
                                   minlength="8"
                                   placeholder="Min 8 characters">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="employeeFirstName" required placeholder="e.g., John">
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="employeeLastName" required placeholder="e.g., Doe">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Email *</label>
                        <input type="email" id="employeeEmail" required placeholder="e.g., john@worryfreemovers.com">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Phone</label>
                        <input type="tel" id="employeePhone" placeholder="e.g., 330-123-4567">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="employeeRole" required>
                                <option value="">Select Role</option>
                                <option value="crew">Crew Member</option>
                                <option value="driver">Driver</option>
                                <option value="lead">Crew Lead</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Team</label>
                            <input type="text" id="employeeTeam" placeholder="e.g., crew-a">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Hire Date</label>
                            <input type="date" id="employeeHireDate">
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="employeeStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer" style="margin-top: 25px;">
                        <button type="button" class="btn-modal btn-cancel" onclick="closeEmployeeModal()">Cancel</button>
                        <button type="submit" class="btn-modal btn-save">Save Employee</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Packing Materials Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="materialModalTitle">Add New Packing Material</h2>
                <button class="btn-close" onclick="closeMaterialModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="materialForm" onsubmit="saveMaterial(event)">
                    <input type="hidden" id="materialId" value="">
                    <input type="hidden" id="materialOriginalId" value="">

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Material ID *</label>
                        <input type="text" id="materialItemId" required
                               pattern="[a-zA-Z0-9_]+"
                               title="Only letters, numbers, and underscores (e.g., extraLargeBox)"
                               placeholder="e.g., extraLargeBox">
                        <small style="color: #666; font-size: 12px;">Unique identifier (camelCase recommended)</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Display Name *</label>
                        <input type="text" id="materialName" required placeholder="e.g., Extra Large Box (6.0 cu ft)">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Price ($) *</label>
                        <input type="number" id="materialPrice" required min="0" step="0.01" placeholder="e.g., 4.99">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Category *</label>
                        <select id="materialCategory" required>
                            <option value="">Select Category</option>
                            <option value="boxes">Boxes</option>
                            <option value="protection">Protection</option>
                            <option value="supplies">Supplies</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="materialEnabled" checked>
                            <span>Enabled (visible to customers)</span>
                        </label>
                    </div>

                    <div class="modal-footer" style="margin-top: 25px;">
                        <button type="button" class="btn-modal btn-cancel" onclick="closeMaterialModal()">Cancel</button>
                        <button type="submit" class="btn-modal btn-save">Save Material</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW APPOINTMENT MODAL (Like Acuity) -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚ûï Create New Appointment</h2>
                <span class="close" onclick="closeNewAppointmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm" onsubmit="event.preventDefault(); createNewAppointment();">
                    <!-- Service Selection -->
                    <div class="form-group">
                        <label for="appt-service">Service Type <span style="color: red;">*</span></label>
                        <select id="appt-service" required onchange="updateAppointmentPricing()">
                            <option value="">-- Select Service --</option>
                            <!-- Will be populated from /api/services -->
                        </select>
                    </div>

                    <!-- Date & Time -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="appt-date">Date <span style="color: red;">*</span></label>
                            <input type="date" id="appt-date" required onchange="checkAppointmentAvailability()">
                        </div>
                        <div class="form-group">
                            <label for="appt-time">Time <span style="color: red;">*</span></label>
                            <select id="appt-time" required>
                                <option value="">-- Select Date First --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="appt-firstName">First Name <span style="color: red;">*</span></label>
                            <input type="text" id="appt-firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="appt-lastName">Last Name <span style="color: red;">*</span></label>
                            <input type="text" id="appt-lastName" required>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="appt-email">Email <span style="color: red;">*</span></label>
                            <input type="email" id="appt-email" required>
                        </div>
                        <div class="form-group">
                            <label for="appt-phone">Phone <span style="color: red;">*</span></label>
                            <input type="tel" id="appt-phone" required>
                        </div>
                    </div>

                    <!-- Addresses -->
                    <div class="form-group">
                        <label for="appt-pickup">Pickup Address <span style="color: red;">*</span></label>
                        <input type="text" id="appt-pickup" required placeholder="123 Main St, Akron OH 44301">
                    </div>

                    <div class="form-group">
                        <label for="appt-dropoff">Dropoff Address</label>
                        <input type="text" id="appt-dropoff" placeholder="456 Oak Ave, Canton OH 44702">
                    </div>

                    <!-- Pricing Estimate (Auto-calculated) -->
                    <div id="appt-pricing-display" style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 20px 0; display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #004085;">Estimated Pricing</h4>
                        <div id="appt-pricing-details"></div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label for="appt-notes">Notes (Optional)</label>
                        <textarea id="appt-notes" rows="3" placeholder="Any special instructions or details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNewAppointmentModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createNewAppointment()">
                    <span id="createApptBtnText">Create Appointment</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:3001/api';
        let sessionToken = localStorage.getItem('adminToken');
        let allAppointments = [];
        let currentAppointment = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            if (sessionToken) {
                showDashboard();
                loadAppointments();
            }

            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });

        // ==============================================
        // LOGIN FUNCTIONS
        // ==============================================
        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.token;
                    localStorage.setItem('adminToken', sessionToken);
                    localStorage.setItem('adminUsername', data.user.username);

                    showDashboard();
                    loadAppointments();
                } else {
                    showError(data.error || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please check your connection.');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            const username = localStorage.getItem('adminUsername') || 'Admin';
            document.getElementById('username-display').textContent = username;
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            sessionToken = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        // ==============================================
        // DATA FUNCTIONS
        // ==============================================
        async function loadAppointments() {
            try {
                const response = await fetch(`${API_URL}/appointments`);
                const data = await response.json();

                if (data.success) {
                    allAppointments = data.appointments;
                    updateStats();
                    displayAppointments(allAppointments);
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsTableBody').innerHTML =
                    '<tr><td colspan="7" class="empty-state">Failed to load appointments</td></tr>';
            }
        }

        function updateStats() {
            const total = allAppointments.length;
            const confirmed = allAppointments.filter(a => a.status === 'confirmed').length;
            const pending = allAppointments.filter(a => a.status === 'pending').length;

            // Count this month
            const now = new Date();
            const thisMonth = allAppointments.filter(a => {
                const aptDate = new Date(a.date);
                return aptDate.getMonth() === now.getMonth() && aptDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-month').textContent = thisMonth;
        }

        function displayAppointments(appointments) {
            const tbody = document.getElementById('appointmentsTableBody');

            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No appointments found</td></tr>';
                return;
            }

            tbody.innerHTML = appointments.map(apt => {
                const date = new Date(apt.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const statusClass = `status-${apt.status || 'pending'}`;

                return `
                    <tr>
                        <td><strong>${apt.bookingId}</strong></td>
                        <td>${apt.firstName} ${apt.lastName}</td>
                        <td>${apt.serviceType}</td>
                        <td>${formattedDate} at ${apt.time}</td>
                        <td>
                            ${apt.email}<br>
                            <small>${apt.phone}</small>
                        </td>
                        <td><span class="status-badge ${statusClass}">${(apt.status || 'pending').toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewAppointment('${apt.bookingId}')">View</button>
                                <button class="btn-action btn-edit" onclick="editAppointment('${apt.bookingId}')">Edit</button>
                                <button class="btn-action btn-delete" onclick="deleteAppointment('${apt.bookingId}')">Cancel</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterAppointments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;

            const filtered = allAppointments.filter(apt => {
                const matchesSearch = !searchTerm ||
                    apt.bookingId.toLowerCase().includes(searchTerm) ||
                    `${apt.firstName} ${apt.lastName}`.toLowerCase().includes(searchTerm) ||
                    apt.email.toLowerCase().includes(searchTerm) ||
                    apt.phone.includes(searchTerm);

                const matchesStatus = !statusFilter || (apt.status || 'pending') === statusFilter;
                const matchesService = !serviceFilter || apt.serviceType === serviceFilter;

                return matchesSearch && matchesStatus && matchesService;
            });

            displayAppointments(filtered);
        }

        // ==============================================
        // MODAL FUNCTIONS
        // ==============================================
        function viewAppointment(bookingId) {
            const apt = allAppointments.find(a => a.bookingId === bookingId);
            if (!apt) return;

            currentAppointment = apt;
            document.getElementById('modalTitle').textContent = 'Appointment Details';

            const date = new Date(apt.date);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-group">
                    <label>Booking ID</label>
                    <div class="value">${apt.bookingId}</div>
                </div>
                <div class="detail-group">
                    <label>Customer Name</label>
                    <div class="value">${apt.firstName} ${apt.lastName}</div>
                </div>
                <div class="detail-group">
                    <label>Email</label>
                    <div class="value">${apt.email}</div>
                </div>
                <div class="detail-group">
                    <label>Phone</label>
                    <div class="value">${apt.phone}</div>
                </div>
                <div class="detail-group">
                    <label>Service Type</label>
                    <div class="value">${apt.serviceType}</div>
                </div>
                <div class="detail-group">
                    <label>Date & Time</label>
                    <div class="value">${formattedDate} at ${apt.time}</div>
                </div>
                ${apt.pickupAddress ? `
                <div class="detail-group">
                    <label>Pickup Address</label>
                    <div class="value">${apt.pickupAddress}</div>
                </div>
                ` : ''}
                ${apt.dropoffAddress ? `
                <div class="detail-group">
                    <label>Dropoff Address</label>
                    <div class="value">${apt.dropoffAddress}</div>
                </div>
                ` : ''}
                ${apt.notes ? `
                <div class="detail-group">
                    <label>Customer Notes</label>
                    <div class="value">${apt.notes}</div>
                </div>
                ` : ''}
                ${apt.privateNotes ? `
                <div class="detail-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <label style="color: #856404; font-weight: 700;">üîí Private Notes (Admin Only)</label>
                    <div class="value" style="color: #856404;">${apt.privateNotes}</div>
                </div>
                ` : ''}
                ${apt.adminOverride ? `
                <div class="detail-group" style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <label style="color: #0c5460; font-weight: 700;">‚ö†Ô∏è Admin Overrides</label>
                    <div class="value" style="color: #0c5460;">
                        ${apt.adminOverride.customPrice ? `Custom Price: $${apt.adminOverride.customPrice}<br>` : ''}
                        ${apt.adminOverride.overbookAllowed ? `Overbooked: Yes<br>` : ''}
                        ${apt.adminOverride.reason ? `Reason: ${apt.adminOverride.reason}` : ''}
                    </div>
                </div>
                ` : ''}
                <div class="detail-group">
                    <label>Status</label>
                    <div class="value"><span class="status-badge status-${apt.status || 'pending'}">${(apt.status || 'pending').toUpperCase()}</span></div>
                </div>
                <div class="detail-group">
                    <label>Created</label>
                    <div class="value">${new Date(apt.createdAt).toLocaleString()}</div>
                </div>
            `;

            document.getElementById('modalFooter').innerHTML = `
                <button class="btn-modal btn-cancel" onclick="closeModal()">Close</button>
                <button class="btn-modal" onclick="viewCustomerHistory('${apt.email}')" style="background: #28a745;">üìã Customer History</button>
                <button class="btn-modal btn-save" onclick="generateBOL('${apt.bookingId}')">üìÑ Generate BOL</button>
            `;

            document.getElementById('appointmentModal').style.display = 'block';
        }

        function editAppointment(bookingId) {
            const apt = allAppointments.find(a => a.bookingId === bookingId);
            if (!apt) return;

            currentAppointment = apt;
            document.getElementById('modalTitle').textContent = 'Edit Appointment';

            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="edit-firstName" value="${apt.firstName}">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="edit-lastName" value="${apt.lastName}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-email" value="${apt.email}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="edit-phone" value="${apt.phone}">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="edit-date" value="${apt.date}">
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="edit-time" value="${apt.time}">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="edit-status">
                        <option value="confirmed" ${apt.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                        <option value="pending" ${apt.status === 'pending' || !apt.status ? 'selected' : ''}>Pending</option>
                        <option value="cancelled" ${apt.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer Notes (Visible to Customer)</label>
                    <textarea id="edit-notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">${apt.notes || ''}</textarea>
                </div>
                <div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <label style="color: #856404; font-weight: 700;">üîí Private Notes (Admin Only - Not Visible to Customer)</label>
                    <textarea id="edit-privateNotes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 6px; background: #fffbf0;">${apt.privateNotes || ''}</textarea>
                </div>
                <div class="form-group" style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #0c5460;">‚öôÔ∏è Admin Override Options</h4>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer; color: #0c5460;">
                            <input type="checkbox" id="edit-overbookAllowed" ${apt.adminOverride?.overbookAllowed ? 'checked' : ''} style="margin-right: 8px;">
                            Allow Overbooking (bypass availability limits)
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="color: #0c5460;">Custom Price (leave blank for normal pricing)</label>
                        <input type="number" id="edit-customPrice" step="0.01" placeholder="0.00" value="${apt.adminOverride?.customPrice || ''}" style="width: 100%; padding: 10px; border: 2px solid #17a2b8; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <label style="color: #0c5460;">Override Reason</label>
                        <input type="text" id="edit-overrideReason" placeholder="e.g., VIP customer, special discount" value="${apt.adminOverride?.reason || ''}" style="width: 100%; padding: 10px; border: 2px solid #17a2b8; border-radius: 6px;">
                    </div>
                </div>
            `;

            document.getElementById('modalFooter').innerHTML = `
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-modal btn-save" onclick="saveAppointment()">Save Changes</button>
            `;

            document.getElementById('appointmentModal').style.display = 'block';
        }

        async function saveAppointment() {
            if (!currentAppointment) return;

            const overbookAllowed = document.getElementById('edit-overbookAllowed').checked;
            const customPrice = document.getElementById('edit-customPrice').value;
            const overrideReason = document.getElementById('edit-overrideReason').value;

            const updatedData = {
                firstName: document.getElementById('edit-firstName').value,
                lastName: document.getElementById('edit-lastName').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                date: document.getElementById('edit-date').value,
                time: document.getElementById('edit-time').value,
                status: document.getElementById('edit-status').value,
                notes: document.getElementById('edit-notes').value,
                privateNotes: document.getElementById('edit-privateNotes').value
            };

            // Add admin override data if any override is set
            if (overbookAllowed || customPrice || overrideReason) {
                updatedData.adminOverride = {
                    overbookAllowed: overbookAllowed,
                    customPrice: customPrice ? parseFloat(customPrice) : null,
                    reason: overrideReason
                };
            } else {
                updatedData.adminOverride = null;
            }

            try {
                const response = await fetch(`${API_URL}/appointments/${currentAppointment.bookingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Appointment updated successfully!');
                    closeModal();
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update appointment'));
                }
            } catch (error) {
                console.error('Error updating appointment:', error);
                alert('Failed to update appointment');
            }
        }

        async function deleteAppointment(bookingId) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/appointments/${bookingId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Appointment cancelled successfully!');
                    loadAppointments();
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel appointment'));
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('Failed to cancel appointment');
            }
        }

        function closeModal() {
            document.getElementById('appointmentModal').style.display = 'none';
            currentAppointment = null;
        }

        // ==============================================
        // CUSTOMER HISTORY VIEW
        // ==============================================
        function viewCustomerHistory(email) {
            // Close the appointment modal first
            closeModal();

            // Filter all appointments for this customer
            const customerAppointments = allAppointments.filter(apt =>
                apt.email.toLowerCase() === email.toLowerCase()
            );

            if (customerAppointments.length === 0) {
                alert('No appointment history found for this customer');
                return;
            }

            // Sort by date (most recent first)
            const sortedAppointments = customerAppointments.sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            const customer = sortedAppointments[0]; // Get customer info from most recent booking

            document.getElementById('customerModalTitle').textContent =
                `${customer.firstName} ${customer.lastName} - Appointment History`;

            document.getElementById('customerModalBody').innerHTML = `
                <div class="detail-group">
                    <label>Customer Email</label>
                    <div class="value">${customer.email}</div>
                </div>
                <div class="detail-group">
                    <label>Customer Phone</label>
                    <div class="value">${customer.phone}</div>
                </div>
                <div class="detail-group">
                    <label>Total Appointments</label>
                    <div class="value">${customerAppointments.length}</div>
                </div>

                <div class="customer-bookings-list" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                        üìã All Appointments
                    </h3>
                    ${sortedAppointments.map(apt => {
                        const date = new Date(apt.date);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const statusClass = `status-${apt.status || 'pending'}`;

                        return `
                            <div class="booking-item" style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;"
                                 onclick="closeCustomerModal(); viewAppointment('${apt.bookingId}');"
                                 onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.2)';"
                                 onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none';">
                                <div class="booking-item-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong style="font-size: 15px; color: #333;">üìÑ ${apt.bookingId}</strong>
                                    <span class="status-badge ${statusClass}" style="padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: 700;">
                                        ${(apt.status || 'pending').toUpperCase()}
                                    </span>
                                </div>
                                <div class="booking-item-details" style="font-size: 13px; color: #666;">
                                    <div style="margin-bottom: 5px;"><strong>üì¶ Service:</strong> ${apt.serviceType}</div>
                                    <div style="margin-bottom: 5px;"><strong>üìÖ Date:</strong> ${formattedDate} at ${apt.time}</div>
                                    ${apt.pickupAddress ? `<div style="margin-bottom: 5px;"><strong>üìç From:</strong> ${apt.pickupAddress}</div>` : ''}
                                    ${apt.dropoffAddress ? `<div style="margin-bottom: 5px;"><strong>üéØ To:</strong> ${apt.dropoffAddress}</div>` : ''}
                                    ${apt.notes ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; font-style: italic; color: #999;">
                                        "${apt.notes.substring(0, 100)}${apt.notes.length > 100 ? '...' : ''}"
                                    </div>` : ''}
                                </div>
                                <div style="text-align: right; margin-top: 10px; color: #667eea; font-size: 12px; font-weight: 600;">
                                    Click to view full details ‚Üí
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f0f4f8; border-radius: 8px; text-align: center; color: #666;">
                    üí° Click any appointment to view full details
                </div>
            `;

            document.getElementById('customerModal').style.display = 'block';
        }

        // ==============================================
        // BOL GENERATION
        // ==============================================
        function generateBOL(bookingId) {
            const apt = allAppointments.find(a => a.bookingId === bookingId);
            if (!apt) {
                alert('Appointment not found');
                return;
            }

            // Parse service details from notes
            const notes = apt.notes || '';
            const specialItems = [];
            const packingMaterials = [];
            let stairInfo = '';

            // Extract special items
            if (notes.includes('Special Items:')) {
                const itemsMatch = notes.match(/Special Items: ([^\n]+)/);
                if (itemsMatch) {
                    specialItems.push(...itemsMatch[1].split(', '));
                }
            }

            // Extract detailed stairs/elevator info
            const accessInfo = {
                pickup: {},
                dropoff: {}
            };

            // Extract pickup location details
            if (notes.includes('Pickup Stairs:') || notes.includes('Pickup Floor:') || notes.includes('Pickup Elevator:')) {
                const pickupStairsMatch = notes.match(/Pickup Stairs:\s*([^\n]+)/);
                const pickupFloorMatch = notes.match(/Pickup Floor:\s*([^\n]+)/);
                const pickupElevatorMatch = notes.match(/Pickup Elevator:\s*([^\n]+)/);
                const pickupLongCarryMatch = notes.match(/Pickup Long Carry:\s*([^\n]+)/);

                if (pickupStairsMatch) accessInfo.pickup.stairs = pickupStairsMatch[1];
                if (pickupFloorMatch) accessInfo.pickup.floor = pickupFloorMatch[1];
                if (pickupElevatorMatch) accessInfo.pickup.elevator = pickupElevatorMatch[1];
                if (pickupLongCarryMatch) accessInfo.pickup.longCarry = pickupLongCarryMatch[1];
            }

            // Extract dropoff location details
            if (notes.includes('Dropoff Stairs:') || notes.includes('Dropoff Floor:') || notes.includes('Dropoff Elevator:')) {
                const dropoffStairsMatch = notes.match(/Dropoff Stairs:\s*([^\n]+)/);
                const dropoffFloorMatch = notes.match(/Dropoff Floor:\s*([^\n]+)/);
                const dropoffElevatorMatch = notes.match(/Dropoff Elevator:\s*([^\n]+)/);
                const dropoffLongCarryMatch = notes.match(/Dropoff Long Carry:\s*([^\n]+)/);

                if (dropoffStairsMatch) accessInfo.dropoff.stairs = dropoffStairsMatch[1];
                if (dropoffFloorMatch) accessInfo.dropoff.floor = dropoffFloorMatch[1];
                if (dropoffElevatorMatch) accessInfo.dropoff.elevator = dropoffElevatorMatch[1];
                if (dropoffLongCarryMatch) accessInfo.dropoff.longCarry = dropoffLongCarryMatch[1];
            }

            // Backward compatibility: check for old "Stairs:" format
            if (notes.includes('Stairs:') && !notes.includes('Pickup Stairs:') && !notes.includes('Dropoff Stairs:')) {
                const stairsMatch = notes.match(/Stairs:\s*([^\n]+)/);
                if (stairsMatch) {
                    stairInfo = stairsMatch[1];
                }
            }

            const hasAccessInfo = Object.keys(accessInfo.pickup).length > 0 || Object.keys(accessInfo.dropoff).length > 0;

            // Extract packing materials
            if (notes.includes('Packing Materials:')) {
                const materialsSection = notes.split('Packing Materials:')[1];
                if (materialsSection) {
                    const materialLines = materialsSection.split('\n').filter(line =>
                        line.trim() && !line.includes('Materials Total:')
                    );
                    packingMaterials.push(...materialLines.map(line => line.trim()));
                }
            }

            const date = new Date(apt.date);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric', weekday: 'long' });

            // Create printable BOL window
            const bolWindow = window.open('', '_blank', 'width=800,height=1000');
            bolWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>Bill of Lading - ${apt.bookingId}</title>
    <style>
        @media print {
            @page {
                margin: 0.5in;
                size: letter;
            }
            body { margin: 0; }
            .no-print { display: none; }
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            border-bottom: 3px solid #004085;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .company-name {
            font-size: 28px;
            font-weight: 700;
            color: #004085;
            margin-bottom: 5px;
        }

        .doc-title {
            font-size: 20px;
            font-weight: 600;
            color: #666;
            margin: 10px 0;
        }

        .booking-id {
            font-size: 16px;
            color: #999;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #004085;
            background: #f0f4f8;
            padding: 10px 15px;
            border-left: 4px solid #004085;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .info-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .service-details {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .item-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .item-list li {
            padding: 8px 12px;
            background: white;
            border-left: 3px solid #004085;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .signature-section {
            margin-top: 40px;
            page-break-inside: avoid;
        }

        .signature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .signature-box {
            border-top: 2px solid #333;
            padding-top: 10px;
        }

        .signature-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .signature-date {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #666;
        }

        .disclaimer {
            background: #fff9e6;
            border: 1px solid #ffd700;
            padding: 15px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 20px;
            color: #666;
            line-height: 1.6;
        }

        .print-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #004085;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .print-btn:hover {
            background: #003366;
        }
    </style>
</head>
<body>
    <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print BOL</button>

    <div class="header">
        <div class="company-name">WORRY FREE MOVING LLC</div>
        <div style="font-size: 12px; color: #666; margin: 5px 0;">
            üìû (330) 435-8686 ‚Ä¢ ‚úâÔ∏è service@worryfreemovers.com<br>
            Akron, Ohio ‚Ä¢ Licensed & Insured
        </div>
        <div class="doc-title">BILL OF LADING</div>
        <div class="booking-id">BOL #${apt.bookingId}</div>
    </div>

    <div class="section">
        <div class="section-title">üìÖ SERVICE INFORMATION</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Service Date</div>
                <div class="info-value">${formattedDate}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Arrival Window</div>
                <div class="info-value">${apt.time || 'TBD'}</div>
            </div>
            <div class="info-item full-width">
                <div class="info-label">Service Type</div>
                <div class="info-value">${apt.serviceType || 'Standard Moving Service'}</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">üë§ CUSTOMER INFORMATION</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Customer Name</div>
                <div class="info-value">${apt.firstName} ${apt.lastName}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Phone</div>
                <div class="info-value">${apt.phone}</div>
            </div>
            <div class="info-item full-width">
                <div class="info-label">Email</div>
                <div class="info-value">${apt.email}</div>
            </div>
        </div>
    </div>

    ${apt.pickupAddress ? `
    <div class="section">
        <div class="section-title">üìç LOCATIONS</div>
        <div class="info-grid">
            <div class="info-item full-width">
                <div class="info-label">Pickup Address</div>
                <div class="info-value">${apt.pickupAddress}</div>
            </div>
            <div class="info-item full-width">
                <div class="info-label">Delivery Address</div>
                <div class="info-value">${apt.dropoffAddress}</div>
            </div>
        </div>
    </div>
    ` : ''}

    ${specialItems.length > 0 || stairInfo || hasAccessInfo || packingMaterials.length > 0 ? `
    <div class="section">
        <div class="section-title">üì¶ SERVICE DETAILS & FEES</div>
        <div class="service-details">
            ${specialItems.length > 0 ? `
                <div style="margin-bottom: 15px;">
                    <div class="info-label">Special Items</div>
                    <ul class="item-list">
                        ${specialItems.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            ${hasAccessInfo ? `
                <div style="margin-bottom: 15px;">
                    <div class="info-label">üè¢ Building Access & Stairs</div>
                    <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; margin-top: 8px;">
                        ${Object.keys(accessInfo.pickup).length > 0 ? `
                            <div style="margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #28a745; margin-bottom: 6px; font-size: 13px;">üìç Pickup Location</div>
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 13px;">
                                    ${accessInfo.pickup.floor ? `
                                        <span style="color: #666;">Floor:</span>
                                        <span style="font-weight: 500;">${accessInfo.pickup.floor}</span>
                                    ` : ''}
                                    ${accessInfo.pickup.stairs ? `
                                        <span style="color: #666;">Stairs:</span>
                                        <span style="font-weight: 500;">${accessInfo.pickup.stairs}</span>
                                    ` : ''}
                                    ${accessInfo.pickup.elevator ? `
                                        <span style="color: #666;">Elevator:</span>
                                        <span style="font-weight: 500;">${accessInfo.pickup.elevator}</span>
                                    ` : ''}
                                    ${accessInfo.pickup.longCarry ? `
                                        <span style="color: #666;">Long Carry:</span>
                                        <span style="font-weight: 500;">${accessInfo.pickup.longCarry}</span>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${Object.keys(accessInfo.dropoff).length > 0 ? `
                            <div>
                                <div style="font-weight: 600; color: #007bff; margin-bottom: 6px; font-size: 13px;">üìç Dropoff Location</div>
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 13px;">
                                    ${accessInfo.dropoff.floor ? `
                                        <span style="color: #666;">Floor:</span>
                                        <span style="font-weight: 500;">${accessInfo.dropoff.floor}</span>
                                    ` : ''}
                                    ${accessInfo.dropoff.stairs ? `
                                        <span style="color: #666;">Stairs:</span>
                                        <span style="font-weight: 500;">${accessInfo.dropoff.stairs}</span>
                                    ` : ''}
                                    ${accessInfo.dropoff.elevator ? `
                                        <span style="color: #666;">Elevator:</span>
                                        <span style="font-weight: 500;">${accessInfo.dropoff.elevator}</span>
                                    ` : ''}
                                    ${accessInfo.dropoff.longCarry ? `
                                        <span style="color: #666;">Long Carry:</span>
                                        <span style="font-weight: 500;">${accessInfo.dropoff.longCarry}</span>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : stairInfo ? `
                <div style="margin-bottom: 15px;">
                    <div class="info-label">Stairs/Floors (Legacy)</div>
                    <div class="info-value">${stairInfo}</div>
                </div>
            ` : ''}

            ${packingMaterials.length > 0 ? `
                <div>
                    <div class="info-label">Packing Materials</div>
                    <ul class="item-list">
                        ${packingMaterials.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
    </div>
    ` : ''}

    ${apt.notes ? `
    <div class="section">
        <div class="section-title">üìù ADDITIONAL NOTES</div>
        <div class="info-item">
            <pre style="white-space: pre-wrap; font-family: Arial; margin: 0;">${apt.notes}</pre>
        </div>
    </div>
    ` : ''}

    <div class="section signature-section">
        <div class="section-title">‚úçÔ∏è SIGNATURES</div>
        <div class="signature-grid">
            <div>
                <div class="signature-box">
                    <div class="signature-label">Customer Signature</div>
                    <div class="signature-date">Date: _____________</div>
                </div>
            </div>
            <div>
                <div class="signature-box">
                    <div class="signature-label">Crew Leader Signature</div>
                    <div class="signature-date">Date: _____________</div>
                </div>
            </div>
        </div>
    </div>

    <div class="disclaimer">
        <strong>IMPORTANT CUSTOMER ACKNOWLEDGEMENT:</strong><br><br>
        By signing this Bill of Lading, customer acknowledges:<br>
        ‚Ä¢ Customer has inspected all items and confirmed their condition before the move<br>
        ‚Ä¢ Customer understands that hourly rates apply and time begins upon crew arrival<br>
        ‚Ä¢ Customer agrees to be present or designate a representative at both pickup and delivery locations<br>
        ‚Ä¢ Customer understands additional charges may apply for stairs, long carries, or additional services<br>
        ‚Ä¢ Customer has read and agrees to Worry Free Moving's Terms & Conditions<br>
        ‚Ä¢ Any damages must be reported within 24 hours of move completion<br><br>
        <strong>Cancellation Policy:</strong> 48-hour notice required for full refund. Late cancellations subject to fee.
    </div>

    <div class="footer">
        <div style="font-weight: 600; margin-bottom: 5px;">WORRY FREE MOVING LLC</div>
        <div>Licensed & Insured ‚Ä¢ USDOT# [License Number] ‚Ä¢ MC# [MC Number]</div>
        <div style="margin-top: 10px;">Thank you for choosing Worry Free Moving!</div>
        <div style="margin-top: 5px; font-size: 10px;">Document generated on ${new Date().toLocaleString()}</div>
    </div>
</body>
</html>
            `);
            bolWindow.document.close();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('appointmentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ==============================================
        // TAB SWITCHING
        // ==============================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');

            // Load data based on tab
            if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'services') {
                loadServices();
            } else if (tabName === 'pricing') {
                loadPricing();
            } else if (tabName === 'settings') {
                loadSettings();
            } else if (tabName === 'calendar') {
                loadCalendar();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'employees') {
                loadEmployees();
            }
        }

        // ==============================================
        // CUSTOMER CATALOG FUNCTIONS
        // ==============================================
        let allCustomers = [];

        async function loadCustomers() {
            // Load customer notes first
            let customerNotes = {};
            try {
                const response = await fetch(`${API_URL}/customer-notes`);
                const data = await response.json();
                if (data.success) {
                    customerNotes = data.notes;
                }
            } catch (error) {
                console.error('Error loading customer notes:', error);
            }

            // Aggregate customers from appointments
            const customerMap = new Map();

            allAppointments.forEach(apt => {
                const key = apt.email.toLowerCase();

                if (!customerMap.has(key)) {
                    customerMap.set(key, {
                        firstName: apt.firstName,
                        lastName: apt.lastName,
                        email: apt.email,
                        phone: apt.phone,
                        bookings: [],
                        totalBookings: 0,
                        firstBooking: apt.date,
                        lastBooking: apt.date,
                        privateNotes: customerNotes[key]?.privateNotes || ''
                    });
                }

                const customer = customerMap.get(key);
                customer.bookings.push(apt);
                customer.totalBookings++;

                // Update first/last booking dates
                if (new Date(apt.date) < new Date(customer.firstBooking)) {
                    customer.firstBooking = apt.date;
                }
                if (new Date(apt.date) > new Date(customer.lastBooking)) {
                    customer.lastBooking = apt.date;
                }
            });

            allCustomers = Array.from(customerMap.values());
            updateCustomerStats();
            displayCustomers(allCustomers);
        }

        function updateCustomerStats() {
            const totalCustomers = allCustomers.length;
            const repeatCustomers = allCustomers.filter(c => c.totalBookings > 1).length;

            // Active this month
            const now = new Date();
            const activeThisMonth = allCustomers.filter(c => {
                return c.bookings.some(apt => {
                    const aptDate = new Date(apt.date);
                    return aptDate.getMonth() === now.getMonth() && aptDate.getFullYear() === now.getFullYear();
                });
            }).length;

            // New this month
            const newThisMonth = allCustomers.filter(c => {
                const firstDate = new Date(c.firstBooking);
                return firstDate.getMonth() === now.getMonth() && firstDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('stat-customers').textContent = totalCustomers;
            document.getElementById('stat-active-customers').textContent = activeThisMonth;
            document.getElementById('stat-repeat-customers').textContent = repeatCustomers;
            document.getElementById('stat-new-customers').textContent = newThisMonth;
        }

        function displayCustomers(customers) {
            const grid = document.getElementById('customerGrid');

            if (customers.length === 0) {
                grid.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }

            grid.innerHTML = customers.map(customer => {
                const initials = (customer.firstName[0] + customer.lastName[0]).toUpperCase();
                const lastBooking = new Date(customer.lastBooking).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                    <div class="customer-card" onclick="viewCustomer('${customer.email}')">
                        <div class="customer-header">
                            <div class="customer-avatar">${initials}</div>
                            <div class="customer-info">
                                <h3>${customer.firstName} ${customer.lastName}</h3>
                                <p>${customer.email}</p>
                                <p>${customer.phone}</p>
                            </div>
                        </div>
                        <div class="customer-stats">
                            <div class="customer-stat">
                                <label>Total Bookings</label>
                                <div class="value">${customer.totalBookings}</div>
                            </div>
                            <div class="customer-stat">
                                <label>Last Booking</label>
                                <div class="value">${lastBooking}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearchInput').value.toLowerCase();

            // Normalize phone for searching (remove all non-digits)
            const normalizePhone = (phone) => phone.replace(/\D/g, '');
            const normalizedSearchTerm = normalizePhone(searchTerm);

            const filtered = allCustomers.filter(customer => {
                const nameMatch = `${customer.firstName} ${customer.lastName}`.toLowerCase().includes(searchTerm);
                const emailMatch = customer.email.toLowerCase().includes(searchTerm);
                const phoneMatch = normalizedSearchTerm && normalizePhone(customer.phone).includes(normalizedSearchTerm);

                return nameMatch || emailMatch || phoneMatch;
            });

            displayCustomers(filtered);
        }

        function viewCustomer(email) {
            const customer = allCustomers.find(c => c.email.toLowerCase() === email.toLowerCase());
            if (!customer) return;

            document.getElementById('customerModalTitle').textContent = `${customer.firstName} ${customer.lastName}`;

            const sortedBookings = [...customer.bookings].sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('customerModalBody').innerHTML = `
                <div class="detail-group">
                    <label>Email</label>
                    <div class="value">${customer.email}</div>
                </div>
                <div class="detail-group">
                    <label>Phone</label>
                    <div class="value">${customer.phone}</div>
                </div>
                <div class="detail-group">
                    <label>Total Bookings</label>
                    <div class="value">${customer.totalBookings}</div>
                </div>
                <div class="detail-group">
                    <label>First Booking</label>
                    <div class="value">${new Date(customer.firstBooking).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                </div>
                <div class="detail-group">
                    <label>Last Booking</label>
                    <div class="value">${new Date(customer.lastBooking).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                </div>

                <div class="detail-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                    <label style="color: #856404; font-weight: 700; display: flex; justify-content: space-between; align-items: center;">
                        <span>üîí Private Customer Notes (Admin Only)</span>
                        <button onclick="event.stopPropagation(); editCustomerNotes('${customer.email}')" style="padding: 5px 12px; background: #ffc107; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Edit Notes</button>
                    </label>
                    <div class="value" id="customer-notes-${customer.email.replace(/[^a-zA-Z0-9]/g, '')}" style="color: #856404; margin-top: 10px; white-space: pre-wrap;">
                        ${customer.privateNotes || 'No private notes yet. Click Edit Notes to add.'}
                    </div>
                </div>

                <div class="customer-bookings-list">
                    <h3 style="margin-bottom: 15px; color: #333;">Booking History</h3>
                    ${sortedBookings.map(booking => {
                        const date = new Date(booking.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                        const statusClass = `status-${booking.status || 'pending'}`;

                        return `
                            <div class="booking-item">
                                <div class="booking-item-header">
                                    <strong>${booking.bookingId}</strong>
                                    <span class="status-badge ${statusClass}">${(booking.status || 'pending').toUpperCase()}</span>
                                </div>
                                <div class="booking-item-details">
                                    <div><strong>Service:</strong> ${booking.serviceType}</div>
                                    <div><strong>Date:</strong> ${date} at ${booking.time}</div>
                                    ${booking.pickupAddress ? `<div><strong>From:</strong> ${booking.pickupAddress}</div>` : ''}
                                    ${booking.dropoffAddress ? `<div><strong>To:</strong> ${booking.dropoffAddress}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('customerModal').style.display = 'block';
        }

        function editCustomerNotes(email) {
            const customer = allCustomers.find(c => c.email.toLowerCase() === email.toLowerCase());
            if (!customer) return;

            const notes = prompt('Enter private notes for ' + customer.firstName + ' ' + customer.lastName + ':\n\n(These notes are only visible to admin)', customer.privateNotes || '');

            if (notes !== null) { // null means user cancelled
                saveCustomerNotes(email, notes);
            }
        }

        async function saveCustomerNotes(email, notes) {
            try {
                const response = await fetch(`${API_URL}/customer-notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, privateNotes: notes })
                });

                const data = await response.json();

                if (data.success) {
                    // Update the local customer object
                    const customer = allCustomers.find(c => c.email.toLowerCase() === email.toLowerCase());
                    if (customer) {
                        customer.privateNotes = notes;
                    }

                    // Update the display
                    const safeEmail = email.replace(/[^a-zA-Z0-9]/g, '');
                    const notesElement = document.getElementById('customer-notes-' + safeEmail);
                    if (notesElement) {
                        notesElement.textContent = notes || 'No private notes yet. Click Edit Notes to add.';
                    }

                    alert('Customer notes saved successfully!');
                } else {
                    alert('Failed to save customer notes: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving customer notes:', error);
                alert('Failed to save customer notes');
            }
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        // Close customer modal when clicking outside
        window.addEventListener('click', function(event) {
            const customerModal = document.getElementById('customerModal');
            if (event.target === customerModal) {
                closeCustomerModal();
            }
        });

        // ==============================================
        // SERVICES MANAGEMENT FUNCTIONS
        // ==============================================
        let servicesConfig = null;

        async function testServicesAPI() {
            const debugDiv = document.getElementById('servicesDebugInfo');
            const debugOutput = document.getElementById('debugOutput');

            debugDiv.style.display = 'block';
            debugOutput.textContent = 'Testing API...\n\n';

            try {
                // Add timestamp to force fresh request
                const timestamp = new Date().getTime();
                const apiUrl = `${API_URL}/services?_t=${timestamp}`;
                debugOutput.textContent += `1. Testing fetch to: ${apiUrl}\n`;

                const response = await fetch(apiUrl, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                debugOutput.textContent += `2. Response status: ${response.status}\n`;
                debugOutput.textContent += `3. Response OK: ${response.ok}\n`;

                const data = await response.json();
                debugOutput.textContent += `4. Data received:\n`;
                debugOutput.textContent += JSON.stringify(data, null, 2);

                if (data.success && data.services) {
                    debugOutput.textContent += `\n\n‚úÖ API is working correctly!`;
                    debugOutput.textContent += `\n\nMoving Services found: ${Object.keys(data.services.movingServices || {}).length}`;
                    debugOutput.textContent += `\nOther Services: laborOnly=${!!data.services.laborOnly}, singleItem=${!!data.services.singleItem}`;
                } else {
                    debugOutput.textContent += `\n\n‚ùå API returned data but format is invalid`;
                }
            } catch (error) {
                debugOutput.textContent += `\n\n‚ùå ERROR: ${error.message}`;
                debugOutput.textContent += `\n\nStack: ${error.stack}`;
            }
        }

        async function loadServices() {
            const loadingIndicator = document.getElementById('servicesLoadingIndicator');
            const movingContainer = document.getElementById('movingServicesContainer');
            const otherContainer = document.getElementById('otherServicesContainer');

            try {
                // Show loading indicator
                if (loadingIndicator) loadingIndicator.style.display = 'block';

                // Clear containers
                if (movingContainer) movingContainer.innerHTML = '<p style="color: #999;">Loading...</p>';
                if (otherContainer) otherContainer.innerHTML = '<p style="color: #999;">Loading...</p>';

                console.log('=== LOADING SERVICES ===');

                // Add timestamp to URL to force fresh request (aggressive cache-busting)
                const timestamp = new Date().getTime();
                const apiUrl = `${API_URL}/services?_t=${timestamp}`;
                console.log('API URL:', apiUrl);

                const response = await fetch(apiUrl, {
                    cache: 'no-cache',  // Force fresh data
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Data received:', data);

                if (data.success && data.services) {
                    servicesConfig = data.services;
                    console.log('Services config loaded successfully');
                    displayServices();
                    console.log('=== SERVICES DISPLAYED SUCCESSFULLY ===');

                    // Hide loading indicator
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                } else {
                    throw new Error('Invalid services data format');
                }
            } catch (error) {
                console.error('=== ERROR LOADING SERVICES ===', error);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (movingContainer) {
                    movingContainer.innerHTML = `
                        <div style="background: #fee; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <h4 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è Failed to Load Services</h4>
                            <p style="margin-bottom: 10px;"><strong>Error:</strong> ${error.message}</p>
                            <p style="margin-bottom: 10px;">Please check:</p>
                            <ul style="margin: 10px 0;">
                                <li>Server is running on port 3001</li>
                                <li>data/services.json file exists</li>
                                <li>Browser console for detailed errors (F12)</li>
                            </ul>
                            <button onclick="loadServices()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
                alert('Failed to load services: ' + error.message);
            }
        }

        function displayServices() {
            displayMovingServices();
            displayOtherServices();
            displayPackingMaterials();
            displayFees();
        }

        function displayMovingServices() {
            console.log('displayMovingServices called');
            const container = document.getElementById('movingServicesContainer');
            if (!container) {
                console.error('movingServicesContainer not found');
                return;
            }
            console.log('Container found:', container);

            if (!servicesConfig) {
                console.error('servicesConfig is null or undefined');
                container.innerHTML = '<p style="color: red;">Services configuration not loaded. Please try reloading the page.</p>';
                return;
            }

            if (!servicesConfig.movingServices) {
                console.error('servicesConfig.movingServices not available. servicesConfig:', servicesConfig);
                container.innerHTML = '<p style="color: red;">Moving services data not found. Please check the services.json file.</p>';
                return;
            }

            const movingServices = servicesConfig.movingServices;
            console.log('Moving services:', movingServices);

            let html = '';
            for (const [key, service] of Object.entries(movingServices)) {
                html += `
                    <div class="service-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid ${service.enabled ? '#667eea' : '#ddd'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #333;">${service.icon} ${service.name}</h4>
                                <p style="margin: 0; color: #666; font-size: 13px;">${service.crew} crew members</p>
                            </div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${service.enabled ? 'checked' : ''}
                                    onchange="servicesConfig.movingServices['${key}'].enabled = this.checked"
                                    style="margin-right: 5px;">
                                <span style="font-size: 13px;">Enabled</span>
                            </label>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">${service.description}</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Base Hourly Rate</label>
                                <input type="number" step="0.01" value="${service.baseRate}"
                                    onchange="servicesConfig.movingServices['${key}'].baseRate = parseFloat(this.value)"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Distance Adjustment (per mile)</label>
                                <input type="number" step="0.01" value="${service.distanceAdjustment}"
                                    onchange="servicesConfig.movingServices['${key}'].distanceAdjustment = parseFloat(this.value)"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Service Charge (%)</label>
                                <input type="number" step="0.01" value="${service.serviceCharge * 100}"
                                    onchange="servicesConfig.movingServices['${key}'].serviceCharge = parseFloat(this.value) / 100"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            ${service.features.map(f => `‚Ä¢ ${f}`).join('<br>')}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function displayOtherServices() {
            const container = document.getElementById('otherServicesContainer');
            const services = [
                { key: 'laborOnly', service: servicesConfig.laborOnly },
                { key: 'singleItem', service: servicesConfig.singleItem },
                { key: 'junkRemoval', service: servicesConfig.junkRemoval },
                { key: 'cleanout', service: servicesConfig.cleanout }
            ];

            let html = '';
            for (const { key, service } of services) {
                html += `
                    <div class="service-card" style="background: white; border-radius: 12px; padding: 20px; border: 2px solid ${service.enabled ? '#667eea' : '#ddd'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #333;">${service.icon} ${service.name}</h4>
                            </div>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${service.enabled ? 'checked' : ''}
                                    onchange="servicesConfig.${key}.enabled = this.checked"
                                    style="margin-right: 5px;">
                                <span style="font-size: 13px;">Enabled</span>
                            </label>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">${service.description}</p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            ${generateServiceFields(key, service)}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function generateServiceFields(key, service) {
            let fields = '';

            if (service.baseRate !== undefined) {
                fields += `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Base Rate</label>
                        <input type="number" step="0.01" value="${service.baseRate}"
                            onchange="servicesConfig.${key}.baseRate = parseFloat(this.value)"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                `;
            }

            if (service.baseHourlyRate !== undefined) {
                fields += `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Base Hourly Rate</label>
                        <input type="number" step="0.01" value="${service.baseHourlyRate}"
                            onchange="servicesConfig.${key}.baseHourlyRate = parseFloat(this.value)"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                `;
            }

            if (service.distanceRate !== undefined) {
                fields += `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Distance Rate</label>
                        <input type="number" step="0.01" value="${service.distanceRate}"
                            onchange="servicesConfig.${key}.distanceRate = parseFloat(this.value)"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                `;
            }

            if (service.serviceCharge !== undefined) {
                fields += `
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Service Charge (%)</label>
                        <input type="number" step="0.01" value="${service.serviceCharge * 100}"
                            onchange="servicesConfig.${key}.serviceCharge = parseFloat(this.value) / 100"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                `;
            }

            return fields;
        }

        function displayPackingMaterials() {
            const container = document.getElementById('packingMaterialsContainer');
            if (!container) {
                console.error('packingMaterialsContainer not found');
                return;
            }

            if (!servicesConfig || !servicesConfig.packingMaterials) {
                console.error('Packing materials not available in servicesConfig');
                container.innerHTML = '<p style="color: #999;">No packing materials found.</p>';
                return;
            }

            const materials = servicesConfig.packingMaterials;

            // Group materials by category
            const categories = {
                boxes: [],
                protection: [],
                supplies: []
            };

            for (const [key, material] of Object.entries(materials)) {
                const category = material.category || 'supplies';
                if (!categories[category]) categories[category] = [];
                categories[category].push({ key, ...material });
            }

            let html = '';

            // Display materials organized by category
            for (const [categoryName, items] of Object.entries(categories)) {
                if (items.length === 0) continue;

                const categoryEmoji = {
                    boxes: 'üì¶',
                    protection: 'üõ°Ô∏è',
                    supplies: 'üîß'
                };

                html += `
                    <div style="grid-column: 1 / -1; margin-top: ${Object.keys(categories).indexOf(categoryName) > 0 ? '20px' : '0'};">
                        <h4 style="color: #667eea; margin: 10px 0; text-transform: capitalize;">
                            ${categoryEmoji[categoryName]} ${categoryName}
                        </h4>
                    </div>
                `;

                for (const material of items) {
                    const statusColor = material.enabled ? '#28a745' : '#dc3545';
                    const statusText = material.enabled ? 'Active' : 'Inactive';

                    html += `
                        <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid ${material.enabled ? '#e0e0e0' : '#ffebee'}; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: #333; font-size: 15px;">${material.name}</h4>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                                            ${statusText}
                                        </span>
                                        <span style="color: #667eea; font-size: 16px; font-weight: 600;">
                                            $${material.price.toFixed(2)}
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editMaterial('${material.key}')"
                                            style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button onclick="deleteMaterial('${material.key}')"
                                            style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ID: <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${material.key}</code>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html || '<p style="color: #999;">No packing materials found.</p>';
        }

        function displayFees() {
            const container = document.getElementById('feesContainer');
            const fees = servicesConfig.fees;

            let html = '';
            for (const [key, fee] of Object.entries(fees)) {
                const isPercentage = fee.percentage !== undefined;
                const hasApartmentHouse = fee.apartment !== undefined && fee.house !== undefined;

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid ${fee.enabled ? '#667eea' : '#ddd'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #333;">${fee.name}</h4>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" ${fee.enabled ? 'checked' : ''}
                                    onchange="servicesConfig.fees['${key}'].enabled = this.checked"
                                    style="margin-right: 5px;">
                                <span style="font-size: 13px;">Enabled</span>
                            </label>
                        </div>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">${fee.description || ''}</p>
                        ${hasApartmentHouse ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Apartment Rate ($)</label>
                                    <input type="number" step="0.01" value="${fee.apartment}"
                                        onchange="servicesConfig.fees['${key}'].apartment = parseFloat(this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">House Rate ($)</label>
                                    <input type="number" step="0.01" value="${fee.house}"
                                        onchange="servicesConfig.fees['${key}'].house = parseFloat(this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            ${fee.apartmentTime !== undefined && fee.houseTime !== undefined ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">Apartment Time (hours)</label>
                                    <input type="number" step="0.01" value="${fee.apartmentTime}"
                                        onchange="servicesConfig.fees['${key}'].apartmentTime = parseFloat(this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">House Time (hours)</label>
                                    <input type="number" step="0.01" value="${fee.houseTime}"
                                        onchange="servicesConfig.fees['${key}'].houseTime = parseFloat(this.value)"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                            </div>
                            ` : ''}
                        ` : `
                            <div>
                                <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">
                                    ${isPercentage ? 'Percentage (%)' : 'Amount ($)'}
                                </label>
                                <input type="number" step="0.01"
                                    value="${isPercentage ? fee.percentage * 100 : fee.amount}"
                                    onchange="servicesConfig.fees['${key}'].${isPercentage ? 'percentage' : 'amount'} = ${isPercentage ? 'parseFloat(this.value) / 100' : 'parseFloat(this.value)'}"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        `}
                        ${fee.unit ? `<p style="font-size: 12px; color: #999; margin-top: 8px;">Unit: ${fee.unit}</p>` : ''}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        async function saveServices() {
            try {
                const response = await fetch(`${API_URL}/services`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(servicesConfig)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Services configuration saved successfully!');
                } else {
                    alert('Failed to save services: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving services:', error);
                alert('Failed to save services configuration');
            }
        }

        // ==============================================
        // SETTINGS FUNCTIONS
        // ==============================================
        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}/communication-settings`);
                const data = await response.json();

                if (data.success && data.settings) {
                    const settings = data.settings;

                    // Confirmation Email
                    document.getElementById('confirm-email-subject').value = settings.confirmEmail?.subject || "Your Worry Free Moving Appointment is Confirmed! üöö";
                    document.getElementById('confirm-email-body').value = settings.confirmEmail?.body || getDefaultConfirmEmail();

                    // Confirmation SMS
                    document.getElementById('confirm-sms-body').value = settings.confirmSMS?.body || getDefaultConfirmSMS();

                    // 24-Hour Reminder Email
                    document.getElementById('reminder-24h-timing').value = settings.reminder24h?.timing || "24";
                    document.getElementById('reminder-24h-email-subject').value = settings.reminder24h?.emailSubject || "Reminder: Your Move is Tomorrow! üöö";
                    document.getElementById('reminder-24h-email-body').value = settings.reminder24h?.emailBody || getDefault24hEmail();
                    document.getElementById('reminder-24h-sms-body').value = settings.reminder24h?.smsBody || getDefault24hSMS();

                    // 2-Hour Reminder SMS
                    document.getElementById('reminder-2h-timing').value = settings.reminder2h?.timing || "2";
                    document.getElementById('reminder-2h-sms-body').value = settings.reminder2h?.smsBody || getDefault2hSMS();

                    // Calendar Integration
                    if (settings.calendarSync) {
                        document.getElementById('calendar-sync-enabled').value = settings.calendarSync.enabled || "disabled";
                        document.getElementById('calendar-provider').value = settings.calendarSync.provider || "google";
                        document.getElementById('calendar-id').value = settings.calendarSync.calendarId || "";
                        document.getElementById('calendar-api-key').value = settings.calendarSync.apiKey || "";
                        document.getElementById('calendar-sync-direction').value = settings.calendarSync.syncDirection || "one-way";
                    }
                }

                updateCharacterCounts();
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use defaults if loading fails
                updateCharacterCounts();
            }
        }

        async function saveSettings() {
            const settings = {
                confirmEmail: {
                    subject: document.getElementById('confirm-email-subject').value,
                    body: document.getElementById('confirm-email-body').value
                },
                confirmSMS: {
                    body: document.getElementById('confirm-sms-body').value
                },
                reminder24h: {
                    timing: document.getElementById('reminder-24h-timing').value,
                    emailSubject: document.getElementById('reminder-24h-email-subject').value,
                    emailBody: document.getElementById('reminder-24h-email-body').value,
                    smsBody: document.getElementById('reminder-24h-sms-body').value
                },
                reminder2h: {
                    timing: document.getElementById('reminder-2h-timing').value,
                    smsBody: document.getElementById('reminder-2h-sms-body').value
                },
                calendarSync: {
                    enabled: document.getElementById('calendar-sync-enabled').value,
                    provider: document.getElementById('calendar-provider').value,
                    calendarId: document.getElementById('calendar-id').value,
                    apiKey: document.getElementById('calendar-api-key').value,
                    syncDirection: document.getElementById('calendar-sync-direction').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/communication-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    // Show save indicator
                    const indicator = document.getElementById('saveIndicator');
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                } else {
                    alert('Error saving settings: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings');
            }
        }

        function updateCharacterCounts() {
            const confirmSMS = document.getElementById('confirm-sms-body');
            const reminder24hSMS = document.getElementById('reminder-24h-sms-body');
            const reminder2hSMS = document.getElementById('reminder-2h-sms-body');

            document.getElementById('confirm-sms-count').textContent = confirmSMS.value.length;
            document.getElementById('reminder-24h-sms-count').textContent = reminder24hSMS.value.length;
            document.getElementById('reminder-2h-sms-count').textContent = reminder2hSMS.value.length;

            // Add event listeners for real-time updates
            confirmSMS.addEventListener('input', () => {
                document.getElementById('confirm-sms-count').textContent = confirmSMS.value.length;
            });

            reminder24hSMS.addEventListener('input', () => {
                document.getElementById('reminder-24h-sms-count').textContent = reminder24hSMS.value.length;
            });

            reminder2hSMS.addEventListener('input', () => {
                document.getElementById('reminder-2h-sms-count').textContent = reminder2hSMS.value.length;
            });
        }

        // Default templates
        function getDefaultConfirmEmail() {
            return `Hi {{firstName}}!

Great news - your moving appointment is confirmed! We're excited to help make your move worry-free.

üìÖ Date: {{date}}
üïê Time: {{time}}
üì¶ Service: {{serviceType}}
üìç Pickup: {{pickupAddress}}
üìç Dropoff: {{dropoffAddress}}

üì± Booking ID: {{bookingId}}

We'll send you a reminder 24 hours before your appointment. If you have any questions, feel free to contact us!

Best regards,
Worry Free Moving Team
330-435-8686
service@worryfreemovers.com`;
        }

        function getDefaultConfirmSMS() {
            return "Hi {{firstName}}! Your Worry Free Moving appointment is confirmed for {{date}} at {{time}}. Booking ID: {{bookingId}}. We'll send a reminder 24 hours before. Questions? Call 330-435-8686";
        }

        function getDefault24hEmail() {
            return `Hi {{firstName}}!

Just a friendly reminder that your move is scheduled for tomorrow!

üìÖ Date: {{date}}
üïê Time: {{time}}
üì¶ Service: {{serviceType}}
üìç Pickup: {{pickupAddress}}
üìç Dropoff: {{dropoffAddress}}

üì± Booking ID: {{bookingId}}

Please make sure everything is packed and ready to go. We'll send you another reminder 2 hours before your appointment.

Looking forward to helping you with your move!

Best regards,
Worry Free Moving Team
330-435-8686
service@worryfreemovers.com`;
        }

        function getDefault24hSMS() {
            return "Hi {{firstName}}! Reminder: Your move with Worry Free Moving is tomorrow {{date}} at {{time}}. Please have everything packed and ready. We'll text again 2 hours before. ID: {{bookingId}}";
        }

        function getDefault2hSMS() {
            return "Hi {{firstName}}! Your Worry Free Moving crew will arrive in 2 hours at {{time}}. Make sure you're at {{pickupAddress}}. See you soon! ID: {{bookingId}}";
        }

        // ==============================================
        // CALENDAR FUNCTIONS
        // ==============================================
        let currentDate = new Date();
        let blockedDates = [];
        let availabilitySettings = {};

        async function loadCalendar() {
            await loadBlockedDates();
            await loadAvailabilitySettingsData();
            renderCalendar();
        }

        async function loadBlockedDates() {
            try {
                const response = await fetch(`${API_URL}/blocked-dates`);
                const data = await response.json();
                if (data.success) {
                    blockedDates = data.dates || [];
                }
            } catch (error) {
                console.error('Error loading blocked dates:', error);
                blockedDates = [];
            }
        }

        async function loadAvailabilitySettingsData() {
            try {
                const response = await fetch(`${API_URL}/availability-settings`);
                const data = await response.json();
                if (data.success && data.settings) {
                    availabilitySettings = data.settings;
                }
            } catch (error) {
                console.error('Error loading availability settings:', error);
                availabilitySettings = {};
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Build calendar grid
            let html = '';

            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            // Current month days
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = isCurrentMonth && today.getDate() === day;
                const isBlocked = blockedDates.includes(dateStr);

                // Count bookings for this day
                const dayBookings = allAppointments.filter(apt => apt.date === dateStr && apt.status !== 'cancelled');

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isBlocked) classes += ' blocked';

                // Generate booking circles
                let circlesHtml = '';
                if (dayBookings.length > 0) {
                    dayBookings.forEach(booking => {
                        const circleClass = booking.status === 'confirmed' ? 'confirmed' : 'pending';
                        circlesHtml += `<div class="booking-circle ${circleClass}"></div>`;
                    });
                }

                html += `
                    <div class="${classes}" onclick="openDayDetail('${dateStr}')">
                        <div class="day-number">${day}</div>
                        ${circlesHtml ? `<div class="day-bookings">${circlesHtml}</div>` : ''}
                        ${isBlocked ? '<div class="blocked-badge">BLOCKED</div>' : ''}
                    </div>
                `;
            }

            // Next month days
            const totalCells = firstDay + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
                }
            }

            document.getElementById('calendar-grid').innerHTML = html;

            // Update mini calendar
            renderMiniCalendar();

            // Update stats
            updateCalendarStats();
        }

        function renderMiniCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            document.getElementById('mini-month-year').textContent = `${monthNames[month]} ${year}`;

            let html = '';

            // Day headers (abbreviated)
            const dayAbbr = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayAbbr.forEach(day => {
                html += `<div class="mini-day-header" style="font-size: 10px; color: #999; text-align: center; padding: 4px 0;">${day}</div>`;
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                html += `<div class="mini-day" style="color: #ccc;">${day}</div>`;
            }

            // Current month days
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = isCurrentMonth && today.getDate() === day;
                const dayBookings = allAppointments.filter(apt => apt.date === dateStr && apt.status !== 'cancelled');

                let classes = 'mini-day';
                let styles = 'cursor: pointer; position: relative;';

                if (isToday) {
                    styles += ' background: #667eea; color: white; font-weight: bold;';
                } else if (dayBookings.length > 0) {
                    if (dayBookings.length >= 3) {
                        styles += ' background: #999; color: white; font-weight: 600;';
                    } else {
                        styles += ' background: #e0e0e0; font-weight: 600;';
                    }
                }

                html += `<div class="${classes}" style="${styles}" onclick="jumpToDate('${dateStr}')">${day}</div>`;
            }

            // Next month days
            const totalCells = firstDay + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="mini-day" style="color: #ccc;">${day}</div>`;
                }
            }

            document.getElementById('mini-calendar-grid').innerHTML = html;
        }

        function jumpToDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            currentDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            renderCalendar();
            openDayDetail(dateStr);
        }

        function updateCalendarStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Count bookings this month
            const monthBookings = allAppointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate.getFullYear() === year && aptDate.getMonth() === month && apt.status !== 'cancelled';
            }).length;

            // Count blocked days this month
            const monthBlocked = blockedDates.filter(date => {
                const d = new Date(date);
                return d.getFullYear() === year && d.getMonth() === month;
            }).length;

            document.getElementById('month-bookings').textContent = monthBookings;
            document.getElementById('month-blocked').textContent = monthBlocked;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function today() {
            currentDate = new Date();
            renderCalendar();
        }

        function openDayDetail(dateStr) {
            const dayBookings = allAppointments.filter(apt => apt.date === dateStr);
            const isBlocked = blockedDates.includes(dateStr);

            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            document.getElementById('dayModalTitle').textContent = formattedDate;

            let html = `
                <div style="margin-bottom: 20px;">
                    <strong>Bookings: </strong>${dayBookings.filter(b => b.status !== 'cancelled').length}
                </div>
            `;

            if (dayBookings.length > 0) {
                html += '<div class="booking-list">';
                dayBookings.forEach(booking => {
                    if (booking.status !== 'cancelled') {
                        html += `
                            <div class="booking-list-item" style="cursor: pointer;">
                                <div onclick="closeDayModal(); viewAppointment('${booking.bookingId}');">
                                    <div class="booking-time">${booking.time}</div>
                                    <div class="booking-customer" style="color: #667eea; text-decoration: underline; cursor: pointer;"
                                         onclick="event.stopPropagation(); closeDayModal(); viewCustomerHistory('${booking.email}');">
                                        ${booking.firstName} ${booking.lastName}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">${booking.serviceType}</div>
                                </div>
                                <span class="status-badge status-${booking.status || 'pending'}">${(booking.status || 'pending').toUpperCase()}</span>
                            </div>
                        `;
                    }
                });
                html += '</div>';
            } else {
                html += '<div style="text-align: center; color: #999; padding: 20px;">No bookings for this day</div>';
            }

            document.getElementById('dayModalBody').innerHTML = html;

            // Footer buttons
            if (isBlocked) {
                document.getElementById('dayModalFooter').innerHTML = `
                    <button class="btn-modal btn-cancel" onclick="closeDayModal()">Close</button>
                    <button class="btn-modal btn-save" onclick="unblockDate('${dateStr}')">‚úì Unblock This Day</button>
                `;
            } else {
                document.getElementById('dayModalFooter').innerHTML = `
                    <button class="btn-modal btn-cancel" onclick="closeDayModal()">Close</button>
                    <button class="btn-modal" style="background: #f44336; color: white;" onclick="blockDate('${dateStr}')">üö´ Block This Day</button>
                `;
            }

            document.getElementById('dayModal').style.display = 'block';
        }

        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        async function blockDate(dateStr) {
            if (!confirm('Block this day? No new bookings will be allowed.')) return;

            try {
                const response = await fetch(`${API_URL}/blocked-dates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateStr, action: 'block' })
                });

                const data = await response.json();
                if (data.success) {
                    blockedDates.push(dateStr);
                    renderCalendar();
                    closeDayModal();
                    alert('Day blocked successfully');
                }
            } catch (error) {
                console.error('Error blocking date:', error);
                alert('Failed to block date');
            }
        }

        async function unblockDate(dateStr) {
            try {
                const response = await fetch(`${API_URL}/blocked-dates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateStr, action: 'unblock' })
                });

                const data = await response.json();
                if (data.success) {
                    blockedDates = blockedDates.filter(d => d !== dateStr);
                    renderCalendar();
                    closeDayModal();
                    alert('Day unblocked successfully');
                }
            } catch (error) {
                console.error('Error unblocking date:', error);
                alert('Failed to unblock date');
            }
        }

        // ==============================================
        // AVAILABILITY SETTINGS - QUICK ACTIONS
        // ==============================================
        function applyToAllDays() {
            const mondayStart = document.getElementById('hours-1-start').value;
            const mondayEnd = document.getElementById('hours-1-end').value;
            const mondayClosed = document.getElementById('hours-1-closed').checked;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`hours-${i}-start`).value = mondayStart;
                document.getElementById(`hours-${i}-end`).value = mondayEnd;
                document.getElementById(`hours-${i}-closed`).checked = mondayClosed;
            }
        }

        function applyToWeekdays() {
            const mondayStart = document.getElementById('hours-1-start').value;
            const mondayEnd = document.getElementById('hours-1-end').value;
            const mondayClosed = document.getElementById('hours-1-closed').checked;

            // Apply to Tuesday (2) through Friday (5)
            for (let i = 2; i <= 5; i++) {
                document.getElementById(`hours-${i}-start`).value = mondayStart;
                document.getElementById(`hours-${i}-end`).value = mondayEnd;
                document.getElementById(`hours-${i}-closed`).checked = mondayClosed;
            }
        }

        function markAllClosed() {
            for (let i = 0; i < 7; i++) {
                document.getElementById(`hours-${i}-closed`).checked = true;
            }
        }

        // ==============================================
        // HOLIDAY MANAGEMENT
        // ==============================================
        let holidays = [];

        function addHoliday() {
            const date = document.getElementById('holiday-date').value;
            const name = document.getElementById('holiday-name').value;

            if (!date || !name) {
                alert('Please enter both date and holiday name');
                return;
            }

            // Check if already exists
            if (holidays.some(h => h.date === date)) {
                alert('This date is already marked as a holiday');
                return;
            }

            holidays.push({ date, name });
            displayHolidays();

            // Clear inputs
            document.getElementById('holiday-date').value = '';
            document.getElementById('holiday-name').value = '';
        }

        function removeHoliday(date) {
            holidays = holidays.filter(h => h.date !== date);
            displayHolidays();
        }

        function displayHolidays() {
            const list = document.getElementById('holidays-list');

            if (holidays.length === 0) {
                list.innerHTML = '<p style="color: #999; font-size: 13px; margin: 10px 0;">No holidays configured</p>';
                return;
            }

            const sorted = holidays.sort((a, b) => new Date(a.date) - new Date(b.date));

            list.innerHTML = sorted.map(holiday => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; margin-bottom: 5px;">
                    <div>
                        <strong style="font-size: 13px;">${holiday.name}</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">${new Date(holiday.date).toLocaleDateString()}</span>
                    </div>
                    <button onclick="removeHoliday('${holiday.date}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove</button>
                </div>
            `).join('');
        }

        function openAvailabilitySettings() {
            // Load individual day hours
            if (availabilitySettings.dailyHours) {
                for (let i = 0; i < 7; i++) {
                    const dayHours = availabilitySettings.dailyHours[i];
                    if (dayHours) {
                        document.getElementById(`hours-${i}-start`).value = dayHours.start || '08:00';
                        document.getElementById(`hours-${i}-end`).value = dayHours.end || '18:00';
                        document.getElementById(`hours-${i}-closed`).checked = dayHours.closed || false;
                    }
                }
            } else if (availabilitySettings.businessHours) {
                // Backward compatibility - convert old format
                const start = availabilitySettings.businessHours.weekday?.start || '08:00';
                const end = availabilitySettings.businessHours.weekday?.end || '18:00';
                const weekendStart = availabilitySettings.businessHours.weekend?.start || '09:00';
                const weekendEnd = availabilitySettings.businessHours.weekend?.end || '17:00';

                // Set weekdays (Mon-Fri)
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`hours-${i}-start`).value = start;
                    document.getElementById(`hours-${i}-end`).value = end;
                }

                // Set weekend (Sun, Sat)
                document.getElementById('hours-0-start').value = weekendStart;
                document.getElementById('hours-0-end').value = weekendEnd;
                document.getElementById('hours-6-start').value = weekendStart;
                document.getElementById('hours-6-end').value = weekendEnd;
            }

            // Load holidays
            if (availabilitySettings.holidays) {
                holidays = availabilitySettings.holidays;
                displayHolidays();
            }

            // Load other settings
            if (availabilitySettings.maxAppointments) {
                document.getElementById('max-appointments').value = availabilitySettings.maxAppointments;
            }
            if (availabilitySettings.appointmentDuration) {
                document.getElementById('appointment-duration').value = availabilitySettings.appointmentDuration;
            }
            if (availabilitySettings.bufferTime) {
                document.getElementById('buffer-time').value = availabilitySettings.bufferTime;
            }

            document.getElementById('availabilityModal').style.display = 'block';
        }

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').style.display = 'none';
        }

        async function saveAvailabilitySettings() {
            // Collect individual day hours
            const dailyHours = {};
            const workingDays = [];

            for (let i = 0; i < 7; i++) {
                const start = document.getElementById(`hours-${i}-start`).value;
                const end = document.getElementById(`hours-${i}-end`).value;
                const closed = document.getElementById(`hours-${i}-closed`).checked;

                dailyHours[i] = {
                    start: start,
                    end: end,
                    closed: closed
                };

                // Build workingDays array (for backward compatibility)
                if (!closed) {
                    workingDays.push(i);
                }
            }

            const settings = {
                dailyHours: dailyHours,
                workingDays: workingDays, // Backward compatibility
                holidays: holidays,
                maxAppointments: parseInt(document.getElementById('max-appointments').value),
                appointmentDuration: parseInt(document.getElementById('appointment-duration').value),
                bufferTime: parseInt(document.getElementById('buffer-time').value),
                timezone: document.getElementById('timezone').value
            };

            try {
                const response = await fetch(`${API_URL}/availability-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    availabilitySettings = settings;
                    closeAvailabilityModal();
                    alert('Availability settings saved successfully!');
                }
            } catch (error) {
                console.error('Error saving availability settings:', error);
                alert('Failed to save settings');
            }
        }

        function viewBlockedDates() {
            if (blockedDates.length === 0) {
                alert('No blocked dates');
                return;
            }

            let message = 'Blocked Dates:\n\n';
            blockedDates.sort().forEach(date => {
                const d = new Date(date + 'T00:00:00');
                message += d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) + '\n';
            });

            alert(message);
        }

        // ==============================================
        // CALENDAR SYNC FUNCTIONS
        // ==============================================

        async function testCalendarConnection() {
            const provider = document.getElementById('calendar-provider').value;
            const calendarId = document.getElementById('calendar-id').value;
            const apiKey = document.getElementById('calendar-api-key').value;
            const statusDiv = document.getElementById('calendar-sync-status');

            if (!apiKey) {
                alert('Please enter your API key / credentials first');
                return;
            }

            statusDiv.textContent = 'Status: Testing connection...';
            statusDiv.style.color = '#0066cc';

            // Simulate connection test (in production, this would call the actual API)
            setTimeout(() => {
                // Placeholder - replace with actual API call
                statusDiv.textContent = `Status: Test mode - ${provider} connection would be tested here`;
                statusDiv.style.color = '#28a745';
                alert(`Connection test for ${provider} calendar:\n\nProvider: ${provider}\nCalendar ID: ${calendarId || 'Not specified'}\n\nNote: This is a placeholder. Implement actual OAuth/API connection testing in production.`);
            }, 1000);
        }

        async function syncCalendarsNow() {
            const enabled = document.getElementById('calendar-sync-enabled').value;
            const provider = document.getElementById('calendar-provider').value;
            const calendarId = document.getElementById('calendar-id').value;
            const statusDiv = document.getElementById('calendar-sync-status');

            if (enabled === 'disabled') {
                alert('Please enable calendar sync first in the settings above');
                return;
            }

            if (!document.getElementById('calendar-api-key').value) {
                alert('Please configure your API credentials first');
                return;
            }

            if (!confirm(`Sync all appointments with ${provider}?\n\nThis will create/update calendar events for all active appointments.`)) {
                return;
            }

            statusDiv.textContent = 'Status: Syncing appointments...';
            statusDiv.style.color = '#0066cc';

            // Placeholder - in production, this would call the backend API to sync
            setTimeout(() => {
                const appointmentCount = allAppointments.filter(apt => apt.status === 'confirmed').length;
                statusDiv.textContent = `Status: Last synced ${appointmentCount} appointments at ${new Date().toLocaleTimeString()}`;
                statusDiv.style.color = '#28a745';
                alert(`Sync complete!\n\n${appointmentCount} appointments would be synced to ${provider}.\n\nNote: This is a placeholder. Implement actual calendar sync in production.`);
            }, 2000);
        }

        async function viewCalendarLogs() {
            alert('Calendar Sync Logs\n\n' +
                  '======================\n' +
                  'Recent sync activity:\n\n' +
                  '‚Ä¢ ' + new Date().toLocaleDateString() + ' - Manual sync requested\n' +
                  '‚Ä¢ No automatic syncs configured yet\n\n' +
                  'Note: This is a placeholder. Implement actual sync logging in production.');
        }

        async function syncCalendars() {
            // This function is called from the dashboard quick action button
            syncCalendarsNow();
        }

        // ==============================================
        // USER MANAGEMENT FUNCTIONS
        // ==============================================
        let allUsers = [];
        let currentEditUserId = null;

        // Load all users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/authorized-users`);
                const data = await response.json();

                if (data.success) {
                    allUsers = data.users || [];
                    displayUsers(allUsers);
                    updateUserStats();
                } else {
                    console.error('Failed to load users:', data.error);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #dc3545;">
                            Failed to load users. Please refresh the page.
                        </td>
                    </tr>
                `;
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                            No users found. Click "Add New User" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map((user, index) => {
                const roleBadge = getRoleBadge(user.role);
                const statusBadge = getStatusBadge(user.status);
                const lastLogin = user.lastLogin
                    ? new Date(user.lastLogin).toLocaleDateString() + ' ' + new Date(user.lastLogin).toLocaleTimeString()
                    : 'Never';

                return `
                    <tr style="background: ${index % 2 === 0 ? '#fff' : '#f8f9fa'};">
                        <td style="padding: 15px;">
                            <strong>${user.username}</strong>
                        </td>
                        <td style="padding: 15px;">
                            ${user.firstName} ${user.lastName}
                        </td>
                        <td style="padding: 15px;">
                            ${user.email}
                        </td>
                        <td style="padding: 15px;">
                            ${roleBadge}
                        </td>
                        <td style="padding: 15px;">
                            ${statusBadge}
                        </td>
                        <td style="padding: 15px; font-size: 13px; color: #666;">
                            ${lastLogin}
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <button onclick="showEditUserModal('${user.id}')"
                                    style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;"
                                    title="Edit User">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="resetUserPassword('${user.id}')"
                                    style="background: #ffc107; color: #333; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 12px;"
                                    title="Reset Password">
                                üîë Reset
                            </button>
                            <button onclick="deleteUser('${user.id}')"
                                    style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                    title="Delete User">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get role badge HTML
        function getRoleBadge(role) {
            const badges = {
                admin: '<span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Admin</span>',
                manager: '<span style="background: #007bff; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Manager</span>',
                staff: '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Staff</span>'
            };
            return badges[role] || role;
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            if (status === 'active') {
                return '<span style="display: inline-flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></span> Active</span>';
            } else {
                return '<span style="display: inline-flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; background: #999; border-radius: 50%;"></span> Inactive</span>';
            }
        }

        // Update user stats
        function updateUserStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.status === 'active').length;
            const adminUsers = allUsers.filter(u => u.role === 'admin').length;

            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('activeUsersCount').textContent = activeUsers;
            document.getElementById('adminUsersCount').textContent = adminUsers;
        }

        // Filter users based on search
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();

            if (!searchTerm) {
                displayUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(user =>
                user.username.toLowerCase().includes(searchTerm) ||
                user.firstName.toLowerCase().includes(searchTerm) ||
                user.lastName.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );

            displayUsers(filtered);
        }

        // Show Add User Modal
        function showAddUserModal() {
            currentEditUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordLabel').innerHTML = 'Password *';

            // Set default permissions for new user
            document.getElementById('permViewBookings').checked = true;
            document.getElementById('permCreateBookings').checked = true;
            document.getElementById('permEditBookings').checked = true;
            document.getElementById('permDeleteBookings').checked = false;
            document.getElementById('permViewCustomers').checked = true;
            document.getElementById('permManageUsers').checked = false;
            document.getElementById('permManageSettings').checked = false;
            document.getElementById('permViewReports').checked = true;

            document.getElementById('userModal').style.display = 'flex';
        }

        // Show Edit User Modal
        async function showEditUserModal(userId) {
            try {
                const response = await fetch(`${API_URL}/authorized-users/${userId}`);
                const data = await response.json();

                if (data.success && data.user) {
                    const user = data.user;
                    currentEditUserId = userId;

                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userFirstName').value = user.firstName;
                    document.getElementById('userLastName').value = user.lastName;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userStatus').value = user.status;

                    // Password is optional when editing
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userPassword').required = false;
                    document.getElementById('passwordLabel').innerHTML = 'Password <small>(leave blank to keep current)</small>';

                    // Set permissions
                    const perms = user.permissions || {};
                    document.getElementById('permViewBookings').checked = perms.viewBookings !== false;
                    document.getElementById('permCreateBookings').checked = perms.createBookings !== false;
                    document.getElementById('permEditBookings').checked = perms.editBookings !== false;
                    document.getElementById('permDeleteBookings').checked = perms.deleteBookings === true;
                    document.getElementById('permViewCustomers').checked = perms.viewCustomers !== false;
                    document.getElementById('permManageUsers').checked = perms.manageUsers === true;
                    document.getElementById('permManageSettings').checked = perms.manageSettings === true;
                    document.getElementById('permViewReports').checked = perms.viewReports !== false;

                    document.getElementById('userModal').style.display = 'flex';
                } else {
                    alert('Failed to load user details');
                }
            } catch (error) {
                console.error('Error loading user:', error);
                alert('Failed to load user details');
            }
        }

        // Close User Modal
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            currentEditUserId = null;
        }

        // Save User (Create or Update)
        async function saveUser(event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const firstName = document.getElementById('userFirstName').value;
            const lastName = document.getElementById('userLastName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            const permissions = {
                viewBookings: document.getElementById('permViewBookings').checked,
                createBookings: document.getElementById('permCreateBookings').checked,
                editBookings: document.getElementById('permEditBookings').checked,
                deleteBookings: document.getElementById('permDeleteBookings').checked,
                viewCustomers: document.getElementById('permViewCustomers').checked,
                manageUsers: document.getElementById('permManageUsers').checked,
                manageSettings: document.getElementById('permManageSettings').checked,
                viewReports: document.getElementById('permViewReports').checked
            };

            const userData = {
                username,
                firstName,
                lastName,
                email,
                role,
                status,
                permissions
            };

            // Add password only if provided
            if (password) {
                userData.password = password;
            }

            console.log('Saving user data:', userData);

            try {
                const isEdit = userId !== '';
                const url = isEdit
                    ? `${API_URL}/authorized-users/${userId}`
                    : `${API_URL}/authorized-users`;
                const method = isEdit ? 'PUT' : 'POST';

                console.log('Request URL:', url);
                console.log('Request method:', method);

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    alert(isEdit ? 'User updated successfully!' : 'User created successfully!');
                    closeUserModal();
                    loadUsers(); // Reload the users list
                } else {
                    alert('Error: ' + (data.error || data.message || 'Failed to save user'));
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Failed to save user. Error: ' + error.message);
            }
        }

        // Delete User
        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);

            if (!user) {
                alert('User not found');
                return;
            }

            // Prevent deleting yourself
            // This is a simple check - in production, verify on server side
            if (confirm(`Are you sure you want to delete user "${user.username}"?\n\nThis action cannot be undone.`)) {
                try {
                    const response = await fetch(`${API_URL}/authorized-users/${userId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('User deleted successfully');
                        loadUsers(); // Reload the users list
                    } else {
                        alert('Error: ' + (data.error || 'Failed to delete user'));
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Failed to delete user. Please try again.');
                }
            }
        }

        // Reset User Password
        async function resetUserPassword(userId) {
            const user = allUsers.find(u => u.id === userId);

            if (!user) {
                alert('User not found');
                return;
            }

            if (confirm(`Reset password for user "${user.username}"?\n\nA temporary password will be generated and sent to ${user.email}`)) {
                try {
                    const response = await fetch(`${API_URL}/authorized-users/${userId}/reset-password`, {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`Password reset successful!\n\nTemporary password: ${data.tempPassword}\n\nAn email has been sent to ${user.email}`);
                    } else {
                        alert('Error: ' + (data.error || 'Failed to reset password'));
                    }
                } catch (error) {
                    console.error('Error resetting password:', error);
                    alert('Failed to reset password. Please try again.');
                }
            }
        }

        // Update permissions based on role selection
        function updatePermissionsByRole() {
            const role = document.getElementById('userRole').value;

            if (role === 'admin') {
                // Admin: All permissions
                document.getElementById('permViewBookings').checked = true;
                document.getElementById('permCreateBookings').checked = true;
                document.getElementById('permEditBookings').checked = true;
                document.getElementById('permDeleteBookings').checked = true;
                document.getElementById('permViewCustomers').checked = true;
                document.getElementById('permManageUsers').checked = true;
                document.getElementById('permManageSettings').checked = true;
                document.getElementById('permViewReports').checked = true;
            } else if (role === 'manager') {
                // Manager: Most permissions except user/settings management
                document.getElementById('permViewBookings').checked = true;
                document.getElementById('permCreateBookings').checked = true;
                document.getElementById('permEditBookings').checked = true;
                document.getElementById('permDeleteBookings').checked = false;
                document.getElementById('permViewCustomers').checked = true;
                document.getElementById('permManageUsers').checked = false;
                document.getElementById('permManageSettings').checked = false;
                document.getElementById('permViewReports').checked = true;
            } else if (role === 'staff') {
                // Staff: Limited permissions
                document.getElementById('permViewBookings').checked = true;
                document.getElementById('permCreateBookings').checked = true;
                document.getElementById('permEditBookings').checked = false;
                document.getElementById('permDeleteBookings').checked = false;
                document.getElementById('permViewCustomers').checked = true;
                document.getElementById('permManageUsers').checked = false;
                document.getElementById('permManageSettings').checked = false;
                document.getElementById('permViewReports').checked = false;
            }
        }

        // Password strength indicator
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('userPassword');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strengthBar = document.getElementById('passwordStrengthBar');
                    const strengthText = document.getElementById('passwordStrengthText');

                    if (!password) {
                        strengthBar.style.width = '0%';
                        strengthText.textContent = '';
                        return;
                    }

                    let strength = 0;
                    let text = '';
                    let color = '#dc3545';

                    // Length check
                    if (password.length >= 8) strength += 25;
                    if (password.length >= 12) strength += 25;

                    // Character variety checks
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 20;
                    if (/\d/.test(password)) strength += 15;
                    if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

                    if (strength < 40) {
                        text = 'Weak';
                        color = '#dc3545';
                    } else if (strength < 70) {
                        text = 'Medium';
                        color = '#ffc107';
                    } else {
                        text = 'Strong';
                        color = '#28a745';
                    }

                    strengthBar.style.width = strength + '%';
                    strengthBar.style.background = color;
                    strengthText.textContent = text;
                    strengthText.style.color = color;
                });
            }
        });

        // ==============================================
        // EMPLOYEE MANAGEMENT FUNCTIONS
        // ==============================================
        let allEmployees = [];
        let currentEditEmployeeId = null;

        // Load Employees
        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                const data = await response.json();

                if (data.success) {
                    allEmployees = data.employees;
                    displayEmployees(allEmployees);
                    updateEmployeeStats();
                } else {
                    console.error('Failed to load employees:', data.error);
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                document.getElementById('employeesTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #dc3545;">
                            Failed to load employees. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Display Employees
        function displayEmployees(employees) {
            const tbody = document.getElementById('employeesTableBody');

            if (employees.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #999;">
                            No employees found. Click "Add New Employee" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = employees.map(emp => {
                const statusColor = emp.status === 'active' ? '#28a745' : '#dc3545';
                const lastLogin = emp.lastLogin ? new Date(emp.lastLogin).toLocaleDateString() : 'Never';

                return `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 15px;">${emp.username}</td>
                        <td style="padding: 15px;">${emp.firstName} ${emp.lastName}</td>
                        <td style="padding: 15px;">${emp.email}</td>
                        <td style="padding: 15px;">${emp.phone || '-'}</td>
                        <td style="padding: 15px;">
                            <span style="padding: 4px 12px; background: #e8f4f8; color: #0c5460; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${emp.role.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 15px;">${emp.team || '-'}</td>
                        <td style="padding: 15px;">
                            <span style="display: inline-block; width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; margin-right: 6px;"></span>
                            ${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <button onclick="editEmployee('${emp.id}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                Edit
                            </button>
                            <button onclick="deleteEmployee('${emp.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update Employee Stats
        function updateEmployeeStats() {
            document.getElementById('totalEmployeesCount').textContent = allEmployees.length;
            document.getElementById('activeEmployeesCount').textContent = allEmployees.filter(e => e.status === 'active').length;
            document.getElementById('crewMembersCount').textContent = allEmployees.filter(e => e.role === 'crew').length;
        }

        // Filter Employees
        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();

            const filtered = allEmployees.filter(emp => {
                return emp.username.toLowerCase().includes(searchTerm) ||
                       `${emp.firstName} ${emp.lastName}`.toLowerCase().includes(searchTerm) ||
                       emp.email.toLowerCase().includes(searchTerm) ||
                       (emp.phone && emp.phone.includes(searchTerm));
            });

            displayEmployees(filtered);
        }

        // Show Add Employee Modal
        function showAddEmployeeModal() {
            currentEditEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'Add New Employee';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeUsername').value = '';
            document.getElementById('employeePassword').value = '';
            document.getElementById('employeePassword').required = true;
            document.getElementById('employeePasswordLabel').textContent = 'Password *';
            document.getElementById('employeeFirstName').value = '';
            document.getElementById('employeeLastName').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeePhone').value = '';
            document.getElementById('employeeRole').value = '';
            document.getElementById('employeeTeam').value = '';
            document.getElementById('employeeHireDate').value = '';
            document.getElementById('employeeStatus').value = 'active';

            document.getElementById('employeeModal').style.display = 'flex';
        }

        // Edit Employee
        async function editEmployee(employeeId) {
            const employee = allEmployees.find(e => e.id === employeeId);

            if (!employee) {
                alert('Employee not found');
                return;
            }

            currentEditEmployeeId = employeeId;
            document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
            document.getElementById('employeeId').value = employee.id;
            document.getElementById('employeeUsername').value = employee.username;
            document.getElementById('employeePassword').value = '';
            document.getElementById('employeePassword').required = false;
            document.getElementById('employeePasswordLabel').textContent = 'Password (leave blank to keep current)';
            document.getElementById('employeeFirstName').value = employee.firstName;
            document.getElementById('employeeLastName').value = employee.lastName;
            document.getElementById('employeeEmail').value = employee.email;
            document.getElementById('employeePhone').value = employee.phone || '';
            document.getElementById('employeeRole').value = employee.role;
            document.getElementById('employeeTeam').value = employee.team || '';
            document.getElementById('employeeHireDate').value = employee.hireDate || '';
            document.getElementById('employeeStatus').value = employee.status;

            document.getElementById('employeeModal').style.display = 'flex';
        }

        // Close Employee Modal
        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
            currentEditEmployeeId = null;
        }

        // Save Employee
        async function saveEmployee(event) {
            event.preventDefault();

            const employeeId = document.getElementById('employeeId').value;
            const employeeData = {
                username: document.getElementById('employeeUsername').value,
                firstName: document.getElementById('employeeFirstName').value,
                lastName: document.getElementById('employeeLastName').value,
                email: document.getElementById('employeeEmail').value,
                phone: document.getElementById('employeePhone').value,
                role: document.getElementById('employeeRole').value,
                team: document.getElementById('employeeTeam').value,
                hireDate: document.getElementById('employeeHireDate').value,
                status: document.getElementById('employeeStatus').value
            };

            const password = document.getElementById('employeePassword').value;
            if (password) {
                employeeData.password = password;
            }

            try {
                const isEdit = employeeId !== '';
                const url = isEdit
                    ? `${API_URL}/employees/${employeeId}`
                    : `${API_URL}/employees`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(employeeData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(isEdit ? 'Employee updated successfully!' : 'Employee created successfully!');
                    closeEmployeeModal();
                    loadEmployees();
                } else {
                    alert('Error: ' + (data.error || data.message || 'Failed to save employee'));
                }
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Failed to save employee. Error: ' + error.message);
            }
        }

        // Delete Employee
        async function deleteEmployee(employeeId) {
            const employee = allEmployees.find(e => e.id === employeeId);

            if (!employee) {
                alert('Employee not found');
                return;
            }

            if (confirm(`Are you sure you want to delete employee "${employee.username}"?\n\nThis action cannot be undone.`)) {
                try {
                    const response = await fetch(`${API_URL}/employees/${employeeId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Employee deleted successfully');
                        loadEmployees();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to delete employee'));
                    }
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    alert('Failed to delete employee. Please try again.');
                }
            }
        }

        // ========================================
        // PACKING MATERIALS MANAGEMENT
        // ========================================

        function showAddMaterialModal() {
            document.getElementById('materialModalTitle').textContent = 'Add New Packing Material';
            document.getElementById('materialForm').reset();
            document.getElementById('materialId').value = '';
            document.getElementById('materialOriginalId').value = '';
            document.getElementById('materialEnabled').checked = true;
            document.getElementById('materialModal').style.display = 'flex';
        }

        function editMaterial(materialKey) {
            const material = servicesConfig.packingMaterials[materialKey];
            if (!material) {
                alert('Material not found');
                return;
            }

            document.getElementById('materialModalTitle').textContent = 'Edit Packing Material';
            document.getElementById('materialId').value = materialKey;
            document.getElementById('materialOriginalId').value = materialKey;
            document.getElementById('materialItemId').value = materialKey;
            document.getElementById('materialName').value = material.name;
            document.getElementById('materialPrice').value = material.price;
            document.getElementById('materialCategory').value = material.category;
            document.getElementById('materialEnabled').checked = material.enabled;
            document.getElementById('materialModal').style.display = 'flex';
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').style.display = 'none';
        }

        async function saveMaterial(event) {
            event.preventDefault();

            const originalId = document.getElementById('materialOriginalId').value;
            const newId = document.getElementById('materialItemId').value.trim();
            const name = document.getElementById('materialName').value.trim();
            const price = parseFloat(document.getElementById('materialPrice').value);
            const category = document.getElementById('materialCategory').value;
            const enabled = document.getElementById('materialEnabled').checked;

            // Validate
            if (!newId || !name || isNaN(price) || !category) {
                alert('Please fill in all required fields');
                return;
            }

            // Check for duplicate ID (only if changing ID)
            if (originalId !== newId && servicesConfig.packingMaterials[newId]) {
                alert(`Material ID "${newId}" already exists. Please choose a different ID.`);
                return;
            }

            try {
                // If editing and ID changed, remove old entry
                if (originalId && originalId !== newId) {
                    delete servicesConfig.packingMaterials[originalId];
                }

                // Add or update material
                servicesConfig.packingMaterials[newId] = {
                    name,
                    price,
                    category,
                    enabled
                };

                // Save to server
                await saveServices();

                // Refresh display
                displayPackingMaterials();

                // Close modal
                closeMaterialModal();

                alert(originalId ? 'Material updated successfully!' : 'Material added successfully!');
            } catch (error) {
                console.error('Error saving material:', error);
                alert('Failed to save material: ' + error.message);
            }
        }

        async function deleteMaterial(materialKey) {
            const material = servicesConfig.packingMaterials[materialKey];
            if (!material) {
                alert('Material not found');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${material.name}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                // Remove material
                delete servicesConfig.packingMaterials[materialKey];

                // Save to server
                await saveServices();

                // Refresh display
                displayPackingMaterials();

                alert('Material deleted successfully!');
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('Failed to delete material: ' + error.message);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (sessionToken && document.getElementById('dashboardScreen').style.display === 'block') {
                loadAppointments();
            }
        }, 30000);

        // ========================================
        // NEW APPOINTMENT MODAL FUNCTIONS
        // ========================================

        let availableServices = {}; // Will hold services from API

        // Open New Appointment Modal
        async function openNewAppointmentModal() {
            document.getElementById('newAppointmentModal').style.display = 'flex';

            // Load services if not already loaded
            if (Object.keys(availableServices).length === 0) {
                await loadServicesForAppointment();
            }

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appt-date').min = today;
        }

        // Close Modal
        function closeNewAppointmentModal() {
            document.getElementById('newAppointmentModal').style.display = 'none';
            document.getElementById('newAppointmentForm').reset();
            document.getElementById('appt-pricing-display').style.display = 'none';
        }

        // Load Services from API
        async function loadServicesForAppointment() {
            try {
                console.log('Fetching services from:', `${API_URL}/services`);
                const response = await fetch(`${API_URL}/services`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Services loaded:', data);
                availableServices = data;

                // Populate service dropdown
                const serviceSelect = document.getElementById('appt-service');
                serviceSelect.innerHTML = '<option value="">-- Select Service --</option>';

                // Add Moving Services
                if (data.movingServices) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = 'Moving Services';

                    Object.entries(data.movingServices).forEach(([key, service]) => {
                        if (key === 'base' || key === 'distanceAdj' || key === 'crewAdd' || key === 'serviceCharge') return;
                        if (service.enabled !== false) {
                            const option = document.createElement('option');
                            option.value = `moving-${key}`;
                            option.textContent = service.name || key;
                            optgroup.appendChild(option);
                        }
                    });
                    serviceSelect.appendChild(optgroup);
                }

                // Add Other Services
                const otherServices = ['laborOnly', 'singleItem', 'junkRemoval', 'cleanout'];
                const otherOptgroup = document.createElement('optgroup');
                otherOptgroup.label = 'Other Services';

                otherServices.forEach(key => {
                    if (data[key] && data[key].enabled !== false) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = data[key].name || key;
                        otherOptgroup.appendChild(option);
                    }
                });
                serviceSelect.appendChild(otherOptgroup);

            } catch (error) {
                console.error('Error loading services:', error);
                alert(`‚ö†Ô∏è Failed to Load Services\nError: ${error.message}\n\nPlease check:\n1. Server is running: npm start\n2. Access admin portal via: http://localhost:3001/admin-portal.html\n3. Not using file:// URL\n\nSee browser console (F12) for details.`);
            }
        }

        // Check Available Time Slots
        async function checkAppointmentAvailability() {
            const date = document.getElementById('appt-date').value;
            if (!date) return;

            const timeSelect = document.getElementById('appt-time');
            timeSelect.innerHTML = '<option value="">Loading...</option>';

            try {
                const response = await fetch(`${API_URL}/available-slots?date=${date}`);
                const data = await response.json();

                timeSelect.innerHTML = '<option value="">-- Select Time --</option>';

                if (data.success && data.slots && data.slots.length > 0) {
                    data.slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.time;
                        option.textContent = slot.time;
                        timeSelect.appendChild(option);
                    });
                } else {
                    timeSelect.innerHTML = '<option value="">No slots available</option>';
                }
            } catch (error) {
                console.error('Error fetching time slots:', error);
                timeSelect.innerHTML = '<option value="">Error loading slots</option>';
            }
        }

        // Update Pricing Estimate
        function updateAppointmentPricing() {
            const serviceValue = document.getElementById('appt-service').value;
            if (!serviceValue) {
                document.getElementById('appt-pricing-display').style.display = 'none';
                return;
            }

            const pricingDisplay = document.getElementById('appt-pricing-display');
            const pricingDetails = document.getElementById('appt-pricing-details');

            // Parse service type
            let serviceConfig;
            let serviceName;

            if (serviceValue.startsWith('moving-')) {
                const crewKey = serviceValue.replace('moving-', '');
                serviceConfig = availableServices.movingServices?.[crewKey];
                serviceName = serviceConfig?.name || 'Moving Service';

                // Calculate moving service pricing
                const base = availableServices.movingServices?.base || 192.50;
                const crewSize = serviceConfig?.crew || 2;

                pricingDetails.innerHTML = `
                    <div style="margin-bottom: 8px;"><strong>Service:</strong> ${serviceName}</div>
                    <div style="margin-bottom: 8px;"><strong>Base Rate:</strong> $${base}/hour</div>
                    <div style="margin-bottom: 8px;"><strong>Crew Size:</strong> ${crewSize} movers</div>
                    <div style="color: #666; font-size: 13px; margin-top: 10px;">
                        Note: Final pricing will be calculated based on distance and actual time
                    </div>
                `;
            } else {
                serviceConfig = availableServices[serviceValue];
                serviceName = serviceConfig?.name || serviceValue;

                const baseRate = serviceConfig?.baseRate || serviceConfig?.baseHourlyRate || 0;
                pricingDetails.innerHTML = `
                    <div style="margin-bottom: 8px;"><strong>Service:</strong> ${serviceName}</div>
                    <div style="margin-bottom: 8px;"><strong>Base Rate:</strong> $${baseRate}${serviceValue === 'singleItem' ? '' : '/hour'}</div>
                    <div style="color: #666; font-size: 13px; margin-top: 10px;">
                        Note: Final pricing will be calculated based on specific requirements
                    </div>
                `;
            }

            pricingDisplay.style.display = 'block';
        }

        // Create New Appointment
        async function createNewAppointment() {
            const form = document.getElementById('newAppointmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const button = document.querySelector('#createApptBtnText');
            const originalText = button.textContent;
            button.textContent = 'Creating...';

            try {
                const serviceValue = document.getElementById('appt-service').value;
                let serviceType = serviceValue;

                // Convert service value to readable name
                if (serviceValue.startsWith('moving-')) {
                    const crewKey = serviceValue.replace('moving-', '');
                    serviceType = availableServices.movingServices?.[crewKey]?.name || 'Moving Service';
                } else {
                    serviceType = availableServices[serviceValue]?.name || serviceValue;
                }

                const appointmentData = {
                    firstName: document.getElementById('appt-firstName').value,
                    lastName: document.getElementById('appt-lastName').value,
                    email: document.getElementById('appt-email').value,
                    phone: document.getElementById('appt-phone').value,
                    date: document.getElementById('appt-date').value,
                    time: document.getElementById('appt-time').value,
                    serviceType: serviceType,
                    pickupAddress: document.getElementById('appt-pickup').value,
                    dropoffAddress: document.getElementById('appt-dropoff').value || '',
                    notes: document.getElementById('appt-notes').value || '',
                    company: serviceType.toLowerCase().includes('labor') ? 'Quality Moving' : 'Worry Free Moving'
                };

                const response = await fetch(`${API_URL}/book-appointment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Appointment created successfully!\n\nBooking ID: ${result.bookingId}\n\nConfirmation emails have been sent.`);
                    closeNewAppointmentModal();
                    loadAppointments(); // Refresh calendar
                    renderCalendar();
                } else {
                    throw new Error(result.error || 'Failed to create appointment');
                }
            } catch (error) {
                console.error('Error creating appointment:', error);
                alert(`Failed to create appointment: ${error.message}`);
            } finally {
                button.textContent = originalText;
            }
        }
    </script>
</body>
</html>
