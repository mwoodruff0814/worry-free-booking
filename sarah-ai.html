<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Prevent browser caching during development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Worry Free Moving - Chat with Sarah</title>
    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #ffffff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Chat Container */
        #wfm-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: none; /* Always start hidden */
        }

        #wfm-chat-widget {
            width: 456px;
            height: 624px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 40px rgba(0,0,0,0.16);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #wfm-chat-header {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,64,133,0.2);
        }

        #wfm-chat-header img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }

        #wfm-chat-header span {
            flex-grow: 1;
            font-weight: 600;
        }

        #wfm-chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        #wfm-chat-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        #wfm-chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #f8fafb 0%, #f0f4f8 100%);
            -webkit-overflow-scrolling: touch;
        }

        #wfm-chat-navigation {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-button {
            background: white;
            border: 2px solid #004085;
            color: #004085;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-button:hover {
            background: #004085;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        .nav-button:active {
            transform: scale(0.98);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            background: white;
            color: #222;
            margin-right: auto;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .user-message {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            margin-left: auto;
            box-shadow: 0 1px 3px rgba(0,64,133,0.3);
        }

        .typing-indicator {
            display: inline-block;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #004085;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        #wfm-chat-options {
            padding: 10px;
            background: white;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .chat-option {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin: 5px 0;
            background: white;
            border: 2px solid #004085;
            border-radius: 25px;
            color: #004085;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .chat-option:hover {
            background: #004085;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(0,64,133,0.3);
        }

        .chat-option:active {
            transform: scale(0.98);
        }

        .chat-option.primary {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            font-weight: 600;
            border: none;
            box-shadow: 0 3px 12px rgba(0,64,133,0.3);
        }

        .chat-option.primary:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,64,133,0.4);
        }

        .chat-option:disabled {
            background: #e0e0e0;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .chat-option:disabled:hover {
            background: #e0e0e0;
            color: #999;
            transform: none;
            box-shadow: none;
        }

        #wfm-chat-input-area {
            padding: 10px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            position: relative;
            flex-shrink: 0;
        }

        #wfm-chat-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #wfm-chat-input:focus {
            border-color: #004085;
            box-shadow: 0 0 0 3px rgba(0,64,133,0.1);
        }

        #wfm-chat-send {
            padding: 12px 20px;
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        #wfm-chat-send:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.4);
        }

        #wfm-chat-send:active {
            transform: scale(0.98);
        }

        #wfm-chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,64,133,0.3);
            display: none !important; /* Hide the toggle button */
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        #wfm-chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0,64,133,0.4);
        }

        #wfm-chat-toggle:active {
            transform: scale(0.98);
        }

        /* Date Picker Styles */
        #wfm-date-picker-container {
            position: absolute;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background: white;
            border: 2px solid #004085;
            border-radius: 15px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 10001;
        }

        .date-picker-header {
            font-weight: 600;
            color: #004085;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }

        .chat-date-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-date-input:focus {
            border-color: #004085;
            box-shadow: 0 0 0 3px rgba(0,64,133,0.1);
        }

        .date-picker-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .date-picker-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-confirm-btn {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        .date-confirm-btn:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.4);
        }

        .date-cancel-btn {
            background: #f0f4f8;
            color: #004085;
            border: 2px solid #004085;
        }

        .date-cancel-btn:hover {
            background: #e2e8f0;
        }

        /* Payment Modal Styles */
        #wfm-payment-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10003;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #wfm-payment-header {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,64,133,0.2);
        }

        #wfm-payment-back {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        #wfm-payment-back:hover {
            background: white;
            color: #004085;
        }

        .payment-content {
            padding: 20px;
            flex-grow: 1;
        }

        .payment-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .payment-summary-title {
            font-weight: 600;
            color: #004085;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 700;
            color: #004085;
            margin: 10px 0;
        }

        #card-container {
            margin: 20px 0;
        }

        #payment-status-container {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .payment-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .payment-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        #card-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        #card-button:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.4);
        }

        #card-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #skip-card-button {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        #skip-card-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Print Quote Modal Styles */
        #wfm-print-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10003;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #wfm-print-header {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,64,133,0.2);
        }

        #wfm-print-back {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        #wfm-print-back:hover {
            background: white;
            color: #004085;
        }

        .print-quote-content {
            padding: 30px;
            flex-grow: 1;
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
        }

        .print-actions {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            flex-shrink: 0;
        }

        .print-button {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        .print-button:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.4);
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #wfm-print-modal,
            #wfm-print-modal * {
                visibility: visible;
            }

            #wfm-print-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            #wfm-print-header,
            #wfm-print-actions,
            .print-actions {
                display: none !important;
            }

            .print-quote-content {
                padding: 20px;
                max-width: 100%;
            }
        }

        /* Photo Upload Styles */
        .photo-upload-container {
            background: #f8f9fa;
            border: 2px dashed #004085;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload-container:hover {
            background: #e9ecef;
            border-color: #002855;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.2);
        }

        .photo-upload-container.dragging {
            background: #e6f1ff;
            border-color: #004085;
            border-style: solid;
        }

        .photo-upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #004085;
        }

        .photo-upload-text {
            color: #495057;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .photo-upload-button {
            background: linear-gradient(135deg, #004085 0%, #0056b3 100%);
            color: white;
            padding: 10px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,64,133,0.3);
        }

        .photo-upload-button:hover {
            background: linear-gradient(135deg, #002855 0%, #004085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,64,133,0.4);
        }

        .photo-upload-button:active {
            transform: scale(0.98);
        }

        .photo-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-width: 100%;
        }

        .photo-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview-item .remove-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .photo-preview-item .remove-photo:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .photo-upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .photo-upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #004085 0%, #0056b3 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .photo-upload-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            border: 1px solid #f5c6cb;
        }

        .photo-upload-success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            border: 1px solid #c3e6cb;
        }

        .photo-count-indicator {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Other styles */
        .estimate-details {
            background: linear-gradient(135deg, #e6f1ff 0%, #f0f7ff 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #004085;
            box-shadow: 0 2px 8px rgba(0,64,133,0.1);
        }

        .materials-details {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(40,167,69,0.1);
        }

        .materials-breakdown {
            margin-top: 10px;
            font-size: 13px;
        }

        .materials-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #e0e7ee;
        }

        .materials-total {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #004085;
        }

        .coverage-details {
            background: linear-gradient(135deg, #fff3cd 0%, #ffecb5 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255,193,7,0.1);
        }

        .coverage-option-box {
            background: white;
            border: 2px solid #e0e7ee;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .coverage-option-box:hover {
            border-color: #004085;
            background: #f0f7ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,64,133,0.1);
        }

        .coverage-option-box.selected {
            border-color: #004085;
            background: #e6f1ff;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .disclaimer-text {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }

        .overage-disclaimer {
            font-size: 11px;
            color: #dc3545;
            background: #fff3cd;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #ffeaa7;
        }

        .pest-disclaimer {
            background: #fee;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #721c24;
        }

        .pest-disclaimer-header {
            font-weight: bold;
            color: #dc3545;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }

        .pest-disclaimer-checkbox {
            margin-top: 15px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #dc3545;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
        }

        .pest-disclaimer-checkbox:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220,53,69,0.2);
        }

        .pest-disclaimer-checkbox.checked {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
            cursor: default;
        }

        .autocomplete-dropdown {
            position: absolute;
            bottom: 60px;
            left: 10px;
            right: 10px;
            background: white;
            border: 2px solid #004085;
            border-radius: 10px;
            box-shadow: 0 -4px 20px rgba(0,64,133,0.2);
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: none;
            z-index: 10000;
        }

        .autocomplete-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f4f8;
            font-size: 14px;
            color: #333;
            background: white;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .autocomplete-item:hover,
        .autocomplete-item:active {
            background: #f0f4f8;
            color: #004085;
            font-weight: 600;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .highlight-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffecb5 100%);
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(255,193,7,0.1);
        }

        .warning-box {
            background: #fee;
            border: 1px solid #fcc;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            color: #c33;
        }

        .success-badge {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
            box-shadow: 0 1px 4px rgba(40,167,69,0.3);
        }

        .urgency-text {
            color: #dc3545;
            font-weight: 600;
            font-size: 14px;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .critical-error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 12px rgba(220,53,69,0.3);
        }

        .critical-error h3 {
            margin: 0 0 10px 0;
        }

        .critical-error p {
            margin: 5px 0;
        }

        .critical-error a {
            color: white;
            text-decoration: underline;
            font-weight: 600;
        }

        .sending-indicator {
            text-align: center;
            padding: 15px;
            color: #004085;
        }

        .sending-indicator .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #004085;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Claims photo upload styles */
        .photo-upload-area {
            background: #f8f9fa;
            border: 2px dashed #004085;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
        }

        .photo-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #004085;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            #wfm-chat-container {
                bottom: 0;
                right: 0;
                left: 0;
                padding: 0;
            }
            
            #wfm-chat-widget {
                width: 100%;
                height: 100vh;
                height: 100dvh;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 0;
                max-width: none;
                max-height: none;
            }
            
            #wfm-chat-messages {
                padding: 15px;
            }
            
            .chat-message {
                max-width: 85%;
                font-size: 15px;
            }
            
            #wfm-chat-options {
                max-height: 40vh;
            }
            
            .chat-option {
                padding: 14px 20px;
                font-size: 16px;
                margin: 8px 0;
                min-height: 48px;
            }
            
            #wfm-chat-input {
                font-size: 16px;
                padding: 14px 18px;
            }
            
            #wfm-chat-send {
                padding: 14px 24px;
                font-size: 16px;
            }
            
            #wfm-chat-toggle {
                display: none !important;
            }
            
            .autocomplete-dropdown {
                bottom: 70px;
                left: 10px;
                right: 10px;
                max-height: 40vh;
                border-radius: 15px;
                box-shadow: 0 -8px 24px rgba(0,0,0,0.2);
            }
            
            .autocomplete-item {
                padding: 18px;
                font-size: 16px;
                border-bottom: 2px solid #f0f4f8;
                min-height: 50px;
                display: flex;
                align-items: center;
            }
            
            /* Prevent zoom on input focus */
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="date"],
            input[type="file"],
            button {
                font-size: 16px !important;
            }
            
            /* Handle keyboard appearance */
            .keyboard-open #wfm-chat-widget {
                height: 100vh;
                height: 100dvh;
            }
            
            .keyboard-open #wfm-chat-messages {
                padding-bottom: 20px;
            }
            
            .keyboard-open .autocomplete-dropdown {
                position: fixed;
                bottom: auto;
                top: 50%;
                transform: translateY(-50%);
                max-height: 40vh;
            }

            /* Mobile photo upload optimizations */
            .photo-upload-container {
                min-height: 150px;
            }

            .photo-upload-button {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 28px;
            }

            .photo-preview-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
        }

        /* iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            #wfm-chat-widget {
                height: -webkit-fill-available;
            }
            
            .autocomplete-dropdown {
                -webkit-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);
            }
        }

        /* Android-specific fixes */
        @media screen and (max-width: 768px) {
            input:focus {
                font-size: 16px !important;
            }
        }
    </style>

    <!-- Square Web Payments SDK -->
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
</head>
<body>
    <!-- Enhanced Moving Chat Widget with Sarah AI Assistant -->
    <div id="wfm-chat-container" style="display: block;">
        <div id="wfm-chat-widget">
            <div id="wfm-chat-header">
                <img src="https://res.cloudinary.com/dhiukpg4d/image/upload/w_50/v1743554600/WorryFreeMoving_coverart2_e0ed3i.jpg" alt="WFM">
                <span>Sarah - Get Your Moving Estimate & Book</span>
                <button id="wfm-chat-close">√ó</button>
            </div>
            <div id="wfm-chat-messages"></div>
            <div id="wfm-chat-navigation" style="display: none;">
                <button id="wfm-chat-back" class="nav-button">‚Üê Go Back</button>
            </div>
            <div id="wfm-chat-options"></div>
            <div id="wfm-chat-input-area" style="display: none;">
                <div id="wfm-autocomplete-results" class="autocomplete-dropdown"></div>
                <input type="text" id="wfm-chat-input" placeholder="Type your answer..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <button id="wfm-chat-send">Send</button>
            </div>
            
            <!-- Date Picker Container -->
            <div id="wfm-date-picker-container" style="display: none;">
                <div class="date-picker-header">Select Your Moving Date</div>
                <input type="date" id="wfm-date-picker" min="" class="chat-date-input">
                <div class="date-picker-buttons">
                    <button class="date-confirm-btn">Confirm Date</button>
                    <button class="date-cancel-btn">Cancel</button>
                </div>
            </div>
            
            <!-- Print Quote Modal -->
            <div id="wfm-print-modal" style="display: none;">
                <div id="wfm-print-header">
                    <button id="wfm-print-back">‚Üê Back to Chat</button>
                    <span>üìÑ Your Moving Quote</span>
                </div>
                <div id="wfm-print-content" class="print-quote-content"></div>
                <div id="wfm-print-actions" class="print-actions">
                    <button id="wfm-print-button" class="print-button">üñ®Ô∏è Print or Save as PDF</button>
                </div>
            </div>

            <!-- Payment Container -->
            <div id="wfm-payment-container" style="display: none;">
                <div id="wfm-payment-header">
                    <button id="wfm-payment-back">‚Üê Back to Chat</button>
                    <span>üí≥ Save Payment Method</span>
                </div>
                <div class="payment-content">
                    <div class="payment-summary">
                        <div class="payment-summary-title">Booking Summary</div>
                        <div id="payment-estimate-summary"></div>
                        <div class="payment-amount" id="payment-total-amount"></div>
                    </div>

                    <div style="background: #eef2ff; padding: 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #4c51bf; line-height: 1.6;">
                        <strong>üîí Secure Payment</strong><br>
                        Your card will be securely saved for this booking. <strong>No charges will be made until after your move is complete.</strong>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <strong style="color: #004085;">Card Information</strong>
                        <div style="font-size: 13px; color: #666; margin-top: 5px;">
                            üîê Secured by Square ‚Ä¢ PCI Compliant
                        </div>
                    </div>

                    <div id="card-container"></div>
                    <button id="card-button" type="button">üíæ Save Card Securely</button>
                    <button id="skip-card-button" type="button" style="margin-top: 10px;" onclick="handleSkipCard()">Skip - I'll Pay Later</button>

                    <div id="payment-status-container"></div>

                    <div style="margin-top: 16px; font-size: 12px; color: #718096; text-align: center;">
                        üîê No card data stored on our servers ‚Ä¢ Payment due after move completion
                    </div>
                </div>
            </div>
        </div>
        <button id="wfm-chat-toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L1 23l6.71-1.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm0 18c-1.41 0-2.73-.36-3.88-.98l-.28-.15-2.89.85.85-2.89-.15-.28C5.04 14.73 4.68 13.41 4.68 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8z"/>
            </svg>
            Get Estimate
        </button>
    </div>

    <script>
    // Enhanced Worry Free Moving Chatbot with Sarah AI Assistant - FIXED VERSION
    (function() {
        // Configuration - Updated with Cloudinary settings
        const CONFIG = {
            baseAddress: "11715 Mahoning Avenue, North Jackson, OH 44451",
            phone: "330-435-8686",
            email: "service@worryfreemovers.com",
            bookingUrl: "https://worryfreemovers.com/moving/local",
            googleMapsApiKey: "AIzaSyAWGIVnh7-2sgDJin_2qgNvwh4JD9UgJDo",
            formSubmitUrl: "https://formsubmit.co/ajax/service@worryfreemovers.com",
            additionalEmail: "zlarimer24@gmail.com",
            storageKey: "wfm_chat_session",
            // Cloudinary configuration
            cloudinary: {
                cloudName: "dhiukpg4d",
                uploadPreset: "moving_estimates",
                apiUrl: "https://api.cloudinary.com/v1_1/dhiukpg4d/image/upload",
                folder: "moving_estimates"
            },
            // Square payment configuration
            square: {
                applicationId: "sq0idp-7GJn4RN8zcdsw3S1kJaNOA",
                locationId: "L6WP06SMJKJSB", // Worry-Free Moving (Main) - 11715 Mahoning Avenue
                environment: "production", // "sandbox" or "production"
                // Backend API endpoint for processing payments (git alias always points to latest master)
                apiUrl: "https://worry-free-chatbot-git-master-matt-5184s-projects.vercel.app/api/square-customer"
            },
            // Local booking system API
            bookingAPI: {
                baseUrl: "http://localhost:3001",
                endpoints: {
                    bookAppointment: "/api/book-appointment",
                    checkCustomer: "/api/square-customer"
                }
            },
            maxPhotos: 5,
            maxFileSize: 10 * 1024 * 1024, // 10MB
            autoSubmitTimeout: 30000, // 30 seconds timeout for auto-submit
            rates: {
                moving: { 
                    base: 192.50, 
                    distanceAdj: 0.75, 
                    crewAdd: 55,
                    serviceCharge: 0.14
                },
                labor: { 
                    base: 115, 
                    distanceAdj: 0.50, 
                    crewAdd: 55,
                    travel: 1.60, 
                    serviceCharge: 0.08
                },
                singleItem: {
                    base: 249,
                    distance: 1.50,
                    perMinute: 1.67,
                    stairs: 35, // $35 per flight (most single items are apartments)
                    crewRates: { // Hourly rates by crew size
                        2: 167,
                        3: 222,
                        4: 277
                    },
                    minimums: { // Minimum time in minutes
                        standard: 60,
                        set: 90,
                        heavy: 120
                    }
                },
                fvp: {
                    local: 0.025,
                    longDistance: 0.04,
                    minCharge: 49.99
                },
                junkRemoval: {
                    base: 250,           // Base rate for 2-person crew, 1 hour
                    distance: 0.50,      // $0.50 per mile from base
                    disposalFee: 75,     // Standard disposal fee
                    serviceCharge: 0.14, // 14% service fee
                    crewAdd: 100         // Additional cost per extra crew member
                },
                cleanout: {
                    baseHourly: 219.99,  // Base hourly rate before distance adjustment
                    baseHours: 2,        // Base hours included in service
                    distanceAdjustment: 0.50,  // Add $0.50 per mile to hourly rate
                    disposalFee: 200,    // Cleanout disposal fee
                    serviceCharge: 0.14, // 14% service fee
                    crewAdd: 50          // Additional cost per hour per extra crew member beyond 2
                }
            },
            // Single item categories with crew requirements and minimums
            singleItemCategories: {
                // Light items - 2 person crew, 60 min minimum
                couch: { name: "Couch/Sofa", crew: 2, minTime: 60, category: "standard", fee: 0 },
                loveseat: { name: "Loveseat", crew: 2, minTime: 60, category: "standard", fee: 0 },
                chair: { name: "Recliner/Chair", crew: 2, minTime: 60, category: "standard", fee: 0 },
                mattress: { name: "Mattress & Box Spring", crew: 2, minTime: 60, category: "standard", fee: 0 },
                dresser: { name: "Dresser", crew: 2, minTime: 60, category: "standard", fee: 0 },
                desk: { name: "Desk", crew: 2, minTime: 60, category: "standard", fee: 0 },
                table: { name: "Dining Table", crew: 2, minTime: 60, category: "standard", fee: 0 },
                
                // Appliances - 2 person crew, 60 min minimum
                washer: { name: "Washer", crew: 2, minTime: 60, category: "standard", fee: 0 },
                dryer: { name: "Dryer", crew: 2, minTime: 60, category: "standard", fee: 0 },
                refrigerator: { name: "Refrigerator", crew: 2, minTime: 60, category: "standard", fee: 0 },
                stove: { name: "Stove/Range", crew: 2, minTime: 60, category: "standard", fee: 0 },
                freezer: { name: "Deep Freezer", crew: 2, minTime: 60, category: "standard", fee: 0 },
                dishwasher: { name: "Dishwasher", crew: 2, minTime: 60, category: "standard", fee: 0 },
                
                // Sets - 2-3 person crew, 90 min minimum
                bedroomSet: { name: "Bedroom Set", crew: 2, minTime: 90, category: "set", fee: 50 },
                diningSet: { name: "Dining Room Set", crew: 2, minTime: 90, category: "set", fee: 50 },
                livingSet: { name: "Living Room Set", crew: 2, minTime: 90, category: "set", fee: 50 },
                officeSet: { name: "Office Furniture Set", crew: 2, minTime: 90, category: "set", fee: 50 },
                
                // Heavy items - 3 person crew
                piano: { name: "Piano", crew: 3, minTime: 90, category: "heavy", fee: 200, weight: 500 },
                gunSafe: { name: "Gun Safe", crew: 4, minTime: 120, category: "heavy", fee: 100, weight: 300 },
                treadmill: { name: "Treadmill", crew: 2, minTime: 60, category: "standard", fee: 0 },
                elliptical: { name: "Elliptical", crew: 2, minTime: 60, category: "standard", fee: 0 },
                gym: { name: "Home Gym Equipment", crew: 3, minTime: 90, category: "heavy", fee: 100, weight: 400 },
                
                // Extra heavy - 4 person crew, 2 hour minimum
                poolTable: { name: "Pool Table", crew: 4, minTime: 120, category: "heavy", fee: 200, weight: 1000 },
                hotTub: { name: "Hot Tub", crew: 4, minTime: 120, category: "heavy", fee: 200, weight: 800 },
                safe: { name: "Large Safe (500+ lbs)", crew: 4, minTime: 120, category: "heavy", fee: 200, weight: 600 },
                
                // Other
                other: { name: "Other Item", crew: 2, minTime: 60, category: "standard", fee: 0 }
            },
            specialItems: {
                piano: { fee: 200, crew: 3, name: "Piano", time: 1.5 },
                safe: { fee: 200, crew: 4, name: "Safe", time: 1.5 },
                heavyItems: { fee: 150, crew: 3, name: "Heavy Items (300-350lbs)", time: 0.75 },
                gym: { fee: 200, crew: 3, name: "Universal Gym Equipment", time: 1.5 },
                freeWeights: { fee: 100, crew: 3, name: "Free Weights", time: 1.0 },
                treadmill: { fee: 0, crew: 2, name: "Treadmill/Elliptical", time: 0.5 },
                hutch: { fee: 0, crew: 2, name: "China Hutch/Cabinet", time: 0.35 },
                aquarium: { fee: 150, crew: 2, name: "Large Aquarium", time: 0.5 }
            },
            appliances: {
                washer: { fee: 0, time: 0.35, name: "Washer" },
                dryer: { fee: 0, time: 0.35, name: "Dryer" },
                refrigerator: { fee: 0, time: 0.35, name: "Refrigerator" },
                stove: { fee: 0, time: 0.35, name: "Stove" },
                freezer: { fee: 0, time: 0.35, name: "Deep Freezer" }
            },
            // New shop equipment configuration
            shopEquipment: {
                workbench: { fee: 50, crew: 2, time: 0.5, name: "Workbench", weightThreshold: 200 },
                toolChest: { fee: 40, crew: 2, time: 0.3, name: "Large Tool Chest", weightThreshold: 150 },
                tablesaw: { fee: 80, crew: 3, time: 0.75, name: "Table Saw", weightThreshold: 250 },
                airCompressor: { fee: 60, crew: 2, time: 0.4, name: "Air Compressor", weightThreshold: 180 },
                weldingEquipment: { fee: 80, crew: 2, time: 0.5, name: "Welding Equipment", weightThreshold: 200 },
                drillPress: { fee: 100, crew: 3, time: 0.6, name: "Drill Press", weightThreshold: 250 },
                heavyMachinery: { fee: 200, crew: 4, time: 1.0, name: "Heavy Machinery (300+ lbs)", weightThreshold: 300 },
                vehicleLift: { fee: 300, crew: 4, time: 1.5, name: "Vehicle Lift/Hoist", weightThreshold: 500 },
                automotiveEquipment: { fee: 150, crew: 3, time: 0.75, name: "Heavy Automotive Equipment", weightThreshold: 300 }
            },
            // New oversized furniture configuration
            oversizedFurniture: {
                largeSectional: { fee: 40, crew: 2, time: 0.75, name: "Oversized Sectional (10ft+)", weightThreshold: 250 },
                purpleMattress: { fee: 40, crew: 2, time: 0.25, name: "Purple Mattress (Specialty Handling)" },
                tempurPedicMattress: { fee: 40, crew: 2, time: 0.25, name: "Tempur-Pedic Mattress" },
                adjustableBase: { fee: 0, crew: 2, time: 0.5, name: "Adjustable Bed Base" },
                californiaKing: { fee: 40, crew: 2, time: 0.2, name: "California King Mattress" },
                heavyFurniture: { fee: 100, crew: 3, time: 0.5, name: "Heavy Furniture (300+ lbs)", weightThreshold: 300 },
                poolTable: { fee: 200, crew: 4, time: 2.0, name: "Pool Table", weightThreshold: 500 },
                arcadeGame: { fee: 150, crew: 3, time: 0.75, name: "Arcade Game", weightThreshold: 300 },
                largeEntertainmentCenter: { fee: 100, crew: 2, time: 0.75, name: "Large Entertainment Center", weightThreshold: 250 }
            },
            // New access factors configuration
            accessFactors: {
                largeHome: { multiplier: 1.15, name: "Large Home (2600+ sq ft)" },
                longWalk: { multiplier: 1.15, name: "Long Walk (75+ feet from truck)" },
                combinedAccess: { multiplier: 1.25, name: "Large Home + Long Walk" }
            },
            // New TV handling configuration
            tvHandling: {
                tv55to65: { fee: 35, crew: 2, time: 0.3, name: "55-65 inch TV" },
                tv70to75: { fee: 50, crew: 2, time: 0.4, name: "70-75 inch TV" },
                tv80plus: { fee: 75, crew: 3, time: 0.5, name: "80+ inch TV" },
                tvBox55to65: { fee: 55, crew: 0, time: 0, name: "TV Box for 55-65 inch TV" },
                tvBox70to75: { fee: 65, crew: 0, time: 0, name: "TV Box for 70-75 inch TV" },
                tvBox80plus: { fee: 75, crew: 0, time: 0, name: "TV Box for 80+ inch TV" }
            },
            materials: {
                smallBox: { price: 2.59, name: "Small Box (1.5 cu ft)" },
                mediumBox: { price: 3.19, name: "Medium Box (3.0 cu ft)" },
                largeBox: { price: 3.79, name: "Large Box (4.5 cu ft)" },
                wardrobeBox: { price: 14.59, name: "Wardrobe Box" },
                movingBlanket: { price: 14.99, name: "Moving Blanket" },
                packingPaper: { price: 18.99, name: "Packing Paper (10 lb)" },
                packingTape: { price: 6.29, name: "Packing Tape (55yd)" },
                furnitureCover: { price: 6.59, name: "Furniture Cover" },
                dishpack: { price: 9.99, name: "Dish Pack" },
                smallBubbleWrap: { price: 18.99, name: "Small Bubble Wrap" },
                largeBubbleWrap: { price: 18.99, name: "Large Bubble Wrap" },
                twinMattressCover: { price: 6.59, name: "Twin Mattress Cover" },
                twinMattressCoverPremium: { price: 24.99, name: "Twin Mattress Cover (Premium)" },
                fullMattressCover: { price: 7.99, name: "Full/Queen Mattress Cover" },
                fullMattressCoverPremium: { price: 29.99, name: "Full/Queen Mattress Cover (Premium)" },
                kingMattressCover: { price: 8.99, name: "King Mattress Cover" },
                kingMattressCoverPremium: { price: 39.99, name: "King Mattress Cover (Premium)" }
            },
            packingRate: 125 * 1.08, // $125/hr + 8% service fee
            tollCostFactor: 0.08, // Estimated toll cost per mile
            heavyItemFee: 150 // Fee for items over 300lbs
        };

        // Photo suggestions by service type
        const PHOTO_SUGGESTIONS = {
            moving: "üì¶ Furniture and large items | üè† Rooms to be packed | üö™ Stairs and access points | üöõ Parking area",
            labor: "üì¶ Items you need moved | üîß Workspace layout | üö™ Access challenges | üìè Tight spaces",
            single: "üì¶ The item from multiple angles | üìê Size reference (next to door/person) | üö™ Access path | ü™ú Any stairs",
            insurance: "üìã Damaged items | üìÑ Insurance documents | üì∏ Before/after photos | üìù Supporting evidence"
        };

        // Pest control disclaimer text
        const PEST_DISCLAIMER_TEXT = "Customer acknowledges that Worry Free Moving LLC is not responsible for the completion of any services if any pest infestations (including but not limited to bed bugs, roaches, mice, or other insects/rodents) are discovered during or after the moving process. Customer represents that they have disclosed any known pest issues and agrees to hold Worry Free Moving harmless from any pest-related claims or damages. Customer is responsible for proper pest treatment before and after the move.";

        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);

        // Sarah's personality responses
        const SARAH_PERSONALITY = {
            greetings: [
                "Hi! I'm Sarah, your Worry Free Moving assistant! üöö",
                "Hello! I'm Sarah, ready to help make your move worry-free! üè†",
                "Hi there! Sarah here to help with your moving needs! üì¶"
            ],
            expertise: [
                "üí° Pro tip: Book 2-3 weeks ahead for best availability!",
                "‚ö° Quick moves are my specialty - let's get you scheduled!",
                "üí™ Our experienced crews handle moves like this daily!",
                "üèÜ With over 500 successful moves, you're in good hands!"
            ],
            encouragement: [
                "You're making great choices for your move!",
                "This is going to be a smooth relocation!",
                "I can already tell this will be a successful move!",
                "Perfect! You're well on your way to a worry-free move!",
                "Excellent decision! Your items will be in safe hands."
            ],
            thinking: [
                "Let me calculate that for you...",
                "Just a moment while I work this out...",
                "Processing your information...",
                "Analyzing the best options for your move...",
                "Calculating your personalized estimate..."
            ],
            acknowledgments: [
                "Got it!",
                "Perfect!",
                "Excellent!",
                "Great choice!",
                "Understood!",
                "Wonderful!",
                "That's helpful!"
            ],
            excitement: [
                "This is looking great!",
                "You're making excellent choices!",
                "I'm excited to help you with this move!",
                "This is going to be a smooth move!",
                "Your move is shaping up perfectly!"
            ],
            smartRecommendations: {
                heavyItems: "üí° With your heavy items, I recommend a 4-person crew for safety and efficiency",
                longDistance: "üöÄ For moves over 50 miles, consider our Full Value Protection",
                lastMinute: "‚ö° For last-minute moves, I recommend calling right after this estimate",
                packingTip: "üí° For a 3+ bedroom move, most customers find our packing materials save time",
                accessChallenge: "üè† Large homes with long walks require additional time - I've adjusted your estimate"
            }
        };

        // Sales messages
        const SALES_MESSAGES = {
            trust: [
                "‚≠ê We're rated 4.8/5 stars with over 500 happy customers!",
                "üèÜ Family-owned and operated since 2019",
                "‚úÖ Fully licensed and insured for your peace of mind",
                "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ We've helped over 2,000 families move stress-free!"
            ],
            urgency: [
                "üî• Our schedule is filling up fast for this week!",
                "üìÖ We only have a few spots left this week",
                "‚è∞ Book now to lock in this rate",
                "üéØ This estimate is valid for 7 days"
            ]
        };

        // Navigation history for back functionality
        let navigationHistory = [];
        let currentHistoryIndex = -1;

        // Flag to prevent duplicate event listeners
        let printListenersInitialized = false;

        // Chat state with default structure
        let chatState = {
            stage: 'greeting',
            serviceType: null,
            data: {
                pestDisclaimerAgreed: false,
                pestDisclaimerTimestamp: null,
                shopEquipment: [],
                oversizedFurniture: [],
                tvHandling: [],
                homeSize: null,
                accessObstacles: [],
                heavyItemFees: 0,
                accessMultiplier: 1.0,
                photos: [],
                hasPhotos: false,
                photoCategory: null,
                // New location-based structure for moving service
                location1Details: {
                    address: null,
                    homeType: null,
                    bedrooms: null,
                    stairs: 0,
                    isLarge: false,
                    hasChallenges: false
                },
                location2Details: {
                    address: null,
                    homeType: null,
                    bedrooms: null,
                    stairs: 0,
                    isLarge: false,
                    hasChallenges: false
                },
                location3Details: {
                    address: null,
                    homeType: null,
                    bedrooms: null,
                    stairs: 0,
                    isLarge: false,
                    hasChallenges: false,
                    type: null,
                    action: null
                },
                largeHomeLocations: [],
                challengeLocations: [],
                currentLocationBeingConfigured: 1
            },
            messages: [],
            messageCount: 0,
            directionsService: null,
            geocoder: null,
            autocompleteService: null,
            sessionToken: null,
            isOpen: false,
            hasBeenOpened: false,
            conversationStarted: false,
            keyboardOpen: false,
            pendingAutoSubmit: null,
            autoSubmitTimeoutId: null,
            quoteSubmitted: false,
            isAutoSubmit: false,
            uploadedPhotos: [],
            isUploadingPhoto: false
        };

        // DOM elements
        const container = document.getElementById('wfm-chat-container');
        const widget = document.getElementById('wfm-chat-widget');
        const toggle = document.getElementById('wfm-chat-toggle');
        const close = document.getElementById('wfm-chat-close');
        const messages = document.getElementById('wfm-chat-messages');
        const navigation = document.getElementById('wfm-chat-navigation');
        const backButton = document.getElementById('wfm-chat-back');
        const options = document.getElementById('wfm-chat-options');
        const inputArea = document.getElementById('wfm-chat-input-area');
        const input = document.getElementById('wfm-chat-input');
        let send = document.getElementById('wfm-chat-send');
        const autocompleteResults = document.getElementById('wfm-autocomplete-results');
        
        // Date picker elements
const datePickerContainer = document.getElementById('wfm-date-picker-container');
const datePickerInput = document.getElementById('wfm-date-picker');
let dateConfirmBtn, dateCancelBtn;

        // Payment elements
        const paymentContainer = document.getElementById('wfm-payment-container');
        const paymentBackBtn = document.getElementById('wfm-payment-back');

        // Event delegation for pest disclaimer checkbox
        messages.addEventListener('click', (e) => {
            const checkbox = e.target.closest('#pest-disclaimer-checkbox');
            if (checkbox && !checkbox.classList.contains('checked')) {
                console.log('Pest disclaimer clicked via delegation');
                chatState.data.pestDisclaimerAgreed = true;
                chatState.data.pestDisclaimerTimestamp = new Date().toISOString();
                checkbox.classList.add('checked');
                checkbox.innerHTML = '‚úÖ I agree to the terms above';
                
                // Show continue button
                showOptions([
                    { text: "Continue", value: "continue_after_disclaimer", primary: true }
                ]);
                saveSession();
            }
        });

        // Global file input for photo uploads
        let globalFileInput = null;

        // Initialize global file input
        function initializeGlobalFileInput() {
            if (!globalFileInput) {
                globalFileInput = document.createElement('input');
                globalFileInput.type = 'file';
                globalFileInput.accept = 'image/*';
                globalFileInput.multiple = true;
                globalFileInput.style.display = 'none';
                document.body.appendChild(globalFileInput);
                
                // Add change event listener
                globalFileInput.addEventListener('change', handlePhotoSelection);
            }
        }

        // Event delegation for photo upload clicks
        messages.addEventListener('click', (e) => {
            // Check if clicked element is within photo upload container
            const uploadContainer = e.target.closest('.photo-upload-container');
            const uploadButton = e.target.closest('.photo-upload-button');
            const removeButton = e.target.closest('.remove-photo');
            
            if (removeButton) {
                e.preventDefault();
                e.stopPropagation();
                const index = parseInt(removeButton.dataset.index);
                removePhoto(index);
            } else if (uploadContainer || uploadButton) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Photo upload clicked');
                
                // Trigger file input
                if (globalFileInput) {
                    globalFileInput.value = ''; // Reset input
                    globalFileInput.click();
                } else {
                    console.error('Global file input not initialized');
                }
            }
        });

        // Photo Upload Functions
        function showPhotoUpload() {
            const category = chatState.data.photoCategory || chatState.serviceType;
            const suggestions = PHOTO_SUGGESTIONS[category] || PHOTO_SUGGESTIONS.moving;
            
            const uploadHtml = `
                <div class="photo-upload-container" id="photo-upload-dropzone">
                    <div class="photo-upload-icon">üì∏</div>
                    <div class="photo-upload-text">
                        ${isMobile ? 'Tap to take or select photos' : 'Click to upload photos'}
                    </div>
                    <button class="photo-upload-button" type="button">
                        <span>üì∑</span> Add Photos
                    </button>
                    <div class="photo-count-indicator">
                        ${chatState.data.photos.length}/${CONFIG.maxPhotos} photos
                    </div>
                </div>
                <div class="photo-preview-container" id="photo-preview-container"></div>
                ${chatState.data.photos.length > 0 ? '' : `
                    <div class="highlight-box" style="margin-top: 10px;">
                        <strong>Suggested photos:</strong><br>
                        ${suggestions}
                    </div>
                `}
            `;
            
            showBotMessage(uploadHtml);
            
            // Show continue/skip options
            const optionButtons = chatState.data.photos.length > 0 ? [
                { text: "Continue with photos", value: "proceed_with_photos", primary: true },
                { text: "Add more photos", value: "add_more_photos" }
            ] : [
                { text: "Skip photos", value: "proceed_without_photos" },
                { text: "Add photos", value: "add_photos", primary: true }
            ];
            
            showOptions(optionButtons);
            
            // Render existing photos
            renderPhotoThumbnails();
            
            // Setup drag and drop for desktop
            if (!isMobile) {
                setupDragAndDrop();
            }
        }

        function setupDragAndDrop() {
            const dropzone = document.getElementById('photo-upload-dropzone');
            if (!dropzone) return;
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragging');
            });
            
            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragging');
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragging');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handlePhotoSelection({ target: { files } });
                }
            });
        }

        async function handlePhotoSelection(event) {
            const files = Array.from(event.target.files);
            const remainingSlots = CONFIG.maxPhotos - chatState.data.photos.length;
            
            if (remainingSlots <= 0) {
                showBotMessage(`<div class="photo-upload-error">
                    You've reached the maximum of ${CONFIG.maxPhotos} photos. 
                    Please remove some photos to add new ones.
                </div>`);
                return;
            }
            
            const filesToUpload = files.slice(0, remainingSlots);
            
            // Validate files
            for (const file of filesToUpload) {
                if (!file.type.startsWith('image/')) {
                    showBotMessage(`<div class="photo-upload-error">
                        "${file.name}" is not a valid image file. Please select only image files.
                    </div>`);
                    continue;
                }
                
                if (file.size > CONFIG.maxFileSize) {
                    showBotMessage(`<div class="photo-upload-error">
                        "${file.name}" is too large. Maximum file size is 10MB.
                    </div>`);
                    continue;
                }
                
                // Upload to Cloudinary
                await uploadToCloudinary(file);
            }
        }

        async function uploadToCloudinary(file) {
            if (chatState.isUploadingPhoto) return;
            
            chatState.isUploadingPhoto = true;
            
            // Show uploading indicator
            showBotMessage(`<div class="sending-indicator">
                <div class="spinner"></div>
                Uploading ${file.name}...
            </div>`);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CONFIG.cloudinary.uploadPreset);
            formData.append('folder', `${CONFIG.cloudinary.folder}/${chatState.serviceType}`);
            
            // Add metadata
            const metadata = {
                customer: chatState.data.firstName || 'Unknown',
                service_type: chatState.serviceType,
                upload_source: 'worry_free_moving_chatbot',
                timestamp: new Date().toISOString()
            };
            formData.append('context', JSON.stringify(metadata));
            
            try {
                const response = await fetch(CONFIG.cloudinary.apiUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                // Add photo to state
                const photoData = {
                    url: data.secure_url,
                    publicId: data.public_id,
                    filename: file.name,
                    uploadedAt: new Date().toISOString(),
                    category: chatState.data.photoCategory || chatState.serviceType
                };
                
                chatState.data.photos.push(photoData);
                chatState.data.hasPhotos = true;
                
                // Success message
                showBotMessage(`<div class="photo-upload-success">
                    ‚úÖ Photo uploaded successfully!
                </div>`);
                
                // Refresh photo display
                showPhotoUpload();
                
            } catch (error) {
                console.error('Upload error:', error);
                showBotMessage(`<div class="photo-upload-error">
                    ‚ùå Failed to upload photo. You can try again or continue without photos.
                    <br><br>
                    üí° Tip: You can also email photos to ${CONFIG.email}
                </div>`);
            } finally {
                chatState.isUploadingPhoto = false;
                saveSession();
            }
        }

        function renderPhotoThumbnails() {
            const container = document.getElementById('photo-preview-container');
            if (!container || chatState.data.photos.length === 0) return;
            
            container.innerHTML = chatState.data.photos.map((photo, index) => `
                <div class="photo-preview-item">
                    <img src="${photo.url}" alt="${photo.filename}">
                    <button class="remove-photo" data-index="${index}">√ó</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            chatState.data.photos.splice(index, 1);
            if (chatState.data.photos.length === 0) {
                chatState.data.hasPhotos = false;
            }
            saveSession();
            showPhotoUpload();
        }

        function proceedWithPhotos() {
            showBotMessage(`Great! I've added ${chatState.data.photos.length} photo${chatState.data.photos.length > 1 ? 's' : ''} to help our crew prepare properly.`);
            continueAfterPhotos();
        }

        function proceedWithoutPhotos() {
            showBotMessage("No problem! You can always email photos later if needed.");
            continueAfterPhotos();
        }

        // FIXED: Continue after photos for all service types
        function continueAfterPhotos() {
            // Continue with the appropriate flow based on service type and current stage
            if (chatState.serviceType === 'moving') {
                // Continue to special items
                proceedToSpecialItems();
            } else if (chatState.serviceType === 'labor') {
                // Show final estimate - this will automatically go to booking options
                calculateAndShowEstimate();
            } else if (chatState.serviceType === 'single') {
                // For single items, we have everything we need
                calculateAndShowEstimate();
            } else if (chatState.serviceType === 'cleanout' && chatState.stage === 'junk_photos') {
                // Junk removal photos - ask for crew size
                chatState.stage = 'junk_crew';
                showBotMessage("How many crew members do you think you'll need?");
                showOptions([
                    { text: "2 crew members (standard)", value: "2" },
                    { text: "3 crew members", value: "3" },
                    { text: "4 crew members", value: "4" }
                ]);
                saveSession();
            } else if (chatState.stage === 'insurance_photos' || chatState.stage === 'photo_upload_claims') {
                // Insurance claim photos - continue to move date
                chatState.stage = 'move_details_verification';
                showBotMessage("What was your move date?");
                showDatePicker();
                saveSession();
            }
        }

        // Helper function to proceed to photos for labor service
        function proceedToLaborPhotos() {
            // Calculate heavy item fees
            calculateHeavyItemFees();

            // Show summary of heavy items if any
            const totalHeavyItems = chatState.data.shopEquipment.length + chatState.data.oversizedFurniture.length;
            if (totalHeavyItems > 0) {
                const heavyCount = chatState.data.heavyItemCount || 0;
                showBotMessage(`Got it! I've noted ${totalHeavyItems} heavy item${totalHeavyItems > 1 ? 's' : ''}.${heavyCount > 0 ? ` ${heavyCount} of these are extra heavy (300+ lbs) and will have a $${CONFIG.heavyItemFee} surcharge each.` : ''}`);
            }

            // Proceed to photos
            setTimeout(() => {
                chatState.stage = 'offer_photos_labor';
                chatState.data.photoCategory = 'labor';
                showBotMessage("Would you like to add photos? This helps our crew come prepared with proper tools.");
                showBotMessage(PHOTO_SUGGESTIONS.labor, 800);
                setTimeout(() => {
                    showPhotoUpload();
                }, 1500);
            }, totalHeavyItems > 0 ? 1200 : 500);
        }

        // Helper validation functions
        function hasCompleteContactInfo() {
            return chatState.data.firstName && 
                   chatState.data.lastName && 
                   chatState.data.email && 
                   chatState.data.phone;
        }

        function validateEmail(email) {
            return email.includes('@') && email.includes('.') && email.length > 5;
        }

        function validatePhone(phone) {
            // Accept various phone formats
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length >= 10;
        }

        function parseFullName(fullName) {
            const parts = fullName.trim().split(/\s+/);
            if (parts.length >= 2) {
                const firstName = parts[0];
                const lastName = parts.slice(1).join(' ');
                return { firstName, lastName };
            }
            return null;
        }

        // Calculate heavy item fees
        function calculateHeavyItemFees() {
            let fees = 0;
            let heavyItemCount = 0;
            
            // Check shop equipment
            chatState.data.shopEquipment.forEach(item => {
                const equipment = CONFIG.shopEquipment[item];
                if (equipment && equipment.weightThreshold >= 300) {
                    fees += CONFIG.heavyItemFee;
                    heavyItemCount++;
                }
            });
            
            // Check oversized furniture
            chatState.data.oversizedFurniture.forEach(item => {
                const furniture = CONFIG.oversizedFurniture[item];
                if (furniture && furniture.weightThreshold >= 300) {
                    fees += CONFIG.heavyItemFee;
                    heavyItemCount++;
                }
            });
            
            chatState.data.heavyItemFees = fees;
            chatState.data.heavyItemCount = heavyItemCount;
            
            return { fees, count: heavyItemCount };
        }

        // Check if move date is same day
        function isSameDay(moveDateString) {
            const moveDate = parseDate(moveDateString);
            const today = new Date();
            
            return moveDate.getDate() === today.getDate() &&
                   moveDate.getMonth() === today.getMonth() &&
                   moveDate.getFullYear() === today.getFullYear();
        }

        // Smart crew recommendations
        function getSmartCrewRecommendation() {
            let recommendedCrew = 2;
            let reasons = [];
            let hasStairsWithProhibitedItems = false;
            let prohibitedItems = [];

            // NEW: Check for items we don't move
            const selectedSpecialtyItems = chatState.data.selectedSpecialtyItems || [];
            const oversizedFurniture = chatState.data.oversizedFurniture || [];
            const hasAnyStairs = (chatState.data.stairsFrom || 0) + (chatState.data.stairsTo || 0) + (chatState.data.stairsThird || 0) > 0;

            // Pool tables and hot tubs - we don't move these at all
            if (oversizedFurniture.includes('poolTable')) {
                prohibitedItems.push('pool tables');
            }
            if (selectedSpecialtyItems.includes('hotTub') || oversizedFurniture.includes('hotTub')) {
                prohibitedItems.push('hot tubs');
            }

            // Safes with stairs - we don't move
            if ((chatState.data.specialItems === 'safe' || selectedSpecialtyItems.includes('safe')) && hasAnyStairs) {
                prohibitedItems.push('safes with stairs');
                hasStairsWithProhibitedItems = true;
            }

            // Sheds - we don't move
            if (selectedSpecialtyItems.includes('shed')) {
                prohibitedItems.push('sheds');
            }

            // If there are prohibited items, return special message
            if (prohibitedItems.length > 0) {
                let message = '';
                if (prohibitedItems.includes('pool tables') || prohibitedItems.includes('hot tubs')) {
                    message = `We do not move ${prohibitedItems.filter(i => i === 'pool tables' || i === 'hot tubs').join(' or ')}. Please call 330-435-8686 if you need recommendations for specialists.`;
                }
                if (prohibitedItems.includes('safes with stairs') || prohibitedItems.includes('sheds')) {
                    const stairItems = prohibitedItems.filter(i => i === 'safes with stairs' || i === 'sheds');
                    if (message) message += ' ';
                    message += `We cannot move ${stairItems.join(' or ')}${hasStairsWithProhibitedItems ? '' : '. For moves without stairs, please call us at 330-435-8686 for a custom quote.'}`;
                }

                return {
                    crew: 0,
                    reasons: [],
                    message: message,
                    prohibited: true
                };
            }

            // NEW: Phase 5 - Heavy Item Crew Requirements
            // Items over 300 lbs: Eliminate 2-person crew option
            const hasItemsOver300lbs = selectedSpecialtyItems.some(item => {
                const config = CONFIG.specialItems[item] || CONFIG.shopEquipment[item] || CONFIG.oversizedFurniture[item];
                return config && config.weight && config.weight > 300;
            });

            // Spinet pianos and select lighter specialty items: Can use 3-person crew
            if (chatState.data.specialItems === 'piano' && !hasItemsOver300lbs) {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("spinet piano requires 3-person crew minimum");
            }

            // All other heavy items (safes, gun safes, heavy pianos): Must use 4-person crew minimum
            if (chatState.data.specialItems === 'safe') {
                recommendedCrew = Math.max(recommendedCrew, 4);
                reasons.push("safe requires 4-person crew");
            } else if (chatState.data.specialItems === 'gym') {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("heavy equipment requires 3+ crew");
            }

            // Heavy items over 300 lbs require at least 3-person crew
            if (hasItemsOver300lbs) {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("heavy items over 300lbs require 3+ crew");
            }

            // Check appliances count
            const totalAppliances = (chatState.data.appliances?.length || 0) +
                                  (chatState.data.thirdLocationAppliances?.length || 0);
            if (totalAppliances >= 4) {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("multiple appliances");
            }

            // Check heavy shop equipment
            const hasHeavyEquipment = chatState.data.shopEquipment?.some(item =>
                CONFIG.shopEquipment[item]?.weightThreshold >= 300
            );
            if (hasHeavyEquipment) {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("heavy shop equipment");
            }

            // Check for large home
            if (chatState.data.homeSize === 'large' || chatState.data.bedrooms >= 4) {
                recommendedCrew = Math.max(recommendedCrew, 3);
                reasons.push("large home");
            }

            return {
                crew: recommendedCrew,
                reasons: reasons,
                message: reasons.length > 0 ?
                    `üí° Based on your ${reasons.join(", ")}, I recommend a ${recommendedCrew}-person crew for safety and efficiency` :
                    null,
                prohibited: false
            };
        }
// Fail-safe: Re-attach send button listener after a short delay
setTimeout(() => {
    const sendBtn = document.getElementById('wfm-chat-send');
    const inputField = document.getElementById('wfm-chat-input');
    
    if (sendBtn && inputField) {
        // Remove any existing listeners to avoid duplicates
        const newSendBtn = sendBtn.cloneNode(true);
        sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
        
        // Re-attach listener
        newSendBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handleSend();
        });
        
        // Re-cache the element reference
        send = newSendBtn;
        
        // Also ensure input keypress works
        inputField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
    }
}, 100);
        // FIXED: Auto-submit functions with timeout handling
       async function autoSubmitQuote() {
    // If quote already submitted, just return success
    if (chatState.data.quoteSubmitted) {
        return true;
    }
    
    // Clear any existing timeout
    if (chatState.autoSubmitTimeoutId) {
        clearTimeout(chatState.autoSubmitTimeoutId);
        chatState.autoSubmitTimeoutId = null;
    }
    
    // Mark as auto-submit
    chatState.data.isAutoSubmit = true;
    
    // Check if we already have all contact info AND haven't submitted yet
    if (hasCompleteContactInfo() && !chatState.data.quoteSubmitted) {
        // We have all info, just submit
        showBotMessage("üìß Sending your personalized quote...");
        await submitLead();
        chatState.data.quoteSubmitted = true;
        saveSession();
        return true;
    }
    
    // Set timeout for auto-submit
    const timeoutPromise = new Promise((resolve, reject) => {
        chatState.autoSubmitTimeoutId = setTimeout(() => {
            reject(new Error('Auto-submit timeout'));
        }, CONFIG.autoSubmitTimeout);
    });
    
    try {
        // Check if we have contact info, collect if needed
        if (!hasCompleteContactInfo()) {
            // Race between collecting info and timeout
            await Promise.race([
                collectMissingContactInfo(),
                timeoutPromise
            ]);
        }
        
        // Clear timeout if we got here successfully
        if (chatState.autoSubmitTimeoutId) {
            clearTimeout(chatState.autoSubmitTimeoutId);
            chatState.autoSubmitTimeoutId = null;
        }
        
        // Only submit if not already submitted
        if (!chatState.data.quoteSubmitted) {
            showBotMessage("üìß Sending your personalized quote...");
            await submitLead();
            chatState.data.quoteSubmitted = true;
            saveSession();
            return true; // Successfully submitted
        }
        return false; // Already submitted
    } catch (error) {
        // Handle timeout or other errors
        console.error('Auto-submit error:', error);
        if (chatState.pendingAutoSubmit) {
            chatState.pendingAutoSubmit = null;
        }
        showBotMessage("We'll need your contact info to send the quote. You can provide it now or call us directly.");
        return false;
    }
}

        async function collectMissingContactInfo() {
            return new Promise((resolve) => {
                // Set flag to resolve promise after contact collection
                chatState.data.pendingAutoSubmit = resolve;
                
                if (!chatState.data.firstName || !chatState.data.lastName) {
                    chatState.stage = 'collect_full_name';
                    showBotMessage("I'll need your full name to proceed:");
                    showInput("Enter your first and last name...");
                } else if (!chatState.data.email) {
                    chatState.stage = 'collect_email_required';
                    showBotMessage("What's your email address?");
                    showInput("Enter your email...");
                } else if (!chatState.data.phone) {
                    chatState.stage = 'collect_phone_required';
                    showBotMessage("And your phone number?");
                    showInput("Enter your phone number...");
                }
            });
        }

        // Navigation management functions
        function saveNavigationState() {
            const state = {
                stage: chatState.stage,
                serviceType: chatState.serviceType,
                data: JSON.parse(JSON.stringify(chatState.data)), // Deep copy
                messageCount: chatState.messageCount
            };
            
            // If we're not at the end of history, remove future states
            if (currentHistoryIndex < navigationHistory.length - 1) {
                navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
            }
            
            navigationHistory.push(state);
            currentHistoryIndex = navigationHistory.length - 1;
            updateNavigationButtons();
        }

        // FIXED: Remove pest_disclaimer from restricted stages
        function canGoBack() {
            const restrictedStages = ['show_booking_options', 'get_email', 'get_phone', 
                                    'collect_email_required', 'collect_phone_required'];
            return currentHistoryIndex > 0 && !restrictedStages.includes(chatState.stage);
        }

        function updateNavigationButtons() {
            if (canGoBack()) {
                navigation.style.display = 'block';
            } else {
                navigation.style.display = 'none';
            }
        }

        // FIXED goBack function to properly restore UI state
        function goBack() {
            if (!canGoBack()) return;
            
            currentHistoryIndex--;
            const previousState = navigationHistory[currentHistoryIndex];
            
            // Restore state
            chatState.stage = previousState.stage;
            chatState.serviceType = previousState.serviceType;
            chatState.data = JSON.parse(JSON.stringify(previousState.data)); // Deep copy
            
            // Remove recent messages
            const messagesToRemove = chatState.messageCount - previousState.messageCount;
            for (let i = 0; i < messagesToRemove; i++) {
                chatState.messages.pop();
            }
            chatState.messageCount = previousState.messageCount;
            
            // Restore UI
            restoreMessages();
            
            // IMPORTANT: Restore the interactive UI state
            setTimeout(() => {
                restoreUIState();
                updateNavigationButtons();
            }, 100); // Small delay to ensure messages are rendered first
            
            saveSession();
        }

        // FIXED Date picker functions to allow past dates for insurance claims
        function showDatePicker() {
            // Hide other inputs
            options.innerHTML = '';
            inputArea.style.display = 'none';
            
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            
            // For insurance claims, allow past dates
            if (chatState.stage === 'move_details_verification') {
                // Allow dates from 1 year ago
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const minDD = String(oneYearAgo.getDate()).padStart(2, '0');
                const minMM = String(oneYearAgo.getMonth() + 1).padStart(2, '0');
                const minYYYY = oneYearAgo.getFullYear();
                datePickerInput.min = minYYYY + '-' + minMM + '-' + minDD;
                datePickerInput.max = yyyy + '-' + mm + '-' + dd; // Can't be future
            } else {
                // For regular moves, only allow future dates
                datePickerInput.min = yyyy + '-' + mm + '-' + dd;
                datePickerInput.removeAttribute('max'); // No max for future moves
            }
            
            datePickerInput.value = '';
            
            // Show date picker
            datePickerContainer.style.display = 'block';
            
            // Focus on date input (desktop only)
            if (!isMobile) {
                datePickerInput.focus();
            }
        }

        function hideDatePicker() {
            datePickerContainer.style.display = 'none';
        }

       function handleDateConfirm() {
    const selectedDate = datePickerInput.value;
    if (selectedDate) {
        hideDatePicker();
        
        // Format the date nicely
        const date = new Date(selectedDate + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);
        
        // Show in chat
        showUserMessage(formattedDate);
        
        // Debug log
        console.log('Current stage:', chatState.stage);
        console.log('Service type:', chatState.serviceType);
        
        // Process the date
        processResponse(formattedDate);
    }
}

        function handleDateCancel() {
            hideDatePicker();
            // Show input again
            showInput("Enter your preferred date...");
        }

        // Square Payment Functions
        let squarePayments = null;
        let squareCard = null;

        async function showPaymentModal() {
            const paymentContainer = document.getElementById('wfm-payment-container');
            if (!paymentContainer) return;

            // Hide chat elements
            messages.style.display = 'none';
            navigation.style.display = 'none';
            options.style.display = 'none';
            inputArea.style.display = 'none';

            // Get estimate total
            const estimateTotal = parseFloat(chatState.data.estimate?.total || 0);

            // Update payment summary
            const summaryEl = document.getElementById('payment-estimate-summary');
            const totalEl = document.getElementById('payment-total-amount');

            if (summaryEl && totalEl) {
                summaryEl.innerHTML = `
                    <div style="margin: 10px 0;">
                        <div style="font-size: 14px; color: #666;">Estimated Total</div>
                        <div style="font-size: 18px; font-weight: 600; color: #004085;">$${estimateTotal}</div>
                    </div>
                `;
                totalEl.textContent = `$${estimateTotal}`;
            }

            // Show payment container
            paymentContainer.style.display = 'flex';

            // Initialize Square Payments
            await initializeSquarePayments();
        }

        async function initializeSquarePayments() {
            try {
                // Wait for Square SDK to load (with timeout)
                let attempts = 0;
                while (!window.Square && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.Square) {
                    throw new Error('Square SDK not loaded after waiting');
                }

                console.log('‚úÖ Square SDK loaded successfully');

                // Check if we're on HTTPS or localhost (Square Web SDK requirement)
                // Explicitly exclude file:// protocol which is not secure
                const isSecureContext = window.location.protocol !== 'file:' &&
                                       (window.isSecureContext ||
                                        window.location.protocol === 'https:' ||
                                        window.location.hostname === 'localhost');

                if (!isSecureContext) {
                    console.warn('‚ö†Ô∏è Square Web SDK requires HTTPS. Skipping payment card initialization for non-secure context.');
                    // Hide payment form, show alternative message
                    const cardContainer = document.getElementById('card-container');
                    if (cardContainer) {
                        cardContainer.innerHTML = `
                            <div style="padding: 20px; background: #fff3cd; border-radius: 8px; text-align: center;">
                                <p style="margin: 0 0 10px 0; color: #856404;">üí≥ Card payment requires a secure connection (HTTPS).</p>
                                <p style="margin: 0; color: #856404; font-size: 14px;">Please contact us to complete payment: <strong>${CONFIG.phone}</strong></p>
                            </div>
                        `;
                    }
                    return; // Skip Square initialization
                }

                // Initialize Square Payments
                squarePayments = window.Square.payments(
                    CONFIG.square.applicationId,
                    CONFIG.square.locationId
                );

                // Initialize card payment method with styling
                squareCard = await squarePayments.card({
                    style: {
                        input: {
                            fontSize: '16px'
                        },
                        '.input-container': {
                            borderColor: '#e2e8f0',
                            borderRadius: '8px'
                        }
                    },
                    includeInputLabels: true
                });

                await squareCard.attach('#card-container');
                console.log('‚úÖ Square Card form attached');

                // Setup payment button (only add listener once)
                const cardButton = document.getElementById('card-button');
                if (cardButton && !cardButton.dataset.listenerAdded) {
                    cardButton.addEventListener('click', handlePaymentSubmit);
                    cardButton.dataset.listenerAdded = 'true';
                }

                // Setup skip button
                const skipButton = document.getElementById('skip-card-button');
                if (skipButton && !skipButton.dataset.listenerAdded) {
                    skipButton.addEventListener('click', handleSkipCard);
                    skipButton.dataset.listenerAdded = 'true';
                }

            } catch (error) {
                console.error('‚ùå Failed to initialize Square Payments:', error);

                // Check if it's the HTTPS error specifically
                if (error.message && error.message.includes('secure context')) {
                    showPaymentStatus('Card payment requires HTTPS. Please call us at ' + CONFIG.phone + ' to complete booking.', 'error');
                } else {
                    showPaymentStatus('Failed to load payment system. Please try again or contact us at ' + CONFIG.phone, 'error');
                }
            }
        }

        async function handlePaymentSubmit() {
            const cardButton = document.getElementById('card-button');
            const statusContainer = document.getElementById('payment-status-container');

            try {
                // Disable button
                cardButton.disabled = true;
                cardButton.textContent = '‚è≥ Processing...';
                statusContainer.style.display = 'none';

                // Tokenize card details
                console.log('Tokenizing card...');
                const result = await squareCard.tokenize();

                if (result.status === 'OK') {
                    console.log('‚úÖ Card tokenized successfully');
                    // Send token to backend to store card on file
                    await processPayment(result.token, result.details);
                } else {
                    console.error('‚ùå Tokenization failed:', result.errors);
                    let errorMessage = 'Card validation failed. Please check your card details.';
                    if (result.errors && result.errors.length > 0) {
                        errorMessage = result.errors.map(e => e.message).join(', ');
                    }
                    showPaymentStatus(errorMessage, 'error');
                    cardButton.disabled = false;
                    cardButton.textContent = 'üíæ Save Card Securely';
                }
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                showPaymentStatus('An error occurred. Please try again.', 'error');
                cardButton.disabled = false;
                cardButton.textContent = 'üíæ Save Card Securely';
            }
        }

        async function processPayment(token, cardDetails) {
            const customerEmail = chatState.data.email;
            const customerName = `${chatState.data.firstName} ${chatState.data.lastName}`;

            try {
                console.log('üì§ Sending card to backend to store on file...');
                console.log('API URL:', CONFIG.square.apiUrl);
                console.log('Token:', token);

                const requestBody = {
                    customerData: {
                        firstName: chatState.data.firstName,
                        lastName: chatState.data.lastName,
                        email: chatState.data.email,
                        phone: chatState.data.phone,
                        movingDate: chatState.data.formattedDate || chatState.data.movingDate
                    },
                    cardToken: token,
                    estimate: chatState.data.estimate
                };

                console.log('Request payload:', JSON.stringify(requestBody, null, 2));

                // Call the backend API to create Square customer and store card
                const response = await fetch(CONFIG.square.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                const responseText = await response.text();
                console.log('Response body (raw):', responseText);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(`Server error (${response.status}): ${responseText}`);
                    }
                    throw new Error(errorData.error || errorData.details || `Failed to save card (${response.status})`);
                }

                const result = JSON.parse(responseText);
                console.log('‚úÖ Card saved successfully:', result);

                // Store card info in session
                chatState.data.cardSaved = true;
                chatState.data.customerId = result.customerId;
                chatState.data.cardId = result.cardId;
                chatState.data.cardLast4 = result.cardLast4;
                chatState.data.cardBrand = result.cardBrand;
                saveSession();

                showPaymentStatus(`‚úÖ ${result.message || 'Card saved successfully!'}`, 'success');

                // Send confirmation email and create booking
                setTimeout(() => {
                    submitLead().then(() => {
                        setTimeout(() => {
                            hidePaymentModal();
                            showBotMessage("üéâ Perfect! Your card is securely saved.");
                            showBotMessage(`Payment method saved: ${result.cardBrand} ending in ${result.cardLast4}`);

                            // Store Square customer ID for booking
                            chatState.data.squareCustomerId = result.customerId;
                            saveSession();

                            // Redirect to booking portal to finalize booking
                            setTimeout(() => {
                                showBotMessage("Now let's finalize your booking details and check real-time availability...");
                                setTimeout(() => {
                                    const bookingURL = buildBookingPortalURL();
                                    console.log('Redirecting to booking portal:', bookingURL);
                                    window.location.href = bookingURL;
                                }, 1500);
                            }, 1500);
                        }, 1500);
                    });
                }, 2000);

            } catch (error) {
                console.error('‚ùå Failed to save card:', error);
                showPaymentStatus(`Failed to save payment method: ${error.message}`, 'error');

                // Re-enable button
                const cardButton = document.getElementById('card-button');
                if (cardButton) {
                    cardButton.disabled = false;
                    cardButton.textContent = 'üíæ Save Card Securely';
                }
            }
        }

        function showPaymentStatus(message, type) {
            const statusContainer = document.getElementById('payment-status-container');
            statusContainer.textContent = message;
            statusContainer.className = type === 'success' ? 'payment-success' : 'payment-error';
            statusContainer.style.display = 'block';
        }

        function hidePaymentModal() {
            const paymentContainer = document.getElementById('wfm-payment-container');
            if (!paymentContainer) return;

            // Hide payment container
            paymentContainer.style.display = 'none';

            // Show chat elements again
            messages.style.display = 'block';
            navigation.style.display = 'block';
            options.style.display = 'block';
            inputArea.style.display = 'flex';

            // Restore UI state
            restoreUIState();
        }

        // Handle skipping card collection
        function handleSkipCard() {
            console.log('User skipped card collection');

            // Mark that card was skipped
            chatState.data.cardSaved = false;
            chatState.data.cardSkipped = true;
            saveSession();

            // Hide payment modal
            hidePaymentModal();

            // Show message
            showBotMessage("No problem! You can pay after your move is complete.");

            // Redirect to booking portal to finalize booking
            setTimeout(() => {
                showBotMessage("Now let's finalize your booking details and check real-time availability...");

                setTimeout(() => {
                    const bookingURL = buildBookingPortalURL();
                    console.log('Redirecting to booking portal:', bookingURL);
                    window.location.href = bookingURL;
                }, 1500);
            }, 1000);
        }

        // Expose to global scope for inline onclick handler
        window.handleSkipCard = handleSkipCard;

        // Ask for available time slot
        function askForTimeSlot() {
            chatState.stage = 'select_time';

            showBotMessage("What time works best for you?");

            const timeSlots = [
                { text: 'üåÖ 8:00 AM - 10:00 AM', value: '08:00' },
                { text: 'üåû 10:00 AM - 12:00 PM', value: '10:00' },
                { text: '‚òÄÔ∏è 12:00 PM - 2:00 PM', value: '12:00' },
                { text: 'üå§Ô∏è 2:00 PM - 4:00 PM', value: '14:00' }
            ];

            showOptions(timeSlots);
        }

        // Show final booking confirmation
        function showFinalConfirmation() {
            const moveDate = chatState.data.movingDate || chatState.data.selectedDate;
            const moveTime = chatState.data.selectedTime || '09:00';
            const total = chatState.data.estimate?.total || 0;
            const serviceType = chatState.serviceType || 'moving';

            const dateObj = new Date(moveDate + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            chatState.stage = 'final_confirmation';

            showBotMessage("Perfect! Let me confirm all the details:");

            setTimeout(() => {
                const confirmMessage = `
üìã <strong>Booking Summary:</strong>
üë§ ${chatState.data.firstName} ${chatState.data.lastName}
üìß ${chatState.data.email}
üìû ${chatState.data.phone}

üìÖ Date: ${formattedDate}
üïê Estimated Arrival: ${formatTime(moveTime)}
üöö Service: ${getServiceTypeName(serviceType)}
üí∞ Estimated Total: $${total.toFixed(2)}

${chatState.data.from ? `üìç From: ${chatState.data.from}` : ''}
${chatState.data.to ? `üìç To: ${chatState.data.to}` : ''}
                `;

                showBotMessage(confirmMessage);

                setTimeout(() => {
                    showOptions([
                        { text: '‚úÖ Confirm & Book', value: 'confirm_booking', primary: true },
                        { text: '‚úèÔ∏è Make Changes', value: 'edit_booking' }
                    ]);
                }, 1000);
            }, 500);
        }

        // Format time for display
        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Build booking portal URL with customer data
        function buildBookingPortalURL() {
            const params = new URLSearchParams();

            // Customer info
            if (chatState.data.firstName) params.append('firstName', chatState.data.firstName);
            if (chatState.data.lastName) params.append('lastName', chatState.data.lastName);
            if (chatState.data.email) params.append('email', chatState.data.email);
            if (chatState.data.phone) params.append('phone', chatState.data.phone);

            // Address info (stored as 'from' and 'to' in chatState)
            if (chatState.data.from) params.append('pickupAddress', chatState.data.from);
            if (chatState.data.to) params.append('dropoffAddress', chatState.data.to);

            // Service info
            if (chatState.serviceType) params.append('serviceType', chatState.serviceType);

            // Estimate data
            if (chatState.data.estimate) {
                params.append('estimateTotal', chatState.data.estimate.total || 0);
                if (chatState.data.estimate.breakdown) {
                    params.append('estimateData', JSON.stringify(chatState.data.estimate));
                }
            }

            // Payment info
            if (chatState.data.cardSaved) {
                params.append('paymentSaved', 'true');
                if (chatState.data.squareCustomerId) params.append('squareCustomerId', chatState.data.squareCustomerId);
                if (chatState.data.cardLast4) params.append('cardLast4', chatState.data.cardLast4);
                if (chatState.data.cardBrand) params.append('cardBrand', chatState.data.cardBrand);
            } else if (chatState.data.cardSkipped) {
                params.append('paymentSkipped', 'true');
            }

            return `chatbot-review.html?${params.toString()}`;
        }

        // Expose to global scope
        window.buildBookingPortalURL = buildBookingPortalURL;

        function trackEvent(eventName, data = {}) {
            // Track events for analytics
            console.log('Event:', eventName, data);
        }

        // Enhanced date parsing function
        function parseDate(dateString) {
            // Normalize the date string - remove ordinals (st, nd, rd, th)
            let normalizedDate = dateString.replace(/(\d+)(st|nd|rd|th)/gi, '$1');
            
            // Try multiple date formats
            const formats = [
                // Standard formats
                (str) => new Date(str),
                // Handle "March 10" or "March 10th" (current year)
                (str) => {
                    const date = new Date(str + ', ' + new Date().getFullYear());
                    return isNaN(date.getTime()) ? new Date(str) : date;
                },
                // Handle "Next Tuesday" etc.
                (str) => {
                    const lower = str.toLowerCase();
                    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    const dayIndex = days.findIndex(day => lower.includes(day));
                    
                    if (dayIndex !== -1) {
                        const today = new Date();
                        const todayDay = today.getDay();
                        let daysToAdd = dayIndex - todayDay;
                        
                        if (lower.includes('next')) {
                            daysToAdd += 7;
                        } else if (daysToAdd <= 0) {
                            daysToAdd += 7;
                        }
                        
                        const targetDate = new Date(today);
                        targetDate.setDate(today.getDate() + daysToAdd);
                        return targetDate;
                    }
                    return new Date(str);
                },
                // Handle "Tomorrow" or "Today"
                (str) => {
                    const lower = str.toLowerCase();
                    const today = new Date();
                    
                    if (lower.includes('today')) {
                        return today;
                    } else if (lower.includes('tomorrow')) {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);
                        return tomorrow;
                    }
                    return new Date(str);
                }
            ];
            
            // Try each format
            for (const format of formats) {
                const date = format(normalizedDate);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            // If all else fails, return invalid date
            return new Date('invalid');
        }

        // Mobile keyboard handling
        let windowHeight = window.innerHeight;
        let isKeyboardVisible = false;

        function detectKeyboard() {
            if (isMobile) {
                const currentHeight = window.innerHeight;
                const threshold = windowHeight * 0.75;
                
                if (currentHeight < threshold && !isKeyboardVisible) {
                    isKeyboardVisible = true;
                    document.body.classList.add('keyboard-open');
                    chatState.keyboardOpen = true;
                    
                    // Scroll to input
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                } else if (currentHeight >= threshold && isKeyboardVisible) {
                    isKeyboardVisible = false;
                    document.body.classList.remove('keyboard-open');
                    chatState.keyboardOpen = false;
                }
            }
        }

        // Setup mobile viewport handling
        if (isMobile) {
            window.addEventListener('resize', detectKeyboard);
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    windowHeight = window.innerHeight;
                }, 500);
            });

            // Handle viewport meta tag for iOS
            if (isIOS) {
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                }
            }
        }

        // FIXED: Session management functions with better photo restoration
        function saveSession() {
            try {
                const sessionData = {
                    stage: chatState.stage,
                    serviceType: chatState.serviceType,
                    data: chatState.data,
                    messages: chatState.messages,
                    messageCount: chatState.messageCount,
                    isOpen: chatState.isOpen,
                    hasBeenOpened: chatState.hasBeenOpened,
                    conversationStarted: chatState.conversationStarted,
                    navigationHistory: navigationHistory,
                    currentHistoryIndex: currentHistoryIndex,
                    timestamp: Date.now()
                };
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(sessionData));
            } catch (e) {
                console.error('Failed to save session:', e);
            }
        }

        function loadSession() {
            try {
                const saved = localStorage.getItem(CONFIG.storageKey);
                if (saved) {
                    const sessionData = JSON.parse(saved);
                    
                    // Check if session is less than 24 hours old
                    const dayInMs = 24 * 60 * 60 * 1000;
                    if (Date.now() - sessionData.timestamp < dayInMs) {
                        // Restore state (except Google services which will be initialized)
                        chatState.stage = sessionData.stage || 'greeting';
                        chatState.serviceType = sessionData.serviceType;
                        chatState.data = sessionData.data || {};
                        chatState.messages = sessionData.messages || [];
                        chatState.messageCount = sessionData.messageCount || 0;
                        chatState.isOpen = sessionData.isOpen || false;
                        chatState.hasBeenOpened = sessionData.hasBeenOpened || false;
                        chatState.conversationStarted = sessionData.conversationStarted || false;
                        navigationHistory = sessionData.navigationHistory || [];
                        currentHistoryIndex = sessionData.currentHistoryIndex || -1;
                        
                        // Initialize data defaults if not present
                        if (!chatState.data.pestDisclaimerAgreed) chatState.data.pestDisclaimerAgreed = false;
                        if (!chatState.data.shopEquipment) chatState.data.shopEquipment = [];
                        if (!chatState.data.oversizedFurniture) chatState.data.oversizedFurniture = [];
                        if (!chatState.data.tvHandling) chatState.data.tvHandling = [];
                        if (!chatState.data.accessObstacles) chatState.data.accessObstacles = [];
                        if (!chatState.data.photos) chatState.data.photos = [];
                        
                        // Clear any expired session tokens
                        chatState.sessionToken = null;
                        
                        return true;
                    }
                }
            } catch (e) {
                console.error('Failed to load session:', e);
            }
            return false;
        }

        function clearSession() {
            try {
                localStorage.removeItem(CONFIG.storageKey);
                navigationHistory = [];
                currentHistoryIndex = -1;
                
                // Clear any pending auto-submit
                if (chatState.autoSubmitTimeoutId) {
                    clearTimeout(chatState.autoSubmitTimeoutId);
                    chatState.autoSubmitTimeoutId = null;
                }
                if (chatState.pendingAutoSubmit) {
                    chatState.pendingAutoSubmit = null;
                }
            } catch (e) {
                console.error('Failed to clear session:', e);
            }
        }

        function restoreMessages() {
            messages.innerHTML = '';
            if (chatState.messages && chatState.messages.length > 0) {
                chatState.messages.forEach(msg => {
                    const message = document.createElement('div');
                    message.className = `chat-message ${msg.type}-message`;
                    message.innerHTML = msg.content;
                    messages.appendChild(message);
                });
                messages.scrollTop = messages.scrollHeight;
            }
        }

        function saveMessage(content, type) {
            if (!chatState.messages) {
                chatState.messages = [];
            }
            chatState.messages.push({ content, type, timestamp: Date.now() });
            saveSession();
        }

        // Show critical error
        function showCriticalError() {
            messages.innerHTML = `
                <div class="critical-error">
                    <h3>‚ö†Ô∏è Service Temporarily Unavailable</h3>
                    <p>We're having trouble loading required services.</p>
                    <p>Please try one of these options:</p>
                    <p>üìû Call us directly: <a href="tel:330-435-8686">330-435-8686</a></p>
                    <p>üåê Visit: <a href="${CONFIG.bookingUrl}" target="_blank">Book Online</a></p>
                    <p>üîÑ <a href="#" onclick="location.reload()">Refresh Page</a></p>
                </div>
            `;
            options.innerHTML = '';
            inputArea.style.display = 'none';
        }

        // Load Google Maps with retry logic
        function loadGoogleMaps() {
            return new Promise((resolve, reject) => {
                let retryCount = 0;
                const maxRetries = 3;

                function attemptLoad() {
                    // Check if already loaded
                    if (window.google && window.google.maps && window.google.maps.places) {
                        console.log('Google Maps already loaded');
                        resolve();
                        return;
                    }

                    // Create unique callback name
                    const callbackName = `initGoogleMaps_${Date.now()}`;
                    
                    window[callbackName] = function() {
                        console.log('Google Maps loaded via callback');
                        delete window[callbackName];
                        
                        // Verify all required services are available
                        if (window.google && window.google.maps && window.google.maps.places) {
                            resolve();
                        } else {
                            reject(new Error('Google Maps loaded but services missing'));
                        }
                    };

                    // Remove any existing script tags
                    const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                    if (existingScript) {
                        existingScript.remove();
                    }

                    // Load script
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.googleMapsApiKey}&libraries=places&callback=${callbackName}`;
                    script.async = true;
                    script.defer = true;
                    
                    script.onerror = () => {
                        delete window[callbackName];
                        retryCount++;
                        
                        if (retryCount < maxRetries) {
                            console.warn(`Google Maps load failed, retrying... (${retryCount}/${maxRetries})`);
                            setTimeout(attemptLoad, 2000);
                        } else {
                            reject(new Error('Failed to load Google Maps after multiple attempts'));
                        }
                    };
                    
                    document.head.appendChild(script);
                }

                // Start loading
                attemptLoad();

                // Overall timeout
                setTimeout(() => {
                    reject(new Error('Google Maps loading timeout'));
                }, 30000);
            });
        }

        // Initialize Google Services
        function initializeGoogleServices() {
            try {
                chatState.directionsService = new google.maps.DirectionsService();
                chatState.geocoder = new google.maps.Geocoder();
                chatState.autocompleteService = new google.maps.places.AutocompleteService();
                chatState.sessionToken = new google.maps.places.AutocompleteSessionToken();
                
                // Test the services
                return new Promise((resolve, reject) => {
                    chatState.geocoder.geocode({ address: CONFIG.baseAddress }, (results, status) => {
                        if (status === 'OK') {
                            console.log('Google services initialized and tested successfully');
                            resolve();
                        } else {
                            reject(new Error(`Geocoder test failed: ${status}`));
                        }
                    });
                });
            } catch (error) {
                throw new Error(`Failed to initialize Google services: ${error.message}`);
            }
        }

        // Load pricing from API and update CONFIG
        async function loadPricingFromAPI() {
            try {
                console.log('üìä Loading pricing from API...');
                const response = await fetch(`${CONFIG.bookingAPI.baseUrl}/api/services?t=${Date.now()}`);
                const data = await response.json();

                if (data.success && data.services) {
                    const services = data.services;
                    console.log('‚úÖ Pricing loaded from API');

                    // Update CONFIG.rates with API data
                    // Moving service rates (2-person crew)
                    if (services.movingServices && services.movingServices['2-person-crew']) {
                        const moving2 = services.movingServices['2-person-crew'];
                        CONFIG.rates.moving = {
                            base: moving2.baseRate || CONFIG.rates.moving.base,
                            distanceAdj: moving2.distanceAdjustment || CONFIG.rates.moving.distanceAdj,
                            crewAdd: 55, // Add $55 per additional crew member
                            serviceCharge: moving2.serviceCharge || CONFIG.rates.moving.serviceCharge
                        };
                    }

                    // Labor service rates
                    if (services.laborOnly) {
                        CONFIG.rates.labor = {
                            base: services.laborOnly.baseRate || CONFIG.rates.labor.base,
                            distanceAdj: services.laborOnly.distanceAdjustment || CONFIG.rates.labor.distanceAdj,
                            crewAdd: services.laborOnly.crewAddRate || CONFIG.rates.labor.crewAdd,
                            travel: services.laborOnly.travelRate || CONFIG.rates.labor.travel,
                            serviceCharge: services.laborOnly.serviceCharge || CONFIG.rates.labor.serviceCharge
                        };
                    }

                    // Single item rates
                    if (services.singleItem) {
                        CONFIG.rates.singleItem = {
                            ...CONFIG.rates.singleItem,
                            base: services.singleItem.baseRate || CONFIG.rates.singleItem.base,
                            distance: services.singleItem.distanceRate || CONFIG.rates.singleItem.distance,
                            perMinute: services.singleItem.perMinuteRate || CONFIG.rates.singleItem.perMinute,
                            stairs: services.fees?.stairs?.apartment || 35, // Use apartment rate for single items
                            crewRates: services.singleItem.crewRates || CONFIG.rates.singleItem.crewRates
                        };
                    }

                    // Junk removal rates
                    if (services.junkRemoval) {
                        CONFIG.rates.junkRemoval = {
                            base: services.junkRemoval.baseRate || CONFIG.rates.junkRemoval.base,
                            distance: services.junkRemoval.distanceRate || CONFIG.rates.junkRemoval.distance,
                            disposalFee: services.junkRemoval.disposalFee || CONFIG.rates.junkRemoval.disposalFee,
                            serviceCharge: services.junkRemoval.serviceCharge || CONFIG.rates.junkRemoval.serviceCharge,
                            crewAdd: services.junkRemoval.crewAddRate || CONFIG.rates.junkRemoval.crewAdd
                        };
                    }

                    // Cleanout rates
                    if (services.cleanout) {
                        CONFIG.rates.cleanout = {
                            baseHourly: services.cleanout.baseHourlyRate || CONFIG.rates.cleanout.baseHourly,
                            baseHours: services.cleanout.minimumHours || CONFIG.rates.cleanout.baseHours,
                            distanceAdjustment: services.cleanout.distanceAdjustment || CONFIG.rates.cleanout.distanceAdjustment,
                            disposalFee: services.cleanout.disposalFee || CONFIG.rates.cleanout.disposalFee,
                            serviceCharge: services.cleanout.serviceCharge || CONFIG.rates.cleanout.serviceCharge,
                            crewAdd: services.cleanout.crewAddRate || CONFIG.rates.cleanout.crewAdd
                        };
                    }

                    // Store stair pricing for use in calculations
                    if (services.fees && services.fees.stairs) {
                        CONFIG.stairPricing = {
                            apartment: services.fees.stairs.apartment || 35,
                            house: services.fees.stairs.house || 25,
                            apartmentTime: services.fees.stairs.apartmentTime || 0.35,
                            houseTime: services.fees.stairs.houseTime || 0.275
                        };
                        console.log('‚úÖ Stair pricing:', CONFIG.stairPricing);
                    }

                    console.log('‚úÖ CONFIG updated with API pricing');
                } else {
                    console.warn('‚ö†Ô∏è Failed to load pricing from API, using defaults');
                }
            } catch (error) {
                console.error('‚ùå Error loading pricing from API:', error);
                console.warn('‚ö†Ô∏è Using default pricing from CONFIG');
            }
        }

        // Initialize chat
        async function init() {
            // Start with container visible but widget hidden
            container.style.display = 'block';

            // MOBILE: Ensure chat never auto-opens on mobile
            if (isMobile) {
                chatState.isOpen = false;
                chatState.hasBeenOpened = false;
            }

            // Initialize global file input
            initializeGlobalFileInput();

            // Load saved session
            const hasSession = loadSession();

            // EMBEDDED MODE: Start hidden, controlled by header buttons
            // widget.style.display = 'flex';  // DISABLED - controlled by header
            // toggle.style.display = 'flex';  // DISABLED - always hidden, controlled by header
            // chatState.isOpen = true;  // DISABLED - starts closed
            // container.style.display = 'block'; // Container visible but widget hidden

            try {
                // Load pricing from API
                await loadPricingFromAPI();

                // Load Google Maps
                await loadGoogleMaps();
                console.log('Google Maps script loaded');

                // Initialize services
                await initializeGoogleServices();
                console.log('Google services initialized');
                
               // Setup event listeners with proper binding
toggle.addEventListener('click', openChat);
close.addEventListener('click', closeChat);

// Fix for send button - ensure it's properly bound
if (send) {
    send.addEventListener('click', function(e) {
        e.preventDefault();
        handleSend();
    });
    
    // Also handle Enter key in input
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
    }
}

backButton.addEventListener('click', goBack);
                
                // Date picker event listeners
dateConfirmBtn = document.querySelector('.date-confirm-btn');
dateCancelBtn = document.querySelector('.date-cancel-btn');
if (dateConfirmBtn) dateConfirmBtn.addEventListener('click', handleDateConfirm);
if (dateCancelBtn) dateCancelBtn.addEventListener('click', handleDateCancel);

                // Payment back button
                paymentBackBtn.addEventListener('click', hidePaymentModal);

                // Print modal event listeners (only add once to prevent duplicates)
                if (!printListenersInitialized) {
                    const printBackBtn = document.getElementById('wfm-print-back');
                    const printButton = document.getElementById('wfm-print-button');

                    if (printBackBtn) {
                        printBackBtn.addEventListener('click', function() {
                            document.getElementById('wfm-print-modal').style.display = 'none';
                            document.getElementById('wfm-container').style.display = 'block';
                        });
                    }

                    if (printButton) {
                        printButton.addEventListener('click', function() {
                            window.print();
                        });
                    }

                    printListenersInitialized = true;
                }

               // Mobile touch events for send button
if (isMobile && send) {
    send.addEventListener('touchstart', function(e) {
        e.preventDefault();
    });
    
    send.addEventListener('touchend', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handleSend();
    });
}
               

                // Mobile touch events for send button
                if (isMobile) {
                    send.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        handleSend();
                    });
                }

                // Setup autocomplete with mobile optimization
                let autocompleteTimeout;
                let lastInputValue = '';
                
                input.addEventListener('input', (e) => {
                    clearTimeout(autocompleteTimeout);
                    const value = e.target.value.trim();
                    
                    // Only process if value actually changed (helps with mobile keyboards)
                    if (value === lastInputValue) return;
                    lastInputValue = value;
                    
                    if ((chatState.stage === 'location_from' || chatState.stage === 'location_to' ||
                         chatState.stage === 'location_third' || chatState.stage === 'cleanout_location' ||
                         chatState.stage === 'location_1' || chatState.stage === 'location_2' || chatState.stage === 'location_3') && value.length > 3) {
                        autocompleteTimeout = setTimeout(() => {
                            getAddressSuggestions(value);
                        }, isMobile ? 500 : 300); // Longer delay on mobile
                    } else {
                        autocompleteResults.style.display = 'none';
                    }
                });

                // Fixed mobile-optimized autocomplete item handling
                autocompleteResults.addEventListener('click', (e) => {
                    if (e.target.classList.contains('autocomplete-item')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const value = e.target.textContent;
                        input.value = value;
                        autocompleteResults.style.display = 'none';
                        chatState.sessionToken = new google.maps.places.AutocompleteSessionToken();
                        
                        // On mobile, blur input to hide keyboard
                        if (isMobile) {
                            input.blur();
                            // Small delay to ensure keyboard is hidden before processing
                            setTimeout(() => {
                                handleSend();
                            }, 100);
                        } else {
                            // Desktop - process immediately
                            handleSend();
                        }
                    }
                });

                // Hide autocomplete on click outside
                document.addEventListener('click', (e) => {
                    if (!inputArea.contains(e.target) && !autocompleteResults.contains(e.target)) {
                        autocompleteResults.style.display = 'none';
                    }
                });

                // Fixed mobile touch event for autocomplete
                if (isMobile) {
                    let touchStarted = false;
                    
                    autocompleteResults.addEventListener('touchstart', (e) => {
                        if (e.target.classList.contains('autocomplete-item')) {
                            touchStarted = true;
                            e.preventDefault();
                        }
                    });
                    
                    autocompleteResults.addEventListener('touchend', (e) => {
                        if (e.target.classList.contains('autocomplete-item') && touchStarted) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const value = e.target.textContent;
                            input.value = value;
                            autocompleteResults.style.display = 'none';
                            chatState.sessionToken = new google.maps.places.AutocompleteSessionToken();
                            
                            // Hide keyboard and process
                            input.blur();
                            setTimeout(() => {
                                handleSend();
                            }, 100);
                            
                            touchStarted = false;
                        }
                    });
                }

                // Handle focus events on mobile
                if (isMobile) {
                    input.addEventListener('focus', () => {
                        setTimeout(() => {
                            messages.scrollTop = messages.scrollHeight;
                        }, 300);
                    });

                    input.addEventListener('blur', () => {
                        // Hide autocomplete when input loses focus
                        setTimeout(() => {
                            autocompleteResults.style.display = 'none';
                        }, 200);
                    });
                }
                
                if (hasSession && chatState.conversationStarted) {
                    restoreMessages();
                    restoreUIState();
                    updateNavigationButtons();
                }

                // EMBEDDED MODE: Hide widget initially, controlled by header buttons
                widget.style.display = 'none';  // Start hidden
                toggle.style.display = 'none';  // Always hidden (controlled by header)
                chatState.isOpen = false;  // Start closed

            } catch (error) {
                console.error('Initialization error:', error);
                showCriticalError();
            }
        }

        // FIXED: Enhanced restoreUIState function with complete stage handling
        function restoreUIState() {
            // Clear any existing options/input
            options.innerHTML = '';
            inputArea.style.display = 'none';
            hideDatePicker();
            
            // Determine what UI to show based on current stage
            const needsInput = ['get_name_initial', 'get_email_early', 'get_phone_early', 'location_from', 'location_to', 'location_third',
                              'location_1', 'location_2', 'location_3',
                              'cleanout_location', 'hours', 'describe_item', 'get_email', 'get_phone', 'fvp_value',
                              'collect_full_name', 'collect_email_required', 'collect_phone_required',
                              'equipment_weight_input', 'furniture_weight_input', 'damage_description',
                              'item_value_input', 'invoice_number_input', 'item_value_assessment',
                              'damage_cause'];
            
            if (needsInput.includes(chatState.stage)) {
                showInput(getPlaceholderForStage(chatState.stage));
            } else if (chatState.stage === 'moving_date' || chatState.stage === 'move_details_verification') {
                // Show date picker for moving date
                showDatePicker();
            } else {
                // Show appropriate options based on stage
                showOptionsForCurrentStage();
            }
        }

        function getPlaceholderForStage(stage) {
            const placeholders = {
                'get_name_initial': "Enter your full name (first and last)...",
                'get_email_early': "Enter your email...",
                'get_phone_early': "Enter your phone number...",
                'collect_full_name': "Enter your first and last name...",
                'location_from': "Start typing your address...",
                'location_to': "Start typing destination address...",
                'location_third': "Start typing third location address...",
                'location_1': "Start typing pickup address (Location 1)...",
                'location_2': "Start typing delivery address (Location 2)...",
                'location_3': "Start typing third location address...",
                'cleanout_location': "Start typing address...",
                'hours': "Enter number of hours...",
                'describe_item': "e.g., Large wardrobe, Gun safe...",
                'get_email': "Enter your email...",
                'collect_email_required': "Enter your email...",
                'get_phone': "Enter your phone number...",
                'collect_phone_required': "Enter your phone number...",
                'fvp_value': "Enter total value...",
                'moving_date': "Click to select date...",
                'equipment_weight_input': "Enter weight in pounds...",
                'furniture_weight_input': "Enter weight in pounds...",
                'damage_description': "Describe the damage in detail...",
                'item_value_assessment': "Enter item value in dollars...",
                'item_value_input': "Enter item value in dollars...",
                'invoice_number_input': "Enter invoice number...",
                'damage_cause': "Describe what happened..."
            };
            return placeholders[stage] || "Type your answer...";
        }

        // NEW FLOW: Phase 2 - Collect details for each location
        function proceedToLocationDetails() {
            // Start with Location 1
            chatState.data.currentLocationBeingConfigured = 1;
            chatState.stage = 'location_1_home_type';
            showBotMessage("Great! Now I need details about each location.");
            setTimeout(() => {
                showBotMessage("What type of home is the 1st location?");
                showOptions([
                    { text: "üè† House", value: "house" },
                    { text: "üè¢ Apartment", value: "apartment" },
                    { text: "üè¢ Condo", value: "condo" },
                    { text: "üì¶ Storage Unit", value: "storage" }
                ]);
                saveSession();
            }, 800);
        }

        // NEW FLOW: Phase 3 - Ask about large homes (multi-select)
        function proceedToLargeHomesQuestion() {
            chatState.stage = 'large_homes_multiselect';
            chatState.data.largeHomeLocations = [];

            showBotMessage("Are any locations larger than 2,600 square feet?");
            showBotMessage("Select all that apply:");

            const options = [
                { text: "1st location", value: "location_1" },
                { text: "2nd location", value: "location_2" }
            ];

            if (chatState.data.hasThirdLocation) {
                options.push({ text: "3rd location", value: "location_3" });
            }

            options.push({ text: "None are that large", value: "none" });
            options.push({ text: "‚úì Done with selections", value: "done_large_homes", primary: true });

            showOptions(options);
            saveSession();
        }

        // NEW FLOW: Phase 4 - Ask about access challenges (multi-select)
        function proceedToAccessChallengesQuestion() {
            chatState.stage = 'access_challenges_multiselect';
            chatState.data.challengeLocations = [];

            showBotMessage("Are there any of the following at any location: long halls, long driveways, long walks, or slow elevators?");
            showBotMessage("Select all locations that have these challenges:");

            const options = [
                { text: "1st location", value: "location_1" },
                { text: "2nd location", value: "location_2" }
            ];

            if (chatState.data.hasThirdLocation) {
                options.push({ text: "3rd location", value: "location_3" });
            }

            options.push({ text: "No challenges", value: "none" });
            options.push({ text: "‚úì Done with selections", value: "done_challenges", primary: true });

            showOptions(options);
            saveSession();
        }

        function proceedAfterFromLocation() {
            if (chatState.serviceType === 'labor') {
                chatState.stage = 'crew_size';
                showBotMessage("How many movers do you need?");
                showOptions([
                    { text: "üë• 2 person crew", value: "2" },
                    { text: "üë• 3 person crew", value: "3" },
                    { text: "üë• 4 person crew", value: "4" }
                ]);
                saveSession();
            } else {
                // Moving service - ask for destination
                chatState.stage = 'location_to';
                showBotMessage("Great! Now I need your destination address.");
                showBotMessage("Where are you moving TO?");
                showInput("Start typing destination address...");
                saveSession();
            }
        }

        function proceedAfterToLocation() {
            chatState.stage = 'home_type';
            showBotMessage("What type of place are you moving FROM?");
            showOptions([
                { text: "üè† House", value: "house" },
                { text: "üè¢ Apartment", value: "apartment" },
                { text: "üè¢ Condo", value: "condo" },
                { text: "üì¶ Storage Unit", value: "storage" }
            ]);
            saveSession();
        }

        function proceedToShopEquipment() {
            chatState.stage = 'shop_equipment_check';
            showBotMessage("Do you have any workshop equipment or tools (workbenches, tool chests, etc.)?");
            showOptions([
                { text: "Yes, I have shop equipment", value: "yes" },
                { text: "No shop equipment", value: "no" }
            ]);
            saveSession();
        }

        function proceedToOversizedFurniture() {
            chatState.stage = 'oversized_furniture_check';
            showBotMessage("Do you have any oversized furniture or specialty mattresses (Purple, Tempur-Pedic, etc.)?");
            showOptions([
                { text: "Yes, I have oversized/specialty items", value: "yes" },
                { text: "No oversized items", value: "no" }
            ]);
            saveSession();
        }

        function proceedToSpecialItems() {
            chatState.stage = 'special_items';
            showBotMessage("Do you have any special items that require extra care?");
            showOptions([
                { text: "No special items", value: "none" },
                { text: "Piano üéπ", value: "piano" },
                { text: "Safe üîí", value: "safe" },
                { text: "Heavy Items (300+ lbs)", value: "heavyItems" },
                { text: "Universal Gym", value: "gym" },
                { text: "Free Weights", value: "freeWeights" },
                { text: "Treadmill/Elliptical", value: "treadmill" },
                { text: "China Hutch", value: "hutch" },
                { text: "Large Aquarium", value: "aquarium" },
                { text: "Multiple Special Items", value: "multiple" }
            ]);
            saveSession();
        }

        function askAboutAppliance(index) {
            const applianceList = ['washer', 'dryer', 'refrigerator', 'stove', 'freezer'];
            const applianceNames = ['Washer', 'Dryer', 'Refrigerator', 'Stove', 'Deep Freezer'];
            
            if (index < applianceList.length) {
                showBotMessage(`Do you have a ${applianceNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        function askAboutThirdLocationAppliance(index) {
            const applianceList = ['washer', 'dryer', 'refrigerator', 'stove', 'freezer'];
            const applianceNames = ['Washer', 'Dryer', 'Refrigerator', 'Stove', 'Deep Freezer'];
            
            if (index < applianceList.length) {
                showBotMessage(`At the third location: Do you have a ${applianceNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        function askAboutShopEquipment(index) {
            const equipmentList = ['workbench', 'toolChest', 'tablesaw', 'airCompressor', 
                                  'weldingEquipment', 'drillPress', 'vehicleLift', 'automotiveEquipment'];
            const equipmentNames = ['Workbench', 'Large Tool Chest', 'Table Saw', 'Air Compressor',
                                   'Welding Equipment', 'Drill Press', 'Vehicle Lift/Hoist', 'Heavy Automotive Equipment'];
            
            if (index < equipmentList.length) {
                showBotMessage(`Do you have a ${equipmentNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        function askAboutOversizedFurniture(index) {
            const furnitureList = ['largeSectional', 'poolTable', 'arcadeGame', 'largeEntertainmentCenter', 'heavyFurniture'];
            const furnitureNames = ['Oversized Sectional (10ft+)', 'Pool Table', 'Arcade Game', 
                                   'Large Entertainment Center', 'Heavy Furniture (300+ lbs)'];
            
            if (index < furnitureList.length) {
                showBotMessage(`Do you have: ${furnitureNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        function askAboutMattress(index) {
            const mattressList = ['purpleMattress', 'tempurPedicMattress', 'adjustableBase', 'californiaKing'];
            const mattressNames = ['Purple Mattress', 'Tempur-Pedic Mattress', 'Adjustable Bed Base', 'California King Mattress'];
            
            if (index < mattressList.length) {
                showBotMessage(`Do you have a ${mattressNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        function askAboutTVSize(index) {
            const tvSizes = ['tv55to65', 'tv70to75', 'tv80plus'];
            const tvSizeNames = ['55-65 inch TV', '70-75 inch TV', '80+ inch TV'];
            
            if (index < tvSizes.length) {
                showBotMessage(`Do you have a ${tvSizeNames[index]}?`);
                showOptions([
                    { text: "Yes", value: "yes" },
                    { text: "No", value: "no" }
                ]);
            }
        }

        // Combined heavy/specialty items selection - uses standard options pattern
        function showHeavySpecialtyItemsCheckboxes() {
            chatState.stage = 'specialty_items_ask';
            chatState.data.shopEquipment = [];
            chatState.data.oversizedFurniture = [];
            chatState.data.selectedSpecialtyItems = [];

            showBotMessage("Do you have any specialty items? (Shop equipment, oversized furniture, specialty mattresses)");
            showSpecialtyItemOptions();
        }

        function showSpecialtyItemOptions() {
            showOptions([
                { text: "üîß Workbench", value: "workbench" },
                { text: "üß∞ Tool Chest", value: "toolChest" },
                { text: "ü™ö Table Saw", value: "tablesaw" },
                { text: "üõãÔ∏è Oversized Sectional", value: "largeSectional" },
                { text: "üé± Pool Table", value: "poolTable" },
                { text: "üíú Purple Mattress", value: "purpleMattress" },
                { text: "üõèÔ∏è Tempur-Pedic", value: "tempurPedicMattress" },
                { text: "‚öñÔ∏è Other Heavy Item (300+ lbs)", value: "heavyFurniture" },
                { text: "‚úì Done / No Specialty Items", value: "done_specialty", primary: true }
            ]);
        }

        function showSpecialtyItemsMultiSelect() {
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';

            const items = [
                // Shop Equipment
                { value: 'workbench', type: 'shop', label: 'üîß Workbench', category: 'üõ†Ô∏è SHOP EQUIPMENT' },
                { value: 'toolChest', type: 'shop', label: 'üß∞ Large Tool Chest' },
                { value: 'tablesaw', type: 'shop', label: 'ü™ö Table Saw' },
                { value: 'airCompressor', type: 'shop', label: 'üí® Air Compressor' },
                { value: 'weldingEquipment', type: 'shop', label: 'üî• Welding Equipment' },
                { value: 'drillPress', type: 'shop', label: '‚öôÔ∏è Drill Press' },
                { value: 'vehicleLift', type: 'shop', label: 'üèóÔ∏è Vehicle Lift/Hoist' },
                { value: 'automotiveEquipment', type: 'shop', label: 'üöó Heavy Automotive Equipment' },
                // Furniture
                { value: 'largeSectional', type: 'furniture', label: 'üõãÔ∏è Oversized Sectional (10ft+)', category: 'üõãÔ∏è OVERSIZED FURNITURE' },
                { value: 'poolTable', type: 'furniture', label: 'üé± Pool Table' },
                { value: 'arcadeGame', type: 'furniture', label: 'üïπÔ∏è Arcade Game' },
                { value: 'largeEntertainmentCenter', type: 'furniture', label: 'üì∫ Large Entertainment Center' },
                { value: 'heavyFurniture', type: 'furniture', label: '‚öñÔ∏è Heavy Furniture (300+ lbs)' },
                // Mattresses
                { value: 'purpleMattress', type: 'mattress', label: 'üíú Purple Mattress', category: 'üõèÔ∏è SPECIALTY MATTRESSES' },
                { value: 'tempurPedicMattress', type: 'mattress', label: 'üõèÔ∏è Tempur-Pedic Mattress' },
                { value: 'adjustableBase', type: 'mattress', label: 'üîß Adjustable Bed Base' },
                { value: 'californiaKing', type: 'mattress', label: 'üëë California King Mattress' }
            ];

            items.forEach(item => {
                // Add category header if present
                if (item.category) {
                    const header = document.createElement('div');
                    header.style.cssText = 'font-weight: bold; margin: 15px 5px 8px 5px; color: #2c5aa0; font-size: 14px;';
                    header.textContent = item.category;
                    optionsDiv.appendChild(header);
                }

                const button = document.createElement('button');
                button.className = 'chat-option specialty-select-btn';
                button.textContent = item.label;
                button.dataset.value = item.value;
                button.dataset.type = item.type;
                button.dataset.selected = 'false';

                button.onclick = function() {
                    if (this.dataset.selected === 'false') {
                        this.dataset.selected = 'true';
                        this.style.background = '#28a745';
                        this.style.color = 'white';

                        if (item.type === 'shop') {
                            if (!chatState.data.shopEquipment) chatState.data.shopEquipment = [];
                            chatState.data.shopEquipment.push(item.value);
                        } else {
                            if (!chatState.data.oversizedFurniture) chatState.data.oversizedFurniture = [];
                            chatState.data.oversizedFurniture.push(item.value);
                        }
                    } else {
                        this.dataset.selected = 'false';
                        this.style.background = '';
                        this.style.color = '';

                        if (item.type === 'shop') {
                            chatState.data.shopEquipment = chatState.data.shopEquipment.filter(v => v !== item.value);
                        } else {
                            chatState.data.oversizedFurniture = chatState.data.oversizedFurniture.filter(v => v !== item.value);
                        }
                    }
                    saveSession();
                };

                optionsDiv.appendChild(button);
            });

            // Add Done button
            const doneButton = document.createElement('button');
            doneButton.className = 'chat-option primary';
            doneButton.textContent = '‚úì Done - Continue';
            doneButton.style.marginTop = '15px';

            doneButton.onclick = function() {
                // Clear options
                optionsDiv.innerHTML = '';

                // Show summary
                const totalItems = (chatState.data.shopEquipment?.length || 0) + (chatState.data.oversizedFurniture?.length || 0);
                if (totalItems > 0) {
                    let summary = `Got it! ${totalItems} specialty item${totalItems > 1 ? 's' : ''} noted. `;
                    if (chatState.data.shopEquipment && chatState.data.shopEquipment.length > 0) {
                        summary += `Shop equipment: ${chatState.data.shopEquipment.map(e => CONFIG.shopEquipment[e].name).join(', ')}. `;
                    }
                    if (chatState.data.oversizedFurniture && chatState.data.oversizedFurniture.length > 0) {
                        summary += `Specialty items: ${chatState.data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ')}.`;
                    }
                    showBotMessage(summary);
                } else {
                    showBotMessage("Got it! No specialty items.");
                }

                // Continue to photos
                setTimeout(() => {
                    proceedToPhotosAfterSpecialtyItems();
                }, 800);

                saveSession();
            };

            optionsDiv.appendChild(doneButton);
        }

        // Simplified appliances selection - uses standard options pattern
        function showAppliancesCheckboxes() {
            chatState.stage = 'appliances_ask_first';
            chatState.data.appliances = [];
            chatState.data.selectedAppliances = [];

            showBotMessage("Do you have any appliances that need to be moved?");
            showOptions([
                { text: "ü´ß Washer", value: "washer" },
                { text: "üåÄ Dryer", value: "dryer" },
                { text: "üßä Refrigerator", value: "refrigerator" },
                { text: "üî• Stove", value: "stove" },
                { text: "‚ùÑÔ∏è Deep Freezer", value: "freezer" },
                { text: "‚úì Done / No Appliances", value: "done_appliances", primary: true }
            ]);
        }

        // Helper function to proceed after appliances selection
        function proceedAfterAppliances() {
            // Check if third location needs appliances check
            if (chatState.data.hasThirdLocation &&
                chatState.data.thirdLocationAction !== 'drop_only' &&
                !chatState.data.thirdLocationAppliancesChecked) {
                showThirdLocationAppliancesCheckboxes();
            } else {
                // Move to specialty items
                showHeavySpecialtyItemsCheckboxes();
            }
        }

        // Simplified third location appliances selection
        function showThirdLocationAppliancesCheckboxes() {
            chatState.stage = 'third_appliances_selection';
            chatState.data.thirdLocationAppliancesChecked = true;
            chatState.data.thirdLocationAppliances = [];

            // IMMEDIATELY clear any existing options
            const optionsDiv = document.getElementById('options');
            if (optionsDiv) {
                optionsDiv.innerHTML = '';
            }

            showBotMessage("Which appliances at your third location need to be moved? (Select all that apply)");
            showBotMessage("Click each appliance you have, then click 'Done' when finished.");

            setTimeout(() => {
                showThirdApplianceMultiSelect();
            }, 500);
        }

        function showThirdApplianceMultiSelect() {
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';

            const appliances = [
                { value: 'washer', label: 'ü´ß Washer' },
                { value: 'dryer', label: 'üåÄ Dryer' },
                { value: 'refrigerator', label: 'üßä Refrigerator' },
                { value: 'stove', label: 'üî• Stove' },
                { value: 'freezer', label: '‚ùÑÔ∏è Deep Freezer' }
            ];

            appliances.forEach(app => {
                const button = document.createElement('button');
                button.className = 'chat-option appliance-select-btn';
                button.textContent = app.label;
                button.dataset.value = app.value;
                button.dataset.selected = 'false';

                button.onclick = function() {
                    if (this.dataset.selected === 'false') {
                        this.dataset.selected = 'true';
                        this.style.background = '#28a745';
                        this.style.color = 'white';
                        if (!chatState.data.thirdLocationAppliances) chatState.data.thirdLocationAppliances = [];
                        chatState.data.thirdLocationAppliances.push(app.value);
                    } else {
                        this.dataset.selected = 'false';
                        this.style.background = '';
                        this.style.color = '';
                        chatState.data.thirdLocationAppliances = chatState.data.thirdLocationAppliances.filter(a => a !== app.value);
                    }
                    saveSession();
                };

                optionsDiv.appendChild(button);
            });

            // Add Done button
            const doneButton = document.createElement('button');
            doneButton.className = 'chat-option primary';
            doneButton.textContent = '‚úì Done - Continue';
            doneButton.style.marginTop = '15px';

            doneButton.onclick = function() {
                // Clear options
                optionsDiv.innerHTML = '';

                // Show summary
                if (chatState.data.thirdLocationAppliances && chatState.data.thirdLocationAppliances.length > 0) {
                    showBotMessage(`Noted! Third location appliances: ${chatState.data.thirdLocationAppliances.map(a => CONFIG.appliances[a].name).join(', ')}`);
                } else {
                    showBotMessage("Got it! No appliances at third location.");
                }

                // Continue to specialty items
                setTimeout(() => {
                    showHeavySpecialtyItemsCheckboxes();
                }, 800);

                saveSession();
            };

            optionsDiv.appendChild(doneButton);
        }

        // Helper function to proceed to photos after specialty items
        function proceedToPhotosAfterSpecialtyItems() {
            if (chatState.serviceType === 'moving') {
                // For moving service, proceed to photos
                chatState.stage = 'offer_photos_moving';
                chatState.data.photoCategory = 'moving';
                showBotMessage("Would you like to add photos of your items? This helps us bring the right equipment and crew size.");
                showBotMessage(PHOTO_SUGGESTIONS.moving, 800);
                setTimeout(() => {
                    showPhotoUpload();
                }, 1500);
            } else if (chatState.serviceType === 'labor') {
                // For labor service, proceed to labor photos
                chatState.stage = 'offer_photos_labor';
                chatState.data.photoCategory = 'labor';
                showBotMessage("Would you like to add photos? This helps our crew come prepared with proper tools.");
                showBotMessage(PHOTO_SUGGESTIONS.labor, 800);
                setTimeout(() => {
                    showPhotoUpload();
                }, 1500);
            } else if (chatState.serviceType === 'single') {
                // For single item, proceed to single item photos
                chatState.stage = 'offer_photos_single';
                chatState.data.photoCategory = 'single';
                showBotMessage("Would you like to add a photo of your item? This helps us come prepared!");
                setTimeout(() => {
                    showPhotoUpload();
                }, 1000);
            }
        }

        // FIXED: Enhanced showOptionsForCurrentStage with all missing stages
        function showOptionsForCurrentStage() {
            // This function recreates the options based on the current stage
            switch (chatState.stage) {
                case 'service_selection':
                    showOptions([
                        { text: "üöö Full Moving Service", value: "moving" },
                        { text: "üí™ Labor Only (I have truck)", value: "labor" },
                        { text: "üì¶ Single Item Move", value: "single" },
                        { text: "üóëÔ∏è Cleanout/Junk Removal", value: "cleanout" },
                        { text: "‚ùì I have questions", value: "questions" },
                        { text: "üõ°Ô∏è File Insurance Claim", value: "insurance_claim" }
                    ]);
                    break;
                case 'show_booking_options':
                    showOptions([
                        { text: "üìû Call: 330-435-8686", value: "call" },
                        { text: "üìß Email Estimate", value: "email_quote" },
                        { text: "üí¨ New Estimate", value: "restart" }
                    ]);
                    break;
                case 'pest_disclaimer':
                    showPestDisclaimer();
                    break;
                case 'stairs_from':
                    showOptions([
                        { text: "No stairs", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    break;
                case 'stairs_to':
                case 'item_stairs_delivery':
                    showOptions([
                        { text: "No stairs", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    break;
                case 'ask_third_location':
                    showOptions([
                        { text: "No, just these two locations", value: "no" },
                        { text: "Yes, I have a third stop", value: "yes" }
                    ]);
                    break;
                case 'home_type':
                    showOptions([
                        { text: "üè† House", value: "house" },
                        { text: "üè¢ Apartment", value: "apartment" },
                        { text: "üè¢ Condo", value: "condo" },
                        { text: "üì¶ Storage Unit", value: "storage" }
                    ]);
                    break;
                case 'bedrooms_from':
                    showOptions([
                        { text: "Studio/1 Bedroom", value: "1" },
                        { text: "2 Bedrooms", value: "2" },
                        { text: "3 Bedrooms", value: "3" },
                        { text: "4 Bedrooms", value: "4" },
                        { text: "5+ Bedrooms", value: "5" }
                    ]);
                    break;
                case 'insurance_claims_start':
                    showOptions([
                        { text: "Free Standard Coverage ($0.60/lb per article)", value: "standard_coverage" },
                        { text: "Full Value Protection (FVP)", value: "fvp_coverage" }
                    ]);
                    break;
                // Add photo upload stages
                case 'offer_photos_moving':
                case 'offer_photos_labor':
                case 'offer_photos_single':
                case 'insurance_photos':
                case 'photo_upload_claims':
                    showPhotoUpload();
                    break;
                case 'photo_upload_complete':
                    showOptions([
                        { text: "Continue", value: "continue_after_photos", primary: true }
                    ]);
                    break;
                // Equipment selection stages
                case 'select_appliances':
                    askAboutAppliance(chatState.data.currentApplianceIndex || 0);
                    break;
                case 'select_third_appliances':
                    askAboutThirdLocationAppliance(chatState.data.currentThirdApplianceIndex || 0);
                    break;
                case 'shop_equipment_details':
                    askAboutShopEquipment(chatState.data.currentShopEquipmentIndex || 0);
                    break;
                case 'mattress_details':
                    askAboutMattress(chatState.data.currentMattressIndex || 0);
                    break;
                case 'select_oversized_furniture':
                    askAboutOversizedFurniture(chatState.data.currentOversizedIndex || 0);
                    break;
                case 'tv_size_details':
                    askAboutTVSize(chatState.data.currentTvIndex || 0);
                    break;
                // Crew size stages
                case 'crew_size':
                    showOptions([
                        { text: "üë• 2 person crew", value: "2" },
                        { text: "üë• 3 person crew", value: "3" },
                        { text: "üë• 4 person crew", value: "4" }
                    ]);
                    break;
                case 'crew_size_moving':
                    const recommendation = getSmartCrewRecommendation();
                    showOptions([
                        { text: "üë• 2 person crew", value: "2", disabled: recommendation.crew > 2 },
                        { text: "üë• 3 person crew", value: "3", disabled: recommendation.crew > 3 },
                        { text: "üë• 4 person crew", value: "4" }
                    ]);
                    break;
                // Item selection stages
                case 'item_type':
                    showOptions([
                        { text: "üõãÔ∏è Furniture", value: "category_furniture" },
                        { text: "üîå Appliance", value: "category_appliance" },
                        { text: "üõèÔ∏è Furniture Set", value: "category_set" },
                        { text: "üèãÔ∏è Heavy/Special Item", value: "category_heavy" },
                        { text: "üì¶ Other", value: "other" }
                    ]);
                    break;
                case 'select_furniture_item':
                    showOptions([
                        { text: "Couch/Sofa", value: "couch" },
                        { text: "Loveseat", value: "loveseat" },
                        { text: "Recliner/Chair", value: "chair" },
                        { text: "Mattress & Box Spring", value: "mattress" },
                        { text: "Dresser", value: "dresser" },
                        { text: "Desk", value: "desk" },
                        { text: "Dining Table", value: "table" },
                        { text: "Other Furniture", value: "other" }
                    ]);
                    break;
                case 'select_appliance_item':
                    showOptions([
                        { text: "Refrigerator", value: "refrigerator" },
                        { text: "Washer", value: "washer" },
                        { text: "Dryer", value: "dryer" },
                        { text: "Stove/Range", value: "stove" },
                        { text: "Deep Freezer", value: "freezer" },
                        { text: "Dishwasher", value: "dishwasher" },
                        { text: "Other Appliance", value: "other" }
                    ]);
                    break;
                case 'questions':
                    showOptions([
                        { text: "üìç Service areas", value: "service_areas" },
                        { text: "üí∞ What's included?", value: "whats_included" },
                        { text: "üì¶ Packing services", value: "packing_info" },
                        { text: "üö´ Items you don't move", value: "restricted_items" },
                        { text: "‚≠ê Why choose Worry Free?", value: "why_choose_us" },
                        { text: "üì∏ Upload photos for estimate", value: "insurance_photos" },
                        { text: "‚Ü©Ô∏è Get an estimate", value: "restart" }
                    ]);
                    break;
                // Add more cases as needed
                default:
                    console.log('Unknown stage for options:', chatState.stage);
            }
            updateNavigationButtons();
        }

        // FIXED Show pest disclaimer - simplified without timer issues and with exit option
        function showPestDisclaimer() {
            const disclaimerHtml = `
                <div class="pest-disclaimer">
                    <div class="pest-disclaimer-header">‚ö†Ô∏è IMPORTANT PEST CONTROL DISCLAIMER</div>
                    <p>${PEST_DISCLAIMER_TEXT}</p>
                    <div class="pest-disclaimer-checkbox ${chatState.data.pestDisclaimerAgreed ? 'checked' : ''}" id="pest-disclaimer-checkbox">
                        ${chatState.data.pestDisclaimerAgreed ? '‚úÖ I agree to the terms above' : '‚òê Click here to agree'}
                    </div>
                </div>
            `;
            
            showBotMessage(disclaimerHtml);
            
            // If already agreed, show continue button immediately
            if (chatState.data.pestDisclaimerAgreed) {
                setTimeout(() =>
                      {
                    showOptions([
                        { text: "Continue", value: "continue_after_disclaimer", primary: true }
                    ]);
                }, 1500);
            } else {
                // Show both agree and exit options
                showOptions([
                    { text: "I need to address pest issues first", value: "exit_pest_issues" },
                    { text: "Call to discuss: 330-435-8686", value: "call" }
                ]);
            }
        }

        function getRandomResponse(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getAddressSuggestions(inputValue) {
            if (!chatState.autocompleteService) {
                console.error('Autocomplete service not initialized');
                return;
            }

            const request = {
                input: inputValue,
                sessionToken: chatState.sessionToken,
                componentRestrictions: { country: 'us' },
                types: ['address']
            };

            chatState.autocompleteService.getPlacePredictions(request, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    showAutocompleteSuggestions(predictions);
                } else {
                    console.warn('Autocomplete status:', status);
                    autocompleteResults.style.display = 'none';
                }
            });
        }

        function showAutocompleteSuggestions(predictions) {
            autocompleteResults.innerHTML = '';
            
            predictions.slice(0, 5).forEach(prediction => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = prediction.description;
                autocompleteResults.appendChild(item);
            });
            
            autocompleteResults.style.display = 'block';
            
            // On mobile, ensure dropdown is visible
            if (isMobile && chatState.keyboardOpen) {
                setTimeout(() => {
                    autocompleteResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        function startConversation() {
            // Clear previous conversation and any pending operations
            if (chatState.autoSubmitTimeoutId) {
                clearTimeout(chatState.autoSubmitTimeoutId);
                chatState.autoSubmitTimeoutId = null;
            }
            if (chatState.pendingAutoSubmit) {
                chatState.pendingAutoSubmit = null;
            }
            
            chatState = {
                stage: 'greeting',
                serviceType: null,
                data: {
                    pestDisclaimerAgreed: false,
                    pestDisclaimerTimestamp: null,
                    shopEquipment: [],
                    oversizedFurniture: [],
                    tvHandling: [],
                    homeSize: null,
                    accessObstacles: [],
                    heavyItemFees: 0,
                    accessMultiplier: 1.0,
                    photos: [],
                    hasPhotos: false,
                    photoCategory: null
                },
                messages: [],
                messageCount: 0,
                directionsService: chatState.directionsService,
                geocoder: chatState.geocoder,
                autocompleteService: chatState.autocompleteService,
                sessionToken: new google.maps.places.AutocompleteSessionToken(),
                isOpen: true,
                hasBeenOpened: true,
                conversationStarted: true,
                keyboardOpen: false,
                pendingAutoSubmit: null,
                autoSubmitTimeoutId: null,
                quoteSubmitted: false,
                isAutoSubmit: false,
                uploadedPhotos: [],
                isUploadingPhoto: false
            };
            
            messages.innerHTML = '';
            navigationHistory = [];
            currentHistoryIndex = -1;
            
            const greeting = getRandomResponse(SARAH_PERSONALITY.greetings);
            showBotMessage(greeting);

            setTimeout(() => {
                showBotMessage("I can help you get an instant estimate and schedule your move today! Before we start, what's your full name? üòä");
                showInput("Enter your full name (first and last)...");
                chatState.stage = 'get_name_initial';
                saveNavigationState();
                saveSession();
            }, 400);
        }

        function openChat() {
            // Always show the container when opening
            container.style.display = 'block';
            widget.style.display = 'flex';
            toggle.style.display = 'none'; // Keep toggle hidden
            chatState.isOpen = true;
            chatState.hasBeenOpened = true;
            
            if (isMobile) {
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.top = `-${window.scrollY}px`; // Preserve scroll position
            }
            
            if (!chatState.conversationStarted) {
                startConversation();
            } else if (chatState.messageCount > 5) {
                showBotMessage("Welcome back! Would you like to continue or start fresh?");
                showOptions([
                    { text: "Continue where we left off", value: "continue" },
                    { text: "Start a new estimate", value: "restart" },
                    { text: "üõ°Ô∏è File Insurance Claim", value: "insurance_claim" }
                ]);
            } else {
                // If conversation just started, continue normally
                restoreUIState();
            }
            
            updateNavigationButtons();
            saveSession();
        }

        function closeChat() {
            widget.style.display = 'none';
            toggle.style.display = 'none'; // Keep toggle hidden
            container.style.display = 'none'; // Hide entire container
            chatState.isOpen = false;

            // Restore body scroll on mobile
            if (isMobile) {
                const scrollY = document.body.style.top;
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }

            saveSession();
        }

        function showTypingIndicator() {
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.id = 'typing-indicator';
            typing.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(typing);
            messages.scrollTop = messages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function showBotMessage(text, delay = 0) {
            chatState.messageCount++;
            
            setTimeout(() => {
                showTypingIndicator();
                
                // Random typing time for personality
                const typingTime = 800 + Math.random() * 700;
                
                setTimeout(() => {
                    hideTypingIndicator();
                    const message = document.createElement('div');
                    message.className = 'chat-message bot-message';
                    message.innerHTML = text;
                    messages.appendChild(message);
                    messages.scrollTop = messages.scrollHeight;
                    
                    // Save message to session
                    saveMessage(text, 'bot');
                }, typingTime);
            }, delay);
        }

        function showUserMessage(text) {
            chatState.messageCount++;
            const message = document.createElement('div');
            message.className = 'chat-message user-message';
            message.textContent = text;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
            
            // Save message to session
            saveMessage(text, 'user');
        }

        function showOptions(optionsArray) {
            options.innerHTML = '';
            inputArea.style.display = 'none';
            autocompleteResults.style.display = 'none';
            
            optionsArray.forEach(option => {
                const button = document.createElement('button');
                button.className = 'chat-option' + (option.primary ? ' primary' : '');
                button.textContent = option.text;
                if (option.disabled) {
                    button.disabled = true;
                }
                button.addEventListener('click', () => handleOption(option));
                
                // Add touch event for mobile
                if (isMobile) {
                    button.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        handleOption(option);
                    });
                }
                
                options.appendChild(button);
            });
            
            updateNavigationButtons();
            saveSession();
        }

        function showInput(placeholder = "Type your answer...") {
            options.innerHTML = '';
            inputArea.style.display = 'flex';
            input.placeholder = placeholder;
            input.value = '';
            
            // Focus input on desktop only
            if (!isMobile) {
                input.focus();
            }
            
            updateNavigationButtons();
            saveSession();
        }

        function handleOption(option) {
            showUserMessage(option.text);
            processResponse(option.value);
        }

        function handleSend() {
    // Ensure input exists and has value
    if (!input) {
        console.error('Input element not found');
        return;
    }
    
    const value = input.value.trim();
    if (!value) return;
    
    // Ensure we can show messages
    if (!messages) {
        console.error('Messages container not found');
        return;
    }
    
    autocompleteResults.style.display = 'none';
    showUserMessage(value);
    input.value = '';
    
    // On mobile, blur input after sending
    if (isMobile) {
        input.blur();
    }
    
    processResponse(value);
}

        // Calculate distance using Google Maps
        async function calculateDistance(origin, destination) {
            return new Promise((resolve, reject) => {
                if (!chatState.directionsService) {
                    reject(new Error('Directions service not initialized'));
                    return;
                }

                chatState.directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    avoidTolls: false,
                    avoidHighways: false
                }, (response, status) => {
                    if (status === 'OK' && response.routes && response.routes[0]) {
                        const route = response.routes[0];
                        let distance = 0;
                        let duration = 0; // Add duration tracking
                        let hasTolls = false;
                        
                        for (let i = 0; i < route.legs.length; i++) {
                            distance += route.legs[i].distance.value;
                            duration += route.legs[i].duration.value; // Sum up duration in seconds
                            
                            // Check for tolls
                            if (route.legs[i].steps) {
                                for (let j = 0; j < route.legs[i].steps.length; j++) {
                                    const step = route.legs[i].steps[j];
                                    if (step.instructions && step.instructions.toLowerCase().includes('toll')) {
                                        hasTolls = true;
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Convert to miles and hours
                        const miles = (distance / 1609.34).toFixed(1);
                        const hours = (duration / 3600).toFixed(2); // Convert seconds to hours
                        resolve({ distance: miles, duration: hours, hasTolls: hasTolls });
                    } else {
                        reject(new Error('Unable to calculate distance. Please check the address and try again.'));
                    }
                });
            });
        }

        // Add this helper function right here
        async function calculateDistanceFromDeliveryToBase() {
            return new Promise((resolve, reject) => {
                if (!chatState.directionsService) {
                    reject(new Error('Directions service not initialized'));
                    return;
                }

                chatState.directionsService.route({
                    origin: chatState.data.to,
                    destination: CONFIG.baseAddress,
                    travelMode: google.maps.TravelMode.DRIVING,
                    avoidTolls: false,
                    avoidHighways: false
                }, (response, status) => {
                    if (status === 'OK' && response.routes && response.routes[0]) {
                        const route = response.routes[0];
                        let distance = 0;
                        let duration = 0;
                        
                        for (let i = 0; i < route.legs.length; i++) {
                            distance += route.legs[i].distance.value;
                            duration += route.legs[i].duration.value;
                        }
                        
                        // Convert to miles and hours
                        const miles = (distance / 1609.34).toFixed(1);
                        const hours = (duration / 3600).toFixed(2);
                        resolve({ distance: miles, duration: hours });
                    } else {
                        // Fallback to using fromDistance as estimate
                        resolve({ 
                            distance: chatState.data.fromDistance || 30,
                            duration: ((chatState.data.fromDistance || 30) / 45).toFixed(2) // Fallback to 45mph
                        });
                    }
                });
            });
        }

        // Calculate packing materials based on bedrooms
        function calculatePackingMaterials(bedrooms) {
            const materials = {
                smallBox: { qty: 6 + (bedrooms * 8), cost: 0 },
                mediumBox: { qty: 6 + (bedrooms * 6), cost: 0 },
                largeBox: { qty: 2 + (bedrooms * 4), cost: 0 },
                wardrobeBox: { qty: bedrooms * 2, cost: 0 },
                movingBlanket: { qty: 12 + (bedrooms * 6), cost: 0 },
                packingPaper: { qty: Math.ceil(bedrooms * 0.5), cost: 0 },
                packingTape: { qty: Math.ceil(bedrooms * 0.50), cost: 0 },
                furnitureCover: { qty: Math.ceil(bedrooms * 2), cost: 0 },
                dishpack: { qty: Math.ceil(bedrooms * 0.75), cost: 0 },
                smallBubbleWrap: { qty: Math.ceil(bedrooms * 0.50), cost: 0 },
                largeBubbleWrap: { qty: Math.ceil(bedrooms * 0.50), cost: 0 }
            };

            let totalCost = 0;
            let itemsList = [];

            // Calculate costs
            Object.keys(materials).forEach(key => {
                const item = materials[key];
                const materialConfig = CONFIG.materials[key];
                item.cost = item.qty * materialConfig.price;
                totalCost += item.cost;
                
                if (item.qty > 0) {
                    itemsList.push({
                        name: materialConfig.name,
                        qty: item.qty,
                        unitPrice: materialConfig.price,
                        total: item.cost
                    });
                }
            });

            return {
                items: itemsList,
                total: totalCost
            };
        }

        // Calculate FVP cost (fixed NaN issue)
        function calculateFVPCost(value, deductible, tripDistance) {
            // Ensure all values are numbers
            const cleanValue = parseFloat(value) || 0;
            const cleanDeductible = parseInt(deductible) || 0;
            const cleanTripDistance = parseFloat(tripDistance) || 30;
            
            const baseRate = cleanTripDistance > 50 ? CONFIG.rates.fvp.longDistance : CONFIG.rates.fvp.local;
            let fvpCost = cleanValue * baseRate;
            
            // Apply deductible discount
            const deductibleLevels = [0, 250, 500, 750, 1000];
            const selectedIndex = deductibleLevels.indexOf(cleanDeductible);
            
            // Apply 15% discount for each level of deductible
            for (let i = 0; i < selectedIndex; i++) {
                fvpCost *= 0.85;
            }

            // Ensure minimum charge
            fvpCost = Math.max(fvpCost, CONFIG.rates.fvp.minCharge);
            
            return parseFloat(fvpCost.toFixed(2));
        }

        // Format currency
        function formatMoney(amount) {
            const cleanAmount = parseFloat(amount) || 0;
            return '$' + cleanAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Format date
        function formatDate(dateString) {
            try {
                const date = parseDate(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            } catch (e) {
                return dateString;
            }
        }

        // FIXED: Process user responses with enhanced handling and complete flow
        async function processResponse(value) {
            console.log('>>> processResponse called - Stage:', chatState.stage, 'Value:', value);

            // Save navigation state before processing
            if (!['restart', 'continue', 'back_to_questions'].includes(value)) {
                saveNavigationState();
            }

            // Handle restart
            if (value === 'restart') {
                clearSession();
                messages.innerHTML = '';
                startConversation();
                return;
            }
            
            // Handle continue
            if (value === 'continue') {
                restoreUIState();
                return;
            }
            
            // Handle photo upload responses
            if (value === 'add_photos' || value === 'add_more_photos') {
                showPhotoUpload();
                return;
            }
            
            if (value === 'proceed_with_photos') {
                proceedWithPhotos();
                return;
            }
            
            if (value === 'proceed_without_photos') {
                proceedWithoutPhotos();
                return;
            }
            
            // Handle pest disclaimer exit
            if (value === 'exit_pest_issues') {
                showBotMessage("I understand. Please contact us at 330-435-8686 once any pest issues have been addressed. We'll be happy to help with your move then!");
                showOptions([
                    { text: "üìû Call: 330-435-8686", value: "call" },
                    { text: "üí¨ Start Over", value: "restart" }
                ]);
                return;
            }
            
            // Handle insurance claim
            if (value === 'insurance_claim') {
                chatState.stage = 'insurance_claims_start';
                chatState.data.photoCategory = 'insurance';
                showBotMessage("I'm sorry to hear about the damage. I'm here to help you file your claim quickly and easily.");
                
                setTimeout(() => {
                    showBotMessage("What type of coverage did you have?");
                    showOptions([
                        { text: "Free Standard Coverage ($0.60/lb per article)", value: "standard_coverage" },
                        { text: "Full Value Protection (FVP)", value: "fvp_coverage" }
                    ]);
                    saveSession();
                }, 1200);
                return;
            }
            
            // Handle numeric hours input
            if (chatState.stage === 'hours' && !isNaN(value)) {
                const hours = parseInt(value);
                if (hours >= 2 && hours <= 12) {
                    chatState.data.hours = hours;
                    // Check if we should offer photos for labor service
                    if (chatState.serviceType === 'labor') {
                        chatState.stage = 'offer_photos_labor';
                        showBotMessage("Would you like to add photos? This helps our crew come prepared with proper tools.");
                        showBotMessage(PHOTO_SUGGESTIONS.labor, 800);
                        setTimeout(() => {
                            showPhotoUpload();
                        }, 1500);
                    } else {
                        calculateAndShowEstimate();
                    }
                    return;
                } else {
                    showBotMessage("Please enter a number between 2 and 12 hours.");
                    showInput("Enter number of hours (2-12)...");
                    return;
                }
            }
            
            // Handle FVP value input
            if (chatState.stage === 'fvp_value' && !isNaN(value)) {
                const fvpValue = parseFloat(value);
                if (fvpValue > 0) {
                    chatState.data.fvpValue = fvpValue;
                    chatState.stage = 'fvp_deductible';
                    showBotMessage("Choose your deductible option:");
                    showOptions([
                        { text: "$0 Deductible", value: "0" },
                        { text: "$250 Deductible (15% discount)", value: "250" },
                        { text: "$500 Deductible (30% discount)", value: "500" },
                        { text: "$750 Deductible (45% discount)", value: "750" },
                        { text: "$1,000 Deductible (60% discount)", value: "1000" }
                    ]);
                    saveSession();
                    return;
                } else {
                    showBotMessage("Please enter a valid value greater than 0.");
                    showInput("Enter total value...");
                    return;
                }
            }
            
            switch (chatState.stage) {
                case 'get_email_early':
                    if (validateEmail(value)) {
                        chatState.data.email = value;
                        chatState.stage = 'get_phone_early';
                        showBotMessage("Great! And what's the best phone number to reach you? üìû");
                        showInput("Enter your phone number...");
                        saveSession();
                    } else {
                        showBotMessage("Hmm, that doesn't look like a valid email. Please try again:");
                        showInput("Enter a valid email address...");
                    }
                    break;

                case 'get_phone_early':
                    if (validatePhone(value)) {
                        chatState.data.phone = value;
                        showBotMessage("Awesome! Now let's get you an estimate. üíØ");

                        setTimeout(() => {
                            showBotMessage("What type of service do you need today?");
                            showOptions([
                                { text: "üöö Full Moving Service", value: "moving" },
                                { text: "üí™ Labor Only (I have truck)", value: "labor" },
                                { text: "üì¶ Single Item Move", value: "single" },
                                { text: "üóëÔ∏è Cleanout/Junk Removal", value: "cleanout" },
                                { text: "‚ùì I have questions", value: "questions" },
                                { text: "üõ°Ô∏è File Insurance Claim", value: "insurance_claim" }
                            ]);
                            chatState.stage = 'service_selection';
                            saveSession();
                        }, 1200);
                    } else {
                        showBotMessage("Please enter a valid phone number (at least 10 digits):");
                        showInput("Enter valid phone number...");
                    }
                    break;

                case 'get_name_initial':
                    const parsedName = parseFullName(value);
                    if (parsedName) {
                        chatState.data.name = value;
                        chatState.data.firstName = parsedName.firstName;
                        chatState.data.lastName = parsedName.lastName;
                        const acknowledgment = getRandomResponse(SARAH_PERSONALITY.acknowledgments);
                        showBotMessage(`${acknowledgment} Nice to meet you, ${parsedName.firstName}! üòä`);
                        
                        // Add trust builder with Sarah's expertise
                        setTimeout(() => {
                            const trustMessage = getRandomResponse(SALES_MESSAGES.trust);
                            showBotMessage(trustMessage);
                            
                            // Add Sarah's expertise tip
                            const expertiseTip = getRandomResponse(SARAH_PERSONALITY.expertise);
                            showBotMessage(expertiseTip, 800);
                        }, 800);
                        
                        setTimeout(() => {
                            showBotMessage("Perfect! What's your email address? I'll send your quote there. üìß");
                            showInput("Enter your email...");
                            chatState.stage = 'get_email_early';
                            saveSession();
                        }, 3000);
                    } else {
                        showBotMessage("I need both your first and last name to proceed. Please enter your full name:");
                        showInput("Enter your first and last name...");
                    }
                    break;
                    
                case 'collect_full_name':
                    const fullName = parseFullName(value);
                    if (fullName) {
                        chatState.data.firstName = fullName.firstName;
                        chatState.data.lastName = fullName.lastName;
                        
                        // Check if we need email or phone next
                        if (!chatState.data.email) {
                            chatState.stage = 'collect_email_required';
                            showBotMessage("What's your email address?");
                            showInput("Enter your email...");
                        } else if (!chatState.data.phone) {
                            chatState.stage = 'collect_phone_required';
                            showBotMessage("And your phone number?");
                            showInput("Enter your phone number...");
                        } else if (chatState.data.pendingAutoSubmit) {
                            // All info collected, resolve promise
                            chatState.data.pendingAutoSubmit();
                            chatState.data.pendingAutoSubmit = null;
                        }
                    } else {
                        showBotMessage("Please enter both your first and last name:");
                        showInput("Enter your first and last name...");
                    }
                    saveSession();
                    break;
                    
                case 'collect_email_required':
                    if (validateEmail(value)) {
                        chatState.data.email = value;
                        
                        // Check if we need phone next
                        if (!chatState.data.phone) {
                            chatState.stage = 'collect_phone_required';
                            showBotMessage("And your phone number?");
                            showInput("Enter your phone number...");
                        } else if (chatState.data.pendingAutoSubmit) {
                            // All info collected, resolve promise
                            chatState.data.pendingAutoSubmit();
                            chatState.data.pendingAutoSubmit = null;
                        }
                    } else {
                        showBotMessage("Hmm, that doesn't look like a valid email. Please try again:");
                        showInput("Enter a valid email address...");
                    }
                    saveSession();
                    break;
                    
                case 'collect_phone_required':
    if (validatePhone(value)) {
        chatState.data.phone = value;
        
        // Check what flow we're in
        if (chatState.data.invoiceNumber !== undefined) {
            // This is insurance claim flow
            submitInsuranceClaim();
        } else if (chatState.data.pendingAutoSubmit) {
            // This is auto-submit flow - resolve the promise
            chatState.data.pendingAutoSubmit();
            chatState.data.pendingAutoSubmit = null;
        } else {
            // Regular flow - check if we should submit lead or if already submitted
            if (!chatState.data.quoteSubmitted) {
                // Submit the lead
                submitLead();
            } else {
                // Quote already submitted, return to booking options
                showBotMessage("Great! Now let's get you scheduled.");
                chatState.stage = 'show_booking_options';
                showFinalBookingOptions();
            }
        }
    } else {
        showBotMessage("Please enter a valid phone number (at least 10 digits):");
        showInput("Enter your phone number...");
    }
    saveSession();
    break;
                    
                case 'service_selection':
                    if (value === 'questions') {
                        chatState.stage = 'questions';
                        showBotMessage("I'm happy to help! What would you like to know?");
                        showOptions([
                            { text: "üìç Service areas", value: "service_areas" },
                            { text: "üí∞ What's included?", value: "whats_included" },
                            { text: "üì¶ Packing services", value: "packing_info" },
                            { text: "üö´ Items you don't move", value: "restricted_items" },
                            { text: "‚≠ê Why choose Worry Free?", value: "why_choose_us" },
                            { text: "üì∏ Upload photos for estimate", value: "insurance_photos" },
                            { text: "‚Ü©Ô∏è Get an estimate", value: "restart" }
                        ]);
                    } else if (value === 'insurance_claim') {
                        processResponse('insurance_claim');
                    } else if (value === 'cleanout') {
                        // Cleanout/Junk Removal flow
                        chatState.serviceType = 'cleanout';
                        chatState.stage = 'cleanout_location';

                        const ack = getRandomResponse(SARAH_PERSONALITY.acknowledgments);
                        showBotMessage(`${ack} I'll help you with cleanout and junk removal services.`);

                        setTimeout(() => {
                            showBotMessage("First, I need the location where we'll be working. What's the address?");
                            showBotMessage("üí° Tip: Start typing and I'll suggest addresses!", 800);
                            showInput("Start typing address...");
                            saveSession();
                        }, 1200);
                    } else {
                        chatState.serviceType = value;

                        if (value === 'single') {
                            // For single item, show categories first
                            chatState.stage = 'item_type';
                            const ack = getRandomResponse(SARAH_PERSONALITY.acknowledgments);
                            showBotMessage(`${ack} I'll help you move a single item.`);
                            
                            setTimeout(() => {
                                showBotMessage("What category best describes your item?");
                                showOptions([
                                    { text: "üõãÔ∏è Furniture", value: "category_furniture" },
                                    { text: "üîå Appliance", value: "category_appliance" },
                                    { text: "üõèÔ∏è Furniture Set", value: "category_set" },
                                    { text: "üèãÔ∏è Heavy/Special Item", value: "category_heavy" },
                                    { text: "üì¶ Other", value: "other" }
                                ]);
                                saveSession();
                            }, 1200);
                        } else {
                            // Existing moving/labor flow
                            chatState.stage = 'moving_date';
                            
                            const serviceNames = {
                                'moving': 'full moving service',
                                'labor': 'labor crew',
                                'single': 'single item move'
                            };
                            
                            const ack = getRandomResponse(SARAH_PERSONALITY.acknowledgments);
                            showBotMessage(`${ack} I'll help you get a ${serviceNames[value]} estimate.`);
                            
                            setTimeout(() => {
                                showBotMessage("Let's start with your moving date. When would you like to schedule your service? üìÖ");
                                
                                // Add Sarah's expertise about booking timing
                                const expertAdvice = "üí° Pro tip: Weekends fill up fast! Consider a weekday for better availability and rates.";
                                showBotMessage(expertAdvice, 800);
                                
                                setTimeout(() => {
                                    showDatePicker();
                                    saveSession();
                                }, 1200);
                            }, 1200);
                        }
                    }
                    break;
                    
                case 'moving_date':
    // Try to parse the date with enhanced parsing
    const parsedDate = parseDate(value);
    if (isNaN(parsedDate.getTime())) {
        showBotMessage("I couldn't understand that date format. Could you please try again?");
        showBotMessage("Examples: 'March 15', '3/15/2024', 'Next Tuesday', 'Tomorrow'");
        showDatePicker();
        return;
    }
    
    chatState.data.movingDate = value;
    chatState.data.formattedDate = formatDate(value);
    
    // Check if date is soon for urgency
    const today = new Date();
    const daysDiff = Math.ceil((parsedDate - today) / (1000 * 60 * 60 * 24));
    
    if (daysDiff <= 7 && daysDiff >= 0) {
        showBotMessage(`<div class="highlight-box">
            <span class="urgency-text">‚ö° That's coming up soon - ${daysDiff} days away!</span><br>
            We MAY have availability but spots are filling fast.
        </div>`);
        
        // Add Sarah's urgency tip
        showBotMessage("üöÄ Sarah's tip: For last-minute moves, I recommend calling right after this estimate to secure your spot!", 1000);
    } else {
        // Add encouragement from Sarah
        const encouragement = getRandomResponse(SARAH_PERSONALITY.encouragement);
        showBotMessage(encouragement);
    }
    
    showBotMessage(`Perfect! I have ${chatState.data.formattedDate} noted for your service.`);
    
    // For single items, skip pest disclaimer and go straight to location
    if (chatState.serviceType === 'single') {
        chatState.stage = 'location_from';
        setTimeout(() => {
            showBotMessage("Now I need the pickup address for your " + (chatState.data.itemName || 'item') + ".");
            if (isMobile) {
                showBotMessage("üí° Type your street address and I'll help you complete it!");
            } else {
                showBotMessage("üí° Tip: Start typing and I'll suggest addresses!");
            }
            showInput("Start typing pickup address...");
            saveSession();
        }, 1500);
    } else {
        // Show pest disclaimer for moving/labor services
        chatState.stage = 'pest_disclaimer';
        
        setTimeout(() => {
            showBotMessage("Before we continue, I need to show you an important notice:");
            showPestDisclaimer();
            saveSession();
        }, 1500);
    }
    break;
                    
                case 'pest_disclaimer':
                    if (value === 'continue_after_disclaimer') {
                        if (!chatState.data.pestDisclaimerAgreed) {
                            showBotMessage("You must agree to the pest control disclaimer to continue.");
                            showPestDisclaimer();
                            return;
                        }

                        // NEW FLOW: Start with Location 1
                        if (chatState.serviceType === 'moving') {
                            chatState.stage = 'location_1';
                            showBotMessage("Great! Now I'll collect the addresses for your move.");
                            showBotMessage("What's the pickup address (Location 1)?");
                            if (isMobile) {
                                showBotMessage("üí° Type your street address and I'll help you complete it!");
                            } else {
                                showBotMessage("üí° Tip: Start typing and I'll suggest addresses!");
                            }
                            showInput("Start typing pickup address (Location 1)...");
                        } else {
                            // Labor service uses old flow
                            chatState.stage = 'location_from';
                            showBotMessage("Now I'll need your complete starting address to calculate the estimate.");
                            if (isMobile) {
                                showBotMessage("üí° Type your street address and I'll help you complete it!");
                            } else {
                                showBotMessage("üí° Tip: Start typing and I'll suggest addresses!");
                            }
                            showInput("Start typing your address...");
                        }
                        saveSession();
                    }
                    break;
                    
                case 'location_from':
                    chatState.data.from = value;
                    
                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Could you please enter a complete address including street, city, and state?");
                        showBotMessage("Example: 123 Main Street, Youngstown, OH 44512");
                        showInput("Enter complete address...");
                        return;
                    }
                    
                    // Show thinking message
                    const thinking = getRandomResponse(SARAH_PERSONALITY.thinking);
                    showBotMessage(thinking);
                    
                    // Calculate distance
                    try {
                        const result = await calculateDistance(CONFIG.baseAddress, value);
                        chatState.data.fromDistance = parseFloat(result.distance);
                        chatState.data.fromDuration = parseFloat(result.duration); // Store duration
                        chatState.data.fromHasTolls = result.hasTolls;
                        
                        showBotMessage(`Distance from our base: ${result.distance} miles (${Math.ceil(result.duration * 60)} minutes drive) ‚úÖ`);
                        
                        if (chatState.data.fromDistance > 150) {
                            showBotMessage("üö® This location might be outside our standard service area. You may need to call for a custom quote.");
                            showOptions([
                                { text: "üìû Call 330-435-8686", value: "call", primary: true },
                                { text: "Continue anyway", value: "continue_anyway" },
                                { text: "‚Ü©Ô∏è Start over", value: "restart" }
                            ]);
                        } else {
                            // Ask about stairs at pickup location
                            chatState.stage = 'stairs_from';
                            setTimeout(() => {
                                showBotMessage("Are there any stairs at your current location?");
                                showOptions([
                                    { text: "No stairs", value: "0" },
                                    { text: "1 flight", value: "1" },
                                    { text: "2 flights", value: "2" },
                                    { text: "3+ flights", value: "3" }
                                ]);
                                saveSession();
                            }, 800);
                        }
                        saveSession();
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;
                    
                case 'stairs_from':
                    chatState.data.stairsFrom = parseInt(value);
                    
                    if (chatState.serviceType === 'single') {
                        // For single items, go to destination address
                        chatState.stage = 'location_to';
                        showBotMessage("Great! Now I need the delivery address.");
                        showInput("Start typing delivery address...");
                        saveSession();
                    } else {
                        proceedAfterFromLocation();
                    }
                    break;
                    
                case 'location_to':
                    chatState.data.to = value;
                    
                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Please enter a complete address including street, city, and state.");
                        showInput("Enter complete address...");
                        return;
                    }
                    
                    showBotMessage("Calculating trip distance and time... üó∫Ô∏è");
                    
                    // Calculate trip distance
                    try {
                        const result = await calculateDistance(chatState.data.from, value);
                        chatState.data.tripDistance = parseFloat(result.distance);
                        chatState.data.tripDuration = parseFloat(result.duration); // Store duration
                        chatState.data.tripHasTolls = result.hasTolls;
                        
                        // Estimate toll costs
                        if (result.hasTolls || chatState.data.fromHasTolls) {
                            chatState.data.tollCost = Math.max(10, chatState.data.tripDistance * CONFIG.tollCostFactor);
                        } else {
                            chatState.data.tollCost = 0;
                        }
                        
                        showBotMessage(`Trip distance: ${result.distance} miles (${Math.ceil(result.duration * 60)} minutes drive) ‚úÖ`);
                        if (chatState.data.tollCost > 0) {
                            showBotMessage(`<div class="highlight-box">üìç Note: This route includes toll roads. Estimated toll cost: ${formatMoney(chatState.data.tollCost)}</div>`);
                        }
                        
                        // Ask about stairs at destination
                        chatState.stage = 'stairs_to';
                        setTimeout(() => {
                            showBotMessage("Are there any stairs at your destination?");
                            showOptions([
                                { text: "No stairs", value: "0" },
                                { text: "1 flight", value: "1" },
                                { text: "2 flights", value: "2" },
                                { text: "3+ flights", value: "3" }
                            ]);
                            saveSession();
                        }, 800);
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;
                    
                case 'stairs_to':
                    chatState.data.stairsTo = parseInt(value);
                    
                    if (chatState.serviceType === 'single') {
                        // For single items, also set the delivery stairs with the correct variable name
                        chatState.data.deliveryStairs = parseInt(value);
                        
                        // Offer photos for single item
                        chatState.stage = 'offer_photos_single';
                        chatState.data.photoCategory = 'single';
                        showBotMessage(`Would you like to add photos of your ${chatState.data.itemName || 'item'}? This ensures we bring the right equipment.`);
                        showBotMessage(PHOTO_SUGGESTIONS.single, 800);
                        setTimeout(() => {
                            showPhotoUpload();
                        }, 1500);
                        saveSession();
                    } else {
                        // Ask about third location for moving service
                        chatState.stage = 'ask_third_location';
                        showBotMessage("Do you have a third location (like a storage unit)?");
                        showOptions([
                            { text: "No, just these two locations", value: "no" },
                            { text: "Yes, I have a third stop", value: "yes" }
                        ]);
                        saveSession();
                    }
                    break;

                case 'cleanout_location':
                    chatState.data.cleanoutLocation = value;

                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Could you please enter a complete address including street, city, and state?");
                        showBotMessage("Example: 123 Main Street, Youngstown, OH 44512");
                        showInput("Enter complete address...");
                        return;
                    }

                    showBotMessage("Calculating distance from our base... üó∫Ô∏è");

                    // Calculate distance from base
                    try {
                        const result = await calculateDistance(CONFIG.baseAddress, value);
                        chatState.data.cleanoutDistance = parseFloat(result.distance);
                        chatState.data.cleanoutDuration = parseFloat(result.duration);

                        showBotMessage(`Distance from our base: ${result.distance} miles (${Math.ceil(result.duration * 60)} minutes drive) ‚úÖ`);

                        if (chatState.data.cleanoutDistance > 150) {
                            showBotMessage("üö® This location might be outside our standard service area. You may need to call for a custom quote.");
                            showOptions([
                                { text: "üìû Call 330-435-8686", value: "call", primary: true },
                                { text: "Continue anyway", value: "continue_anyway" },
                                { text: "‚Ü©Ô∏è Start over", value: "restart" }
                            ]);
                        } else {
                            // Ask if it's junk removal or cleanout
                            chatState.stage = 'cleanout_type';
                            setTimeout(() => {
                                showBotMessage("Is this a junk removal or a cleanout service?");
                                showOptions([
                                    { text: "üóëÔ∏è Junk Removal (1 hour)", value: "junk" },
                                    { text: "üßπ Cleanout (2+ hours)", value: "cleanout_service" }
                                ]);
                                saveSession();
                            }, 800);
                        }
                        saveSession();
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;

                case 'cleanout_type':
                    chatState.data.cleanoutType = value;

                    if (value === 'junk') {
                        // Junk removal flow
                        chatState.stage = 'junk_hazardous';
                        showBotMessage("Safety first! Is any of the material hazardous (paint, chemicals, batteries, etc.)?");
                        showOptions([
                            { text: "No hazardous materials", value: "no" },
                            { text: "Yes, there are hazardous items", value: "yes" }
                        ]);
                        saveSession();
                    } else {
                        // Cleanout service flow - skip hazard check, go to hours
                        chatState.stage = 'cleanout_hours';
                        showBotMessage("How many hours do you estimate you'll need? (Minimum 2 hours, included in base price)");
                        showOptions([
                            { text: "2 hours", value: "2" },
                            { text: "3 hours", value: "3" },
                            { text: "4 hours", value: "4" },
                            { text: "5+ hours", value: "5" }
                        ]);
                        saveSession();
                    }
                    break;

                case 'junk_hazardous':
                    if (value === 'yes') {
                        showBotMessage("‚ö†Ô∏è We cannot dispose of hazardous materials. Please contact your local waste management facility for proper disposal of hazardous items.");
                        showBotMessage("For non-hazardous junk removal, feel free to call us at 330-435-8686!");
                        showOptions([
                            { text: "üìû Call: 330-435-8686", value: "call" },
                            { text: "‚Ü©Ô∏è Start Over", value: "restart" }
                        ]);
                        return;
                    }

                    // Ask for photos
                    chatState.stage = 'junk_photos';
                    chatState.data.photoCategory = 'junk';
                    showBotMessage("Great! Please upload photos of the junk to be removed. This helps us prepare properly.");
                    showBotMessage("üì∏ Pro tip: Take photos from different angles to show the full scope of work!", 800);
                    setTimeout(() => {
                        showPhotoUpload();
                    }, 1500);
                    saveSession();
                    break;

                case 'cleanout_hours':
                    chatState.data.cleanoutHours = parseInt(value);

                    // Move to crew size selection
                    chatState.stage = 'cleanout_crew';
                    showBotMessage("How many crew members do you think you'll need?");
                    showOptions([
                        { text: "2 crew members (standard)", value: "2" },
                        { text: "3 crew members", value: "3" },
                        { text: "4 crew members", value: "4" }
                    ]);
                    saveSession();
                    break;

                case 'junk_crew':
                    chatState.data.cleanoutCrew = parseInt(value);

                    // Calculate and show junk removal estimate
                    calculateAndShowCleanoutEstimate();
                    break;

                case 'cleanout_crew':
                    chatState.data.cleanoutCrew = parseInt(value);

                    // Calculate and show cleanout estimate
                    calculateAndShowCleanoutEstimate();
                    break;

                case 'ask_third_location':
                    chatState.data.hasThirdLocation = value === 'yes';
                    
                    if (value === 'yes') {
                        chatState.stage = 'location_third';
                        showBotMessage("What's the address of the third location?");
                        showInput("Start typing third location address...");
                    } else {
                        // No third location, proceed to home type
                        proceedAfterToLocation();
                    }
                    saveSession();
                    break;
                    
                case 'location_third':
                    chatState.data.thirdLocation = value;
                    chatState.data.hasThirdLocation = true;
                    
                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Please enter a complete address including street, city, and state.");
                        showInput("Enter complete address...");
                        return;
                    }
                    
                    showBotMessage("Calculating additional distance and time... üó∫Ô∏è");
                    
                    // Calculate distances for third location
                    try {
                        // Calculate from destination to third location
                        const toThird = await calculateDistance(chatState.data.to, value);
                        // Calculate from third location back to base
                        const thirdToBase = await calculateDistance(value, CONFIG.baseAddress);
                        
                        chatState.data.thirdLocationDistance = parseFloat(toThird.distance);
                        chatState.data.thirdLocationDuration = parseFloat(toThird.duration); // Store duration
                        chatState.data.thirdToBaseDistance = parseFloat(thirdToBase.distance);
                        chatState.data.thirdToBaseDuration = parseFloat(thirdToBase.duration); // Store duration
                        
                        // Add to trip distance
                        chatState.data.totalTripDistance = chatState.data.tripDistance + 
                            chatState.data.thirdLocationDistance + 
                            chatState.data.thirdToBaseDistance;
                        
                        showBotMessage(`Additional distance for third location: ${toThird.distance} miles (${Math.ceil(toThird.duration * 60)} minutes) ‚úÖ`);
                        showBotMessage(`Total trip with all stops: ${chatState.data.totalTripDistance.toFixed(1)} miles`);
                        
                        // Ask about stairs at third location
                        chatState.stage = 'stairs_third';
                        setTimeout(() => {
                            showBotMessage("Are there any stairs at the third location?");
                            showOptions([
                                { text: "No stairs", value: "0" },
                                { text: "1 flight", value: "1" },
                                { text: "2 flights", value: "2" },
                                { text: "3+ flights", value: "3" }
                            ]);
                            saveSession();
                        }, 800);
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;
                    
                case 'stairs_third':
                    chatState.data.stairsThird = parseInt(value);
                    
                    // Ask about type of third location
                    chatState.stage = 'third_location_type';
                    showBotMessage("What type of location is your third stop?");
                    showOptions([
                        { text: "üì¶ Storage Unit", value: "storage" },
                        { text: "üè† House", value: "house" },
                        { text: "üè¢ Apartment", value: "apartment" },
                        { text: "üè¢ Business/Office", value: "business" }
                    ]);
                    saveSession();
                    break;
                    
                case 'third_location_type':
                    chatState.data.thirdLocationType = value;
                    
                    // Ask if there are items at third location that need moving
                    chatState.stage = 'third_location_items';
                    showBotMessage("Are you picking up or dropping off items at this third location?");
                    showOptions([
                        { text: "Dropping off items only", value: "drop_only" },
                        { text: "Picking up items only", value: "pick_only" },
                        { text: "Both picking up and dropping off", value: "both" }
                    ]);
                    saveSession();
                    break;
                    
                case 'third_location_items':
                    chatState.data.thirdLocationAction = value;
                    proceedAfterToLocation();
                    break;

                // NEW FLOW: Phase 1 - Collect all addresses first
                case 'location_1':
                    console.log('=== LOCATION_1 PROCESSING START ===');
                    console.log('Address value:', value);
                    console.log('DirectionsService initialized:', !!chatState.directionsService);

                    // Ensure location details objects exist
                    if (!chatState.data.location1Details) {
                        chatState.data.location1Details = {
                            address: null,
                            homeType: null,
                            bedrooms: null,
                            challenges: [],
                            hasChallenges: false
                        };
                    }

                    chatState.data.location1Details.address = value;
                    chatState.data.from = value; // Maintain backward compatibility

                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        console.log('Address validation failed - missing comma or not enough parts');
                        showBotMessage("Could you please enter a complete address including street, city, and state?");
                        showBotMessage("Example: 123 Main Street, Youngstown, OH 44512");
                        showInput("Enter complete address...");
                        return;
                    }

                    console.log('Address validation passed, calculating distance...');
                    showBotMessage("Calculating distance from our base... üó∫Ô∏è");

                    try {
                        console.log('Calling calculateDistance from:', CONFIG.baseAddress, 'to:', value);
                        const result = await calculateDistance(CONFIG.baseAddress, value);
                        console.log('Distance calculation result:', result);

                        chatState.data.fromDistance = parseFloat(result.distance);
                        chatState.data.fromDuration = parseFloat(result.duration);
                        chatState.data.fromHasTolls = result.hasTolls;

                        showBotMessage(`Distance from our base: ${result.distance} miles (${Math.ceil(result.duration * 60)} minutes drive) ‚úÖ`);

                        if (chatState.data.fromDistance > 150) {
                            console.log('Distance > 150 miles, showing out-of-area options');
                            showBotMessage("üö® This location might be outside our standard service area. You may need to call for a custom quote.");
                            showOptions([
                                { text: "üìû Call 330-435-8686", value: "call", primary: true },
                                { text: "Continue anyway", value: "continue_anyway" },
                                { text: "‚Ü©Ô∏è Start over", value: "restart" }
                            ]);
                        } else {
                            console.log('Distance OK, moving to location_2');
                            // Move to Location 2
                            chatState.stage = 'location_2';
                            setTimeout(() => {
                                showBotMessage("What's the delivery address (Location 2)?");
                                showInput("Start typing delivery address (Location 2)...");
                                saveSession();
                            }, 800);
                        }
                        saveSession();
                        console.log('=== LOCATION_1 PROCESSING END - SUCCESS ===');
                    } catch (error) {
                        console.error('=== LOCATION_1 ERROR ===', error);
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;

                case 'location_2':
                    // Ensure location details objects exist
                    if (!chatState.data.location2Details) {
                        chatState.data.location2Details = {
                            address: null,
                            homeType: null,
                            bedrooms: null,
                            challenges: [],
                            hasChallenges: false
                        };
                    }

                    chatState.data.location2Details.address = value;
                    chatState.data.to = value; // Maintain backward compatibility

                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Please enter a complete address including street, city, and state.");
                        showInput("Enter complete address...");
                        return;
                    }

                    showBotMessage("Calculating trip distance and time... üó∫Ô∏è");

                    try {
                        const result = await calculateDistance(chatState.data.location1Details.address, value);
                        chatState.data.tripDistance = parseFloat(result.distance);
                        chatState.data.tripDuration = parseFloat(result.duration);
                        chatState.data.tripHasTolls = result.hasTolls;

                        // Estimate toll costs
                        if (result.hasTolls || chatState.data.fromHasTolls) {
                            chatState.data.tollCost = Math.max(10, chatState.data.tripDistance * CONFIG.tollCostFactor);
                        } else {
                            chatState.data.tollCost = 0;
                        }

                        showBotMessage(`Trip distance: ${result.distance} miles (${Math.ceil(result.duration * 60)} minutes drive) ‚úÖ`);
                        if (chatState.data.tollCost > 0) {
                            showBotMessage(`<div class="highlight-box">üìç Note: This route includes toll roads. Estimated toll cost: ${formatMoney(chatState.data.tollCost)}</div>`);
                        }

                        // Ask about third location
                        chatState.stage = 'ask_location_3';
                        setTimeout(() => {
                            showBotMessage("Do you have a third location (like a storage unit)?");
                            showOptions([
                                { text: "No, just these two locations", value: "no" },
                                { text: "Yes, I have a third stop", value: "yes" }
                            ]);
                            saveSession();
                        }, 800);
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;

                case 'ask_location_3':
                    if (value === 'yes') {
                        chatState.data.hasThirdLocation = true;
                        chatState.stage = 'location_3';
                        showBotMessage("What's the address of the third location?");
                        showInput("Start typing third location address...");
                        saveSession();
                    } else {
                        chatState.data.hasThirdLocation = false;
                        // All addresses collected, move to Phase 2: Collect location details
                        proceedToLocationDetails();
                    }
                    break;

                case 'location_3':
                    // Ensure location details objects exist
                    if (!chatState.data.location3Details) {
                        chatState.data.location3Details = {
                            address: null,
                            homeType: null,
                            bedrooms: null,
                            challenges: [],
                            hasChallenges: false
                        };
                    }

                    chatState.data.location3Details.address = value;
                    chatState.data.thirdLocation = value; // Maintain backward compatibility

                    // Validate address format
                    if (!value.includes(',') || value.split(',').length < 2) {
                        showBotMessage("Please enter a complete address including street, city, and state.");
                        showInput("Enter complete address...");
                        return;
                    }

                    showBotMessage("Calculating additional distance and time... üó∫Ô∏è");

                    try {
                        // Calculate from destination to third location
                        const toThird = await calculateDistance(chatState.data.location2Details.address, value);
                        // Calculate from third location back to base
                        const thirdToBase = await calculateDistance(value, CONFIG.baseAddress);

                        chatState.data.thirdLocationDistance = parseFloat(toThird.distance);
                        chatState.data.thirdLocationDuration = parseFloat(toThird.duration);
                        chatState.data.thirdToBaseDistance = parseFloat(thirdToBase.distance);
                        chatState.data.thirdToBaseDuration = parseFloat(thirdToBase.duration);

                        // Add to trip distance
                        chatState.data.totalTripDistance = chatState.data.tripDistance +
                            chatState.data.thirdLocationDistance +
                            chatState.data.thirdToBaseDistance;

                        showBotMessage(`Additional distance for third location: ${toThird.distance} miles (${Math.ceil(toThird.duration * 60)} minutes) ‚úÖ`);
                        showBotMessage(`Total trip with all stops: ${chatState.data.totalTripDistance.toFixed(1)} miles`);

                        // All addresses collected, move to Phase 2: Collect location details
                        setTimeout(() => {
                            proceedToLocationDetails();
                        }, 1000);
                    } catch (error) {
                        showBotMessage(`<div class="error-message">‚ö†Ô∏è ${error.message}</div>`);
                        showBotMessage("Please check the address and try again:");
                        showInput("Enter complete address...");
                    }
                    break;

                // NEW FLOW: Phase 2 - Location Details Collection
                case 'location_1_home_type':
                    chatState.data.location1Details.homeType = value;
                    chatState.data.homeType = value; // Backward compatibility

                    chatState.stage = 'location_1_bedrooms';
                    showBotMessage("How many bedrooms at the 1st location?");
                    showOptions([
                        { text: "Studio", value: "0" },
                        { text: "1 Bedroom", value: "1" },
                        { text: "2 Bedrooms", value: "2" },
                        { text: "3 Bedrooms", value: "3" },
                        { text: "4 Bedrooms", value: "4" },
                        { text: "5+ Bedrooms", value: "5" }
                    ]);
                    saveSession();
                    break;

                case 'location_1_bedrooms':
                    chatState.data.location1Details.bedrooms = parseInt(value);
                    chatState.data.bedrooms = parseInt(value); // Backward compatibility

                    chatState.stage = 'location_1_stairs';
                    showBotMessage("How many flights of stairs at the 1st location?");
                    showOptions([
                        { text: "No stairs", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    saveSession();
                    break;

                case 'location_1_stairs':
                    chatState.data.location1Details.stairs = parseInt(value);
                    chatState.data.stairsFrom = parseInt(value); // Backward compatibility

                    // Move to Location 2
                    chatState.stage = 'location_2_home_type';
                    showBotMessage("What type of home is the 2nd location?");
                    showOptions([
                        { text: "üè† House", value: "house" },
                        { text: "üè¢ Apartment", value: "apartment" },
                        { text: "üè¢ Condo", value: "condo" },
                        { text: "üì¶ Storage Unit", value: "storage" }
                    ]);
                    saveSession();
                    break;

                case 'location_2_home_type':
                    chatState.data.location2Details.homeType = value;
                    chatState.data.destinationType = value; // Backward compatibility

                    chatState.stage = 'location_2_bedrooms';
                    if (value === 'storage') {
                        showBotMessage("How many bedrooms worth of items are you storing?");
                    } else {
                        showBotMessage("How many bedrooms at the 2nd location?");
                    }
                    showOptions([
                        { text: "Studio", value: "0" },
                        { text: "1 Bedroom", value: "1" },
                        { text: "2 Bedrooms", value: "2" },
                        { text: "3 Bedrooms", value: "3" },
                        { text: "4 Bedrooms", value: "4" },
                        { text: "5+ Bedrooms", value: "5" }
                    ]);
                    saveSession();
                    break;

                case 'location_2_bedrooms':
                    chatState.data.location2Details.bedrooms = parseInt(value);
                    chatState.data.bedroomsTo = parseInt(value); // Backward compatibility

                    chatState.stage = 'location_2_stairs';
                    showBotMessage("How many flights of stairs at the 2nd location?");
                    showOptions([
                        { text: "No stairs", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    saveSession();
                    break;

                case 'location_2_stairs':
                    chatState.data.location2Details.stairs = parseInt(value);
                    chatState.data.stairsTo = parseInt(value); // Backward compatibility

                    // Check if we have a third location
                    if (chatState.data.hasThirdLocation) {
                        chatState.stage = 'location_3_home_type';
                        showBotMessage("What type of location is the 3rd location?");
                        showOptions([
                            { text: "üè† House", value: "house" },
                            { text: "üè¢ Apartment", value: "apartment" },
                            { text: "üè¢ Condo", value: "condo" },
                            { text: "üì¶ Storage Unit", value: "storage" }
                        ]);
                        saveSession();
                    } else {
                        // Move to Phase 3: Large homes
                        proceedToLargeHomesQuestion();
                    }
                    break;

                case 'location_3_home_type':
                    chatState.data.location3Details.homeType = value;
                    chatState.data.location3Details.type = value;
                    chatState.data.thirdLocationType = value; // Backward compatibility

                    chatState.stage = 'location_3_bedrooms';
                    if (value === 'storage') {
                        showBotMessage("How many bedrooms worth of items at the 3rd location?");
                    } else {
                        showBotMessage("How many bedrooms at the 3rd location?");
                    }
                    showOptions([
                        { text: "Studio", value: "0" },
                        { text: "1 Bedroom", value: "1" },
                        { text: "2 Bedrooms", value: "2" },
                        { text: "3 Bedrooms", value: "3" },
                        { text: "4 Bedrooms", value: "4" },
                        { text: "5+ Bedrooms", value: "5" }
                    ]);
                    saveSession();
                    break;

                case 'location_3_bedrooms':
                    chatState.data.location3Details.bedrooms = parseInt(value);

                    chatState.stage = 'location_3_stairs';
                    showBotMessage("How many flights of stairs at the 3rd location?");
                    showOptions([
                        { text: "No stairs", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    saveSession();
                    break;

                case 'location_3_stairs':
                    chatState.data.location3Details.stairs = parseInt(value);
                    chatState.data.stairsThird = parseInt(value); // Backward compatibility

                    // Ask what they're doing at third location
                    chatState.stage = 'location_3_action';
                    showBotMessage("Are you picking up or dropping off items at the 3rd location?");
                    showOptions([
                        { text: "Dropping off items only", value: "drop_only" },
                        { text: "Picking up items only", value: "pick_only" },
                        { text: "Both picking up and dropping off", value: "both" }
                    ]);
                    saveSession();
                    break;

                case 'location_3_action':
                    chatState.data.location3Details.action = value;
                    chatState.data.thirdLocationAction = value; // Backward compatibility

                    // Move to Phase 3: Large homes
                    proceedToLargeHomesQuestion();
                    break;

                // NEW FLOW: Phase 3 - Large Homes Multi-Select
                case 'large_homes_multiselect':
                    if (value === 'done_large_homes') {
                        // Mark locations as large
                        if (chatState.data.largeHomeLocations.includes('location_1')) {
                            chatState.data.location1Details.isLarge = true;
                        }
                        if (chatState.data.largeHomeLocations.includes('location_2')) {
                            chatState.data.location2Details.isLarge = true;
                        }
                        if (chatState.data.largeHomeLocations.includes('location_3')) {
                            chatState.data.location3Details.isLarge = true;
                        }

                        // Set backward compatibility flag
                        if (chatState.data.largeHomeLocations.length > 0 && chatState.data.largeHomeLocations[0] !== 'none') {
                            chatState.data.homeSize = 'large';
                        } else {
                            chatState.data.homeSize = 'standard';
                        }

                        // Move to Phase 4: Access challenges
                        proceedToAccessChallengesQuestion();
                    } else if (value === 'none') {
                        // Clear all and mark as none
                        chatState.data.largeHomeLocations = [];
                        if (chatState.data.location1Details) chatState.data.location1Details.isLarge = false;
                        if (chatState.data.location2Details) chatState.data.location2Details.isLarge = false;
                        if (chatState.data.location3Details) chatState.data.location3Details.isLarge = false;
                    } else {
                        // Toggle selection
                        const index = chatState.data.largeHomeLocations.indexOf(value);
                        if (index > -1) {
                            chatState.data.largeHomeLocations.splice(index, 1);
                        } else {
                            // Remove 'none' if adding a specific location
                            const noneIndex = chatState.data.largeHomeLocations.indexOf('none');
                            if (noneIndex > -1) {
                                chatState.data.largeHomeLocations.splice(noneIndex, 1);
                            }
                            chatState.data.largeHomeLocations.push(value);
                        }
                        // Re-show the options (this keeps the UI showing selections)
                        proceedToLargeHomesQuestion();
                    }
                    saveSession();
                    break;

                // NEW FLOW: Phase 4 - Access Challenges Multi-Select
                case 'access_challenges_multiselect':
                    if (value === 'done_challenges') {
                        // Mark locations with challenges
                        if (chatState.data.challengeLocations.includes('location_1')) {
                            chatState.data.location1Details.hasChallenges = true;
                        }
                        if (chatState.data.challengeLocations.includes('location_2')) {
                            chatState.data.location2Details.hasChallenges = true;
                        }
                        if (chatState.data.challengeLocations.includes('location_3')) {
                            chatState.data.location3Details.hasChallenges = true;
                        }

                        // Calculate access multiplier for backward compatibility
                        const hasLargeHome = chatState.data.largeHomeLocations.length > 0 &&
                                           !chatState.data.largeHomeLocations.includes('none');
                        const hasChallenges = chatState.data.challengeLocations.length > 0 &&
                                            !chatState.data.challengeLocations.includes('none');

                        if (hasLargeHome && hasChallenges) {
                            chatState.data.accessMultiplier = CONFIG.accessFactors.combinedAccess.multiplier;
                            showBotMessage("üìè I've added extra time for large homes and access challenges");
                        } else if (hasLargeHome) {
                            chatState.data.accessMultiplier = CONFIG.accessFactors.largeHome.multiplier;
                            showBotMessage("üìè I've added time for the larger home size");
                        } else if (hasChallenges) {
                            chatState.data.accessMultiplier = CONFIG.accessFactors.longWalk.multiplier;
                            showBotMessage("üìè I've added time for access challenges");
                        } else {
                            chatState.data.accessMultiplier = 1.0;
                        }

                        // Move to TVs check
                        setTimeout(() => {
                            chatState.stage = 'tv_handling_check';
                            showBotMessage("Do you have any large TVs (50\" or bigger) that need special handling?");
                            showOptions([
                                { text: "Yes, I have large TVs", value: "yes" },
                                { text: "No large TVs", value: "no" }
                            ]);
                            saveSession();
                        }, 1000);
                    } else if (value === 'none') {
                        // Clear all and mark as none
                        chatState.data.challengeLocations = [];
                        if (chatState.data.location1Details) chatState.data.location1Details.hasChallenges = false;
                        if (chatState.data.location2Details) chatState.data.location2Details.hasChallenges = false;
                        if (chatState.data.location3Details) chatState.data.location3Details.hasChallenges = false;
                    } else {
                        // Toggle selection
                        const index = chatState.data.challengeLocations.indexOf(value);
                        if (index > -1) {
                            chatState.data.challengeLocations.splice(index, 1);
                        } else {
                            // Remove 'none' if adding a specific location
                            const noneIndex = chatState.data.challengeLocations.indexOf('none');
                            if (noneIndex > -1) {
                                chatState.data.challengeLocations.splice(noneIndex, 1);
                            }
                            chatState.data.challengeLocations.push(value);
                        }
                        // Re-show the options (this keeps the UI showing selections)
                        proceedToAccessChallengesQuestion();
                    }
                    saveSession();
                    break;

                case 'home_type':
                    chatState.data.homeType = value;
                    
                    // Ask about home size
                    chatState.stage = 'home_size_assessment';
                    showBotMessage("Is your current home larger than 2,600 square feet?");
                    showOptions([
                        { text: "Yes, it's larger than 2,600 sq ft", value: "large" },
                        { text: "No, it's 2,600 sq ft or smaller", value: "standard" }
                    ]);
                    saveSession();
                    break;
                    
                case 'home_size_assessment':
                    chatState.data.homeSize = value;
                    
                    // Ask about access obstacles
                    chatState.stage = 'access_obstacles';
                    showBotMessage("Are there any long walks from the truck to your front door (over 75 feet)?");
                    showOptions([
                        { text: "No, normal distance", value: "normal" },
                        { text: "Yes, long walk (75+ feet)", value: "long_walk" }
                    ]);
                    saveSession();
                    break;
                    
                case 'access_obstacles':
                    if (value === 'long_walk') {
                        chatState.data.accessObstacles.push('long_walk');
                    }
                    
                    // Calculate access multiplier
                    if (chatState.data.homeSize === 'large' && value === 'long_walk') {
                        chatState.data.accessMultiplier = CONFIG.accessFactors.combinedAccess.multiplier;
                        showBotMessage("üè† Large homes with long walks require additional time - I've adjusted your estimate");
                    } else if (chatState.data.homeSize === 'large') {
                        chatState.data.accessMultiplier = CONFIG.accessFactors.largeHome.multiplier;
                        showBotMessage("üìè I've added time for the larger home size");
                    } else if (value === 'long_walk') {
                        chatState.data.accessMultiplier = CONFIG.accessFactors.longWalk.multiplier;
                        showBotMessage("üìè I've added time for the long walk to your door");
                    }
                    
                    chatState.stage = 'destination_type';
                    showBotMessage("What type of location are you moving TO?");
                    showOptions([
                        { text: "üè† House", value: "house" },
                        { text: "üè¢ Apartment", value: "apartment" },
                        { text: "üè¢ Condo", value: "condo" },
                        { text: "üì¶ Storage Unit", value: "storage" }
                    ]);
                    saveSession();
                    break;
                    
                case 'destination_type':
                    chatState.data.destinationType = value;
                    chatState.stage = 'bedrooms_from';
                    if (value === 'storage') {
                        showBotMessage("Great! How many bedrooms worth of items are you storing?");
                    } else {
                        showBotMessage("How many bedrooms at your CURRENT location?");
                    }
                    showOptions([
                        { text: "Studio/1 Bedroom", value: "1" },
                        { text: "2 Bedrooms", value: "2" },
                        { text: "3 Bedrooms", value: "3" },
                        { text: "4 Bedrooms", value: "4" },
                        { text: "5+ Bedrooms", value: "5" }
                    ]);
                    saveSession();
                    break;
                    
                case 'bedrooms_from':
                    chatState.data.bedrooms = parseInt(value);
                    
                    // Check for smart packing recommendation
                    if (chatState.data.bedrooms >= 3) {
                        showBotMessage("üí° For a 3+ bedroom move, most customers find our packing materials save time and protect items better");
                    }
                    
                    if (chatState.data.destinationType === 'storage') {
                        chatState.data.bedroomsTo = 0; // Storage doesn't have bedrooms
                        
                        // Ask about TVs before appliances
                        chatState.stage = 'tv_handling_check';
                        showBotMessage("Do you have any large TVs (50\" or bigger) that need special handling?");
                        showOptions([
                            { text: "Yes, I have large TVs", value: "yes" },
                            { text: "No large TVs", value: "no" }
                        ]);
                    } else {
                        chatState.stage = 'bedrooms_to';
                        showBotMessage("And how many bedrooms at your NEW location?");
                        showOptions([
                            { text: "Studio/1 Bedroom", value: "1" },
                            { text: "2 Bedrooms", value: "2" },
                            { text: "3 Bedrooms", value: "3" },
                            { text: "4 Bedrooms", value: "4" },
                            { text: "5+ Bedrooms", value: "5" }
                        ]);
                    }
                    saveSession();
                    break;
                    
                case 'bedrooms_to':
                    chatState.data.bedroomsTo = parseInt(value);
                    
                    // Ask about TVs
                    chatState.stage = 'tv_handling_check';
                    showBotMessage("Do you have any large TVs (50\" or bigger) that need special handling?");
                    showOptions([
                        { text: "Yes, I have large TVs", value: "yes" },
                        { text: "No large TVs", value: "no" }
                    ]);
                    saveSession();
                    break;
                    
                case 'tv_handling_check':
                    if (value === 'yes') {
                        chatState.stage = 'tv_size_details';
                        showBotMessage("What size TV(s) do you have?");
                        showBotMessage("I'll go through each size range to ensure proper handling:");

                        // Start TV selection flow
                        chatState.data.tvHandling = [];
                        chatState.data.currentTvIndex = 0;
                        askAboutTVSize(0);
                    } else {
                        chatState.data.tvHandling = [];

                        // Move to appliances
                        showAppliancesCheckboxes();
                    }
                    saveSession();
                    break;

                case 'appliances_ask_first':
                    if (value === 'done_appliances') {
                        // Done selecting appliances
                        if (chatState.data.selectedAppliances && chatState.data.selectedAppliances.length > 0) {
                            chatState.data.appliances = chatState.data.selectedAppliances;
                            showBotMessage(`Great! I've noted these appliances: ${chatState.data.appliances.map(a => CONFIG.appliances[a].name).join(', ')}`);
                        } else {
                            chatState.data.appliances = [];
                            showBotMessage("Got it! No appliances.");
                        }
                        setTimeout(() => {
                            proceedAfterAppliances();
                        }, 800);
                    } else {
                        // Add appliance to selection
                        if (!chatState.data.selectedAppliances) chatState.data.selectedAppliances = [];

                        if (!chatState.data.selectedAppliances.includes(value)) {
                            chatState.data.selectedAppliances.push(value);
                            showBotMessage(`‚úì ${CONFIG.appliances[value].name} added`);
                        }

                        // Show same options again
                        setTimeout(() => {
                            showBotMessage("Any other appliances? (or click Done)");
                            showOptions([
                                { text: "ü´ß Washer", value: "washer" },
                                { text: "üåÄ Dryer", value: "dryer" },
                                { text: "üßä Refrigerator", value: "refrigerator" },
                                { text: "üî• Stove", value: "stove" },
                                { text: "‚ùÑÔ∏è Deep Freezer", value: "freezer" },
                                { text: "‚úì Done", value: "done_appliances", primary: true }
                            ]);
                        }, 500);
                    }
                    saveSession();
                    break;

                case 'specialty_items_ask':
                    if (value === 'done_specialty') {
                        // Done selecting specialty items
                        if (chatState.data.selectedSpecialtyItems && chatState.data.selectedSpecialtyItems.length > 0) {
                            // Categorize items
                            chatState.data.selectedSpecialtyItems.forEach(item => {
                                if (CONFIG.shopEquipment[item]) {
                                    chatState.data.shopEquipment.push(item);
                                } else if (CONFIG.oversizedFurniture[item]) {
                                    chatState.data.oversizedFurniture.push(item);
                                }
                            });

                            const totalItems = chatState.data.shopEquipment.length + chatState.data.oversizedFurniture.length;
                            let summary = `Got it! ${totalItems} specialty item${totalItems > 1 ? 's' : ''} noted. `;
                            if (chatState.data.shopEquipment.length > 0) {
                                summary += `Shop equipment: ${chatState.data.shopEquipment.map(e => CONFIG.shopEquipment[e].name).join(', ')}. `;
                            }
                            if (chatState.data.oversizedFurniture.length > 0) {
                                summary += `Specialty items: ${chatState.data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ')}.`;
                            }
                            showBotMessage(summary);
                        } else {
                            showBotMessage("Got it! No specialty items.");
                        }
                        setTimeout(() => {
                            proceedToPhotosAfterSpecialtyItems();
                        }, 800);
                    } else {
                        // Add item to selection
                        if (!chatState.data.selectedSpecialtyItems) chatState.data.selectedSpecialtyItems = [];

                        if (!chatState.data.selectedSpecialtyItems.includes(value)) {
                            chatState.data.selectedSpecialtyItems.push(value);

                            // Get item name from config
                            let itemName = '';
                            if (CONFIG.shopEquipment[value]) {
                                itemName = CONFIG.shopEquipment[value].name;
                            } else if (CONFIG.oversizedFurniture[value]) {
                                itemName = CONFIG.oversizedFurniture[value].name;
                            }
                            showBotMessage(`‚úì ${itemName} added`);
                        }

                        // Show same options again
                        setTimeout(() => {
                            showBotMessage("Any other specialty items? (or click Done)");
                            showSpecialtyItemOptions();
                        }, 500);
                    }
                    saveSession();
                    break;

                case 'tv_size_details':
                    const tvSizes = ['tv55to65', 'tv70to75', 'tv80plus'];
                    const currentTvIndex = chatState.data.currentTvIndex || 0;
                    
                    if (value === 'yes') {
                        chatState.data.tvHandling.push(tvSizes[currentTvIndex]);
                    }
                    
                    // Move to next TV size
                    const nextTvIndex = currentTvIndex + 1;
                    if (nextTvIndex < tvSizes.length) {
                        chatState.data.currentTvIndex = nextTvIndex;
                        askAboutTVSize(nextTvIndex);
                    } else {
                        // Done with TV sizes, ask about TV boxes
                        if (chatState.data.tvHandling.length > 0) {
                            chatState.stage = 'tv_packing_options';
                            showBotMessage("For your TV protection:");
                            showBotMessage("Do you have the original TV boxes, or would you like to purchase professional TV boxes from us?");
                            showOptions([
                                { text: "I have the original boxes", value: "have_boxes" },
                                { text: "I need professional TV boxes", value: "need_boxes", primary: true },
                                { text: "I'll wrap them myself", value: "no_boxes" }
                            ]);
                        } else {
                            // No TVs selected, move to appliances
                            showAppliancesCheckboxes();
                        }
                    }
                    saveSession();
                    break;
                    
                case 'tv_packing_options':
                    chatState.data.tvPackingOption = value;
                    
                    if (value === 'need_boxes') {
                        // Add TV boxes to materials
                        chatState.data.tvHandling.forEach(tv => {
                            const boxKey = tv.replace('tv', 'tvBox');
                            if (CONFIG.tvHandling[boxKey]) {
                                if (!chatState.data.tvBoxes) chatState.data.tvBoxes = [];
                                chatState.data.tvBoxes.push(boxKey);
                            }
                        });
                        showBotMessage("‚úÖ Perfect! I've added professional TV boxes to protect your investment during the move.");
                    } else if (value === 'have_boxes') {
                        showBotMessage("Great! Using the original boxes is the best protection for your TVs.");
                    } else {
                        showBotMessage("Understood. Please ensure they're well-protected for transport.");
                    }

                    // Move to appliances
                    setTimeout(() => {
                        showAppliancesCheckboxes();
                    }, 1000);
                    break;
                    
                case 'check_appliances':
                    if (value === 'yes') {
                        chatState.stage = 'select_appliances';
                        showBotMessage("Which appliances do you need moved?");
                        showBotMessage("I'll ask about each type:");
                        
                        // Start appliance selection flow
                        chatState.data.appliances = [];
                        chatState.data.currentApplianceIndex = 0;
                        askAboutAppliance(0);
                    } else {
                        chatState.data.appliances = [];
                        
                        // Check if third location needs appliances check
                        if (chatState.data.hasThirdLocation && 
                            chatState.data.thirdLocationAction !== 'drop_only' &&
                            !chatState.data.thirdLocationAppliancesChecked) {
                            chatState.stage = 'check_third_appliances';
                            showBotMessage("Do you have any appliances at your third location that need to be moved?");
                            showOptions([
                                { text: "Yes, appliances at third location", value: "yes" },
                                { text: "No appliances there", value: "no" }
                            ]);
                            saveSession();
                        } else {
                            // Move to specialty items
                            showHeavySpecialtyItemsCheckboxes();
                        }
                    }
                    break;
                    
                case 'check_third_appliances':
                    chatState.data.thirdLocationAppliancesChecked = true;
                    if (value === 'yes') {
                        chatState.stage = 'select_third_appliances';
                        showBotMessage("Which appliances at the third location need to be moved?");
                        chatState.data.thirdLocationAppliances = [];
                        chatState.data.currentThirdApplianceIndex = 0;
                        askAboutThirdLocationAppliance(0);
                    } else {
                        chatState.data.thirdLocationAppliances = [];
                        showHeavySpecialtyItemsCheckboxes();
                    }
                    break;
                    
                case 'select_appliances':
                    const applianceList = ['washer', 'dryer', 'refrigerator', 'stove', 'freezer'];
                    const currentIndex = chatState.data.currentApplianceIndex || 0;
                    
                    if (value === 'yes') {
                        chatState.data.appliances.push(applianceList[currentIndex]);
                    }
                    
                    // Move to next appliance
                    const nextIndex = currentIndex + 1;
                    if (nextIndex < applianceList.length) {
                        chatState.data.currentApplianceIndex = nextIndex;
                        askAboutAppliance(nextIndex);
                    } else {
                        // Done with appliances, move to special items or third location check
                        if (chatState.data.appliances.length > 0) {
                            showBotMessage(`Great! I've noted these appliances: ${chatState.data.appliances.map(a => CONFIG.appliances[a].name).join(', ')}`);
                        }
                        
                        // Check if third location needs appliances check
                        if (chatState.data.hasThirdLocation && 
                            chatState.data.thirdLocationAction !== 'drop_only' &&
                            !chatState.data.thirdLocationAppliancesChecked) {
                            chatState.stage = 'check_third_appliances';
                            setTimeout(() => {
                                showBotMessage("Do you have any appliances at your third location that need to be moved?");
                                showOptions([
                                    { text: "Yes, appliances at third location", value: "yes" },
                                    { text: "No appliances there", value: "no" }
                                ]);
                                saveSession();
                            }, 1000);
                        } else {
                            showHeavySpecialtyItemsCheckboxes();
                        }
                    }
                    break;
                    
                case 'select_third_appliances':
                    const thirdApplianceList = ['washer', 'dryer', 'refrigerator', 'stove', 'freezer'];
                    const currentThirdIndex = chatState.data.currentThirdApplianceIndex || 0;
                    
                    if (value === 'yes') {
                        chatState.data.thirdLocationAppliances.push(thirdApplianceList[currentThirdIndex]);
                    }
                    
                    // Move to next appliance
                    const nextThirdIndex = currentThirdIndex + 1;
                    if (nextThirdIndex < thirdApplianceList.length) {
                        chatState.data.currentThirdApplianceIndex = nextThirdIndex;
                        askAboutThirdLocationAppliance(nextThirdIndex);
                    } else {
                        // Done with third location appliances
                        if (chatState.data.thirdLocationAppliances.length > 0) {
                            showBotMessage(`Noted! Third location appliances: ${chatState.data.thirdLocationAppliances.map(a => CONFIG.appliances[a].name).join(', ')}`);
                        }

                        showHeavySpecialtyItemsCheckboxes();
                    }
                    break;
                    
                case 'shop_equipment_check':
                    if (value === 'yes') {
                        chatState.stage = 'shop_equipment_details';
                        showBotMessage("Let me ask about specific workshop equipment. This helps us bring the right crew and equipment.");
                        showBotMessage("Do you have any of these items? I'll go through each category:");
                        
                        // Start shop equipment selection
                        chatState.data.shopEquipment = [];
                        chatState.data.currentShopEquipmentIndex = 0;
                        askAboutShopEquipment(0);
                    } else {
                        chatState.data.shopEquipment = [];
                        proceedToOversizedFurniture();
                    }
                    saveSession();
                    break;
                    
                case 'shop_equipment_details':
                    const shopEquipmentList = ['workbench', 'toolChest', 'tablesaw', 'airCompressor', 
                                             'weldingEquipment', 'drillPress', 'vehicleLift', 'automotiveEquipment'];
                    const currentShopIndex = chatState.data.currentShopEquipmentIndex || 0;
                    
                    if (value === 'yes') {
                        const equipment = shopEquipmentList[currentShopIndex];
                        chatState.data.shopEquipment.push(equipment);
                        
                        // Check if weight assessment needed
                        const equipmentConfig = CONFIG.shopEquipment[equipment];
                        if (equipmentConfig && equipmentConfig.weightThreshold >= 300) {
                            chatState.stage = 'equipment_weight_assessment';
                            showBotMessage(`How much does your ${equipmentConfig.name} weigh approximately?`);
                            showInput("Enter weight in pounds...");
                            chatState.data.pendingEquipment = equipment;
                            return;
                        }
                    }
                    
                    // Move to next equipment
                    const nextShopIndex = currentShopIndex + 1;
                    if (nextShopIndex < shopEquipmentList.length) {
                        chatState.data.currentShopEquipmentIndex = nextShopIndex;
                        askAboutShopEquipment(nextShopIndex);
                    } else {
                        // Done with shop equipment
                        if (chatState.data.shopEquipment.length > 0) {
                            showBotMessage(`Noted! Workshop equipment: ${chatState.data.shopEquipment.map(e => CONFIG.shopEquipment[e].name).join(', ')}`);
                            
                            // Calculate heavy item fees
                            const heavyItems = calculateHeavyItemFees();
                            if (heavyItems.count > 0) {
                                showBotMessage(`‚ö†Ô∏è Heavy item surcharge applied: ${heavyItems.count} items over 300lbs (+${formatMoney(heavyItems.fees)})`);
                            }
                        }
                        
                        proceedToOversizedFurniture();
                    }
                    saveSession();
                    break;
                    
                case 'equipment_weight_assessment':
                    const weight = parseInt(value);
                    if (!isNaN(weight) && weight > 0) {
                        chatState.data[`${chatState.data.pendingEquipment}Weight`] = weight;
                        
                        // Continue with shop equipment selection
                        chatState.stage = 'shop_equipment_details';
                        const shopEquipmentList = ['workbench', 'toolChest', 'tablesaw', 'airCompressor', 
                                                 'weldingEquipment', 'drillPress', 'vehicleLift', 'automotiveEquipment'];
                        const nextIndex = chatState.data.currentShopEquipmentIndex + 1;
                        
                        if (nextIndex < shopEquipmentList.length) {
                            chatState.data.currentShopEquipmentIndex = nextIndex;
                            askAboutShopEquipment(nextIndex);
                        } else {
                            if (chatState.data.shopEquipment.length > 0) {
                                showBotMessage(`Noted! Workshop equipment: ${chatState.data.shopEquipment.map(e => CONFIG.shopEquipment[e].name).join(', ')}`);
                                
                                const heavyItems = calculateHeavyItemFees();
                                if (heavyItems.count > 0) {
                                    showBotMessage(`‚ö†Ô∏è Heavy item surcharge applied: ${heavyItems.count} items over 300lbs (+${formatMoney(heavyItems.fees)})`);
                                }
                            }
                            proceedToOversizedFurniture();
                        }
                    } else {
                        showBotMessage("Please enter a valid weight in pounds:");
                        showInput("Enter weight in pounds...");
                    }
                    saveSession();
                    break;
                    
                case 'oversized_furniture_check':
                    if (value === 'yes') {
                        chatState.stage = 'oversized_furniture_details';
                        showBotMessage("Let me ask about specific oversized items:");
                        
                        // Ask about mattresses first
                        showBotMessage("Do you have any specialty mattresses (Purple, Tempur-Pedic, etc.)?");
                        showOptions([
                            { text: "Yes, I have specialty mattresses", value: "yes_mattress" },
                            { text: "No specialty mattresses", value: "no_mattress" }
                        ]);
                    } else {
                        chatState.data.oversizedFurniture = [];
                        // Offer photos before special items for moving service
                        if (chatState.serviceType === 'moving') {
                            chatState.stage = 'offer_photos_moving';
                            chatState.data.photoCategory = 'moving';
                            showBotMessage("Would you like to add photos of your items? This helps us bring the right equipment and crew size.");
                            showBotMessage(PHOTO_SUGGESTIONS.moving, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                        } else {
                            proceedToSpecialItems();
                        }
                    }
                    saveSession();
                    break;
                    
                case 'oversized_furniture_details':
                    if (value === 'yes_mattress') {
                        chatState.stage = 'mattress_details';
                        showBotMessage("Which specialty mattress brands do you have?");
                        chatState.data.currentMattressIndex = 0;
                        askAboutMattress(0);
                    } else {
                        // Ask about other oversized furniture
                        chatState.stage = 'other_oversized_check';
                        showBotMessage("Do you have any oversized sectionals (10ft+), pool tables, or arcade games?");
                        showOptions([
                            { text: "Yes, I have oversized furniture", value: "yes" },
                            { text: "No oversized furniture", value: "no" }
                        ]);
                    }
                    saveSession();
                    break;
                    
                case 'mattress_details':
                    const mattressList = ['purpleMattress', 'tempurPedicMattress', 'adjustableBase', 'californiaKing'];
                    const currentMattressIndex = chatState.data.currentMattressIndex || 0;
                    
                    if (value === 'yes') {
                        chatState.data.oversizedFurniture.push(mattressList[currentMattressIndex]);
                    }
                    
                    // Move to next mattress type
                    const nextMattressIndex = currentMattressIndex + 1;
                    if (nextMattressIndex < mattressList.length) {
                        chatState.data.currentMattressIndex = nextMattressIndex;
                        askAboutMattress(nextMattressIndex);
                    } else {
                        // Done with mattresses, ask about other oversized
                        chatState.stage = 'other_oversized_check';
                        showBotMessage("Do you have any oversized sectionals (10ft+), pool tables, or arcade games?");
                        showOptions([
                            { text: "Yes, I have oversized furniture", value: "yes" },
                            { text: "No oversized furniture", value: "no" }
                        ]);
                    }
                    saveSession();
                    break;
                    
                case 'other_oversized_check':
                    if (value === 'yes') {
                        chatState.stage = 'select_oversized_furniture';
                        chatState.data.currentOversizedIndex = 0;
                        askAboutOversizedFurniture(0);
                    } else {
                        if (chatState.data.oversizedFurniture.length > 0) {
                            showBotMessage(`Noted! Oversized items: ${chatState.data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ')}`);
                            
                            const heavyItems = calculateHeavyItemFees();
                            if (heavyItems.count > 0) {
                                showBotMessage(`‚ö†Ô∏è Heavy item surcharge applied: ${heavyItems.count} items over 300lbs (+${formatMoney(heavyItems.fees)})`);
                            }
                        }
                        // Offer photos before special items for moving service
                        if (chatState.serviceType === 'moving') {
                            chatState.stage = 'offer_photos_moving';
                            chatState.data.photoCategory = 'moving';
                            showBotMessage("Would you like to add photos of your items? This helps us bring the right equipment and crew size.");
                            showBotMessage(PHOTO_SUGGESTIONS.moving, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                        } else {
                            proceedToSpecialItems();
                        }
                    }
                    saveSession();
                    break;
                    
                case 'select_oversized_furniture':
                    const oversizedList = ['largeSectional', 'poolTable', 'arcadeGame', 'largeEntertainmentCenter', 'heavyFurniture'];
                    const currentOversizedIndex = chatState.data.currentOversizedIndex || 0;
                    
                    if (value === 'yes') {
                        const furniture = oversizedList[currentOversizedIndex];
                        chatState.data.oversizedFurniture.push(furniture);
                        
                        // Check if weight assessment needed
                        const furnitureConfig = CONFIG.oversizedFurniture[furniture];
                        if (furnitureConfig && furnitureConfig.weightThreshold >= 300) {
                            chatState.stage = 'furniture_weight_assessment';
                            showBotMessage(`How much does your ${furnitureConfig.name} weigh approximately?`);
                            showInput("Enter weight in pounds...");
                            chatState.data.pendingFurniture = furniture;
                            return;
                        }
                    }
                    
                    // Move to next furniture
                    const nextOversizedIndex = currentOversizedIndex + 1;
                    if (nextOversizedIndex < oversizedList.length) {
                        chatState.data.currentOversizedIndex = nextOversizedIndex;
                        askAboutOversizedFurniture(nextOversizedIndex);
                    } else {
                        // Done with oversized furniture
                        if (chatState.data.oversizedFurniture.length > 0) {
                            showBotMessage(`Noted! Oversized items: ${chatState.data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ')}`);
                            
                            const heavyItems = calculateHeavyItemFees();
                            if (heavyItems.count > 0) {
                                showBotMessage(`‚ö†Ô∏è Heavy item surcharge applied: ${heavyItems.count} items over 300lbs (+${formatMoney(heavyItems.fees)})`);
                            }
                        }
                        // Offer photos before special items for moving service
                        if (chatState.serviceType === 'moving') {
                            chatState.stage = 'offer_photos_moving';
                            chatState.data.photoCategory = 'moving';
                            showBotMessage("Would you like to add photos of your items? This helps us bring the right equipment and crew size.");
                            showBotMessage(PHOTO_SUGGESTIONS.moving, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                        } else {
                            proceedToSpecialItems();
                        }
                    }
                    saveSession();
                    break;
                    
                case 'furniture_weight_assessment':
                    const furnitureWeight = parseInt(value);
                    if (!isNaN(furnitureWeight) && furnitureWeight > 0) {
                        chatState.data[`${chatState.data.pendingFurniture}Weight`] = furnitureWeight;
                        
                        // Continue with furniture selection
                        chatState.stage = 'select_oversized_furniture';
                        const oversizedList = ['largeSectional', 'poolTable', 'arcadeGame', 'largeEntertainmentCenter', 'heavyFurniture'];
                        const nextIndex = chatState.data.currentOversizedIndex + 1;
                        
                        if (nextIndex < oversizedList.length) {
                            chatState.data.currentOversizedIndex = nextIndex;
                            askAboutOversizedFurniture(nextIndex);
                        } else {
                            if (chatState.data.oversizedFurniture.length > 0) {
                                showBotMessage(`Noted! Oversized items: ${chatState.data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ')}`);
                                
                                const heavyItems = calculateHeavyItemFees();
                                if (heavyItems.count > 0) {
                                    showBotMessage(`‚ö†Ô∏è Heavy item surcharge applied: ${heavyItems.count} items over 300lbs (+${formatMoney(heavyItems.fees)})`);
                                }
                            }
                            // Offer photos before special items for moving service
                            if (chatState.serviceType === 'moving') {
                                chatState.stage = 'offer_photos_moving';
                                chatState.data.photoCategory = 'moving';
                                showBotMessage("Would you like to add photos of your items? This helps us bring the right equipment and crew size.");
                                showBotMessage(PHOTO_SUGGESTIONS.moving, 800);
                                setTimeout(() => {
                                    showPhotoUpload();
                                }, 1500);
                            } else {
                                proceedToSpecialItems();
                            }
                        }
                    } else {
                        showBotMessage("Please enter a valid weight in pounds:");
                        showInput("Enter weight in pounds...");
                    }
                    saveSession();
                    break;
                    
                case 'offer_photos_moving':
                case 'offer_photos_labor':
                case 'offer_photos_single':
                    // This is handled by the button clicks
                    break;
                    
                case 'special_items':
                    chatState.data.specialItems = value;
                    if (value === 'multiple') {
                        showBotMessage("For multiple special items, I recommend calling for a detailed quote. Our specialists can ensure we bring the right crew and equipment!");
                        showOptions([
                            { text: "üìû Call Now", value: "call", primary: true },
                            { text: "Continue Estimate", value: "continue_anyway" }
                        ]);
                    } else {
                        // Get smart crew recommendation
                        const recommendation = getSmartCrewRecommendation();

                        // NEW: Check if item is prohibited
                        if (recommendation.prohibited) {
                            showBotMessage(`<div class="warning-box">‚ö†Ô∏è ${recommendation.message}</div>`);
                            showOptions([
                                { text: "üìû Call 330-435-8686", value: "call", primary: true },
                                { text: "‚Ü©Ô∏è Start Over", value: "restart" }
                            ]);
                            saveSession();
                            return;
                        }

                        chatState.data.minCrewSize = recommendation.crew;
                        chatState.stage = 'crew_size_moving';

                        if (recommendation.message) {
                            showBotMessage(recommendation.message);
                        }

                        // Add Sarah's expertise about crew size
                        const sarahTip = "üí° Sarah's tip: A larger crew often means a faster, safer move - especially with heavy items!";
                        showBotMessage(sarahTip, 800);

                        setTimeout(() => {
                            showBotMessage("How many movers would you like?");
                            showOptions([
                                { text: "üë• 2 person crew", value: "2", disabled: recommendation.crew > 2 },
                                { text: "üë• 3 person crew", value: "3", disabled: recommendation.crew > 3 },
                                { text: "üë• 4 person crew", value: "4" }
                            ]);
                            saveSession();
                        }, recommendation.message ? 2000 : 1000);
                    }
                    break;
                    
                case 'crew_size_moving':
                    const selectedCrew = parseInt(value);
                    const minRequired = chatState.data.minCrewSize || 2;
                    
                    if (selectedCrew < minRequired) {
                        showBotMessage(`<div class="warning-box">‚ö†Ô∏è For your safety and the protection of your items, we require a minimum ${minRequired}-person crew for this move.</div>`);
                        showOptions([
                            { text: "üë• 2 person crew", value: "2", disabled: minRequired > 2 },
                            { text: "üë• 3 person crew", value: "3", disabled: minRequired > 3 },
                            { text: "üë• 4 person crew", value: "4" }
                        ]);
                        return;
                    }
                    
                    chatState.data.crewSize = selectedCrew;
                    
                    // Ask about packing supplies
                    chatState.stage = 'ask_packing_supplies';
                    showBotMessage("Would you like us to provide packing materials?");
                    showOptions([
                        { text: "Yes, I need packing materials", value: "yes" },
                        { text: "No, I have my own", value: "no" }
                    ]);
                    saveSession();
                    break;
                    
                case 'ask_packing_supplies':
                    chatState.data.needsPackingMaterials = value === 'yes';
                    
                    // Ask about packing service
                    chatState.stage = 'ask_packing_service';
                    showBotMessage("Would you like professional packing services?");
                    showBotMessage("üí° Our team can pack 1-2 days before your move!");
                    showOptions([
                        { text: "Yes, pack everything", value: "full" },
                        { text: "Partial packing (fragile items)", value: "partial" },
                        { text: "No packing service needed", value: "no" }
                    ]);
                    saveSession();
                    break;
                    
                case 'ask_packing_service':
                    chatState.data.packingService = value;
                    calculateAndShowEstimate();
                    break;
                    
                case 'crew_size':
                    chatState.data.crewSize = parseInt(value);
                    chatState.stage = 'hours';
                    showBotMessage("How many hours do you need the crew?");
                    showOptions([
                        { text: "2 hours (minimum)", value: "2" },
                        { text: "4 hours", value: "4" },
                        { text: "6 hours", value: "6" },
                        { text: "8 hours (full day)", value: "8" },
                        { text: "Other amount", value: "other_hours" }
                    ]);
                    saveSession();
                    break;
                    
                case 'hours':
                    if (value === 'other_hours') {
                        showBotMessage("How many hours do you need? (2-12)");
                        showInput("Enter number of hours...");
                    } else {
                        chatState.data.hours = parseInt(value);

                        // For labor service, show specialty items checkboxes before photos
                        if (chatState.serviceType === 'labor') {
                            showHeavySpecialtyItemsCheckboxes();
                        } else {
                            // For other service types, continue to photos as before
                            chatState.stage = 'offer_photos_labor';
                            chatState.data.photoCategory = 'labor';
                            showBotMessage("Would you like to add photos? This helps our crew come prepared with proper tools.");
                            showBotMessage(PHOTO_SUGGESTIONS.labor, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                        }
                        saveSession();
                    }
                    break;

                case 'labor_heavy_items':
                    if (value === 'no_heavy_items') {
                        // No heavy items, proceed to photos
                        chatState.stage = 'offer_photos_labor';
                        chatState.data.photoCategory = 'labor';
                        showBotMessage("Got it! No heavy items.");
                        setTimeout(() => {
                            showBotMessage("Would you like to add photos? This helps our crew come prepared with proper tools.");
                            showBotMessage(PHOTO_SUGGESTIONS.labor, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                        }, 800);
                    } else if (value === 'has_shop_equipment') {
                        // Ask about shop equipment
                        chatState.data.currentShopEquipmentIndex = 0;
                        chatState.stage = 'labor_shop_equipment';
                        showBotMessage("Let's go through some common shop equipment.");
                        setTimeout(() => {
                            askAboutShopEquipment(0);
                        }, 800);
                    } else if (value === 'has_oversized_furniture') {
                        // Ask about oversized furniture
                        chatState.data.currentOversizedIndex = 0;
                        chatState.stage = 'labor_oversized_furniture';
                        showBotMessage("Let's check what oversized items you have.");
                        setTimeout(() => {
                            askAboutOversizedFurniture(0);
                        }, 800);
                    } else if (value === 'has_both_heavy') {
                        // Ask about shop equipment first, then oversized
                        chatState.data.needsOversizedAfterShop = true;
                        chatState.data.currentShopEquipmentIndex = 0;
                        chatState.stage = 'labor_shop_equipment';
                        showBotMessage("Perfect! Let's start with shop equipment.");
                        setTimeout(() => {
                            askAboutShopEquipment(0);
                        }, 800);
                    }
                    saveSession();
                    break;

                case 'labor_shop_equipment':
                    const equipmentList = ['workbench', 'toolChest', 'tablesaw', 'airCompressor',
                                          'weldingEquipment', 'drillPress', 'vehicleLift', 'automotiveEquipment'];
                    const currentEquipIndex = chatState.data.currentShopEquipmentIndex;

                    if (value === 'yes') {
                        chatState.data.shopEquipment.push(equipmentList[currentEquipIndex]);
                    }

                    chatState.data.currentShopEquipmentIndex++;

                    if (chatState.data.currentShopEquipmentIndex < equipmentList.length) {
                        askAboutShopEquipment(chatState.data.currentShopEquipmentIndex);
                    } else {
                        // Done with shop equipment
                        if (chatState.data.needsOversizedAfterShop) {
                            // Now ask about oversized furniture
                            chatState.data.needsOversizedAfterShop = false;
                            chatState.data.currentOversizedIndex = 0;
                            chatState.stage = 'labor_oversized_furniture';
                            showBotMessage("Great! Now let's check for oversized furniture.");
                            setTimeout(() => {
                                askAboutOversizedFurniture(0);
                            }, 800);
                        } else {
                            // Proceed to photos
                            proceedToLaborPhotos();
                        }
                    }
                    saveSession();
                    break;

                case 'labor_oversized_furniture':
                    const furnitureList = ['largeSectional', 'poolTable', 'arcadeGame', 'largeEntertainmentCenter', 'heavyFurniture'];
                    const currentFurnIndex = chatState.data.currentOversizedIndex;

                    if (value === 'yes') {
                        chatState.data.oversizedFurniture.push(furnitureList[currentFurnIndex]);
                    }

                    chatState.data.currentOversizedIndex++;

                    if (chatState.data.currentOversizedIndex < furnitureList.length) {
                        askAboutOversizedFurniture(chatState.data.currentOversizedIndex);
                    } else {
                        // Done with oversized furniture, proceed to photos
                        proceedToLaborPhotos();
                    }
                    saveSession();
                    break;

                case 'describe_item':
    chatState.data.itemDescription = value;
    chatState.data.itemName = value;
    
    // Check if we need to determine crew size for custom items
    if (!chatState.data.requiredCrew) {
        // Ask about weight to determine crew size
        chatState.stage = 'custom_item_weight';
        showBotMessage(`Got it - "${value}". To ensure we bring the right crew, approximately how heavy is this item?`);
        showOptions([
            { text: "Under 150 lbs (1-2 people can lift)", value: "light" },
            { text: "150-300 lbs (heavy but manageable)", value: "heavy" },
            { text: "Over 300 lbs (requires special handling)", value: "extra_heavy" }
        ]);
        saveSession();
    } else {
        // We already have crew info, proceed to date
        chatState.stage = 'moving_date';
        setTimeout(() => {
            showBotMessage("When would you like to schedule this move? üìÖ");
            showDatePicker();
            saveSession();
        }, 500);
    }
    break;
                    
                case 'item_type':
                    chatState.data.itemType = value;
                    if (value === 'category_furniture') {
                        chatState.stage = 'select_furniture_item';
                        showBotMessage("What type of furniture are you moving?");
                        showOptions([
                            { text: "Couch/Sofa", value: "couch" },
                            { text: "Loveseat", value: "loveseat" },
                            { text: "Recliner/Chair", value: "chair" },
                            { text: "Mattress & Box Spring", value: "mattress" },
                            { text: "Dresser", value: "dresser" },
                            { text: "Desk", value: "desk" },
                            { text: "Dining Table", value: "table" },
                            { text: "Other Furniture", value: "other" }
                        ]);
                    } else if (value === 'category_appliance') {
                        chatState.stage = 'select_appliance_item';
                        showBotMessage("What appliance needs to be moved?");
                        showOptions([
                            { text: "Refrigerator", value: "refrigerator" },
                            { text: "Washer", value: "washer" },
                            { text: "Dryer", value: "dryer" },
                            { text: "Stove/Range", value: "stove" },
                            { text: "Deep Freezer", value: "freezer" },
                            { text: "Dishwasher", value: "dishwasher" },
                            { text: "Other Appliance", value: "other" }
                        ]);
                    } else if (value === 'category_set') {
                        chatState.stage = 'select_set_item';
                        showBotMessage("What type of furniture set?");
                        showOptions([
                            { text: "Bedroom Set", value: "bedroomSet" },
                            { text: "Dining Room Set", value: "diningSet" },
                            { text: "Living Room Set", value: "livingSet" },
                            { text: "Office Furniture Set", value: "officeSet" }
                        ]);
                    } else if (value === 'category_heavy') {
                        chatState.stage = 'select_heavy_item';
                        showBotMessage("What heavy item needs special handling?");
                        showOptions([
                            { text: "Piano", value: "piano" },
                            { text: "Gun Safe", value: "gunSafe" },
                            { text: "Pool Table", value: "poolTable" },
                            { text: "Hot Tub", value: "hotTub" },
                            { text: "Large Safe (500+ lbs)", value: "safe" },
                            { text: "Home Gym Equipment", value: "gym" },
                            { text: "Treadmill", value: "treadmill" },
                            { text: "Elliptical", value: "elliptical" },
                            { text: "Other Heavy Item", value: "other" }
                        ]);
                    } else if (value === 'other') {
                        chatState.stage = 'describe_item';
                        showBotMessage("Please describe your item:");
                        showInput("e.g., Antique armoire, Industrial equipment...");
                    }
                    saveSession();
                    break;

                case 'select_furniture_item':
case 'select_appliance_item':
case 'select_set_item':
case 'select_heavy_item':
    chatState.data.selectedSingleItem = value;
    if (value === 'other') {
        chatState.stage = 'describe_item';
        showBotMessage("Please describe your item:");
        showInput("e.g., Antique armoire, Industrial equipment...");
    } else {
        const itemConfig = CONFIG.singleItemCategories[value];
        chatState.data.itemName = itemConfig.name;
        chatState.data.requiredCrew = itemConfig.crew;
        chatState.data.minimumTime = itemConfig.minTime;
        chatState.data.itemCategory = itemConfig.category;
        chatState.data.itemFee = itemConfig.fee;
        chatState.data.itemWeight = itemConfig.weight || 0;
        
        // Show crew size info if special requirements
        if (itemConfig.crew >= 3) {
            showBotMessage(`‚ö†Ô∏è ${itemConfig.name} requires a ${itemConfig.crew}-person crew for safe handling.`);
            if (itemConfig.minTime > 60) {
                showBotMessage(`üìç Minimum service time: ${itemConfig.minTime / 60} hours`);
            }
        }
        
        // Now get the moving date
        chatState.stage = 'moving_date';
        setTimeout(() => {
            showBotMessage("When would you like to schedule this move? üìÖ");
            
            // Add urgency tip for heavy items
            if (itemConfig.crew >= 4) {
                const expertAdvice = "üí° Pro tip: Large crews book up fast! Schedule 1-2 weeks ahead for best availability.";
                showBotMessage(expertAdvice, 800);
            }
            
            setTimeout(() => {
                showDatePicker();
                saveSession();
            }, itemConfig.crew >= 4 ? 1500 : 500);
        }, itemConfig.crew >= 3 ? 2000 : 500);
    }
    saveSession();
    break;

                case 'custom_item_weight':
    // Set defaults based on weight
    if (value === 'light') {
        chatState.data.requiredCrew = 2;
        chatState.data.minimumTime = 60;
        chatState.data.itemWeight = 100;
        chatState.data.itemFee = 0;
        chatState.data.itemCategory = 'standard';
    } else if (value === 'heavy') {
        chatState.data.requiredCrew = 3;
        chatState.data.minimumTime = 90;
        chatState.data.itemWeight = 250;
        chatState.data.itemFee = 100;
        chatState.data.itemCategory = 'heavy';
        showBotMessage("‚ö†Ô∏è Heavy items require a 3-person crew for safety.");
    } else if (value === 'extra_heavy') {
        chatState.data.requiredCrew = 4;
        chatState.data.minimumTime = 120;
        chatState.data.itemWeight = 500;
        chatState.data.itemFee = 200;
        chatState.data.itemCategory = 'heavy';
        showBotMessage("‚ö†Ô∏è Extra heavy items require a 4-person crew and 2-hour minimum service.");
    }
    
    // Now get the moving date
    chatState.stage = 'moving_date';
    setTimeout(() => {
        showBotMessage("When would you like to schedule this move? üìÖ");
        showDatePicker();
        saveSession();
    }, value !== 'light' ? 1500 : 500);
    break;
                    
                case 'item_stairs':
                    chatState.data.pickupStairs = parseInt(value);
                    chatState.stage = 'item_stairs_delivery';
                    showBotMessage("Any stairs at the delivery location?");
                    showOptions([
                        { text: "Ground floor", value: "0" },
                        { text: "1 flight", value: "1" },
                        { text: "2 flights", value: "2" },
                        { text: "3+ flights", value: "3" }
                    ]);
                    saveSession();
                    break;
                    
                case 'item_stairs_delivery':
                    chatState.data.deliveryStairs = parseInt(value);
                    calculateAndShowEstimate();
                    break;
                    
                // Insurance claim stages
                case 'insurance_claims_start':
                    chatState.data.coverageType = value;
                    
                    if (value === 'fvp_coverage') {
                        chatState.stage = 'fvp_details_collection';
                        showBotMessage("What was your declared value amount?");
                        showInput("Enter declared value in dollars...");
                    } else {
                        chatState.stage = 'damage_description';
                        showBotMessage("Please describe the damaged item(s) and their approximate value:");
                        showInput("Describe the damage in detail...");
                    }
                    saveSession();
                    break;
                    
                case 'fvp_details_collection':
                    const declaredValue = parseFloat(value);
                    if (!isNaN(declaredValue) && declaredValue > 0) {
                        chatState.data.fvpDeclaredValue = declaredValue;
                        chatState.stage = 'fvp_deductible_selection';
                        showBotMessage("What deductible did you select?");
                        showOptions([
                            { text: "$0", value: "0" },
                            { text: "$250", value: "250" },
                            { text: "$500", value: "500" },
                            { text: "$750", value: "750" },
                            { text: "$1,000", value: "1000" }
                        ]);
                    } else {
                        showBotMessage("Please enter a valid dollar amount:");
                        showInput("Enter declared value in dollars...");
                    }
                    saveSession();
                    break;
                    
                case 'fvp_deductible_selection':
                    chatState.data.fvpDeductible = parseInt(value);
                    chatState.stage = 'damage_description';
                    showBotMessage("Please describe the damaged item(s) and their approximate value:");
                    showInput("Describe the damage in detail...");
                    saveSession();
                    break;
                    
                case 'damage_description':
                    chatState.data.damageDescription = value;
                    chatState.stage = 'item_value_assessment';
                    showBotMessage("What is the estimated value of the damaged item(s)?");
                    showInput("Enter item value in dollars...");
                    saveSession();
                    break;
                    
                case 'item_value_assessment':
                    const itemValue = parseFloat(value);
                    if (!isNaN(itemValue) && itemValue > 0) {
                        chatState.data.itemValue = itemValue;
                        
                        // Check if FVP claim is eligible
                        if (chatState.data.coverageType === 'fvp_coverage' && 
                            chatState.data.fvpDeductible && 
                            itemValue < chatState.data.fvpDeductible) {
                            
                            chatState.stage = 'deductible_validation_check';
                            showBotMessage(`‚ö†Ô∏è I notice the claimed item value ($${itemValue}) is less than your selected deductible ($${chatState.data.fvpDeductible}). Unfortunately, this means the deductible would cover the entire claimed amount, so no additional compensation would be due. However, I'll still document this for our records.`);
                            showOptions([
                                { text: "Yes, document this anyway", value: "proceed_documentation" },
                                { text: "Cancel claim process", value: "cancel_claim" }
                            ]);
                        } else {
                            chatState.stage = 'damage_cause';
                            showBotMessage("Can you describe what happened and the extent of the damage?");
                            showInput("Describe what happened...");
                        }
                    } else {
                        showBotMessage("Please enter a valid dollar amount:");
                        showInput("Enter item value in dollars...");
                    }
                    saveSession();
                    break;
                    
                case 'deductible_validation_check':
                    if (value === 'proceed_documentation') {
                        chatState.data.claimStatus = 'ineligible_documented';
                        chatState.stage = 'damage_cause';
                        showBotMessage("Can you describe what happened and the extent of the damage?");
                        showInput("Describe what happened...");
                    } else {
                        showBotMessage("Claim process cancelled. How else can I help you today?");
                        showOptions([
                            { text: "Get a new estimate", value: "restart" },
                            { text: "I have questions", value: "questions" },
                            { text: "Close chat", value: "close" }
                        ]);
                        chatState.stage = 'claim_cancelled';
                    }
                    saveSession();
                    break;
                    
                case 'damage_cause':
                    chatState.data.damageCause = value;
                    chatState.stage = 'photo_upload_claims';
                    chatState.data.photoCategory = 'insurance';
                    showBotMessage("Please upload photos of the damaged item(s). You can upload multiple photos.");
                    setTimeout(() => {
                        showPhotoUpload();
                    }, 1000);
                    saveSession();
                    break;
                    
                case 'photo_upload_claims':
                    if (value === 'continue_claim') {
                        // Move to date selection
                        chatState.stage = 'move_details_verification';
                        showBotMessage("What was your move date?");
                        showDatePicker();
                        saveSession();
                    }
                    break;
                    
                case 'move_details_verification':
                    chatState.data.claimMoveDate = value;
                    chatState.stage = 'invoice_number_input';
                    showBotMessage("Do you have your invoice number? (If not, type 'no')");
                    showInput("Enter invoice number...");
                    saveSession();
                    break;
                    
                case 'invoice_number_input':
                    chatState.data.invoiceNumber = value.toLowerCase() === 'no' ? 'Not provided' : value;
                    
                    // Check if we have contact info
                    if (!hasCompleteContactInfo()) {
                        if (!chatState.data.firstName || !chatState.data.lastName) {
                            chatState.stage = 'collect_full_name';
                            showBotMessage("I'll need your full name to process the claim:");
                            showInput("Enter your first and last name...");
                        } else if (!chatState.data.email) {
                            chatState.stage = 'collect_email_required';
                            showBotMessage("What's your email address?");
                            showInput("Enter your email...");
                        } else if (!chatState.data.phone) {
                            chatState.stage = 'collect_phone_required';
                            showBotMessage("And your phone number?");
                            showInput("Enter your phone number...");
                        }
                    } else {
                        submitInsuranceClaim();
                    }
                    saveSession();
                    break;
                    
                case 'show_fvp_options':
                    if (value === 'standard') {
                        chatState.data.fvpOption = 'standard';
                        chatState.data.fvpCost = 0;
                        chatState.stage = 'show_booking_options';
                        showBotMessage("You've selected Standard Liability Coverage (included at no extra cost).");
                        showBotMessage("‚úÖ Coverage: $0.60 per pound per article");
                        showFinalBookingOptions();
                    } else if (value === 'fvp') {
                        chatState.data.fvpOption = 'fvp';
                        chatState.stage = 'fvp_value';
                        showBotMessage("Full Value Protection provides comprehensive coverage up to $6.00 per pound per article.");
                        showBotMessage("What's the total value of items you'd like to protect? (excluding personal items & antiques)");
                        showInput("Enter total value...");
                    } else if (value === 'skip') {
                        chatState.data.fvpOption = 'standard';
                        chatState.data.fvpCost = 0;
                        showFinalBookingOptions();
                    }
                    saveSession();
                    break;
                    
                case 'fvp_deductible':
                    chatState.data.fvpDeductible = parseInt(value);
                    
                    // Calculate FVP cost with fixed NaN issue
                    const fvpCost = calculateFVPCost(
                        chatState.data.fvpValue, 
                        chatState.data.fvpDeductible,
                        chatState.data.hasThirdLocation ? chatState.data.totalTripDistance : chatState.data.tripDistance
                    );
                    chatState.data.fvpCost = fvpCost;
                    
                    showBotMessage(`<div class="coverage-details">
                        <strong>‚úÖ Your Full Value Protection Quote</strong><br><br>
                        Protected Value: ${formatMoney(chatState.data.fvpValue)}<br>
                        Deductible: ${formatMoney(chatState.data.fvpDeductible)}<br>
                        <strong>Protection Cost: ${formatMoney(fvpCost)}</strong><br><br>
                        This covers qualifying items up to $6 per pound.
                    </div>`);
                    
                    setTimeout(() => {
                        showBotMessage("Your updated total with Full Value Protection:");
                        const estimateTotal = parseFloat(chatState.data.estimate.total) || 0;
                        const newTotal = estimateTotal + fvpCost;
                        showBotMessage(`<div class="estimate-details">
                            <strong>Moving Estimate:</strong> ${formatMoney(estimateTotal)}<br>
                            <strong>Full Value Protection:</strong> ${formatMoney(fvpCost)}<br>
                            <div style="border-top: 2px solid #004085; margin-top: 10px; padding-top: 10px;">
                                <strong style="color: #004085; font-size: 18px;">Total with Protection: ${formatMoney(newTotal)}</strong>
                            </div>
                        </div>`);
                        
                        chatState.stage = 'show_booking_options';
                        showFinalBookingOptions();
                    }, 1500);
                    saveSession();
                    break;
                    
                case 'contact_info':
                    // This case handles when we need to collect contact info
                    // Check if we already have email from early collection
                    if (!chatState.data.email) {
                        chatState.stage = 'get_email';
                        showBotMessage("Perfect! What's your email address?");
                        showInput("Enter your email...");
                    } else if (!chatState.data.phone) {
                        chatState.stage = 'get_phone';
                        showBotMessage("And what's the best phone number to reach you?");
                        showInput("Enter your phone number...");
                    } else {
                        // We already have both, submit directly
                        submitLead();
                    }
                    saveSession();
                    break;
                    
                case 'get_email':
                    if (validateEmail(value)) {
                        chatState.data.email = value;
                        chatState.stage = 'get_phone';
                        showBotMessage("And what's the best phone number to reach you?");
                        showInput("Enter your phone number...");
                        saveSession();
                    } else {
                        showBotMessage("Hmm, that doesn't look like a valid email. Please try again:");
                        showInput("Enter a valid email address...");
                    }
                    break;
                    
                case 'get_phone':
                    if (validatePhone(value)) {
                        chatState.data.phone = value;
                        submitLead();
                    } else {
                        showBotMessage("Please enter a valid phone number (at least 10 digits):");
                        showInput("Enter your phone number...");
                    }
                    break;
                    
                case 'questions':
                    switch(value) {
                        case 'restricted_items':
                            showBotMessage("We move most household items! However, we do NOT move:<br><br>‚ùå Pool tables<br>‚ùå Hazardous materials<br>‚ùå Flammable liquids<br>‚ùå Perishable food<br>‚ùå Plants (long distance)<br>‚ùå Pets");
                            break;
                        case 'whats_included':
                            showBotMessage("Our full moving service includes:<br><br>‚úÖ Professional crew<br>‚úÖ Moving truck<br>‚úÖ All equipment<br>‚úÖ Furniture protection<br>‚úÖ Basic liability coverage<br>‚úÖ Loading & unloading<br><br>Labor-only service includes equipment but NOT moving pads (available for purchase).");
                            break;
                        case 'service_areas':
                            showBotMessage("We proudly serve:<br><br>üìç Youngstown & surrounding areas<br>üìç Boardman, Canfield, Poland<br>üìç Warren, Niles, Cortland<br>üìç Salem, Columbiana<br>üìç New Castle, Hermitage<br>üìç And more! Call for specific locations.");
                            break;
                        case 'why_choose_us':
                            showBotMessage("Why families choose Worry Free Moving:<br><br>‚≠ê 4.8/5 star rating<br>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family-owned since 2019<br>üí™ Professional, trained crews<br>üõ°Ô∏è Fully licensed & insured<br>üí∞ Transparent, honest pricing<br>üèÜ 500+ happy customers<br>üìû 24/7 customer support");
                            break;
                        case 'packing_info':
                            showBotMessage("We offer full packing services!<br><br>üì¶ Professional packing crew<br>üì¶ All materials included<br>üì¶ Fragile item specialists<br>üì¶ Same-day packing available<br><br>Call 330-435-8686 for packing quotes!");
                            break;
                        case 'insurance_photos':
                            // Handle photo upload for questions menu
                            chatState.stage = 'insurance_photos';
                            chatState.data.photoCategory = 'insurance';
                            showBotMessage("You can upload photos for insurance claims or damage reports here.");
                            showBotMessage(PHOTO_SUGGESTIONS.insurance, 800);
                            setTimeout(() => {
                                showPhotoUpload();
                            }, 1500);
                            saveSession();
                            return;
                    }
                    setTimeout(() => {
                        showOptions([
                            { text: "‚Ü©Ô∏è Back to questions", value: "back_to_questions" },
                            { text: "Get an estimate", value: "restart", primary: true }
                        ]);
                        saveSession();
                    }, 1500);
                    break;

                case 'select_time':
                    // Save selected time
                    chatState.data.selectedTime = value;
                    saveSession();

                    showBotMessage(`Great! I've scheduled your arrival window around ${formatTime(value)}.`);

                    // Show final confirmation
                    setTimeout(() => {
                        showFinalConfirmation();
                    }, 1000);
                    break;

                case 'final_confirmation':
                    if (value === 'confirm_booking') {
                        showBotMessage("Perfect! Creating your booking now...");

                        // Submit lead and create booking
                        setTimeout(() => {
                            submitLead().then(() => {
                                setTimeout(() => {
                                    sendBookingToAPI(chatState.data.squareCustomerId || null);
                                }, 1000);
                            });
                        }, 500);
                    } else if (value === 'edit_booking') {
                        showBotMessage("No problem! What would you like to change?");
                        showOptions([
                            { text: 'üìÖ Change Date', value: 'change_date' },
                            { text: 'üïê Change Time', value: 'change_time' },
                            { text: 'üìû Update Contact Info', value: 'change_contact' }
                        ]);
                    }
                    break;

                case 'ask_date':
                    // This is handled by the date picker confirm button
                    // The handleDateConfirm function saves the date and should call askForTimeSlot
                    break;

                default:
                    if (value === 'call') {
                        // Auto-submit quote before calling
                        chatState.data.isAutoSubmit = true;
                        showBotMessage("Perfect! Let me send your quote first...");
                        autoSubmitQuote().then(() => {
                            showBotMessage("‚úÖ Quote sent! Connecting you to our team...");
                            setTimeout(() => {
                                window.location.href = 'tel:330-435-8686';
                            }, 1000);
                        });
                    } else if (value === 'print_quote') {
                        // Show print modal
                        showPrintQuote();
                    } else if (value === 'book_now') {
                        // Redirect to worryfreemovers.com/moving/local
                        window.open(CONFIG.bookingUrl, '_blank');
                    } else if (value === 'pay_deposit') {
                        // Smart booking flow - check for existing customer first
                        initiateBooking();
                    } else if (value === 'continue_anyway') {
                        if (chatState.stage.includes('special')) {
                            // If continuing from special items, ask for crew size
                            const recommendation = getSmartCrewRecommendation();
                            chatState.data.minCrewSize = recommendation.crew;
                            chatState.stage = 'crew_size_moving';
                            showBotMessage("How many movers would you like?");
                            showOptions([
                                { text: "üë• 2 person crew", value: "2", disabled: recommendation.crew > 2 },
                                { text: "üë• 3 person crew", value: "3", disabled: recommendation.crew > 3 },
                                { text: "üë• 4 person crew", value: "4" }
                            ]);
                            saveSession();
                        } else if (chatState.stage.includes('location')) {
                            // Continue after location warning
                            chatState.stage = 'stairs_from';
                            showBotMessage("Are there any stairs at your current location?");
                            showOptions([
                                { text: "No stairs", value: "0" },
                                { text: "1 flight", value: "1" },
                                { text: "2 flights", value: "2" },
                                { text: "3+ flights", value: "3" }
                            ]);
                            saveSession();
                        }
                    } else if (value === 'back_to_questions') {
                        chatState.stage = 'questions';
                        showBotMessage("What else would you like to know?");
                        showOptions([
                            { text: "üìç Service areas", value: "service_areas" },
                            { text: "üí∞ What's included?", value: "whats_included" },
                            { text: "üì¶ Packing services", value: "packing_info" },
                            { text: "üö´ Items you don't move", value: "restricted_items" },
                            { text: "‚≠ê Why choose Worry Free?", value: "why_choose_us" },
                            { text: "üì∏ Upload photos for estimate", value: "insurance_photos" },
                            { text: "‚Ü©Ô∏è Get an estimate", value: "restart", primary: true }
                        ]);
                        saveSession();
                    } else if (value === 'email_quote') {
    // Manual email quote - don't auto-submit
    chatState.data.isAutoSubmit = false;
    chatState.data.isSchedulingAfterEmail = false; // Not scheduling, just emailing
    
    // Check if we already have contact info
    if (!chatState.data.email || !chatState.data.phone) {
        chatState.stage = 'contact_info';
        processResponse('');
    } else {
        // We already have contact info, submit the lead
        submitLead();
    }
} else if (value === 'close') {
    closeChat();
}
                    break;
            }
        }

        // Calculate and show estimate function (remains the same as in original code)
        function calculateAndShowEstimate() {
            let estimate = {};
            
            const thinking = getRandomResponse(SARAH_PERSONALITY.thinking);
            showBotMessage(thinking);
            
            // Add excitement
            const excitement = getRandomResponse(SARAH_PERSONALITY.excitement);
            showBotMessage(excitement, 800);
            
            // Add Sarah's encouragement
            const encouragement = getRandomResponse(SARAH_PERSONALITY.encouragement);
            showBotMessage(encouragement, 1200);
            
            // Make this callback async since it uses await
            setTimeout(async () => {
                if (chatState.serviceType === 'moving') {
                    // Declare deliveryToBaseDistance here so it's available throughout
                    let deliveryToBaseDistance = 0;
                    
                    // Calculate hours based on formula
                    const baseHours = {
                        'apartment': 1.35,
                        'house': 1.50,
                        'condo': 1.45,
                        'storage': 1.20
                    };
                    const bedroomMultiplier = {
                        'apartment': 0.775,
                        'house': 0.85,
                        'condo': 0.775,
                        'storage': 0.70
                    };
                    
                    const homeType = chatState.data.homeType || 'apartment';
                    const bedrooms = Math.max(chatState.data.bedrooms || 2, chatState.data.bedroomsTo || 2);
                    const stairsFrom = chatState.data.stairsFrom || 0;
                    const stairsTo = chatState.data.stairsTo || 0;
                    const stairsThird = chatState.data.stairsThird || 0;
                    const totalStairs = stairsFrom + stairsTo + stairsThird;
                    
                    // Calculate base loading/unloading hours
                    let loadingHours = baseHours[homeType] + ((bedrooms - 1) * bedroomMultiplier[homeType]);

                    // Add stair time - apartments take longer due to narrow hallways and building restrictions
                    const stairTimePerFlight = homeType === 'apartment'
                        ? (CONFIG.stairPricing?.apartmentTime || 0.35)
                        : (CONFIG.stairPricing?.houseTime || 0.275);
                    loadingHours += totalStairs * stairTimePerFlight;
                    
                    // Double for both locations (or add time for third location)
                    if (chatState.data.hasThirdLocation) {
                        loadingHours *= 2.5; // Add 50% more time for third location
                        
                        // Additional time if picking up items at third location
                        if (chatState.data.thirdLocationAction === 'pick_only' || 
                            chatState.data.thirdLocationAction === 'both') {
                            loadingHours += 0.75; // Add 45 minutes for loading at third location
                        }
                    } else {
                        loadingHours *= 2;
                    }
                    
                    // Add time for all appliances (including third location)
                    const allAppliances = [...(chatState.data.appliances || []), 
                                         ...(chatState.data.thirdLocationAppliances || [])];
                    allAppliances.forEach(appliance => {
                        loadingHours += CONFIG.appliances[appliance].time;
                    });
                    
                    // Add time for TVs
                    chatState.data.tvHandling?.forEach(tv => {
                        const tvConfig = CONFIG.tvHandling[tv];
                        if (tvConfig) {
                            loadingHours += tvConfig.time;
                        }
                    });
                    
                    // Add time for shop equipment
                    chatState.data.shopEquipment?.forEach(equipment => {
                        const equipConfig = CONFIG.shopEquipment[equipment];
                        if (equipConfig) {
                            loadingHours += equipConfig.time;
                        }
                    });
                    
                    // Add time for oversized furniture
                    chatState.data.oversizedFurniture?.forEach(furniture => {
                        const furnitureConfig = CONFIG.oversizedFurniture[furniture];
                        if (furnitureConfig) {
                            loadingHours += furnitureConfig.time;
                        }
                    });
                    
                    // Add time for special items
                    if (chatState.data.specialItems && chatState.data.specialItems !== 'none') {
                        const specialItem = CONFIG.specialItems[chatState.data.specialItems];
                        if (specialItem) {
                            loadingHours += specialItem.time;
                        }
                    }
                    
                    // Apply access multiplier to loading hours only
                    loadingHours *= chatState.data.accessMultiplier || 1.0;
                    
                    // DRIVE TIME CALCULATIONS - Using Google Maps actual durations
                    let totalDriveHours = 0;
                    
                    // Add up all the durations we've collected
                    totalDriveHours += chatState.data.fromDuration || 0; // Base to pickup
                    totalDriveHours += chatState.data.tripDuration || 0; // Pickup to delivery
                    
                    // FIXED: Only add half return distance if delivery location > 85 miles from base
                    if (chatState.data.hasThirdLocation) {
                        totalDriveHours += chatState.data.thirdLocationDuration || 0; // To third location
                        totalDriveHours += (chatState.data.thirdToBaseDuration || 0) / 2; // Half way back from third
                    } else {
                        // Check if delivery location is > 85 miles from base
                        try {
                            const deliveryToBase = await calculateDistanceFromDeliveryToBase();
                            deliveryToBaseDistance = parseFloat(deliveryToBase.distance);
                            
                            if (deliveryToBaseDistance > 85) {
                                // Only add half the return trip if > 85 miles
                                totalDriveHours += parseFloat(deliveryToBase.duration) / 2;
                            }
                        } catch (error) {
                            console.error('Error calculating delivery to base duration:', error);
                            // Fallback: only add if fromDistance > 85
                            deliveryToBaseDistance = chatState.data.fromDistance || 0;
                            if (deliveryToBaseDistance > 85) {
                                totalDriveHours += deliveryToBaseDistance / 45 / 2;
                            }
                        }
                    }
                    
                    // Use the actual drive hours from Google Maps
                    const driveHours = totalDriveHours;
                    
                    // Calculate total distance for display (with same logic applied)
                    const fromDistance = chatState.data.fromDistance || 30;
                    const tripDistance = chatState.data.tripDistance || 30;
                    let totalDriveDistance = fromDistance + tripDistance;
                    
                    if (chatState.data.hasThirdLocation) {
                        totalDriveDistance += chatState.data.thirdLocationDistance || 0;
                        totalDriveDistance += (chatState.data.thirdToBaseDistance || 0) / 2;
                    } else {
                        if (deliveryToBaseDistance > 85) {
                            totalDriveDistance += deliveryToBaseDistance / 2;
                        }
                    }
                    
                    // Total hours = loading/unloading + drive time
                    let totalHours = loadingHours + driveHours;
                    
                    // Adjust for crew size efficiency
                    const crewSize = chatState.data.crewSize || chatState.data.minCrewSize || 2;
                    totalHours *= (1 - ((crewSize - 2) * 0.175));
                    
                    // Calculate rates with distance adjustment
                    const baseRate = CONFIG.rates.moving.base + (fromDistance * CONFIG.rates.moving.distanceAdj);
                    const hourlyRate = baseRate + ((crewSize - 2) * CONFIG.rates.moving.crewAdd);
                    const baseCost = totalHours * hourlyRate;

                    // Calculate all fees
                    const specialItemFee = CONFIG.specialItems[chatState.data.specialItems]?.fee || 0;
                    const heavyItemFees = chatState.data.heavyItemFees || 0;

                    // Calculate stair fees for moving service
                    // Apartments charge more due to narrow hallways, no elevator access, and building restrictions
                    const stairRate = homeType === 'apartment'
                        ? (CONFIG.stairPricing?.apartment || 35)
                        : (CONFIG.stairPricing?.house || 25);
                    const stairFee = totalStairs * stairRate;

                    // Calculate TV box fees
                    let tvBoxFees = 0;
                    chatState.data.tvBoxes?.forEach(box => {
                        const boxConfig = CONFIG.tvHandling[box];
                        if (boxConfig) {
                            tvBoxFees += boxConfig.fee;
                        }
                    });

                    // Calculate shop equipment fees
                    let shopEquipmentFees = 0;
                    chatState.data.shopEquipment?.forEach(equipment => {
                        const equipConfig = CONFIG.shopEquipment[equipment];
                        if (equipConfig) {
                            shopEquipmentFees += equipConfig.fee;
                        }
                    });

                    // Calculate oversized furniture fees
                    let oversizedFees = 0;
                    chatState.data.oversizedFurniture?.forEach(furniture => {
                        const furnitureConfig = CONFIG.oversizedFurniture[furniture];
                        if (furnitureConfig) {
                            oversizedFees += furnitureConfig.fee;
                        }
                    });

                    // Calculate toll costs based on all trip segments
                    let tollCost = chatState.data.tollCost || 0;
                    if (chatState.data.hasThirdLocation) {
                        // Add additional toll estimates for third location
                        tollCost += Math.max(5, (chatState.data.thirdLocationDistance || 0) * CONFIG.tollCostFactor);
                    }

                    // Calculate packing costs
                    let packingCost = 0;
                    let packingMaterialsCost = 0;

                    if (chatState.data.packingService && chatState.data.packingService !== 'no') {
                        const packingHours = chatState.data.packingService === 'full' ?
                            loadingHours * 1.75 : loadingHours * 0.75;
                        packingCost = packingHours * CONFIG.packingRate;
                    }

                    if (chatState.data.needsPackingMaterials) {
                        const materials = calculatePackingMaterials(bedrooms);
                        packingMaterialsCost = materials.total;
                        chatState.data.materialsBreakdown = materials;
                    }

                    // SERVICE CHARGE: Apply 14% to ENTIRE JOB minus packing supplies
                    // Subtotal = baseCost + all fees + packing labor (but NOT packing materials)
                    const subtotalBeforeServiceCharge = baseCost + specialItemFee + heavyItemFees +
                                                        tvBoxFees + shopEquipmentFees + oversizedFees +
                                                        packingCost + tollCost + stairFee;
                    const serviceCharge = subtotalBeforeServiceCharge * CONFIG.rates.moving.serviceCharge;

                    // Calculate same-day service fee (10%) - AFTER service charge, applied to subtotal + service charge
                    let sameDayFee = 0;
                    if (chatState.data.movingDate && isSameDay(chatState.data.movingDate)) {
                        sameDayFee = (subtotalBeforeServiceCharge + serviceCharge + packingMaterialsCost) * 0.10;
                    }

                    const total = subtotalBeforeServiceCharge + serviceCharge + packingMaterialsCost + sameDayFee;
                    
                    // Build location string
                    let locationString = `${chatState.data.from} ‚Üí ${chatState.data.to}`;
                    if (chatState.data.hasThirdLocation) {
                        locationString += ` ‚Üí ${chatState.data.thirdLocation}`;
                    }
                    
                    // Store calculated values for display
                    estimate = {
                        type: 'moving',
                        from: chatState.data.from,
                        to: chatState.data.to,
                        thirdLocation: chatState.data.thirdLocation,
                        hasThirdLocation: chatState.data.hasThirdLocation,
                        homeType: homeType,
                        bedrooms: bedrooms,
                        loadingHours: loadingHours.toFixed(1),
                        driveHours: driveHours.toFixed(1),
                        totalHours: totalHours.toFixed(1),
                        totalDistance: totalDriveDistance.toFixed(1),
                        crew: crewSize,
                        hourlyRate: hourlyRate.toFixed(2),
                        baseCost: baseCost.toFixed(2),
                        serviceCharge: serviceCharge.toFixed(2),
                        specialItemFee: specialItemFee,
                        heavyItemFees: heavyItemFees,
                        tvBoxFees: tvBoxFees,
                        shopEquipmentFees: shopEquipmentFees,
                        oversizedFees: oversizedFees,
                        packingCost: packingCost,
                        packingMaterialsCost: packingMaterialsCost,
                        stairFee: stairFee,
                        sameDayFee: sameDayFee,
                        tollCost: tollCost,
                        total: total.toFixed(2),
                        movingDate: chatState.data.formattedDate
                    };
                    
                    // Enhanced estimate display with drive time breakdown
                    showBotMessage(`<div class="estimate-details">
                        <strong>üìä Your Moving Estimate</strong><span class="success-badge">Ready!</span><br><br>
                        üìÖ <strong>Move date:</strong> ${estimate.movingDate}<br>
                        üìç <strong>Route:</strong> ${locationString}<br>
                        üè† <strong>Move size:</strong> ${estimate.bedrooms} bedroom ${estimate.homeType}<br>
                        üë• <strong>Crew:</strong> ${estimate.crew} professional movers<br><br>
                        
                        <div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <strong>‚è±Ô∏è Time Breakdown:</strong><br>
                            Loading/Unloading: ${estimate.loadingHours} hours<br>
                            Drive Time: ${estimate.driveHours} hours<br>
                            <strong>Total Estimated Time: ${estimate.totalHours} hours</strong><br>
                            <span style="font-size: 12px; color: #666;">
                                *Includes ${estimate.totalDistance} miles of driving ${deliveryToBaseDistance > 85 ? '(half return trip included)' : ''}
                            </span>
                        </div>
                        
                        üí∞ <strong>Hourly rate:</strong> $${estimate.hourlyRate}/hour<br><br>
                        
                        <strong>üí∞ Your Investment:</strong><br>
                        Moving service (${estimate.totalHours} hrs): $${estimate.baseCost}<br>
                        Service fee: $${estimate.serviceCharge}<br>
                        ${specialItemFee > 0 ? `Special item handling: $${specialItemFee}<br>` : ''}
                        ${heavyItemFees > 0 ? `Heavy item surcharge: $${heavyItemFees}<br>` : ''}
                        ${tvBoxFees > 0 ? `TV boxes: $${tvBoxFees}<br>` : ''}
                        ${shopEquipmentFees > 0 ? `Shop equipment fees: $${shopEquipmentFees}<br>` : ''}
                        ${oversizedFees > 0 ? `Oversized item fees: $${oversizedFees}<br>` : ''}
                        ${stairFee > 0 ? `Stair fees (${totalStairs} flights): $${stairFee}<br>` : ''}
                        ${sameDayFee > 0 ? `<span style="color: #dc3545;">Same-day service fee (10%): $${sameDayFee.toFixed(2)}</span><br>` : ''}
                        ${packingCost > 0 ? `Packing service: $${packingCost.toFixed(2)}<br>` : ''}
                        ${packingMaterialsCost > 0 ? `Packing materials: $${packingMaterialsCost.toFixed(2)}<br>` : ''}
                        ${tollCost > 0 ? `Estimated tolls: $${tollCost.toFixed(2)}<br>` : ''}
                        <strong style="color: #004085; font-size: 18px;">Total Estimate: $${estimate.total}</strong>
                        
                        <p class="disclaimer-text">*This estimate includes all driving time based on current traffic conditions. Final pricing confirmed upon booking.</p>
                        <div class="overage-disclaimer">‚ö†Ô∏è Important: If the actual move time exceeds ${estimate.totalHours} hours, additional time will be charged at the hourly rate of $${estimate.hourlyRate}/hour.</div>
                    </div>`);
                    
                    // Show packing materials breakdown if applicable
                    if (packingMaterialsCost > 0 && chatState.data.materialsBreakdown) {
                        setTimeout(() => {
                            showBotMessage(`<div class="materials-details">
                                <strong>üì¶ Your Packing Materials</strong><br><br>
                                <div class="materials-breakdown">
                                    ${chatState.data.materialsBreakdown.items.map(item => 
                                        `<div class="materials-item">
                                            <span>${item.name} (${item.qty})</span>
                                            <span>${formatMoney(item.total)}</span>
                                        </div>`
                                    ).join('')}
                                    <div class="materials-total">
                                        Total Materials: ${formatMoney(packingMaterialsCost)}
                                    </div>
                                </div>
                            </div>`);
                        }, 1500);
                    }
                    
                } else if (chatState.serviceType === 'labor') {
                    const crew = chatState.data.crewSize || 2;
                    const hours = chatState.data.hours || 2;
                    const distance = chatState.data.fromDistance || 30;
                    const stairs = chatState.data.stairsFrom || 0;
                    // Most labor jobs are apartments - use apartment rate
                    const stairFee = stairs * (CONFIG.stairPricing?.apartment || 35);

                    // Calculate heavy item fees for labor service
                    const { fees: heavyItemFees, count: heavyItemCount } = calculateHeavyItemFees();

                    // Get individual fee breakdowns
                    const shopEquipmentFees = chatState.data.shopEquipment.reduce((total, item) => {
                        const equipment = CONFIG.shopEquipment[item];
                        return total + (equipment ? equipment.fee : 0);
                    }, 0);

                    const oversizedFees = chatState.data.oversizedFurniture.reduce((total, item) => {
                        const furniture = CONFIG.oversizedFurniture[item];
                        return total + (furniture ? furniture.fee : 0);
                    }, 0);

                    // Calculate drive time for labor service using actual duration if available
                    const driveHours = chatState.data.fromDuration ?
                        (chatState.data.fromDuration * 2) : // Round trip
                        ((distance * 2) / 45); // Fallback to 45 mph average

                    const baseRate = CONFIG.rates.labor.base + (distance * CONFIG.rates.labor.distanceAdj);
                    const hourlyRate = baseRate + ((crew - 2) * CONFIG.rates.labor.crewAdd);
                    const laborCost = hours * hourlyRate;
                    const travelCost = distance * 2 * CONFIG.rates.labor.travel;

                    // SERVICE CHARGE: Apply 8% to ENTIRE JOB (labor + travel + all fees)
                    const subtotalBeforeServiceCharge = laborCost + travelCost + stairFee + heavyItemFees + shopEquipmentFees + oversizedFees;
                    const serviceCharge = subtotalBeforeServiceCharge * CONFIG.rates.labor.serviceCharge;

                    // Calculate same-day service fee (10%) - applied AFTER service charge
                    let sameDayFee = 0;
                    if (chatState.data.movingDate && isSameDay(chatState.data.movingDate)) {
                        sameDayFee = (subtotalBeforeServiceCharge + serviceCharge) * 0.10;
                    }

                    const total = subtotalBeforeServiceCharge + serviceCharge + sameDayFee;
                    
                    estimate = {
                        type: 'labor',
                        location: chatState.data.from,
                        crew: crew,
                        laborHours: hours,
                        driveHours: driveHours.toFixed(1),
                        totalDistance: (distance * 2).toFixed(1),
                        hourlyRate: hourlyRate.toFixed(2),
                        labor: laborCost.toFixed(2),
                        travel: travelCost.toFixed(2),
                        serviceCharge: serviceCharge.toFixed(2),
                        stairFee: stairFee,
                        heavyItemFees: heavyItemFees,
                        shopEquipmentFees: shopEquipmentFees,
                        oversizedFees: oversizedFees,
                        sameDayFee: sameDayFee,
                        total: total.toFixed(2),
                        movingDate: chatState.data.formattedDate
                    };
                    
                    showBotMessage(`<div class="estimate-details">
                        <strong>üí™ Your Labor Crew Estimate</strong><span class="success-badge">Ready!</span><br><br>
                        üìÖ <strong>Service date:</strong> ${estimate.movingDate}<br>
                        üìç <strong>Service location:</strong> ${estimate.location}<br>
                        ü™ú <strong>Stairs:</strong> ${stairs > 0 ? `${stairs} flight(s)` : 'Ground floor'}<br>
                        üë• <strong>Crew size:</strong> ${estimate.crew} movers<br><br>
                        
                        <div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <strong>‚è±Ô∏è Service Details:</strong><br>
                            Labor hours requested: ${estimate.laborHours}<br>
                            Travel time: ${estimate.driveHours} hours<br>
                            Total distance: ${estimate.totalDistance} miles (round trip)<br>
                        </div>
                        
                        üí∞ <strong>Hourly rate:</strong> $${estimate.hourlyRate}/hour<br><br>
                        
                        <strong>üí∞ Your Investment:</strong><br>
                        Labor service (${estimate.laborHours} hrs): $${estimate.labor}<br>
                        Travel: $${estimate.travel}<br>
                        Service fee: $${estimate.serviceCharge}<br>
                        ${stairFee > 0 ? `Stair fees (${stairs} flights): $${stairFee}<br>` : ''}
                        ${heavyItemFees > 0 ? `Heavy item surcharge (${heavyItemCount} items): $${heavyItemFees.toFixed(2)}<br>` : ''}
                        ${shopEquipmentFees > 0 ? `Shop equipment fees: $${shopEquipmentFees.toFixed(2)}<br>` : ''}
                        ${oversizedFees > 0 ? `Oversized item fees: $${oversizedFees.toFixed(2)}<br>` : ''}
                        ${sameDayFee > 0 ? `<span style="color: #dc3545;">Same-day service fee (10%): $${sameDayFee.toFixed(2)}</span><br>` : ''}
                        <strong style="color: #004085; font-size: 18px;">Total Estimate: $${estimate.total}</strong>
                        
                        <p class="disclaimer-text">*Travel time is separate from labor hours. Final pricing confirmed upon booking.</p>
                        <div class="overage-disclaimer">‚ö†Ô∏è Important: Additional labor hours beyond the ${estimate.laborHours} hours requested will be charged at $${estimate.hourlyRate}/hour.</div>
                    </div>`);
                    
                    setTimeout(() => {
                        showBotMessage("‚úÖ You provide the truck<br>‚úÖ We provide the muscle!<br><br>‚ö†Ô∏è Note: Moving equipment included. Pads NOT included but available for purchase.");
                    }, 1000);
                    
                } else if (chatState.serviceType === 'single') {
                    const itemType = chatState.data.selectedSingleItem || chatState.data.itemType || 'other';
                    const itemConfig = CONFIG.singleItemCategories[itemType] || { 
                        name: chatState.data.itemDescription || 'Custom Item',
                        crew: 2,
                        minTime: 60,
                        category: 'standard',
                        fee: 0
                    };
                    
                    const pickupStairs = chatState.data.stairsFrom || 0;
                    const deliveryStairs = chatState.data.deliveryStairs || 0;
                    const totalStairs = pickupStairs + deliveryStairs;
                    const stairFees = totalStairs * CONFIG.rates.singleItem.stairs;
                    
                    const fromDistance = chatState.data.fromDistance || 30;
                    const tripDistance = chatState.data.tripDistance || 30;
                    const totalDistance = fromDistance + tripDistance;
                    
                    // Calculate drive time
                    const driveHours = (chatState.data.fromDuration || 0) + (chatState.data.tripDuration || 0) || 
                                     (totalDistance / 45);
                    const driveMinutes = Math.ceil(driveHours * 60);
                    
                    // Get crew size and minimum time
                    const crewSize = chatState.data.requiredCrew || itemConfig.crew;
                    const minimumMinutes = chatState.data.minimumTime || itemConfig.minTime;
                    
                    // Calculate total time needed (drive time + 30 min for loading/unloading)
                    const totalMinutesNeeded = Math.max(driveMinutes + 30, minimumMinutes);
                    
                    // Get hourly rate based on crew size
                    const hourlyRate = CONFIG.rates.singleItem.crewRates[crewSize] || CONFIG.rates.singleItem.crewRates[2];
                    
                    // Calculate base cost
                    let baseCost;
                    if (totalMinutesNeeded <= 60) {
                        baseCost = CONFIG.rates.singleItem.base; // Flat rate for first hour
                    } else {
                        // First hour flat rate + additional time at hourly rate
                        const additionalHours = (totalMinutesNeeded - 60) / 60;
                        baseCost = CONFIG.rates.singleItem.base + (additionalHours * hourlyRate);
                    }
                    
                    // Add distance cost
                    const distanceCost = totalDistance * CONFIG.rates.singleItem.distance;
                    
                    // Get item fee
                    const itemFee = chatState.data.itemFee || itemConfig.fee || 0;
                    
                    // Apply heavy item fee if weight >= 300 lbs
                    let heavyItemFee = 0;
                    if ((chatState.data.itemWeight || itemConfig.weight || 0) >= 300) {
                        heavyItemFee = CONFIG.heavyItemFee;
                    }
                    
                    // SERVICE CHARGE: Apply 14% to entire job (same as moving service)
                    const subtotalBeforeServiceCharge = baseCost + distanceCost + stairFees + itemFee + heavyItemFee;
                    const serviceCharge = subtotalBeforeServiceCharge * 0.14; // 14% service fee

                    // Calculate same-day service fee (10%) - applied AFTER service charge
                    let sameDayFee = 0;
                    if (chatState.data.movingDate && isSameDay(chatState.data.movingDate)) {
                        sameDayFee = (subtotalBeforeServiceCharge + serviceCharge) * 0.10;
                    }

                    const total = subtotalBeforeServiceCharge + serviceCharge + sameDayFee;
                    
                    estimate = {
                        type: 'single',
                        item: chatState.data.itemName || itemConfig.name,
                        from: chatState.data.from,
                        to: chatState.data.to,
                        crew: crewSize,
                        minimumTime: minimumMinutes,
                        base: baseCost.toFixed(2),
                        distance: distanceCost.toFixed(2),
                        stairs: stairFees,
                        itemFee: itemFee,
                        heavyItemFee: heavyItemFee,
                        serviceCharge: serviceCharge.toFixed(2),
                        sameDayFee: sameDayFee,
                        total: total.toFixed(2),
                        totalDistance: totalDistance.toFixed(1),
                        driveMinutes: driveMinutes,
                        totalMinutesEstimated: totalMinutesNeeded,
                        hourlyRate: hourlyRate,
                        movingDate: chatState.data.formattedDate
                    };
                    
                    showBotMessage(`<div class="estimate-details">
                        <strong>üì¶ Your Single Item Move</strong><span class="success-badge">Ready!</span><br><br>
                        üìÖ <strong>Move date:</strong> ${estimate.movingDate}<br>
                        üì¶ <strong>Item:</strong> ${estimate.item}<br>
                        üìç <strong>Route:</strong> ${estimate.from} ‚Üí ${estimate.to}<br>
                        üë• <strong>Crew:</strong> ${estimate.crew} professional movers<br>
                        ${totalStairs > 0 ? `ü™ú <strong>Stairs:</strong> ${totalStairs} flight(s)<br>` : ''}
                        <br>
                        
                        <div style="background: #f0f7ff; padding: 10px; border-radius: 8px; margin: 10px 0;">
                            <strong>üìè Service Details:</strong><br>
                            Total distance: ${estimate.totalDistance} miles<br>
                            Estimated drive time: ${estimate.driveMinutes} minutes<br>
                            Minimum service time: ${estimate.minimumTime} minutes<br>
                            ${estimate.totalMinutesEstimated > estimate.minimumTime ? 
                                `<span style="color: #dc3545;">Estimated total time: ${estimate.totalMinutesEstimated} minutes</span><br>` : ''}
                        </div>
                        
                        <strong>üí∞ Your Investment:</strong><br>
                        Base service: $${estimate.base}<br>
                        Distance fee: $${estimate.distance}<br>
                        ${stairFees > 0 ? `Stair fees (${totalStairs} flights): $${stairFees}<br>` : ''}
                        ${itemFee > 0 ? `Special handling fee: $${itemFee}<br>` : ''}
                        ${heavyItemFee > 0 ? `Heavy item fee (300+ lbs): $${heavyItemFee}<br>` : ''}
                        Service fee (14%): $${estimate.serviceCharge}<br>
                        ${sameDayFee > 0 ? `<span style="color: #dc3545;">Same-day service fee (10%): $${sameDayFee.toFixed(2)}</span><br>` : ''}
                        <strong style="color: #004085; font-size: 18px;">Total: $${estimate.total}</strong>
                        
                        <p class="disclaimer-text">*Includes ${estimate.minimumTime} minutes minimum service time. Additional time at $${estimate.hourlyRate}/hour for ${estimate.crew}-person crew.</p>
                        ${estimate.totalMinutesEstimated > estimate.minimumTime ? 
                            `<div class="overage-disclaimer">‚ö†Ô∏è Based on distance and item type, your move may take approximately ${estimate.totalMinutesEstimated} minutes. Time beyond ${estimate.minimumTime} minutes will be charged at $${estimate.hourlyRate}/hour.</div>` :
                            `<div class="overage-disclaimer">‚ö†Ô∏è If your move exceeds ${estimate.minimumTime} minutes, additional time will be charged at $${estimate.hourlyRate}/hour.</div>`}
                    </div>`);
                }
                
                chatState.data.estimate = estimate;
                chatState.stage = 'show_fvp_options';
                saveSession();
                
                // Add Sarah's professional advice
                setTimeout(() => {
                    const expertAdvice = getRandomResponse(SARAH_PERSONALITY.expertise);
                    showBotMessage(expertAdvice);
                }, 1500);
                
                // Add FVP options for moving service
                if (chatState.serviceType === 'moving') {
                    setTimeout(() => {
                        showBotMessage(`<div class="warning-box">
                            <strong>‚ö†Ô∏è Important: Personal Items Notice</strong><br><br>
                            For your security, please transport these items in your personal vehicle:
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Irreplaceable items and family heirlooms</li>
                                <li>Prescription medications</li>
                                <li>Important documents</li>
                                <li>Valuable jewelry</li>
                                <li>Items of sentimental value</li>
                            </ul>
                        </div>`);
                        
                        setTimeout(() => {
                            showBotMessage("Would you like to add Full Value Protection to your move?");
                            showOptions([
                                { text: "üìã Standard Coverage (Included)", value: "standard" },
                                { text: "üõ°Ô∏è Full Value Protection", value: "fvp", primary: true },
                                { text: "‚Ü™Ô∏è Skip & Continue", value: "skip" }
                            ]);
                            saveSession();
                        }, 1500);
                    }, 2500);
                } else {
                    // For labor and single item, go straight to booking
                    setTimeout(() => {
                        chatState.stage = 'show_booking_options';
                        showFinalBookingOptions();
                    }, 1500);
                }
            }, 2000);
        }

        // Calculate and show cleanout/junk removal estimate
        function calculateAndShowCleanoutEstimate() {
            const thinking = getRandomResponse(SARAH_PERSONALITY.thinking);
            showBotMessage(thinking);

            const excitement = getRandomResponse(SARAH_PERSONALITY.excitement);
            showBotMessage(excitement, 800);

            setTimeout(() => {
                const distance = chatState.data.cleanoutDistance || 0;
                const crew = chatState.data.cleanoutCrew || 2;
                const isJunk = chatState.data.cleanoutType === 'junk';

                let estimate = {};

                if (isJunk) {
                    // Junk Removal Calculation
                    // Base: $250 for 2-person crew, 1 hour
                    // Distance: $0.50/mile from base
                    // Disposal fee: $75
                    // Service charge: 14%
                    // Extra crew: +$100 per person

                    const baseCost = CONFIG.rates.junkRemoval.base;
                    const crewUpcharge = (crew - 2) * CONFIG.rates.junkRemoval.crewAdd;
                    const totalBase = baseCost + crewUpcharge;

                    const distanceCost = distance * CONFIG.rates.junkRemoval.distance;
                    const disposalFee = CONFIG.rates.junkRemoval.disposalFee;

                    const subtotal = totalBase + distanceCost + disposalFee;
                    const serviceCharge = subtotal * CONFIG.rates.junkRemoval.serviceCharge;
                    const total = subtotal + serviceCharge;

                    estimate = {
                        type: 'junk_removal',
                        location: chatState.data.cleanoutLocation,
                        distance: distance.toFixed(1),
                        crew: crew,
                        hours: 1,
                        baseCost: totalBase.toFixed(2),
                        distanceCost: distanceCost.toFixed(2),
                        disposalFee: disposalFee.toFixed(2),
                        serviceCharge: serviceCharge.toFixed(2),
                        total: total.toFixed(2)
                    };

                    chatState.data.estimate = estimate;
                    saveSession();

                    showBotMessage(`<div class="estimate-details">
                        <strong>üóëÔ∏è Your Junk Removal Estimate</strong><span class="success-badge">Ready!</span><br><br>
                        üìç <strong>Location:</strong> ${estimate.location}<br>
                        üìè <strong>Distance from base:</strong> ${estimate.distance} miles<br>
                        üë• <strong>Crew:</strong> ${estimate.crew} professional movers<br>
                        ‚è±Ô∏è <strong>Time included:</strong> Up to ${estimate.hours} hour<br><br>

                        <strong>üí∞ Your Investment:</strong><br>
                        Base service (${estimate.crew}-person crew): $${estimate.baseCost}<br>
                        Travel ($0.50/mile): $${estimate.distanceCost}<br>
                        Disposal fee: $${estimate.disposalFee}<br>
                        Service fee (14%): $${estimate.serviceCharge}<br><br>

                        <strong style="font-size: 18px; color: #004085;">Total: $${estimate.total}</strong>

                        <div class="overage-disclaimer">‚ö†Ô∏è Important: If the job exceeds ${estimate.hours} hour, additional time will be charged at a rate based on crew size.</div>
                    </div>`);
                } else {
                    // Cleanout Service Calculation
                    // Hourly rate: $219.99 + ($0.50 √ó distance)
                    // Total labor: hours √ó adjusted_hourly_rate
                    // Disposal fee: $200
                    // Service charge: 14%
                    // Extra crew: +$50/hour per person

                    const hours = chatState.data.cleanoutHours || 2;
                    const baseHours = CONFIG.rates.cleanout.baseHours;

                    // Calculate adjusted hourly rate based on distance
                    const baseHourlyRate = CONFIG.rates.cleanout.baseHourly;
                    const distanceAdjustment = distance * CONFIG.rates.cleanout.distanceAdjustment;
                    const adjustedHourlyRate = baseHourlyRate + distanceAdjustment;

                    // Calculate labor cost at adjusted rate
                    const laborCost = hours * adjustedHourlyRate;
                    const crewUpcharge = (crew - 2) * CONFIG.rates.cleanout.crewAdd * hours; // Per hour per crew member
                    const totalLabor = laborCost + crewUpcharge;

                    const disposalFee = CONFIG.rates.cleanout.disposalFee;

                    const subtotal = totalLabor + disposalFee;
                    const serviceCharge = subtotal * CONFIG.rates.cleanout.serviceCharge;
                    const total = subtotal + serviceCharge;

                    estimate = {
                        type: 'cleanout',
                        location: chatState.data.cleanoutLocation,
                        distance: distance.toFixed(1),
                        crew: crew,
                        hours: hours,
                        baseHours: baseHours,
                        baseHourlyRate: baseHourlyRate.toFixed(2),
                        distanceAdjustment: distanceAdjustment.toFixed(2),
                        adjustedHourlyRate: adjustedHourlyRate.toFixed(2),
                        laborCost: laborCost.toFixed(2),
                        crewUpcharge: crewUpcharge.toFixed(2),
                        totalLabor: totalLabor.toFixed(2),
                        disposalFee: disposalFee.toFixed(2),
                        serviceCharge: serviceCharge.toFixed(2),
                        total: total.toFixed(2)
                    };

                    chatState.data.estimate = estimate;
                    saveSession();

                    showBotMessage(`<div class="estimate-details">
                        <strong>üßπ Your Cleanout Service Estimate</strong><span class="success-badge">Ready!</span><br><br>
                        üìç <strong>Location:</strong> ${estimate.location}<br>
                        üìè <strong>Distance from base:</strong> ${estimate.distance} miles<br>
                        üë• <strong>Crew:</strong> ${estimate.crew} professional movers<br>
                        ‚è±Ô∏è <strong>Time estimate:</strong> ${estimate.hours} hours<br>
                        üíµ <strong>Hourly rate:</strong> $${estimate.adjustedHourlyRate}/hr<br><br>

                        <strong>üí∞ Your Investment:</strong><br>
                        Labor (${estimate.hours} hrs @ $${estimate.adjustedHourlyRate}/hr): $${estimate.laborCost}<br>
                        ${crewUpcharge > 0 ? `Extra crew upcharge (${crew - 2} additional @ $50/hr): $${estimate.crewUpcharge}<br>` : ''}
                        Disposal fee: $${estimate.disposalFee}<br>
                        Service fee (14%): $${estimate.serviceCharge}<br><br>

                        <strong style="font-size: 18px; color: #004085;">Total: $${estimate.total}</strong>

                        <div class="overage-disclaimer">‚ö†Ô∏è Important: If the job exceeds ${estimate.hours} hours, additional time will be charged at $${estimate.adjustedHourlyRate}/hour.</div>
                    </div>`);
                }

                // Show booking options
                setTimeout(() => {
                    chatState.stage = 'show_booking_options';
                    showFinalBookingOptions();
                }, 1500);
            }, 2000);
        }

        // ==========================================
        // BOOKING SYSTEM INTEGRATION FUNCTIONS
        // ==========================================

        // Check if customer exists in Square database
        async function checkExistingCustomer(email) {
            try {
                const url = `${CONFIG.bookingAPI.baseUrl}${CONFIG.bookingAPI.endpoints.checkCustomer}/${encodeURIComponent(email)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.hasCard) {
                    console.log('‚úÖ Returning customer found:', data.customer);
                    return {
                        exists: true,
                        customer: data.customer
                    };
                } else {
                    console.log('üìù New customer - will need to collect card');
                    return {
                        exists: false,
                        customer: null
                    };
                }
            } catch (error) {
                console.error('Error checking customer:', error);
                return {
                    exists: false,
                    customer: null
                };
            }
        }

        // Main booking initiation function
        async function initiateBooking() {
            try {
                // Always collect payment - no customer check
                setTimeout(() => {
                    showBotMessage('I\'ll need to collect your payment information to secure your booking. This will only take a moment.');
                }, 1000);

                setTimeout(() => {
                    showBotMessage('üí≥ Let\'s save your payment method securely with Square.');
                    chatState.stage = 'payment';
                    showPaymentModal();
                }, 2000);
            } catch (error) {
                console.error('Error initiating booking:', error);
                showBotMessage('I\'m having trouble processing your booking. Please try again or call us at 330-435-8686.');
            }
        }

        // Send booking data to API
        async function sendBookingToAPI(squareCustomerId = null) {
            try {
                // Get service type name
                const serviceTypeName = getServiceTypeName(chatState.serviceType);

                // Build comprehensive notes from all collected data
                const notes = buildNotesFromChatState();

                // Prepare booking data
                const bookingData = {
                    // Customer info
                    firstName: chatState.data.firstName || '',
                    lastName: chatState.data.lastName || '',
                    email: chatState.data.email || '',
                    phone: chatState.data.phone || '',

                    // Service details
                    serviceType: serviceTypeName,
                    pickupAddress: chatState.data.from || chatState.data.pickupAddress || '',
                    dropoffAddress: chatState.data.to || chatState.data.dropoffAddress || '',

                    // Move details
                    date: chatState.data.movingDate || chatState.data.selectedDate || 'TBD',
                    time: chatState.data.selectedTime || '09:00',

                    // Estimate details
                    estimateDetails: {
                        subtotal: parseFloat(chatState.data.estimate?.subtotal || chatState.data.estimate?.total || 0),
                        fees: chatState.data.estimate?.fees || {},
                        total: parseFloat(chatState.data.estimate?.total || 0),
                        breakdown: chatState.data.estimate || {}
                    },

                    // Comprehensive notes
                    notes: notes,

                    // Payment info
                    payment: squareCustomerId ? {
                        squareCustomerId: squareCustomerId,
                        hasCardOnFile: true
                    } : {
                        squareCustomerId: chatState.data.squareCustomerId || null,
                        hasCardOnFile: !!chatState.data.squareCustomerId
                    }
                };

                console.log('üì§ Sending booking to API:', bookingData);

                // Send to booking API
                const url = `${CONFIG.bookingAPI.baseUrl}${CONFIG.bookingAPI.endpoints.bookAppointment}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });

                const data = await response.json();

                if (data.success) {
                    showBookingSuccess(data.bookingId);
                } else {
                    throw new Error(data.error || 'Booking failed');
                }
            } catch (error) {
                console.error('‚ùå Error sending booking:', error);
                showBotMessage('I couldn\'t complete your booking. Please call us at 330-435-8686 and mention your estimate.');
            }
        }

        // Helper function to get friendly service name
        function getServiceTypeName(type) {
            const serviceNames = {
                'moving': 'Full Service Moving',
                'labor': 'Labor Only',
                'single': 'Single Item Move',
                'cleanout': 'Cleanout Service',
                'junk': 'Junk Removal'
            };
            return serviceNames[type] || 'Moving Service';
        }

        // Helper function to build detailed notes from all collected data
        function buildNotesFromChatState() {
            let notes = [];

            // Moving service details
            if (chatState.serviceType === 'moving') {
                if (chatState.data.bedrooms) notes.push(`Bedrooms: ${chatState.data.bedrooms}`);
                if (chatState.data.homeType) notes.push(`Home type: ${chatState.data.homeType}`);
                if (chatState.data.floors) notes.push(`Floors at pickup: ${chatState.data.floors}`);
                if (chatState.data.deliveryFloors) notes.push(`Floors at dropoff: ${chatState.data.deliveryFloors}`);
                if (chatState.data.stairsFrom) notes.push(`Stairs from: ${chatState.data.stairsFrom} flights`);
                if (chatState.data.stairsTo) notes.push(`Stairs to: ${chatState.data.stairsTo} flights`);
                if (chatState.data.hasElevator !== undefined) notes.push(`Elevator: ${chatState.data.hasElevator ? 'Yes' : 'No'}`);
                if (chatState.data.hasThirdLocation) notes.push(`Has third location: Yes`);
            }

            // Distance and drive time
            if (chatState.data.distance) notes.push(`Distance: ${chatState.data.distance} miles`);
            if (chatState.data.fromDistance) notes.push(`From base: ${chatState.data.fromDistance} miles`);
            if (chatState.data.tripDistance) notes.push(`Trip distance: ${chatState.data.tripDistance} miles`);

            // Special items
            if (chatState.data.specialItems) notes.push(`Special items: ${chatState.data.specialItems}`);
            if (chatState.data.appliances && chatState.data.appliances.length > 0) {
                notes.push(`Appliances: ${chatState.data.appliances.join(', ')}`);
            }
            if (chatState.data.shopEquipment && chatState.data.shopEquipment.length > 0) {
                notes.push(`Shop equipment: ${chatState.data.shopEquipment.map(i => i.name).join(', ')}`);
            }
            if (chatState.data.oversizedFurniture && chatState.data.oversizedFurniture.length > 0) {
                notes.push(`Oversized furniture: ${chatState.data.oversizedFurniture.map(i => i.name).join(', ')}`);
            }

            // Labor service details
            if (chatState.serviceType === 'labor') {
                if (chatState.data.laborHours) notes.push(`Labor hours requested: ${chatState.data.laborHours}`);
            }

            // Single item details
            if (chatState.serviceType === 'single') {
                if (chatState.data.itemName) notes.push(`Item: ${chatState.data.itemName}`);
                if (chatState.data.itemDescription) notes.push(`Description: ${chatState.data.itemDescription}`);
                if (chatState.data.itemWeight) notes.push(`Weight: ${chatState.data.itemWeight} lbs`);
            }

            // FVP coverage
            if (chatState.data.wantsFVP) {
                notes.push(`Full Value Protection: Yes ($${chatState.data.fvpCost || 0})`);
            }

            // Packing services
            if (chatState.data.packingNeeded) notes.push(`Packing needed: ${chatState.data.packingNeeded}`);

            // Customer notes
            if (chatState.data.notes) notes.push(`Customer notes: ${chatState.data.notes}`);

            // Photos
            if (chatState.data.photos && chatState.data.photos.length > 0) {
                notes.push(`Photos uploaded: ${chatState.data.photos.length}`);
            }

            return notes.join(' | ');
        }

        // Show success confirmation after booking
        function showBookingSuccess(bookingId) {
            const successHTML = `
                <div style="padding: 25px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
                            border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-size: 60px; margin-bottom: 15px;">‚úÖ</div>
                    <h2 style="color: #155724; margin-bottom: 15px; font-size: 24px;">Booking Confirmed!</h2>
                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">Your Booking ID</div>
                        <div style="color: #007bff; font-size: 28px; font-weight: 700; letter-spacing: 1px;">${bookingId}</div>
                    </div>
                    <p style="margin: 15px 0; color: #155724; line-height: 1.6;">
                        üìß You'll receive a confirmation email shortly with all the details.<br>
                        üìû We'll call you 24 hours before your move to confirm.
                    </p>
                    <div style="border-top: 2px solid #28a745; margin: 20px 0; padding-top: 20px;">
                        <p style="font-size: 16px; color: #155724; font-weight: 600; margin-bottom: 10px;">
                            Questions? We're here to help!
                        </p>
                        <p style="font-size: 14px; color: #155724;">
                            üìû Call us at <strong>330-435-8686</strong><br>
                            üìß Email <strong>service@worryfreemovers.com</strong>
                        </p>
                    </div>
                </div>
            `;

            showBotMessage(successHTML);

            // Mark booking as completed
            chatState.data.bookingId = bookingId;
            chatState.data.bookingCompleted = true;
            saveSession();

            // Offer to start new conversation
            setTimeout(() => {
                showBotMessage('Would you like to start a new estimate or do you have any questions?');
                showOptions([
                    { text: 'üí¨ New Estimate', value: 'restart', primary: true },
                    { text: '‚ùì Ask a Question', value: 'questions' },
                    { text: 'üëã All Done', value: 'close' }
                ]);
            }, 3000);
        }

        function showFinalBookingOptions() {
            // Add urgency
            setTimeout(() => {
                const urgencyMessage = getRandomResponse(SALES_MESSAGES.urgency);
                showBotMessage(`<div class="highlight-box">
                    <span class="urgency-text">${urgencyMessage}</span><br><br>
                    Ready to secure your date?
                </div>`);
            }, 1000);
            
            setTimeout(() => {
                showBotMessage("How would you like to proceed, " + (chatState.data.firstName || chatState.data.name) + "?");
                showOptions([
                    { text: "üìÖ Book This Move Now", value: "pay_deposit", primary: true },
                    { text: "üìû Call: 330-435-8686", value: "call" },
                    { text: "üìß Email Estimate", value: "email_quote" },
                    { text: "üìÑ View & Print Quote", value: "print_quote" },
                    { text: "üí¨ New Estimate", value: "restart" },
                    { text: "üìä Compare Estimates", value: "compare_estimates" },
                    { text: "üíæ Save & Resume Later", value: "save_resume" }
                ]);
                chatState.stage = 'show_booking_options';
                saveSession();
            }, 2500);
        }

        // Show print quote modal
        function showPrintQuote() {
            const data = chatState.data;

            if (!data || !data.estimate) {
                showBotMessage("‚ö†Ô∏è No estimate data available. Please generate an estimate first.");
                return;
            }

            const estimateTotal = parseFloat(data.estimate.total || 0) || 0;
            const fvpCost = parseFloat(data.fvpCost) || 0;
            const grandTotal = estimateTotal + fvpCost;

            const serviceTypeName = data.estimate.type === 'moving' ? 'Full Service Moving' :
                                  data.estimate.type === 'labor' ? 'Labor-Only Service' :
                                  data.estimate.type === 'junk_removal' ? 'Junk Removal Service' :
                                  data.estimate.type === 'cleanout' ? 'Cleanout Service' : 'Single Item Move';

            const currentDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Build simple HTML content
            html = '<h2 style="color: #004085; border-bottom: 2px solid #004085; padding-bottom: 10px; margin-bottom: 20px;">Quote for ' + data.firstName + ' ' + data.lastName + '</h2>';
            html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
            html += '<p><strong>Service Type:</strong> ' + serviceTypeName + '</p>';
            html += '<p><strong>Date:</strong> ' + currentDate + '</p>';
            html += '<p><strong>Customer:</strong> ' + data.firstName + ' ' + data.lastName + '</p>';
            html += '<p><strong>Email:</strong> ' + (data.email || 'Not provided') + '</p>';
            html += '<p><strong>Phone:</strong> ' + (data.phone || 'Not provided') + '</p>';
            html += '</div>';

            html += '<h3 style="color: #004085; margin: 20px 0 10px;">Estimate Breakdown</h3>';
            html += '<div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;">';
            html += '<div style="font-size: 24px; font-weight: 700; color: #004085; margin-bottom: 15px;">Total: ' + formatMoney(grandTotal) + '</div>';
            html += '<p style="color: #666;">Detailed breakdown sent via email.</p>';
            html += '</div>';

            html += '<div style="margin-top: 30px; padding: 20px; background: #e6f1ff; border-left: 4px solid #004085;">';
            html += '<p style="font-weight: 600;">üìû Call: 330-435-8686</p>';
            html += '<p>üìß Email: service@worryfreemovers.com</p>';
            html += '<p>üåê worryfreemovers.com</p>';
            html += '</div>';

            // Populate modal
            document.getElementById('wfm-print-content').innerHTML = html;

            // Show modal
            document.getElementById('wfm-print-modal').style.display = 'flex';
            document.getElementById('wfm-container').style.display = 'none';
        }

        // Send customer quote via email
        async function sendCustomerQuote(data) {
    const estimateTotal = parseFloat(data.estimate?.total || 0) || 0;
    const fvpCost = parseFloat(data.fvpCost) || 0;
    const grandTotal = estimateTotal + fvpCost;
    
    // Build itemized breakdown based on service type
    let itemizedBreakdown = '';
    let jobDistance = '';
    let whatsIncluded = '';
    let serviceSpecificTerms = '';
    let closingMessage = '';
    
    if (data.estimate?.type === 'moving') {
        // Calculate job distance properly for full service moves
        // For full service: show point A to B (and to C if applicable)
        if (data.hasThirdLocation) {
            // A to B + B to C
            const tripDistance = parseFloat(data.tripDistance || 0);
            const thirdLocationDistance = parseFloat(data.thirdLocationDistance || 0);
            jobDistance = (tripDistance + thirdLocationDistance).toFixed(1);
        } else {
            // Just A to B
            jobDistance = parseFloat(data.tripDistance || 0).toFixed(1);
        }
        
        itemizedBreakdown = `
ITEMIZED BREAKDOWN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Base Moving Service (${data.estimate.totalHours} hrs @ $${data.estimate.hourlyRate}/hr): ${formatMoney(data.estimate.baseCost)}
Service Fee (14%): ${formatMoney(data.estimate.serviceCharge)}`;

        // Add optional fees if present
        if (parseFloat(data.estimate.specialItemFee) > 0) {
            itemizedBreakdown += `\nSpecial Item Handling: ${formatMoney(data.estimate.specialItemFee)}`;
        }
        if (parseFloat(data.estimate.heavyItemFees) > 0) {
            itemizedBreakdown += `\nHeavy Item Surcharge: ${formatMoney(data.estimate.heavyItemFees)}`;
        }
        if (parseFloat(data.estimate.tvBoxFees) > 0) {
            itemizedBreakdown += `\nTV Protection Boxes: ${formatMoney(data.estimate.tvBoxFees)}`;
        }
        if (parseFloat(data.estimate.shopEquipmentFees) > 0) {
            itemizedBreakdown += `\nShop Equipment Fees: ${formatMoney(data.estimate.shopEquipmentFees)}`;
        }
        if (parseFloat(data.estimate.oversizedFees) > 0) {
            itemizedBreakdown += `\nOversized Item Fees: ${formatMoney(data.estimate.oversizedFees)}`;
        }
        if (parseFloat(data.estimate.stairFee) > 0) {
            itemizedBreakdown += `\nStair Fees: ${formatMoney(data.estimate.stairFee)}`;
        }
        if (parseFloat(data.estimate.sameDayFee) > 0) {
            itemizedBreakdown += `\nSame-Day Service Fee (10%): ${formatMoney(data.estimate.sameDayFee)}`;
        }
        if (parseFloat(data.estimate.packingCost) > 0) {
            itemizedBreakdown += `\nPacking Service: ${formatMoney(data.estimate.packingCost)}`;
        }
        if (parseFloat(data.estimate.packingMaterialsCost) > 0) {
            itemizedBreakdown += `\nPacking Materials: ${formatMoney(data.estimate.packingMaterialsCost)}`;
        }
        if (parseFloat(data.estimate.tollCost) > 0) {
            itemizedBreakdown += `\nEstimated Tolls: ${formatMoney(data.estimate.tollCost)}`;
        }
        if (fvpCost > 0) {
            itemizedBreakdown += `\nFull Value Protection: ${formatMoney(fvpCost)}`;
        }
        
        // Full Service What's Included
        whatsIncluded = `WHAT'S INCLUDED IN YOUR FULL SERVICE MOVE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì Professional, uniformed, background-checked crew
‚úì Clean, fully-equipped moving truck
‚úì All professional moving equipment included
‚úì Furniture pads & protective blankets
‚úì Professional shrink wrap & moving straps
‚úì Wardrobe boxes available for purchase
‚úì Free furniture disassembly & reassembly
‚úì ${data.fvpOption === 'fvp' ? 'PREMIUM Full Value Protection - ' + formatMoney(data.fvpValue) : 'Basic liability coverage ($0.60/lb per article)'}
‚úì Complete loading & unloading service
‚úì Placement of furniture in your new home`;

        serviceSpecificTerms = `
FULL SERVICE MOVING TERMS:
- Estimate based on ${data.estimate.totalHours} hours of service
- Additional time charged at $${data.estimate.hourlyRate}/hour
- Professional padding & equipment included
- Crew will protect floors, walls, and doorways
- Large furniture professionally wrapped
- Wardrobe boxes available for purchase on move day`;

        closingMessage = `
üåü READY TO EXPERIENCE WORRY-FREE MOVING? üåü
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${data.firstName} ${data.lastName}, you're making a GREAT choice! Here's why our customers love us:

‚úÖ Over 500 five-star reviews
‚úÖ Family-owned & operated since 2019
‚úÖ Your items treated like our own
‚úÖ No surprises - transparent pricing
‚úÖ Professional crews that care

‚ö° IMPORTANT: Your quote of ${formatMoney(grandTotal)} is locked in for 7 days!
   Don't miss out - our schedule fills quickly, especially for ${data.formattedDate || 'your selected date'}.

BOOK NOW & RELAX - WE'VE GOT THIS! üööüí™`;
        
    } else if (data.estimate?.type === 'labor') {
        // For labor service, show distance from base
        jobDistance = parseFloat(data.fromDistance || 0).toFixed(1);
        
        itemizedBreakdown = `
ITEMIZED BREAKDOWN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Labor Hours Requested: ${data.estimate.laborHours} hours
Travel Time: ${data.estimate.driveHours} hours
Round Trip Distance: ${data.estimate.totalDistance} miles

Labor Service (${data.estimate.laborHours} hrs @ $${data.estimate.hourlyRate}/hr): ${formatMoney(data.estimate.labor)}
Travel Fee: ${formatMoney(data.estimate.travel)}
Service Fee (8%): ${formatMoney(data.estimate.serviceCharge)}`;

        if (parseFloat(data.estimate.stairFee) > 0) {
            itemizedBreakdown += `\nStair Fees: ${formatMoney(data.estimate.stairFee)}`;
        }
        if (parseFloat(data.estimate.heavyItemFees) > 0) {
            itemizedBreakdown += `\nHeavy Item Surcharge: ${formatMoney(data.estimate.heavyItemFees)}`;
        }
        if (parseFloat(data.estimate.shopEquipmentFees) > 0) {
            itemizedBreakdown += `\nShop Equipment Fees: ${formatMoney(data.estimate.shopEquipmentFees)}`;
        }
        if (parseFloat(data.estimate.oversizedFees) > 0) {
            itemizedBreakdown += `\nOversized Item Fees: ${formatMoney(data.estimate.oversizedFees)}`;
        }
        if (parseFloat(data.estimate.sameDayFee) > 0) {
            itemizedBreakdown += `\nSame-Day Service Fee (10%): ${formatMoney(data.estimate.sameDayFee)}`;
        }
        
        // Labor Only What's Included
        whatsIncluded = `WHAT'S INCLUDED IN YOUR LABOR-ONLY SERVICE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì Professional, experienced moving crew
‚úì All necessary moving tools & equipment
‚úì Professional dollies & hand trucks
‚úì Moving straps & tie-downs 
‚úì Shrink wrap for securing items
‚úì Basic liability coverage ($0.60/lb per article)
‚úì Expert loading/unloading of YOUR truck
‚úì Efficient, careful handling of all items

‚ùå NOT INCLUDED (Labor-Only Service):
- Moving truck (you provide)
- Furniture pads/blankets (available for purchase)
- Packing materials
- Long-distance driving`;

        serviceSpecificTerms = `
LABOR-ONLY SERVICE TERMS:
- Estimate based on ${data.estimate.laborHours} hours of labor
- Additional time charged at $${data.estimate.hourlyRate}/hour
- Customer provides moving truck/trailer
- Customer responsible for truck size selection
- Furniture pads available for purchase
- Travel time is included in quoted price`;

        closingMessage = `
üí™ SMART CHOICE - SAVE MONEY WITH LABOR-ONLY! üí™
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${data.firstName} ${data.lastName}, you're getting the BEST of both worlds:

‚úÖ Professional muscle & expertise
‚úÖ YOUR truck = BIG savings
‚úÖ No rental markup fees
‚úÖ Expert loading for maximum space
‚úÖ Safe, efficient, FAST service

Your crew knows how to pack a truck RIGHT the first time!

‚ö° LOCK IN YOUR ${formatMoney(grandTotal)} QUOTE NOW!
   Spots for ${data.formattedDate || 'your date'} are going fast!`;
        
    } else if (data.estimate?.type === 'single') {
        // For single item, show distance from base
        jobDistance = parseFloat(data.fromDistance || 0).toFixed(1);
        
        itemizedBreakdown = `
ITEMIZED BREAKDOWN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Item: ${data.estimate.item}
Point-to-Point Distance: ${data.estimate.totalDistance} miles
Estimated Time: ${data.estimate.totalMinutesEstimated} minutes
Crew Size: ${data.estimate.crew} movers

Base Service: ${formatMoney(data.estimate.base)}
Distance Fee: ${formatMoney(data.estimate.distance)}`;

        if (parseFloat(data.estimate.stairs) > 0) {
            itemizedBreakdown += `\nStair Fees: ${formatMoney(data.estimate.stairs)}`;
        }
        if (parseFloat(data.estimate.itemFee) > 0) {
            itemizedBreakdown += `\nSpecial Handling Fee: ${formatMoney(data.estimate.itemFee)}`;
        }
        if (parseFloat(data.estimate.heavyItemFee) > 0) {
            itemizedBreakdown += `\nHeavy Item Fee (300+ lbs): ${formatMoney(data.estimate.heavyItemFee)}`;
        }

        itemizedBreakdown += `\nService Fee (14%): ${formatMoney(data.estimate.serviceCharge)}`;

        if (parseFloat(data.estimate.sameDayFee) > 0) {
            itemizedBreakdown += `\nSame-Day Service Fee (10%): ${formatMoney(data.estimate.sameDayFee)}`;
        }
        
        // Single Item What's Included
        whatsIncluded = `WHAT'S INCLUDED IN YOUR SINGLE ITEM MOVE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì Dedicated ${data.estimate.crew}-person professional crew
‚úì Appropriate truck for your ${data.estimate.item}
‚úì Specialized equipment for safe transport
‚úì Professional padding & protection
‚úì Careful loading & securing
‚úì Safe delivery & placement
‚úì Basic liability coverage
‚úì All tools & equipment needed
‚úì Minimum ${data.estimate.minimumTime} minutes of service`;

        serviceSpecificTerms = `
SINGLE ITEM SERVICE TERMS:
- Includes ${data.estimate.minimumTime} minutes of service
- Additional time charged at $${data.estimate.hourlyRate}/hour
- Professional handling guaranteed
- Item properly padded & secured
- Direct point-to-point service`;

        closingMessage = `
üì¶ PERFECT SOLUTION FOR YOUR ${data.estimate.item.toUpperCase()}! üì¶
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${data.firstName} ${data.lastName}, here's why single item service is PERFECT for you:

‚úÖ Clear, upfront pricing
‚úÖ Professional ${data.estimate.crew}-person crew
‚úÖ Your item gets VIP treatment
‚úÖ Fast, focused service

üéØ Your all-inclusive price: ${formatMoney(grandTotal)}
   Simple. Transparent. Worry-Free!

‚ö° Book NOW - Single item spots fill FAST!`;
    } else if (data.estimate?.type === 'junk_removal' || data.estimate?.type === 'cleanout') {
        // For cleanout/junk removal, show distance from base
        jobDistance = parseFloat(data.cleanoutDistance || 0).toFixed(1);

        if (data.estimate.type === 'junk_removal') {
            itemizedBreakdown = `
ITEMIZED BREAKDOWN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Junk Removal Service
Location: ${data.cleanoutLocation || 'N/A'}
Distance from Base: ${jobDistance} miles
Crew Size: ${data.estimate.crew} movers
Time Included: Up to ${data.estimate.hours} hour

Base Service (${data.estimate.crew}-person crew): ${formatMoney(data.estimate.baseCost)}
Travel Fee ($0.50/mile): ${formatMoney(data.estimate.distanceCost)}
Disposal Fee: ${formatMoney(data.estimate.disposalFee)}
Service Fee (14%): ${formatMoney(data.estimate.serviceCharge)}`;

            whatsIncluded = `WHAT'S INCLUDED IN YOUR JUNK REMOVAL SERVICE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì Professional ${data.estimate.crew}-person crew
‚úì Efficient removal of junk items
‚úì Complete loading & hauling
‚úì Proper disposal at licensed facility
‚úì Broom sweep of removal area
‚úì All labor & equipment included
‚úì Up to ${data.estimate.hours} hour of service
‚úì Safe, responsible disposal`;

            serviceSpecificTerms = `
JUNK REMOVAL SERVICE TERMS:
- Includes up to ${data.estimate.hours} hour of service
- Additional time charged based on crew size
- No hazardous materials accepted
- Disposal fee covers legal dumping fees
- Same-day service often available`;

            closingMessage = `
üóëÔ∏è FAST, PROFESSIONAL JUNK REMOVAL! üóëÔ∏è
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${data.firstName} ${data.lastName}, get your space back TODAY:

‚úÖ Quick, efficient service
‚úÖ Professional disposal
‚úÖ No hassle for you
‚úÖ Same-day availability
‚úÖ Transparent pricing

Your all-inclusive price: ${formatMoney(grandTotal)}

‚ö° BOOK NOW - Get it done TODAY!`;
        } else {
            // Cleanout service
            itemizedBreakdown = `
ITEMIZED BREAKDOWN
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Cleanout Service
Location: ${data.cleanoutLocation || 'N/A'}
Distance from Base: ${jobDistance} miles
Crew Size: ${data.estimate.crew} movers
Estimated Time: ${data.estimate.hours} hours
Hourly Rate: $${data.estimate.adjustedHourlyRate}/hr

Labor (${data.estimate.hours} hrs @ $${data.estimate.adjustedHourlyRate}/hr): ${formatMoney(data.estimate.laborCost)}`;

            if (parseFloat(data.estimate.crewUpcharge) > 0) {
                itemizedBreakdown += `\nExtra Crew Upcharge (${data.estimate.crew - 2} additional @ $50/hr): ${formatMoney(data.estimate.crewUpcharge)}`;
            }

            itemizedBreakdown += `
Disposal Fee: ${formatMoney(data.estimate.disposalFee)}
Service Fee (14%): ${formatMoney(data.estimate.serviceCharge)}`;

            whatsIncluded = `WHAT'S INCLUDED IN YOUR CLEANOUT SERVICE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì Professional ${data.estimate.crew}-person crew
‚úì Complete property cleanout
‚úì All loading & hauling
‚úì Proper disposal at licensed facility
‚úì Sweep & cleanup after removal
‚úì All labor & equipment included
‚úì Organized, systematic approach
‚úì Hourly rate adjusted for distance`;

            serviceSpecificTerms = `
CLEANOUT SERVICE TERMS:
- Hourly rate: $${data.estimate.adjustedHourlyRate}/hour
- Rate includes distance adjustment ($0.50/mile from base)
- Additional time charged at adjusted hourly rate
- Disposal fee covers legal dumping fees
- No hazardous materials accepted
- Perfect for estate, garage, or property cleanouts`;

            closingMessage = `
üßπ COMPLETE CLEANOUT SERVICE! üßπ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${data.firstName} ${data.lastName}, transform your space with our help:

‚úÖ Thorough, professional service
‚úÖ ${data.estimate.crew}-person experienced crew
‚úÖ Complete removal & disposal
‚úÖ Leave the heavy lifting to us
‚úÖ Fair, transparent pricing

Your all-inclusive price: ${formatMoney(grandTotal)}

‚ö° BOOK NOW - Let's get started!`;
        }
    }

    itemizedBreakdown += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL ESTIMATE: ${formatMoney(grandTotal)}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;

    // Build location string based on service type
    let locationString = '';
    if (data.estimate?.type === 'moving') {
        locationString = `From: ${data.from || 'N/A'}
To: ${data.to || 'N/A'}${data.hasThirdLocation ? '\nThird Location: ' + data.thirdLocation : ''}
Job Distance: ${jobDistance} miles`;
    } else if (data.estimate?.type === 'labor') {
        locationString = `Service Location: ${data.from || 'N/A'}
Distance from Base: ${jobDistance} miles`;
    } else if (data.estimate?.type === 'single') {
        locationString = `From: ${data.from || 'N/A'}
To: ${data.to || 'N/A'}
Distance from Base: ${jobDistance} miles`;
    } else if (data.estimate?.type === 'junk_removal' || data.estimate?.type === 'cleanout') {
        locationString = `Service Location: ${data.cleanoutLocation || 'N/A'}
Distance from Base: ${jobDistance} miles`;
    }

    const plainTextQuote = `
üöö YOUR PERSONALIZED MOVING QUOTE üöö
Worry Free Moving - Making Your Move AMAZING!

Dear ${data.firstName} ${data.lastName},

FANTASTIC NEWS! We're thrilled to help make your move smooth, easy, and worry-free!

QUOTE DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Service Type: ${data.estimate?.type === 'moving' ? '‚≠ê FULL SERVICE MOVING ‚≠ê' :
               data.estimate?.type === 'labor' ? 'üí™ LABOR-ONLY SERVICE üí™' :
               data.estimate?.type === 'junk_removal' ? 'üóëÔ∏è JUNK REMOVAL SERVICE üóëÔ∏è' :
               data.estimate?.type === 'cleanout' ? 'üßπ CLEANOUT SERVICE üßπ' : 'üì¶ SINGLE ITEM MOVE üì¶'}
Moving Date: ${data.formattedDate || 'TBD'}
Crew Size: ${data.crewSize || data.estimate?.crew || 2} professional movers

CUSTOMER INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Name: ${data.firstName} ${data.lastName}
Email: ${data.email}
Phone: ${data.phone}

LOCATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${locationString}

${itemizedBreakdown}

${whatsIncluded}

IMPORTANT TERMS & CONDITIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

PRICING & TIME:
- Your estimated total: ${formatMoney(grandTotal)}
- Estimated time: ${data.estimate?.totalHours || data.estimate?.laborHours || (data.estimate?.minimumTime ? data.estimate.minimumTime + ' minutes' : '2 hours')}
- Rate for additional time: $${data.estimate?.hourlyRate || '0'}/hour
- Time exceeding estimate charged at hourly rate

${serviceSpecificTerms}

LIABILITY & PROTECTION:
- Basic coverage: $0.60 per pound per article (included FREE)
${data.fvpOption === 'fvp' ? '‚Ä¢ ‚≠ê PREMIUM Protection selected: ' + formatMoney(data.fvpValue) + ' coverage with $' + data.fvpDeductible + ' deductible' : '‚Ä¢ Upgrade to Full Value Protection available'}
- Customer-packed items: packed at customer's risk
- Excluded: cash, jewelry, important documents, plants

SCHEDULING & AVAILABILITY:
- This quote expires: ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString()}
- Your date is NOT reserved until booked
- Arrival window: 2-hour notification
- Weekend moves available (may have premium)

YOUR PROFESSIONAL CREW:
- ${data.crewSize || data.estimate?.crew || 2} experienced, background-checked movers
- Crew leader with 2+ years experience
- Additional crew available if needed ($55/hour each)
- English-speaking, uniformed professionals

WEATHER & UNFORESEEN EVENTS:
- We work in light rain - your move happens!
- Severe weather: we'll reschedule together
- No charge for weather delays
- Your safety is our priority

POTENTIAL ADDITIONAL CHARGES:
- Extra heavy items (300+ lbs) not disclosed: $150
- Excessive stairs beyond quoted amount: $25/flight
- Long walks (75+ feet) if not mentioned
- Extended wait time (after first 30 min free)
- Last-minute crew size changes

EASY CANCELLATION:
- 48+ hours notice: NO CHARGE
- 24-48 hours: $150 fee
- Less than 24 hours: 50% of estimate
- We understand plans change!

PAYMENT MADE EASY:
- Pay at completion - see the great job first!
- Cash or card accepted
- 3% fee for credit cards
- No deposits required!

${closingMessage}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

BOOK YOUR MOVE NOW - 3 EASY WAYS:
üìÖ ONLINE (Fastest): ${CONFIG.bookingUrl}
üìû CALL: ${CONFIG.phone} (Friendly team waiting!)
üìß EMAIL: ${CONFIG.email}

Remember: This quote EXPIRES in 7 days and spots are filling up!

By booking, you're joining our family of 500+ happy customers!

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Worry Free Moving LLC
"We Move Your Life, Not Just Your Stuff!"
${CONFIG.baseAddress}
Licensed & Insured | PUCO #652751 | DOT #3820498
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 4.8 Star Rating | BBB Accredited

Office Hours:
Monday-Friday: 8:30 AM - 7:00 PM
Saturday: 8:30 AM - 7:00 PM
Sunday: 10:00 AM - 6:00 PM

Website: www.worryfreemovers.com
Facebook: facebook.com/worryfreemovers
`;

    const customerEmailData = {
        email: data.email,
        from_name: 'Worry Free Moving',
        subject: `Your Moving Quote - ${formatMoney(grandTotal)} - ${data.formattedDate || 'TBD'}`,
        message: plainTextQuote,
        _replyto: CONFIG.email,
        _cc: CONFIG.email,
        _template: 'box',
        _captcha: 'false',
        _autoresponse: 'true'
    };
    
    try {
        const response = await fetch(CONFIG.formSubmitUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(customerEmailData)
        });
        
        if (!response.ok) {
            console.error('Failed to send customer quote email');
        } else {
            console.log('Customer quote sent successfully to:', data.email);
        }
    } catch (error) {
        console.error('Error sending customer quote:', error);
    }
}
        async function submitLead(leadData = null) {
            // Use provided data or current state
            const data = leadData || chatState.data;
            
            // Show sending indicator
            showBotMessage(`<div class="sending-indicator">
                <div class="spinner"></div>
                Sending your estimate...
            </div>`);
            
            // Calculate grand total with FVP (fixed NaN issue)
            const estimateTotal = parseFloat(data.estimate?.total || 0) || 0;
            const fvpCost = parseFloat(data.fvpCost) || 0;
            const grandTotal = estimateTotal + fvpCost;
            
            // Build detailed location information
            let locationDetails = `From: ${data.from || 'N/A'}\nTo: ${data.to || 'N/A'}`;
            if (data.hasThirdLocation) {
                locationDetails += `\nThird Location: ${data.thirdLocation}`;
                locationDetails += `\nThird Location Type: ${data.thirdLocationType || 'N/A'}`;
                locationDetails += `\nThird Location Action: ${data.thirdLocationAction || 'N/A'}`;
            }
            
            // Build appliance list
            let applianceDetails = '';
            if (data.appliances && data.appliances.length > 0) {
                applianceDetails = 'Main Location Appliances: ' + data.appliances.map(a => CONFIG.appliances[a].name).join(', ');
            }
            if (data.thirdLocationAppliances && data.thirdLocationAppliances.length > 0) {
                if (applianceDetails) applianceDetails += '\n';
                applianceDetails += 'Third Location Appliances: ' + data.thirdLocationAppliances.map(a => CONFIG.appliances[a].name).join(', ');
            }
            
            // Build equipment and furniture details
            let specialEquipmentDetails = '';
            if (data.shopEquipment && data.shopEquipment.length > 0) {
                specialEquipmentDetails = 'Shop Equipment: ' + data.shopEquipment.map(e => CONFIG.shopEquipment[e].name).join(', ');
            }
            if (data.oversizedFurniture && data.oversizedFurniture.length > 0) {
                if (specialEquipmentDetails) specialEquipmentDetails += '\n';
                specialEquipmentDetails += 'Oversized Items: ' + data.oversizedFurniture.map(f => CONFIG.oversizedFurniture[f].name).join(', ');
            }
            if (data.tvHandling && data.tvHandling.length > 0) {
                if (specialEquipmentDetails) specialEquipmentDetails += '\n';
                specialEquipmentDetails += 'TVs: ' + data.tvHandling.map(t => CONFIG.tvHandling[t].name).join(', ');
            }
            
            // Build photo URLs string
            let photoUrlsString = '';
            if (data.photos && data.photos.length > 0) {
                photoUrlsString = data.photos.map(p => p.url).join('\n');
            }
            
            // Format estimate details for email
            const estimateDetails = {
                first_name: data.firstName,
                last_name: data.lastName,
                full_name: `${data.firstName} ${data.lastName}`,
                email: data.email,
                phone: data.phone,
                moving_date: data.formattedDate || 'Not specified',
                service_type: leadData ? leadData.service_type : chatState.serviceType,
                location_details: locationDetails,
                home_size: data.homeSize === 'large' ? 'Larger than 2,600 sq ft' : '2,600 sq ft or smaller',
                access_obstacles: data.accessObstacles?.join(', ') || 'None',
                appliances: applianceDetails || 'None',
                special_equipment: specialEquipmentDetails || 'None',
                special_items: data.specialItems || 'None',
                crew_size: data.crewSize || 'N/A',
                estimated_hours: data.estimate?.totalHours || 'N/A',
                packing_service: data.packingService || 'None',
                heavy_item_count: data.heavyItemCount || 0,
                heavy_item_fees: formatMoney(data.heavyItemFees || 0),
                pest_disclaimer_agreed: data.pestDisclaimerAgreed ? 'Yes' : 'No',
                pest_disclaimer_timestamp: data.pestDisclaimerTimestamp || 'N/A',
                photos_uploaded: data.hasPhotos || false,
                photo_count: data.photos?.length || 0,
                photo_urls: photoUrlsString,
                photo_category: data.photoCategory || 'N/A',
                estimate_details: JSON.stringify(data.estimate || {}, null, 2),
                total_estimate: formatMoney(estimateTotal),
                fvp_option: data.fvpOption || 'standard',
                fvp_cost: formatMoney(fvpCost),
                grand_total: formatMoney(grandTotal),
                source: 'Sarah AI Chat Widget',
                submission_type: data.isAutoSubmit ? 'auto_booking' : 'manual_quote',
                quote_auto_submitted: data.isAutoSubmit || false,
                submission_timestamp: new Date().toISOString(),
                _subject: 'New Moving Estimate Request - Via Sarah AI',
                _cc: CONFIG.additionalEmail, // Add CC email
                _captcha: 'false',
                _template: 'table'
            };
            
            try {
                // Check if offline
                if (chatState.isOffline || !navigator.onLine) {
                    saveOfflineData(estimateDetails);
                    showBotMessage(`<div class="estimate-details" style="background: #fff3cd; border-left-color: #ffc107;">
                        <strong>üìµ Offline Mode - Quote Saved!</strong><br><br>
                        Your estimate has been saved and will be sent automatically when you're back online.<br><br>
                        You can still:<br>
                        üìû Call us: <a href="tel:330-435-8686">330-435-8686</a><br>
                        üìß Email: <a href="mailto:${CONFIG.email}">${CONFIG.email}</a>
                    </div>`);
                    return;
                }
                
                // Send via AJAX to FormSubmit
                const response = await fetch(CONFIG.formSubmitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(estimateDetails)
                });
                
                if (response.ok) {
                    // Send formatted quote to customer
                    await sendCustomerQuote(data);
                    
                    // Success message - different for auto vs manual
                    if (data.isAutoSubmit) {
                        showBotMessage(`<div class="estimate-details" style="background: #d4edda; border-left-color: #28a745;">
                            <strong>‚úÖ Perfect! Your quote is secured!</strong><br><br>
                            I've sent your personalized estimate to:<br>
                            üìß ${data.email}<br>
                            üìû ${data.phone}<br><br>
                            
                            You'll have this for your records while we proceed!
                        </div>`);
                    } else {
                        showBotMessage(`<div class="estimate-details" style="background: #d4edda; border-left-color: #28a745;">
                            <strong>‚úÖ Perfect! I've sent your estimate to:</strong><br><br>
                            üë§ ${data.firstName} ${data.lastName}<br>
                            üìß ${data.email}<br>
                            üìû ${data.phone}<br><br>

                            <strong>What happens next:</strong><br>
                            1Ô∏è‚É£ You'll receive this estimate via email<br>
                            2Ô∏è‚É£ Review and compare at your convenience<br>
                            3Ô∏è‚É£ A specialist will follow up within 24 hours<br>
                            4Ô∏è‚É£ No pressure - book when you're ready!<br><br>

                            <strong style="color: #dc3545;">üí° Pro tip:</strong> Our schedule fills fast - book soon for best availability!
                        </div>`);

                        setTimeout(() => {
                            showBotMessage("Would you like to view a printable version of your quote?");
                            showOptions([
                                { text: "üìÑ View & Print Quote", value: "print_quote", primary: true },
                                { text: "üìû Call Now: 330-435-8686", value: "call" },
                                { text: "üí¨ New Estimate", value: "restart" }
                            ]);
                            saveSession();
                        }, 1500);
                    }
                } else {
                    throw new Error('Failed to send estimate');
                }
            } catch (error) {
                console.error('Error submitting lead:', error);
                
                // Save offline if network error
                if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                    saveOfflineData(estimateDetails);
                    showBotMessage(`<div class="estimate-details" style="background: #fff3cd; border-left-color: #ffc107;">
                        <strong>üìµ Connection Issue - Quote Saved!</strong><br><br>
                        Your estimate has been saved and will be sent when connection is restored.<br><br>
                        You can still:<br>
                        üìû Call us: <a href="tel:330-435-8686">330-435-8686</a><br>
                        üìß Email: <a href="mailto:${CONFIG.email}">${CONFIG.email}</a>
                    </div>`);
                } else {
                    // Error message with fallback options
                    showBotMessage(`<div class="error-message">
                        ‚ö†Ô∏è There was an issue sending your estimate electronically.
                        <br><br>
                        But don't worry! You can still get your estimate:
                        <br><br>
                        üìû Call us directly: <a href="tel:330-435-8686" style="color: white;">330-435-8686</a><br>
                        üìß Email us: <a href="mailto:${CONFIG.email}" style="color: white;">${CONFIG.email}</a>
                        <br><br>
                        Your estimate total: <strong>${formatMoney(grandTotal)}</strong>
                    </div>`);
                    
                    setTimeout(() => {
                        showOptions([
                            { text: "üìû Call Now: 330-435-8686", value: "call", primary: true },
                            { text: "üìÖ Book Online", value: "book_now" },
                            { text: "üí¨ Try Again", value: "restart" }
                        ]);
                        saveSession();
                    }, 1000);
                }
            }
        }


        async function submitInsuranceClaim() {
            // Show sending indicator
            showBotMessage(`<div class="sending-indicator">
                <div class="spinner"></div>
                Submitting your insurance claim...
            </div>`);
            
            // Build photo URLs string
            let photoUrlsString = '';
            if (chatState.data.photos && chatState.data.photos.length > 0) {
                photoUrlsString = chatState.data.photos.map(p => p.url).join('\n');
            }
            
            // Build claim details
            const claimDetails = {
                first_name: chatState.data.firstName,
                last_name: chatState.data.lastName,
                full_name: `${chatState.data.firstName} ${chatState.data.lastName}`,
                email: chatState.data.email,
                phone: chatState.data.phone,
                claim_type: 'Insurance Claim',
                coverage_type: chatState.data.coverageType === 'fvp_coverage' ? 'Full Value Protection' : 'Standard Coverage',
                fvp_declared_value: chatState.data.fvpDeclaredValue ? formatMoney(chatState.data.fvpDeclaredValue) : 'N/A',
                fvp_deductible: chatState.data.fvpDeductible ? formatMoney(chatState.data.fvpDeductible) : 'N/A',
                damage_description: chatState.data.damageDescription,
                item_value: formatMoney(chatState.data.itemValue),
                damage_cause: chatState.data.damageCause,
                move_date: chatState.data.claimMoveDate,
                invoice_number: chatState.data.invoiceNumber,
                claim_status: chatState.data.claimStatus || 'eligible',
                photos_uploaded: chatState.data.photos?.length || 0,
                photo_urls: photoUrlsString,
                submission_timestamp: new Date().toISOString(),
                _subject: 'INSURANCE CLAIM - Submitted via Sarah AI',
                _cc: CONFIG.additionalEmail,
                _captcha: 'false',
                _template: 'table'
            };
            
            // If claim is ineligible due to deductible, add note
            if (chatState.data.claimStatus === 'ineligible_documented') {
                claimDetails.special_notes = `CLAIM INELIGIBLE: Item value (${formatMoney(chatState.data.itemValue)}) is less than deductible (${formatMoney(chatState.data.fvpDeductible)}). Documented for records only.`;
            }
            
            try {
                // Send via AJAX to FormSubmit
                const response = await fetch(CONFIG.formSubmitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(claimDetails)
                });
                
                if (response.ok) {
                    showBotMessage(`<div class="estimate-details" style="background: #d4edda; border-left-color: #28a745;">
                        <strong>‚úÖ Your claim has been submitted!</strong><br><br>
                        Claim reference sent to:<br>
                        üìß ${chatState.data.email}<br>
                        üìû ${chatState.data.phone}<br><br>
                        
                        <strong>What happens next:</strong><br>
                        1Ô∏è‚É£ You'll receive a confirmation email<br>
                        2Ô∏è‚É£ Our insurance team will review your claim<br>
                        3Ô∏è‚É£ We'll contact you within 24-48 hours<br>
                        4Ô∏è‚É£ Keep your photos and documentation handy<br><br>
                        
                        ${chatState.data.claimStatus === 'ineligible_documented' ? 
                            '<strong style="color: #dc3545;">Note:</strong> Your claim has been documented but may not be eligible for compensation due to the deductible amount.' : 
                            '<strong>Questions?</strong> Call our insurance team at 330-435-8686'}
                    </div>`);
                    
                    setTimeout(() => {
                        showBotMessage("Is there anything else I can help you with?");
                        showOptions([
                            { text: "Get a new moving estimate", value: "restart" },
                            { text: "I have questions", value: "questions" },
                            { text: "Close chat", value: "close" }
                        ]);
                        saveSession();
                    }, 1500);
                } else {
                    throw new Error('Failed to submit claim');
                }
            } catch (error) {
                console.error('Error submitting claim:', error);
                
                // Error message with fallback options
                showBotMessage(`<div class="error-message">
                    ‚ö†Ô∏è There was an issue submitting your claim electronically.
                    <br><br>
                    Please call our insurance team directly:
                    <br><br>
                    üìû Insurance Claims: <a href="tel:330-435-8686" style="color: white;">330-435-8686</a><br>
                    üìß Email: <a href="mailto:${CONFIG.email}" style="color: white;">${CONFIG.email}</a>
                    <br><br>
                    Reference: Damage to ${chatState.data.damageDescription} valued at ${formatMoney(chatState.data.itemValue)}
                </div>`);
                
                setTimeout(() => {
                    showOptions([
                        { text: "üìû Call Now: 330-435-8686", value: "call", primary: true },
                        { text: "üí¨ Try Again", value: "restart" }
                    ]);
                    saveSession();
                }, 1000);
            }
        }

      // Expose function for external button - properly reference the internal function
window.openWFMChat = function() {
    // Directly reference the chat elements and state
    const container = document.getElementById('wfm-chat-container');
    const widget = document.getElementById('wfm-chat-widget');
    const toggle = document.getElementById('wfm-chat-toggle');
    
    if (container && widget) {
        // Show the container and widget
        container.style.display = 'block';
        widget.style.display = 'flex';
        if (toggle) toggle.style.display = 'none';
        
        // Check if we need to start the conversation
        const messages = document.getElementById('wfm-chat-messages');
        if (messages && messages.children.length === 0) {
            // Trigger the chat to start
            const event = new Event('click');
            toggle && toggle.dispatchEvent(event);
        }
    }
};

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>